SELECT COB_DATE, cut, sum(DELTA) as DELTA, sum(Abs(Delta)) As GROSS_DELTA FROM (SELECT a.COB_DATE, a.ISSUE_ID_DECOMP, case /* MSIP */ when a.CCC_TAPS_COMPANY = '0302' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') then 'UK Group Aggregate.MSIP.NAM' when a.CCC_TAPS_COMPANY = '0302' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') then 'UK Group Aggregate.MSIP.UK' when a.CCC_TAPS_COMPANY = '0302' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB' ,'AND','AUT','BLR' ,'BEL' ,'BIH' ,'BGR','CYP' ,'HRV','CZE' ,'DNK','EST' ,'FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.MSIP.Europe' when a.CCC_TAPS_COMPANY = '0302' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') then 'UK Group Aggregate.MSIP.Japan' when a.CCC_TAPS_COMPANY = '0302' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') then 'UK Group Aggregate.MSIP.China' when a.CCC_TAPS_COMPANY = '0302' and a.ISSUER_COUNTRY_CODE_DECOMP NOT IN ('USA','CAN','GBR','JPN','CHN','ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.MSIP.Other' /* MSBIL */ when a.CCC_TAPS_COMPANY = '0342' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') then 'UK Group Aggregate.MSBIL.NAM' when a.CCC_TAPS_COMPANY = '0342' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') then 'UK Group Aggregate.MSBIL.UK' when a.CCC_TAPS_COMPANY = '0342' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB' ,'AND','AUT','BLR' ,'BEL' ,'BIH' ,'BGR','CYP' ,'HRV','CZE' ,'DNK','EST' ,'FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.MSBIL.Europe' when a.CCC_TAPS_COMPANY = '0342' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') then 'UK Group Aggregate.MSBIL.Japan' when a.CCC_TAPS_COMPANY = '0342' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') then 'UK Group Aggregate.MSBIL.China' when a.CCC_TAPS_COMPANY = '0342' and a.ISSUER_COUNTRY_CODE_DECOMP NOT IN ('USA','CAN','GBR','JPN','CHN','ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.MSBIL.Other' /* MSIM */ when a.CCC_TAPS_COMPANY = '0319' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') then 'UK Group Aggregate.MSIM.NAM' when a.CCC_TAPS_COMPANY = '0319' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') then 'UK Group Aggregate.MSIM.UK' when a.CCC_TAPS_COMPANY = '0319' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB' ,'AND','AUT','BLR' ,'BEL' ,'BIH' ,'BGR','CYP' ,'HRV','CZE' ,'DNK','EST' ,'FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.MSIM.Europe' when a.CCC_TAPS_COMPANY = '0319' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') then 'UK Group Aggregate.MSIM.Japan' when a.CCC_TAPS_COMPANY = '0319' and a.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') then 'UK Group Aggregate.MSIM.China' when a.CCC_TAPS_COMPANY = '0319' and a.ISSUER_COUNTRY_CODE_DECOMP NOT IN ('USA','CAN','GBR','JPN','CHN','ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.MSIM.Other' /* Other */ when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') and a.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') then 'UK Group Aggregate.Other.NAM' when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') and a.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') then 'UK Group Aggregate.Other.UK' when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') and a.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB' ,'AND','AUT','BLR' ,'BEL' ,'BIH' ,'BGR','CYP' ,'HRV','CZE' ,'DNK','EST' ,'FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.Other.Europe' when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') and a.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') then 'UK Group Aggregate.Other.Japan' when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') and a.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') then 'UK Group Aggregate.Other.China' when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') and a.ISSUER_COUNTRY_CODE_DECOMP NOT IN ('USA','CAN','GBR','JPN','CHN','ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.Other.Other' end as Cut, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))/1000 as Delta FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.LE_GROUP = 'UK' AND (a.CASH_ISSUE_TYPE <>'COMM' OR a.CASH_ISSUE_TYPE IS NULL) AND a.CCC_DIVISION <> 'FID DVA' AND a.CCC_DIVISION <> 'FIC DVA' AND CCC_STRATEGY <> 'MS DVA STR NOTES IED' GROUP BY a.COB_DATE, a.ISSUE_ID_DECOMP, a.CCC_TAPS_COMPANY, a.ISSUER_COUNTRY_CODE_DECOMP ) x GROUP BY COB_DATE, cut UNION ALL /* Total by Area */ SELECT COB_DATE, cut, sum(DELTA) as DELTA, sum(Abs_Delta) As GROSS_DELTA FROM (SELECT a.COB_DATE, a.ISSUE_ID_DECOMP, case when a.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') then 'UK Group Aggregate.Total.NAM' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') then 'UK Group Aggregate.Total.UK' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB' ,'AND','AUT','BLR' ,'BEL' ,'BIH' ,'BGR','CYP' ,'HRV','CZE' ,'DNK','EST' ,'FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.Total.Europe' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') then 'UK Group Aggregate.Total.Japan' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') then 'UK Group Aggregate.Total.China' when a.ISSUER_COUNTRY_CODE_DECOMP NOT IN ('USA','CAN','GBR','JPN','CHN','ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.Total.Other' end as Cut, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))/1000 as Delta, abs(sum(coalesce(a.USD_EQ_DELTA_DECOMP,0)))/1000 as Abs_Delta FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.LE_GROUP = 'UK' AND (a.CASH_ISSUE_TYPE <>'COMM' OR a.CASH_ISSUE_TYPE IS NULL) AND a.CCC_DIVISION <> 'FID DVA' AND a.CCC_DIVISION <> 'FIC DVA' AND CCC_STRATEGY <> 'MS DVA STR NOTES IED' GROUP BY a.COB_DATE, a.ISSUE_ID_DECOMP, case when a.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') then 'UK Group Aggregate.Total.NAM' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') then 'UK Group Aggregate.Total.UK' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB' ,'AND','AUT','BLR' ,'BEL' ,'BIH' ,'BGR','CYP' ,'HRV','CZE' ,'DNK','EST' ,'FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.Total.Europe' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') then 'UK Group Aggregate.Total.Japan' when a.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') then 'UK Group Aggregate.Total.China' when a.ISSUER_COUNTRY_CODE_DECOMP NOT IN ('USA','CAN','GBR','JPN','CHN','ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') then 'UK Group Aggregate.Total.Other' end ) x GROUP BY COB_DATE, cut UNION ALL /* Total by LE */ SELECT COB_DATE, Cut, sum(DELTA) as DELTA, sum(Abs(Delta)) As GROSS_DELTA FROM (SELECT a.COB_DATE, a.ISSUE_ID_DECOMP, case when a.CCC_TAPS_COMPANY = '0302' then 'UK Group Aggregate.MSIP.Total' when a.CCC_TAPS_COMPANY = '0342' then 'UK Group Aggregate.MSBIL.Total' when a.CCC_TAPS_COMPANY = '0319' then 'UK Group Aggregate.MSIM.Total' when a.CCC_TAPS_COMPANY not in ('0302','0342','0319') then 'UK Group Aggregate.Other.Total' end as Cut, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))/1000 as Delta FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.LE_GROUP = 'UK' AND (a.CASH_ISSUE_TYPE <>'COMM' OR a.CASH_ISSUE_TYPE IS NULL) AND a.CCC_DIVISION <> 'FID DVA' AND a.CCC_DIVISION <> 'FIC DVA' AND CCC_STRATEGY <> 'MS DVA STR NOTES IED' GROUP BY a.COB_DATE, a.CCC_TAPS_COMPANY, a.ISSUE_ID_DECOMP) x GROUP BY COB_DATE, Cut UNION ALL /* Total Total */ SELECT COB_DATE, 'UK Group Aggregate.Total.Total' as Cut, sum(DELTA) as DELTA, sum(Abs_Delta) As GROSS_DELTA FROM (SELECT a.COB_DATE, a.ISSUE_ID_DECOMP, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))/1000 as Delta, abs(sum(coalesce(a.USD_EQ_DELTA_DECOMP,0)))/1000 as Abs_Delta FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.LE_GROUP = 'UK' AND (a.CASH_ISSUE_TYPE <>'COMM' OR a.CASH_ISSUE_TYPE IS NULL) AND a.CCC_DIVISION <> 'FID DVA' AND a.CCC_DIVISION <> 'FIC DVA' AND CCC_STRATEGY <> 'MS DVA STR NOTES IED' GROUP BY a.COB_DATE, a.ISSUE_ID_DECOMP) x GROUP BY COB_DATE