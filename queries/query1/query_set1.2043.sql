WITH     CREDIT_RAW AS     (         SELECT              COB_DATE,             POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,             CR_ULTIMATE_CNTRY_CODE,                 MRD_RATING,             CCC_BUSINESS_AREA,             CASE                 WHEN MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG'             ELSE 'NIG' END AS IG_NIG,             SUM(COALESCE(USD_EXPOSURE,0)) AS NET_EXPOSURE         FROM            cdwuser.U_EXP_MSR a         WHERE (a.COB_DATE = '2018-02-28' or a.COB_DATE = '2018-02-27') and A.CCC_TAPS_COMPANY in ('0362','0816') AND              a.CCC_DIVISION = 'FIXED INCOME DIVISION' AND     a.CCC_PRODUCT_LINE <> 'DISTRESSED TRADING' AND     /*a.CCC_BUSINESS_AREA NOT IN ('COMMODITIES') AND*/       CCC_BANKING_TRADING IN ('TRADING') AND     POSITION_ULT_ISSUER_PARTY_DARWIN_NAME NOT LIKE ('%MORGAN STANLEY%')         GROUP BY             COB_DATE,             POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,             CR_ULTIMATE_CNTRY_CODE,                 MRD_RATING,             CCC_BUSINESS_AREA,             CASE                 WHEN MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG'             ELSE 'NIG' END     ),     CREDIT_SELECT AS /*IG_NIG Selection IG*/     (         SELECT             b.COB_DATE,             b.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,             b.CR_ULTIMATE_CNTRY_CODE,                 b.MRD_RATING,             b.CCC_BUSINESS_AREA,             b.NET_EXPOSURE         FROM             CREDIT_RAW b         WHERE             b.IG_NIG='IG'     ),     CREDIT_SELECT_SUM AS      (         SELECT             bb.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,             bb.CR_ULTIMATE_CNTRY_CODE,             bb.MRD_RATING,             ABS(SUM(bb.NET_EXPOSURE)) AS NET_EXPOSURE         FROM             CREDIT_SELECT bb         WHERE bb.COB_DATE = '2018-02-28'         GROUP BY             bb.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,             bb.CR_ULTIMATE_CNTRY_CODE,             bb.MRD_RATING     ),     CREDIT_SELECT_RANK AS     (         SELECT             c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,             c.MRD_RATING,             c.NET_EXPOSURE,             RANK () OVER (PARTITION BY c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME ORDER BY c.NET_EXPOSURE DESC) AS RANK1         FROM             CREDIT_SELECT_SUM c     ),     CREDIT_SELECT_RANKING AS     (     SELECT         d.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,         d.MRD_RATING AS MRD_RATING_NEW     FROM         CREDIT_SELECT_RANK d     WHERE         d.RANK1 =1     ),     CREDIT_SELECT_ADJ AS     (     SELECT         b.COB_DATE,         b.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,         b.CR_ULTIMATE_CNTRY_CODE,             b.MRD_RATING AS MRD_RATING_OLD,         e.MRD_RATING_NEW AS MRD_RATING,         b.CCC_BUSINESS_AREA,         b.NET_EXPOSURE     FROM         CREDIT_SELECT b     INNER JOIN         CREDIT_SELECT_RANKING e     ON         b.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME=e.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME     ) SELECT     * FROM     CREDIT_SELECT_ADJ WHERE     NET_EXPOSURE <> 0