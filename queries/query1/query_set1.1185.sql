WITH IED AS ( SELECT a.COB_DATE, a.PROCESS_ID, a.POSITION_ID, SUM(a.D10RAW) AS D10RAW, SUM(a.P10RAW) AS P10RAW FROM ( SELECT e.COB_DATE, e.PROCESS_ID, e.POSITION_ID, SUM(e.SLIDE_EQ_MIN_10_USD) AS D10RAW, SUM(e.SLIDE_EQ_PLS_10_USD) AS P10RAW FROM cdwuser.U_EQ_MSR e WHERE (e.COB_DATE = '2018-02-28') AND e.CCC_PL_REPORTING_REGION in ('EMEA') AND e.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND e.CCC_BANKING_TRADING <> 'BANKING' AND e.SILO_SRC = 'IED' GROUP BY e.COB_DATE, e.PROCESS_ID, e.POSITION_ID ) a GROUP BY a.COB_DATE, a.PROCESS_ID, a.POSITION_ID ), CountryWeights AS ( SELECT d.COB_DATE ,d.PROCESS_ID ,d.POSITION_ID ,d.CCC_BUSINESS_AREA ,d.CCC_PRODUCT_LINE ,d.ISSUER_COUNTRY_CODE_DECOMP AS COUNTRY ,d.FID1_INDUSTRY_NAME_LEVEL2 AS SECTOR ,d.PRODUCT_DESCRIPTION_DECOMP AS Description ,d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP AS Tick ,ABS(SUM(d.PRODUCT_WEIGHT_DECOMP)) AS WEIGHT FROM cdwuser.U_DECOMP_MSR d WHERE (d.COB_DATE = '2018-02-28') AND d.CCC_PL_REPORTING_REGION in ('EMEA') AND d.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND d.CCC_BANKING_TRADING <> 'BANKING' AND d.SILO_SRC = 'IED' GROUP BY d.COB_DATE ,d.PROCESS_ID ,POSITION_ID ,d.FID1_INDUSTRY_NAME_LEVEL2 ,d.ISSUER_COUNTRY_CODE_DECOMP ,d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP ,d.PRODUCT_DESCRIPTION_DECOMP ,d.CCC_BUSINESS_AREA ,d.CCC_PRODUCT_LINE HAVING SUM(PRODUCT_WEIGHT_DECOMP) <> 0 ) ,GrossWeights AS ( SELECT x.COB_DATE ,x.PROCESS_ID ,x.POSITION_ID ,SUM(ABS(x.WEIGHT)) AS GROSS_WEIGHT FROM CountryWeights x GROUP BY x.COB_DATE ,x.PROCESS_ID ,x.POSITION_ID ) , Decomp AS ( SELECT w.COB_DATE ,w.Process_ID ,w.Position_id ,w.SECTOR ,w.COUNTRY ,w.Tick ,w.Description ,w.CCC_BUSINESS_AREA ,w.CCC_PRODUCT_LINE ,ABS(w.WEIGHT / g.GROSS_WEIGHT) AS WEIGHT FROM CountryWeights w LEFT JOIN GrossWeights g ON ( w.cob_date = g.cob_date AND w.process_id = g.process_id AND w.position_id = g.position_id ) ) SELECT VIEW ,z.COB_DATE ,CASE WHEN Country IN ( 'ALB' ,'AND' ,'AUT' ,'BLR' ,'BEL' ,'BIH' ,'BGR' ,'CYP' ,'HRV' ,'CZE' ,'DNK' ,'EST' ,'FRO' ,'FIN' ,'FRA' ,'GEO' ,'DEU' ,'GRC' ,'GGY' ,'VAT' ,'HUN' ,'ISL' ,'IRL' ,'IMN' ,'ITA' ,'JEY' ,'LVA' ,'LIE' ,'LTU' ,'LUX' ,'MKD' ,'MLT' ,'MDA' ,'MCO' ,'MNE' ,'NLD' ,'NOR' ,'POL' ,'PRT' ,'ROU' ,'RUS' ,'SMR' ,'SRB' ,'SVK' ,'SVN' ,'ESP' ,'SJM' ,'SWE' ,'CHE' ,'UKR' ,'GBR' ) THEN 'Europe' WHEN Country IN ( 'USA' ,'CAN' ) THEN 'NAM' WHEN Country IN ( 'AIA' ,'ATG' ,'ARG' ,'ABW' ,'BHS' ,'BRB' ,'BLZ' ,'BMU' ,'BOL' ,'BRA' ,'VGB' ,'CYM' ,'CHL' ,'COL' ,'CRI' ,'CUB' ,'DMA' ,'DOM' ,'ECU' ,'SLV' ,'GUF' ,'GRL' ,'GRD' ,'GLP' ,'GTM' ,'GUY' ,'HTI' ,'HND' ,'JAM' ,'MTQ' ,'MEX' ,'MSR' ,'ANT' ,'NIC' ,'PAN' ,'PRY' ,'PER' ,'PRI' ,'KNA' ,'LCA' ,'SPM' ,'VCT' ,'SGS' ,'SUR' ,'TTO' ,'TCA' ,'URY' ,'VEN' ,'VIR' ) THEN 'LATAM' WHEN Country IN ( 'DZA' ,'AGO' ,'BEN' ,'BWA' ,'BFA' ,'BDI' ,'CMR' ,'CPV' ,'CAF' ,'TCD' ,'COM' ,'COD' ,'CIV' ,'DJI' ,'EGY' ,'GNQ' ,'ERI' ,'ETH' ,'GAB' ,'GMB' ,'GHA' ,'GIB' ,'GIN' ,'GNB' ,'KEN' ,'LSO' ,'LBR' ,'LBY' ,'MDG' ,'MWI' ,'MLI' ,'MRT' ,'MUS' ,'MYT' ,'MAR' ,'MOZ' ,'NAM' ,'NER' ,'NGA' ,'REU' ,'RWA' ,'BLM' ,'SHN' ,'MAF' ,'STP' ,'SEN' ,'SYC' ,'SLE' ,'SOM' ,'ZAF' ,'SSD' ,'SDN' ,'SWZ' ,'TZA' ,'TGO' ,'TUN' ,'UGA' ,'ESH' ,'ZMB' ,'ZWE' ) THEN 'Africa' WHEN Country IN ( 'AFG' ,'ALA' ,'ARM' ,'AZE' ,'BHR' ,'BGD' ,'BTN' ,'IOT' ,'BRN' ,'KHM' ,'CHN' ,'HKG' ,'CXR' ,'CCK' ,'FLK' ,'GUM' ,'IND' ,'IDN' ,'IRN' ,'IRQ' ,'ISR' ,'JPN' ,'JOR' ,'KAZ' ,'PRK' ,'KOR' ,'KWT' ,'KGZ' ,'LAO' ,'LBN' ,'MYS' ,'MDV' ,'MNG' ,'MMR' ,'NPL' ,'OMN' ,'PAK' ,'PSE' ,'PHL' ,'QAT' ,'SAU' ,'SGP' ,'LKA' ,'SYR' ,'TWN' ,'TJK' ,'THA' ,'TUR' ,'TKM' ,'ARE' ,'UMI' ,'UZB' ,'VNM' ,'YEM' ) THEN 'Asia' WHEN Country IN ( 'ASM' ,'ATA' ,'AUS' ,'BVT' ,'COK' ,'FJI' ,'PYF' ,'ATF' ,'HMD' ,'KIR' ,'MHL' ,'FSM' ,'NRU' ,'NCL' ,'NZL' ,'NIU' ,'NFK' ,'MNP' ,'PLW' ,'PNG' ,'PCN' ,'WSM' ,'SLB' ,'TLS' ,'TKL' ,'TON' ,'TUV' ,'VUT' ,'WLF' ) THEN 'Pacific' END AS Regional_Classification ,z.CCC_BUSINESS_AREA ,z.CCC_PRODUCT_LINE ,z.COUNTRY ,z.SECTOR ,z.Tick ,z.Description ,SUM( z.D10RAW ) AS D10RAW ,SUM( z.P10RAW ) AS P10RAW FROM ( SELECT 'Decomp'AS VIEW ,i.COB_DATE ,d.SECTOR ,d.Tick ,d.Description ,d.Country ,d.CCC_BUSINESS_AREA ,d.CCC_PRODUCT_LINE ,(i.D10RAW * d.WEIGHT) AS D10RAW ,(i.P10RAW * d.WEIGHT) AS P10RAW FROM IED i INNER JOIN Decomp d ON ( i.PROCESS_ID = d.PROCESS_ID AND i.POSITION_ID = d.POSITION_ID AND i.COB_DATE = d.COB_DATE ) )z GROUP BY VIEW , z.COB_DATE , z.SECTOR ,z.Tick ,z.Description ,z.Country ,z.CCC_BUSINESS_AREA ,z.CCC_PRODUCT_LINE