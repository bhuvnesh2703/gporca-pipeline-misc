SELECT a.COB_DATE ,A.FLAG , b.IS_PEGGED , b.MAJOR_EM , sum(a.FX) / 1000 AS delta , sum(a.USD_FX_KAPPA) / 1000 AS vega FROM ( SELECT cob_date , a.CURRENCY_OF_MEASURE , CASE WHEN a.CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING') and a.CCC_PL_REPORTING_REGION in ('AMERICAS') THEN( 'US_FXEM_MACRO') ELSE 'OTHER' END AS FLAG , CASE WHEN ( CCC_DIVISION IN ('PRIVATE BANKING GROUP') AND PRODUCT_TYPE_CODE = 'REPO' AND CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS') ) THEN 'BANKING' ELSE UPPER(ccc_banking_trading) END AS CAPITAL_BOOK , SUM((USD_FX) :: numeric(15,5)) AS FX , coalesce(SUM(CASE WHEN A.VERTICAL_SYSTEM LIKE '%STS%' THEN ((A.USD_FX_PARTIAL_KAPPA) :: numeric(15,5)) WHEN A.VERTICAL_SYSTEM LIKE '%FXOPT%' THEN ((A.USD_FX_KAPPA) :: numeric(15,5)) END),0) AS USD_FX_KAPPA FROM CDWUSER.U_FX_MSR a WHERE cob_date IN ( '2018-02-28', '2018-01-31' ) AND CURRENCY_OF_MEASURE not in ('UBD', 'USD', 'US1') AND parent_legal_entity IN ('1633') AND var_excl_fl <> 'Y' GROUP BY cob_date , a.CURRENCY_OF_MEASURE , CASE WHEN a.CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING') and a.CCC_PL_REPORTING_REGION in ('AMERICAS') THEN( 'US_FXEM_MACRO') ELSE 'OTHER' END , CASE WHEN ( CCC_DIVISION IN ('PRIVATE BANKING GROUP') AND PRODUCT_TYPE_CODE = 'REPO' AND CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS') ) THEN 'BANKING' ELSE UPPER(ccc_banking_trading) END ) A INNER JOIN ( SELECT DISTINCT a.CURRENCY_OF_MEASURE , CASE WHEN CURRENCY_OF_MEASURE IN ('CNY', 'CNH') THEN 'Y' ELSE a.IS_PEGGED END AS IS_PEGGED , CASE WHEN a.MAJOR_EM = 'China' THEN 'EM' ELSE a.MAJOR_EM END AS MAJOR_EM FROM cdwuser.U_DM_FX a WHERE cob_date IN ( '2018-02-28' ) AND CURRENCY_OF_MEASURE not in ('UBD', 'USD', 'US1') ) B ON a.CURRENCY_OF_MEASURE = b.CURRENCY_OF_MEASURE WHERE a.CAPITAL_BOOK = 'TRADING' GROUP BY a.COB_DATE ,A.FLAG , b.IS_PEGGED , b.MAJOR_EM