select * from ( SELECT COB_DATE, POSITION_ISSUER_PARTY_DARWIN_NAME "CREDIT ULTIMATE NAME", RANK() OVER(PARTITION BY case when book in ('HFI', 'HFS') then 'HFI/HFS' else 'FV' end order by abs(USD_NOTIONAL - coalesce(PRIOR_USD_NOTIONAL,0.0)) DESC) RANK, BOOK, USD_NOTIONAL "NOTIONAL", USD_NOTIONAL - coalesce(PRIOR_USD_NOTIONAL,0.0) "NOTIONAL CHG", USD_EXPOSURE "NET EXPOSURE", USD_EXPOSURE - coalesce(PRIOR_USD_EXPOSURE,0.0) "NET EXPOSURE CHG" FROM ( SELECT COB_DATE, POSITION_ISSUER_PARTY_DARWIN_NAME, BOOK, USD_EXPOSURE, LAG(USD_EXPOSURE) OVER(PARTITION BY POSITION_ISSUER_PARTY_DARWIN_NAME,BOOK order by COB_DATE) PRIOR_USD_EXPOSURE, USD_NOTIONAL, LAG(USD_NOTIONAL) OVER(PARTITION BY POSITION_ISSUER_PARTY_DARWIN_NAME,BOOK order by COB_DATE) PRIOR_USD_NOTIONAL FROM ( SELECT COB_DATE, POSITION_ISSUER_PARTY_DARWIN_NAME, CASE WHEN BOOK IN ('CRE_LENDING_EU_HFI', 'CRE_LENDING_HFI') THEN 'HFI' WHEN BOOK IN ('CRE_LENDING_EU_HFS','CRE_LENDING_HFS') THEN 'HFS' ELSE 'FV' END AS BOOK, USD_EXPOSURE, SUM(USD_NOTIONAL) OVER(PARTITION BY COB_DATE,POSITION_ISSUER_PARTY_DARWIN_NAME) USD_NOTIONAL FROM ( SELECT a.COB_DATE, a.POSITION_ISSUER_PARTY_DARWIN_NAME, a.BOOK, sum((a.USD_EXPOSURE) :: numeric(15,5)) as USD_EXPOSURE, sum((a.USD_NOTIONAL) :: numeric(15,5)) AS USD_NOTIONAL from cdwuser.U_DM_WM a where a.COB_DATE IN ( '2018-02-28', '2018-01-31' ) and a.CCC_PRODUCT_LINE in ('CRE LENDING', 'CREL BANK HFI', 'CRE LENDING SEC/HFS') and a.SPG_DESC in ('CMBS LOAN', 'CMBS LOAN IO', 'CMBS MEZZANINE LOAN') and a.CCC_TAPS_COMPANY = '1633' GROUP BY a.COB_DATE, a.POSITION_ISSUER_PARTY_DARWIN_NAME, a.BOOK ) a ) b )c where COB_DATE IN ( '2018-02-28' ) and USD_NOTIONAL - coalesce(PRIOR_USD_NOTIONAL,0.0) <> 0 )d where rank < 6