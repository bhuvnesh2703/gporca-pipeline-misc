SELECT MAIN.*, CASE WHEN CURRENCY_OF_MEASURE_GROUP = 'OTHERS' THEN 2 ELSE 1 END AS RANK FROM ( SELECT COB_DATE, LE, CURRENCY_OF_MEASURE, CASE WHEN TOP4 < 5 THEN CURRENCY_OF_MEASURE ELSE 'OTHERS' END AS CURRENCY_OF_MEASURE_GROUP, SUM(EQ_VEGA) EQ_VEGA FROM ( SELECT COB_DATE, LE, CURRENCY_OF_MEASURE, EQ_VEGA, DENSE_RANK() OVER(ORDER BY CASE WHEN MSIP_EQ_VEGA_CURRENT IS NOT NULL THEN 1 ELSE 0 END DESC, MSIP_EQ_VEGA_CURRENT DESC ) TOP4 FROM ( SELECT COB_DATE, LE, CURRENCY_OF_MEASURE, EQ_VEGA, SUM(MSIP_EQ_VEGA_CURRENT)OVER(PARTITION BY CURRENCY_OF_MEASURE) MSIP_EQ_VEGA_CURRENT FROM ( SELECT CASE WHEN B.PARENT_LEGAL_ENTITY LIKE '0302(G)%' THEN 'MSIP' WHEN B.PARENT_LEGAL_ENTITY LIKE '0201(G)%' THEN 'MSCO' END AS LE, B.COB_DATE, B.CURRENCY_OF_MEASURE, SUM(B.USD_EQ_KAPPA) AS EQ_VEGA, ABS(SUM(CASE WHEN COB_DATE = '2018-02-28' AND PARENT_LEGAL_ENTITY IN ('0302(G)') THEN B.USD_EQ_KAPPA END )) MSIP_EQ_VEGA_CURRENT FROM CDWUSER.U_EXP_MSR B WHERE B.COB_DATE IN ('2018-02-28','2018-01-31','2017-12-29','2017-11-30','2017-10-31','2017-09-29','2017-08-31','2017-07-31','2017-06-30','2017-05-31','2017-04-28','2017-03-31','2017-02-28') AND B.CCC_PL_REPORTING_REGION = 'AMERICAS' AND B.VAR_EXCL_FL <> 'Y' AND B.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND USD_EQ_KAPPA IS NOT NULL GROUP BY LE, B.COB_DATE, B.CURRENCY_OF_MEASURE ) TMP_1 ) TMP_2 )TMP GROUP BY COB_DATE, LE, CURRENCY_OF_MEASURE, CURRENCY_OF_MEASURE_GROUP ) MAIN