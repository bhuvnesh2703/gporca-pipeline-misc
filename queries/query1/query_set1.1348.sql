With xMin as (select d.ISSUE_ID_DECOMP as issue_id, d.ticker_decomp||'.'||d.exchange_decomp as tick, d.issuer_country_code_decomp as country, d.ISSUER_PARTY_DARWIN_NAME as issuer_name, sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) as EQ_DELTA_MIN_COB, sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else -coalesce(d.usd_eq_delta_decomp,0) end) as EQ_DELTA_MIN_DOD, Rank() over (partition by d.ISSUE_ID_DECOMP order by sum(Case when cob_date ='2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) asc) as MinRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ISSUE_ID_DECOMP, d.ticker_decomp||'.'||d.exchange_decomp, d.issuer_country_code_decomp, d.ISSUER_PARTY_DARWIN_NAME order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) asc fetch first 100 rows only) ,xMax as (select d.ISSUE_ID_DECOMP as issue_id, d.ticker_decomp||'.'||d.exchange_decomp as tick, d.issuer_country_code_decomp as country, d.ISSUER_PARTY_DARWIN_NAME as issuer_name ,sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) as EQ_DELTA_MAX_COB,sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else -coalesce(d.usd_eq_delta_decomp,0) end) as EQ_DELTA_MAX_DOD, Rank() over (partition by d.ISSUE_ID_DECOMP order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) desc) as MaxRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ISSUE_ID_DECOMP, d.ticker_decomp||'.'||d.exchange_decomp, d.issuer_country_code_decomp, d.ISSUER_PARTY_DARWIN_NAME order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) desc fetch first 100 rows only) ,RmMin as (Select d.ticker_decomp||'.'||d.exchange_decomp as tick, d.CCC_RISK_MANAGER_LOGIN as RM, Rank() over (partition by d.ticker_decomp||'.'||d.exchange_decomp order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) asc) as minRmRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ticker_decomp||'.'||d.exchange_decomp, d.CCC_RISK_MANAGER_LOGIN) ,RmMax as (Select d.ticker_decomp||'.'||d.exchange_decomp as tick, d.CCC_RISK_MANAGER_LOGIN as RM, Rank() over (partition by d.ticker_decomp||'.'||d.exchange_decomp order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) desc) as maxRmRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ticker_decomp||'.'||d.exchange_decomp, d.CCC_RISK_MANAGER_LOGIN) ,prodMax as (select d.ticker_decomp||'.'||d.exchange_decomp as tick, d.product_type_code_decomp as prod_type , Rank() over (partition by d.ticker_decomp||'.'||d.exchange_decomp order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) desc) as maxProdRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ticker_decomp||'.'||d.exchange_decomp, d.product_type_code_decomp) ,prodMin as (select d.ticker_decomp||'.'||d.exchange_decomp as tick, d.product_type_code_decomp as prod_type ,Rank() over (partition by d.ticker_decomp||'.'||d.exchange_decomp order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) asc) as minProdRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ticker_decomp||'.'||d.exchange_decomp, d.product_type_code_decomp) ,deskMax as (select d.ticker_decomp||'.'||d.exchange_decomp as tick, d.CCC_STRATEGY as desk ,Rank() over (partition by d.ticker_decomp||'.'||d.exchange_decomp order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) desc) as maxDeskRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ticker_decomp||'.'||d.exchange_decomp, d.CCC_STRATEGY) ,deskMin as (select d.ticker_decomp||'.'||d.exchange_decomp as tick, d.CCC_STRATEGY as desk , Rank() over (partition by d.ticker_decomp||'.'||d.exchange_decomp order by sum(Case when cob_date = '2018-02-28' then coalesce(d.usd_eq_delta_decomp,0) else 0 end) asc) as minDeskRank from cdwuser.u_decomp_msr d where d.cob_date in ('2018-02-28','2018-02-21') and d.DIVISION = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' and d.CCC_BANKING_TRADING = 'TRADING' and d.CCC_RISK_MANAGER_LOGIN <> 'marcio' group by d.ticker_decomp||'.'||d.exchange_decomp, d.CCC_STRATEGY) Select * from (Select xmin.issuer_name, prodMin.prod_type, xmin.Country, xmin.Tick, eq_delta_min_cob as delta_cob, eq_delta_min_dod as delta_dod, deskMin.desk, rmMin.RM from xMin, rmMin, prodMin, deskMin where xMin.issue_id in (select issue_id from xMax) and xMin.tick = rmMin.tick and xMin.tick = prodMin.tick and xMin.tick = deskMin.tick and MinRank = 1 and minRmRank = 1 and minProdRank = 1 and minDeskRank = 1 Union All Select issuer_name, prod_type, xMax.Country, xMax.Tick, eq_delta_max_cob as delta_cob, eq_delta_max_dod as delta_dod, desk, RM from xMax, rmMax, prodMax, deskMax where xMax.issue_id in (select issue_id from xMin) and xMax.tick = rmMax.tick and xMax.tick = prodMax.tick and xMax.tick = deskMax.tick and MaxRank = 1 and maxRmRank = 1 and maxProdRank = 1 and maxDeskRank = 1) a order by sum(abs(delta_cob)) over (partition by issuer_name) desc, abs(delta_cob) desc fetch first 10 rows only