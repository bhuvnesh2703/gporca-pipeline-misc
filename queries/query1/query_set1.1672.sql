with FDSF_SCENARIOS_DATA as ( select COB_DATE AS "Cob Date", case when ATTRIBUTE4 
in ('CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP','FXEM MACRO TRADING','EM CREDIT TRADING','LIQUID FLOW RATES','STRUCTURED RATES','DSP - CREDIT','CASH EQUITIES','DERIVATIVES','OTHER IED','PRIME BROKERAGE') then ATTRIBUTE4 else 'OTHER' end AS "Sub Business Unit", ATTRIBUTE21 AS "Severity_Spot", ATTRIBUTE22 AS "Severity_Vol", ATTRIBUTE23 AS "Severity_Rot", ATTRIBUTE26 AS "Severity_Rec", ATTRIBUTE10 AS "Severity", sum(coalesce(VALUE1,0)) AS "Scenario Shock Result Value", case when ATTRIBUTE12 like '%BOND%' then 'Bond' when ATTRIBUTE12 like '%DEFSWAP%' then 'CDS' else 'Other' end as "Shock_Type", case when COB_DATE = '2018-02-16' then 'CURRENT' when COB_DATE = '2018-01-19' then 'PRIOR' else 'OTHER' end as COB from CDWUSER.U_GENERIC_DATA where cob_date in ('2018-02-16','2018-01-19','2017-12-29','2017-11-17','2017-10-20') and analytic_group = 'FDSF' and analytics = 'SCENARIOS_DETAILS' and ATTRIBUTE1 = 'CR' group by COB_DATE, ATTRIBUTE3, ATTRIBUTE4, ATTRIBUTE21, ATTRIBUTE22, ATTRIBUTE23, ATTRIBUTE26, ATTRIBUTE10, case when ATTRIBUTE12 like '%BOND%' then 'Bond' when ATTRIBUTE12 like '%DEFSWAP%' then 'CDS' else 'Other' end ) select S1.*, case when S1."Severity" like 'None/None%' then coalesce(S1."Scenario Shock Result Value",0) else coalesce(S1."Scenario Shock Result Value",0) - coalesce(S3."Scenario Shock Result Value",0) end as Rot_PNL, coalesce(S1."Scenario Shock Result Value",0) - coalesce(S4."Scenario Shock Result Value",0) as Rec_PNL from FDSF_SCENARIOS_DATA S1 left join FDSF_SCENARIOS_DATA S2 ON S1."Cob Date" = S2."Cob Date" AND S1."Sub Business Unit" = S2."Sub Business Unit" AND S1."Severity_Spot" = S2."Severity_Spot" AND S2."Severity_Vol" = 'None' AND S2."Severity_Rot" = 'None' AND S2."Severity_Rec" = 'None' AND S1."Shock_Type" = S2."Shock_Type" left join FDSF_SCENARIOS_DATA S3 ON S1."Cob Date" = S3."Cob Date" AND S1."Sub Business Unit" = S3."Sub Business Unit" AND S1."Severity_Spot" = S3."Severity_Spot" AND S1."Severity_Vol" = S3."Severity_Vol" AND S3."Severity_Rot" = 'None' AND S3."Severity_Rec" = 'None' AND S1."Shock_Type" = S3."Shock_Type" left join FDSF_SCENARIOS_DATA S4 ON S1."Cob Date" = S4."Cob Date" AND S1."Sub Business Unit" = S4."Sub Business Unit" AND S1."Severity_Spot" = S4."Severity_Spot" AND S1."Severity_Vol" = S4."Severity_Vol" AND S1."Severity_Rot" = S4."Severity_Rot" AND S4."Severity_Rec" = 'None' AND S1."Shock_Type" = S4."Shock_Type" left join FDSF_SCENARIOS_DATA S5 ON S1."Cob Date" = S5."Cob Date" AND S1."Sub Business Unit" = S5."Sub Business Unit" AND S1."Severity_Spot" = S5."Severity_Spot" AND S1."Severity_Vol" = S5."Severity_Vol" AND S1."Severity_Rot" = S5."Severity_Rot" AND S1."Severity_Rec" = S5."Severity_Rec" AND S1."Shock_Type" = S5."Shock_Type"