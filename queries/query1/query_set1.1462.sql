With x as (SELECT DISTINCT DENSE_RANK() OVER(ORDER BY p.COB_DATE) as RANK, COB_DATE FROM cdwuser.U_PCT_PNL_CURRENT p WHERE (p.COB_DATE > '2018-01-01' AND p.COB_DATE <= '2018-02-28' AND NOT p.COB_DATE = '2017-01-03') AND p.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND p.FINANCIAL_ELEMENT NOT IN('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') ), y as ( SELECT RANK, VAR05, DAILY_PNL, CASE WHEN DAILY_PNL < 0 AND -DAILY_PNL > VAR05 THEN 1 ELSE 0 END AS VaRBREACH FROM ( SELECT RANK, sum(VAR05) as VAR05, sum(DAILY_PNL) as DAILY_PNL FROM ( SELECT DENSE_RANK() OVER(ORDER BY v.COB_DATE) as RANK, COB_DATE, -round(VAR05/1000,2) as VAR05, 0 as DAILY_PNL FROM cdwuser.U_VAR_ID_FLAT_VIEW v WHERE (hierarchy_group_name='EQUITY_CV') AND (hierarchy_name='region') AND (level1 IS NULL) AND (COB_DATE > '2018-01-01' AND COB_DATE <= '2018-02-28') UNION ALL SELECT DENSE_RANK() OVER(ORDER BY p.COB_DATE) AS RANK, p.COB_DATE AS COB_DATE, 0 AS VAR05, sum(round(DAILY_PL/1000000,2)) AS DAILY_PNL FROM cdwuser.U_PCT_PNL_CURRENT p WHERE (COB_DATE > '2018-01-01' AND COB_DATE <= '2018-02-28' AND NOT p.COB_DATE = '2017-01-03') AND p.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND (p.ACCOUNT_PURPOSE_CODE <> 'J' or p.ACCOUNT_PURPOSE_CODE IS NULL) AND p.FINANCIAL_ELEMENT not in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') GROUP BY p.COB_DATE ) z GROUP BY RANK ) zz WHERE VAR05 <> 0 ORDER BY RANK ) SELECT y.RANK, x.COB_DATE, y.VAR05, y.DAILY_PNL, y.VaRBREACH FROM y RIGHT JOIN x ON y.RANK = x.RANK WHERE y.RANK IS NOT NULL