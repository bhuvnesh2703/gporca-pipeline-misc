SELECT a.COB_DATE, a.CCC_TAPS_COMPANY, a.account, a.CCC_STRATEGY, a.book, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, CASE WHEN (ccc_division IN ('PRIVATE BANKING GROUP', 'RETAIL BANKING GROUP', 'PWM US BRANCH') AND ccc_business_area IN ('MSCC MORTGAGE LOAN ORIGINATIONS-GWMG')) AND var_excl_fl <> 'Y' AND (BOOK LIKE ('%LOAN%') OR BOOK LIKE ('%PRODUCTION')) THEN BOOK WHEN CCC_BUSINESS_AREA IN ('US BANKS-CRA PORTFOLIO') AND CCC_TAPS_COMPANY NOT IN ('6635', '1633') THEN BOOK END AS RESI_MTG_BOOK, CASE WHEN a.WM_BANKING_PRODUCT_SUB_GROUP = 'INTERNAL TRANSFER TRADES' THEN 'Internal Hedges' ELSE 'n/a' END AS Hedges, CASE WHEN Product_Type_Code IN ('BOND') THEN 'Credit' WHEN Product_Type_Code IN ('ABS', 'CDO_CASH', 'CLO', 'CMBS') AND PRODUCT_SUB_TYPE_CODE NOT IN ('FHLMC', 'FNMA', 'GNMA', 'STU_LOAN', 'STU_LOAN_FFELP', 'FHLMC_SENIOR') THEN 'Credit' ELSE 'Other' END AS SECTYPE_GROUP, CASE WHEN Product_Type_Code IN ('BOND') THEN 'Credit Corp' WHEN (Product_Type_Code IN ('ABS', 'CDO_CASH', 'CLO', 'CMBS') AND PRODUCT_SUB_TYPE_CODE NOT IN ('FHLMC', 'FNMA', 'GNMA', 'STU_LOAN', 'STU_LOAN_FFELP', 'FHLMC_SENIOR')) OR book IN ('PBCLO') THEN 'Credit ABS' WHEN Product_Type_Code IN ('GVTBOND') THEN 'Treasuries' WHEN Product_Type_Code IN ('ABS', 'AGNCMO', 'CMBS', 'RMBS' ) THEN 'Agencies' ELSE 'Other' END AS SECTYPE_GROUP2, Product_Type_Code, PRODUCT_SUB_TYPE_CODE, CASE WHEN PRODUCT_TYPE_CODE = 'DEPOSIT' THEN (CASE WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-A', 'Tier-6', 'Tier-A-BAU', 'Tier-6-BAU') THEN 'Tier-A' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-B-BAU', 'Tier-5-BAU', 'Tier-B', 'Tier-5') THEN 'Tier-B' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-C-BAU', 'Tier-4-BAU', 'Tier-C', 'Tier-4') THEN 'Tier-C' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-D-BAU', 'Tier-3-BAU', 'Tier-D' , 'Tier-3') THEN 'Tier-D' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-8-BAU', 'Tier-7-BAU', 'Tier-E-BAU', 'Tier-8', 'Tier-7', 'Tier-E') THEN 'Tier-E' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-F-BAU', 'Tier-1-BAU', 'Tier-F' , 'Tier-1') THEN 'Tier-F' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-66-BAU', 'Tier-66') THEN 'Mgd-A' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-65-BAU', 'Tier-65') THEN 'Mgd-B' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-64', 'Tier-64-BAU') THEN 'Mgd-C' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-63', 'Tier-63-BAU') THEN 'Mgd-D' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-67', 'Tier-52', 'Tier-G', 'Tier-67-BAU', 'Tier-52-BAU', 'Tier-G-BAU') THEN 'Mgd-E' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-61', 'Tier-51', 'Tier-J', 'Tier-61-BAU', 'Tier-51-BAU', 'Tier-J-BAU') THEN 'Mgd-F' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-H', 'Tier-914', 'Tier-H-BAU', 'Tier-914-BAU' ) THEN 'Tier-H' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-6-Exp%') THEN 'Tier-A-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-5-Exp%') THEN 'Tier-B-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-4-Exp%') THEN 'Tier-C-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-3-Exp%') THEN 'Tier-D-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-7-Exp%') OR BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-8-Exp%') THEN 'Tier-E-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-1-Exp%') THEN 'Tier-F-Promo' ELSE 'OTHER' END) ELSE 'n/a' END AS TIER, a.TERM_WM, a.MRD_RATING, CCC_Product_line, SUM (COALESCE (a.USD_IR_KAPPA_WM_TERM, 0) ::numeric(15,5) / 10) AS USD_KAPPA, SUM (COALESCE (a.USD_IR_UNIFIED_PV01_WM_TERM, 0) ::numeric(15,5)) AS USD_PV01, SUM (COALESCE (a.USD_PV01SPRD_WM_TERM, 0)::numeric(15,5)) AS usd_pv01sprd, SUM (COALESCE (a.USD_NOTIONAL, 0)::numeric(15,5)) / 1000 AS usd_notional, SUM (COALESCE (USD_EXPOSURE, 0)::numeric(15,5)) / 1000 AS USD_EXPOSURE, SUM (COALESCE (USD_PV10_BENCH, 0)::numeric(15,5)) / 1000 AS USD_PV10_BENCH FROM cdwuser.U_DM_WM A WHERE COB_DATE IN ( '2018-02-28', '2018-01-31', '2017-12-29', '2017-11-30', '2017-10-31', '2017-09-29', '2017-08-31', '2015-12-31' ) AND A.CCC_TAPS_COMPANY = '6635' AND (A.VAR_EXCL_FL <> 'Y' OR A.BOOK IN ('MSDPB3M', 'MSDPT3M')) AND (A.ccc_banking_trading = 'BANKING' OR (A.CCC_HIERARCHY_LEVEL2 IN ('WEALTH MANAGEMENT', 'GLOBAL WEALTH MANAGEMENT') OR a.CCC_business_area = 'US BANKS-LIQUIDITY') AND A.PRODUCT_TYPE_CODE = 'REPO' AND A.CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS')) GROUP BY a.COB_DATE, a.CCC_TAPS_COMPANY, a.account, a.CCC_STRATEGY, a.book, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, CASE WHEN (ccc_division IN ('PRIVATE BANKING GROUP', 'RETAIL BANKING GROUP', 'PWM US BRANCH') AND ccc_business_area IN ('MSCC MORTGAGE LOAN ORIGINATIONS-GWMG')) AND var_excl_fl <> 'Y' AND (BOOK LIKE ('%LOAN%') OR BOOK LIKE ('%PRODUCTION')) THEN BOOK WHEN CCC_BUSINESS_AREA IN ('US BANKS-CRA PORTFOLIO') AND CCC_TAPS_COMPANY NOT IN ('6635', '1633') THEN BOOK END, CASE WHEN a.WM_BANKING_PRODUCT_SUB_GROUP = 'INTERNAL TRANSFER TRADES' THEN 'Internal Hedges' ELSE 'n/a' END, CASE WHEN Product_Type_Code IN ('BOND') THEN 'Credit' WHEN Product_Type_Code IN ('ABS', 'CDO_CASH', 'CLO', 'CMBS') AND PRODUCT_SUB_TYPE_CODE NOT IN ('FHLMC', 'FNMA', 'GNMA', 'STU_LOAN', 'STU_LOAN_FFELP', 'FHLMC_SENIOR') THEN 'Credit' ELSE 'Other' END, CASE WHEN Product_Type_Code IN ('BOND') THEN 'Credit Corp' WHEN (Product_Type_Code IN ('ABS', 'CDO_CASH', 'CLO', 'CMBS') AND PRODUCT_SUB_TYPE_CODE NOT IN ('FHLMC', 'FNMA', 'GNMA', 'STU_LOAN', 'STU_LOAN_FFELP', 'FHLMC_SENIOR')) OR book IN ('PBCLO') THEN 'Credit ABS' WHEN Product_Type_Code IN ('GVTBOND') THEN 'Treasuries' WHEN Product_Type_Code IN ('ABS', 'AGNCMO', 'CMBS', 'RMBS' ) THEN 'Agencies' ELSE 'Other' END, Product_Type_Code, PRODUCT_SUB_TYPE_CODE, CASE WHEN PRODUCT_TYPE_CODE = 'DEPOSIT' THEN (CASE WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-A', 'Tier-6', 'Tier-A-BAU', 'Tier-6-BAU') THEN 'Tier-A' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-B-BAU', 'Tier-5-BAU', 'Tier-B', 'Tier-5') THEN 'Tier-B' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-C-BAU', 'Tier-4-BAU', 'Tier-C', 'Tier-4') THEN 'Tier-C' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-D-BAU', 'Tier-3-BAU', 'Tier-D' , 'Tier-3') THEN 'Tier-D' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-8-BAU', 'Tier-7-BAU', 'Tier-E-BAU', 'Tier-8', 'Tier-7', 'Tier-E') THEN 'Tier-E' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-F-BAU', 'Tier-1-BAU', 'Tier-F' , 'Tier-1') THEN 'Tier-F' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-66-BAU', 'Tier-66') THEN 'Mgd-A' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-65-BAU', 'Tier-65') THEN 'Mgd-B' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-64', 'Tier-64-BAU') THEN 'Mgd-C' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-63', 'Tier-63-BAU') THEN 'Mgd-D' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-67', 'Tier-52', 'Tier-G', 'Tier-67-BAU', 'Tier-52-BAU', 'Tier-G-BAU') THEN 'Mgd-E' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-61', 'Tier-51', 'Tier-J', 'Tier-61-BAU', 'Tier-51-BAU', 'Tier-J-BAU') THEN 'Mgd-F' WHEN BANKING_PRODUCT_DESCRIPTION IN ('Tier-H', 'Tier-914', 'Tier-H-BAU', 'Tier-914-BAU' ) THEN 'Tier-H' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-6-Exp%') THEN 'Tier-A-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-5-Exp%') THEN 'Tier-B-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-4-Exp%') THEN 'Tier-C-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-3-Exp%') THEN 'Tier-D-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-7-Exp%') OR BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-8-Exp%') THEN 'Tier-E-Promo' WHEN BANKING_PRODUCT_DESCRIPTION LIKE ('%Tier-1-Exp%') THEN 'Tier-F-Promo' ELSE 'OTHER' END) ELSE 'n/a' END, a.TERM_WM, a.MRD_RATING, CCC_Product_line