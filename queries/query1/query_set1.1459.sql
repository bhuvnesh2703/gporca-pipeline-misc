SELECT x.PL_REPORTING_REGION as PNL_REGION, x.PRODUCT_LINE, x.COMMISSIONS, x.YTD_PNL as MAX_YTD_PNL, max(xx.PNL_DATE) as DATE_OF_MAX FROM ( select PL_REPORTING_REGION, PRODUCT_LINE, COMMISSIONS, max(YTD_PNL) as YTD_PNL from ( SELECT q.cob_date as pnl_date, q.ccc_pl_reporting_region as pl_reporting_region, q.ccc_product_line as product_line, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end as Commissions, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' AND NOT q.COB_DATE = '2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_pl_reporting_region, q.ccc_product_line, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end ) ax group by PL_REPORTING_REGION, PRODUCT_LINE, COMMISSIONS ) x INNER JOIN ( SELECT q.cob_date as pnl_date, q.ccc_product_line as product_line, q.ccc_pl_reporting_region as pl_reporting_region, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end as Commissions, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' AND NOT q.COB_DATE = '2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_product_line, q.ccc_pl_reporting_region, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end ) xx ON (x.PRODUCT_LINE, x.PL_REPORTING_REGION, x.YTD_PNL,x.Commissions) = (xx.PRODUCT_LINE, xx.PL_REPORTING_REGION, xx.YTD_PNL,xx.Commissions) GROUP BY x.PL_REPORTING_REGION, x.PRODUCT_LINE, x.COMMISSIONS, x.YTD_PNL UNION ALL SELECT x.PL_REPORTING_REGION as PNL_REGION, x.PRODUCT_LINE, 'Total' as Commissions, x.YTD_PNL as MAX_YTD_PNL, max(xx.PNL_DATE) as DATE_OF_MAX FROM ( select PL_REPORTING_REGION, PRODUCT_LINE, max(YTD_PNL) as YTD_PNL from ( SELECT q.cob_date as pnl_date, q.ccc_pl_reporting_region as pl_reporting_region, q.ccc_product_line as product_line, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' AND NOT q.COB_DATE = '2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_pl_reporting_region, q.ccc_product_line ) ax group by PL_REPORTING_REGION, PRODUCT_LINE ) x INNER JOIN ( SELECT q.cob_date as pnl_date, q.ccc_product_line as product_line, q.ccc_pl_reporting_region as pl_reporting_region, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' AND NOT q.COB_DATE = '2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_product_line, q.ccc_pl_reporting_region ) xx ON (x.PRODUCT_LINE, x.PL_REPORTING_REGION, x.YTD_PNL) = (xx.PRODUCT_LINE, xx.PL_REPORTING_REGION, xx.YTD_PNL) GROUP BY x.PL_REPORTING_REGION, x.PRODUCT_LINE, x.YTD_PNL