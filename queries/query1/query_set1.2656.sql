SELECT ISSUE_ID, LEGAL_ULTIMATE_NAME, SEL_NAME, DELTA_CURRENT, ABS_DELTA_CURRENT,DELTA_PRIOR,BAMV_CURRENT,BAMV_PRIOR,LIQUIDITY, ROW_NUMBER() OVER(ORDER BY ABS(DELTA_CURRENT) DESC) AS RANKING FROM ( SELECT ISSUE_ID, LEGAL_ULTIMATE_NAME, SEL_NAME, SUM(CASE WHEN IS_COB = 1 THEN COALESCE(DELTA, 0) ELSE 0 END) AS DELTA_CURRENT, ABS(SUM(CASE WHEN IS_COB = 1 THEN COALESCE(DELTA, 0) ELSE 0 END)) AS ABS_DELTA_CURRENT, CASE WHEN ABS(SUM(CASE WHEN IS_COB = 1 THEN COALESCE(DELTA, 0) ELSE 0 END)) > 24999 THEN 1 ELSE 0 END AS MINIMUM_VALUE, SUM(CASE WHEN IS_COB = 1 THEN 0 ELSE COALESCE(DELTA, 0) END) AS DELTA_PRIOR, SUM(CASE WHEN IS_COB = 1 THEN COALESCE(BAMV, 0) ELSE 0 END) AS BAMV_CURRENT, SUM(CASE WHEN IS_COB = 1 THEN 0 ELSE COALESCE(BAMV, 0) END) AS BAMV_PRIOR, SUM(CASE WHEN IS_COB = 1 THEN COALESCE(LIQUIDITY, 0) ELSE 0 END) AS LIQUIDITY FROM ( SELECT ISSUE_ID_DECOMP AS ISSUE_ID, ISSUER_PARTY_DARWIN_NAME AS LEGAL_ULTIMATE_NAME, COALESCE(CHILD_ISSUER_PARTY_DARWIN_NAME, PRODUCT_DESCRIPTION) AS SEL_NAME, CASE WHEN COB_DATE IN ('2018-02-28') THEN 1 ELSE 0 END AS IS_COB, SUM(COALESCE(USD_EQ_DELTA_DECOMP, 0)) AS DELTA, SUM(COALESCE(USD_BAMV_DECOMP, 0)) AS BAMV, SUM(COALESCE(LIQUIDITY_DAYS_DECOMP, 0)) AS LIQUIDITY FROM CDWUSER.U_DECOMP_MSR WHERE COB_DATE IN ('2018-02-28','2018-01-31') AND VAR_EXCL_FL <> 'Y' AND FEED_SOURCE_ID = 301 AND COALESCE(PRODUCT_TYPE_CODE_DECOMP, '') <> 'COMM' AND COALESCE(CASH_ISSUE_TYPE, '') <> 'COMM' AND CCC_BANKING_TRADING = 'TRADING' AND PARENT_LEGAL_ENTITY = '0302(G)' GROUP BY ISSUE_ID, LEGAL_ULTIMATE_NAME, SEL_NAME, IS_COB ) X GROUP BY ISSUE_ID, LEGAL_ULTIMATE_NAME, SEL_NAME ) Y WHERE MINIMUM_VALUE = 1