SELECT COB_DATE, DIVISION_GROUP, G10_GROUP, EM_GROUP, PV01_CATEGORY, CASE WHEN RANK_FX_HARD < 7 THEN CURRENCY_OF_MEASURE ELSE 'OTHERS' END HARD_CURRENCY, CASE WHEN RANK_FX_LOCAL < 7 THEN CURRENCY_OF_MEASURE ELSE 'OTHERS' END LOCAL_CURRENCY, SUM(FX) FX FROM ( SELECT COB_DATE, DIVISION_GROUP, G10_GROUP, EM_GROUP, PV01_CATEGORY, CURRENCY_OF_MEASURE, DENSE_RANK() OVER ( ORDER BY CASE WHEN EM_GROUP = 'G10' THEN 1 ELSE 2 END, CASE WHEN FX_COB IS NOT NULL THEN 1 ELSE 2 END ASC, ABS(FX_COB) DESC ) RANK_FX_HARD, DENSE_RANK() OVER ( ORDER BY CASE WHEN G10_GROUP = 'Non-G10' THEN 1 ELSE 2 END, CASE WHEN FX_COB IS NOT NULL THEN 1 ELSE 2 END ASC, ABS(FX_COB) DESC ) RANK_FX_LOCAL, FX FROM ( SELECT COB_DATE, DIVISION_GROUP, G10_GROUP, EM_GROUP, PV01_CATEGORY, CURRENCY_OF_MEASURE, FX, SUM(FX_COB) OVER (PARTITION BY CURRENCY_OF_MEASURE) FX_COB FROM ( SELECT COB_DATE, DIVISION_GROUP, G10_GROUP, CASE WHEN A.EM_GROUP IN ( 'Other', 'EM ex CNY, CNH' ) THEN 'EM ex CNY, CNH' ELSE A.EM_GROUP END AS EM_GROUP, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES' ) THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ( 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING' ) THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ( 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT' ) THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP', 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT', 'COMMODITIES' ) THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND PV01_DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN PV01_DIVISION_GROUP IN ( 'ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG' ) THEN PV01_DIVISION_GROUP WHEN CCC_DIVISION NOT IN ( 'INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION' ) AND PV01_DIVISION_GROUP IN ( 'ISG CORE', 'ISG NON CORE' ) THEN 'OTHER ISG' ELSE 'NON ISG' END AS PV01_CATEGORY, CASE WHEN CURRENCY_OF_MEASURE = 'CNH' THEN 'CNY' WHEN CURRENCY_OF_MEASURE = 'KRX' THEN 'KRW' WHEN CURRENCY_OF_MEASURE IN ( 'BRX', 'BR1' ) THEN 'BRL' WHEN CURRENCY_OF_MEASURE IN ( 'RBX', 'RU1' ) THEN 'RUB' ELSE CURRENCY_OF_MEASURE END AS CURRENCY_OF_MEASURE, SUM(COALESCE(USD_FX, 0)) / 1000 AS FX, SUM ( CASE WHEN COB_DATE = '02/28/2018' THEN COALESCE(USD_FX, 0) END ) / 100 FX_COB FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND CCC_BUSINESS_AREA NOT IN ( 'COMMODS FINANCING', 'CREDIT' ) AND A.CCC_PRODUCT_LINE NOT IN ( 'COMMOD LEGACY NON-TRADING', 'COMMOD LENDING' ) AND CURRENCY_OF_MEASURE NOT IN ( 'UBD', 'USD', 'UB1' ) AND VAR_EXCL_FL <> 'Y' AND BU_RISK_SYSTEM <> 'PIPELINE_NY' AND BU_RISK_RUN_CUSTOM1 <> 'STORAGE' AND CCC_DIVISION NOT IN ( 'FIC DVA', 'FID DVA' ) GROUP BY COB_DATE, DIVISION_GROUP, G10_GROUP, CASE WHEN A.EM_GROUP IN ( 'Other', 'EM ex CNY, CNH' ) THEN 'EM ex CNY, CNH' ELSE A.EM_GROUP END, PV01_CATEGORY, CASE WHEN CURRENCY_OF_MEASURE = 'CNH' THEN 'CNY' WHEN CURRENCY_OF_MEASURE = 'KRX' THEN 'KRW' WHEN CURRENCY_OF_MEASURE IN ( 'BRX', 'BR1' ) THEN 'BRL' WHEN CURRENCY_OF_MEASURE IN ( 'RBX', 'RU1' ) THEN 'RUB' ELSE CURRENCY_OF_MEASURE END ) A ) B ) C GROUP BY COB_DATE, DIVISION_GROUP, G10_GROUP, EM_GROUP, PV01_CATEGORY, HARD_CURRENCY, LOCAL_CURRENCY