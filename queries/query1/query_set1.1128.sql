SELECT B.COB_DATE,B.CVA_Type_Flag,B.LEFT_TENOR as TERM_OF_MEASURE_GROUP, B.USD_PV01SPRD*B.LEFT_TENOR_WEIGHT as USD_PV01SPRD FROM  (SELECT a.COB_DATE, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN '1YR' WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN '1YR' WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN '5YR' WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN '10YR' WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN '30YR' ELSE '50YR' END AS LEFT_TENOR, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN '1YR' WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN '5YR' WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN '10YR' WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN '30YR' WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN '50YR' ELSE '50YR' END AS RIGHT_TENOR, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN 0 WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN (5 - a.TERM_OF_MEASURE/365)/(5-1) WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN (10 - a.TERM_OF_MEASURE/365)/(10-5) WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN (30 - a.TERM_OF_MEASURE/365)/(30-10) WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN (50 - a.TERM_OF_MEASURE/365)/(50-30) ELSE 1 END AS LEFT_TENOR_WEIGHT, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN 1 WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN (a.TERM_OF_MEASURE/365-1)/(5-1) WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN (a.TERM_OF_MEASURE/365-5)/(10-5) WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN  (a.TERM_OF_MEASURE/365-10)/(30-10) WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN  (a.TERM_OF_MEASURE/365-30)/(50-30) ELSE 0 END AS RIGHT_TENOR_WEIGHT, CASE WHEN COALESCE(a.CURVE_TYPE,'') = 'CPCRMNE' THEN 'MS CDS' WHEN COALESCE(a.CURVE_TYPE,'') = 'MS_SECCPM' THEN 'MS Bond' WHEN COALESCE(a.CURVE_TYPE,'') IN ('CPCRFUND', 'CPCR_MPEFUND') THEN 'Dealer Bond' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('MPE', 'MPE_CVA', 'MNE', 'MNE_CVA', 'MNE_CP', 'MPE_PROXY', 'MPE_FVA', 'MPE_FVA_RAW', 'MNE_FVA_NET', 'MNE_FVA') THEN 'MPE CVA' WHEN a.PRODUCT_TYPE_CODE IN ('CDSOPTIDX', 'CRDBSKT', 'CRDINDEX', 'LOANINDEX', 'MUNICDX') THEN 'INDEX' ELSE 'SN' END AS CVA_Type_Flag, Sum(usd_pv01sprd) AS USD_PV01SPRD FROM cdwuser.U_CR_MSR a WHERE (a.COB_DATE in ('2/28/2018', '2/27/2018', '1/31/2018', '12/29/2017', '12/29/2017', '9/29/2017', '6/30/2017', '3/31/2017', '12/30/2016', '9/30/2016')) and     (a.CCC_BUSINESS_AREA IN ('CPM TRADING (MPE)', 'CPM', 'CREDIT','MS CVA MNE - FID', 'MS CVA MNE - COMMOD') OR      a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING')) AND     COALESCE (a.CURVE_TYPE,               '') <> 'CPCR_CLEAR' AND      a.usd_pv01sprd IS NOT NULL      GROUP BY a.COB_DATE,LEFT_TENOR,RIGHT_TENOR,LEFT_TENOR_WEIGHT,RIGHT_TENOR_WEIGHT,CVA_Type_Flag) AS B  UNION   SELECT B.COB_DATE,B.CVA_Type_Flag,B.RIGHT_TENOR as TERM_OF_MEASURE_GROUP, B.USD_PV01SPRD*B.RIGHT_TENOR_WEIGHT as USD_PV01SPRD FROM  (SELECT a.COB_DATE, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN '1YR' WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN '1YR' WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN '5YR' WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN '10YR' WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN '30YR' ELSE '50YR' END AS LEFT_TENOR, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN '1YR' WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN '5YR' WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN '10YR' WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN '30YR' WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN '50YR' ELSE '50YR' END AS RIGHT_TENOR, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN 0 WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN (5 - a.TERM_OF_MEASURE/365)/(5-1) WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN (10 - a.TERM_OF_MEASURE/365)/(10-5) WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN (30 - a.TERM_OF_MEASURE/365)/(30-10) WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN (50 - a.TERM_OF_MEASURE/365)/(50-30) ELSE 1 END AS LEFT_TENOR_WEIGHT, CASE WHEN a.TERM_OF_MEASURE/365<=1 THEN 1 WHEN a.TERM_OF_MEASURE/365> 1 and a.TERM_OF_MEASURE/365 <=5 THEN (a.TERM_OF_MEASURE/365-1)/(5-1) WHEN a.TERM_OF_MEASURE/365> 5 and a.TERM_OF_MEASURE/365 <=10 THEN (a.TERM_OF_MEASURE/365-5)/(10-5) WHEN a.TERM_OF_MEASURE/365> 10 and a.TERM_OF_MEASURE/365 <=30 THEN  (a.TERM_OF_MEASURE/365-10)/(30-10) WHEN a.TERM_OF_MEASURE/365> 30 and a.TERM_OF_MEASURE/365 <=50 THEN  (a.TERM_OF_MEASURE/365-30)/(50-30) ELSE 0 END AS RIGHT_TENOR_WEIGHT, CASE WHEN COALESCE(a.CURVE_TYPE,'') = 'CPCRMNE' THEN 'MS CDS' WHEN COALESCE(a.CURVE_TYPE,'') = 'MS_SECCPM' THEN 'MS Bond' WHEN COALESCE(a.CURVE_TYPE,'') IN ('CPCRFUND', 'CPCR_MPEFUND') THEN 'Dealer Bond' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('MPE', 'MPE_CVA', 'MNE', 'MNE_CVA', 'MNE_CP', 'MPE_PROXY', 'MPE_FVA', 'MPE_FVA_RAW', 'MNE_FVA_NET', 'MNE_FVA') THEN 'MPE CVA' WHEN a.PRODUCT_TYPE_CODE IN ('CDSOPTIDX', 'CRDBSKT', 'CRDINDEX', 'LOANINDEX', 'MUNICDX') THEN 'INDEX' ELSE 'SN' END AS CVA_Type_Flag, Sum(usd_pv01sprd) AS USD_PV01SPRD FROM cdwuser.U_CR_MSR a WHERE (a.COB_DATE in ('2/28/2018', '2/27/2018', '1/31/2018', '12/29/2017', '12/29/2017', '9/29/2017', '6/30/2017', '3/31/2017', '12/30/2016', '9/30/2016')) and     (a.CCC_BUSINESS_AREA IN ('CPM TRADING (MPE)', 'CPM', 'CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') OR      a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING')) AND     COALESCE (a.CURVE_TYPE,               '') <> 'CPCR_CLEAR' AND      a.usd_pv01sprd IS NOT NULL      GROUP BY a.COB_DATE,LEFT_TENOR,RIGHT_TENOR,LEFT_TENOR_WEIGHT,RIGHT_TENOR_WEIGHT,CVA_Type_Flag) AS B