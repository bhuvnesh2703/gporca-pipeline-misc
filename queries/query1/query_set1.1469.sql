select pl_reporting_region as pnl_region, business_area, Commissions, ytd_pnl as max_ytd_pnl, cob_date as date_of_max from ( select cob_date,pl_reporting_region,business_area,Commissions,ytd_pnl,row_number() over(partition by pl_reporting_region,business_area,Commissions order by ytd_pnl desc , cob_date desc) highest from 	( 	select 			cob_date, 			case when pl_reporting_region is null and business_area is null then 'TOTAL' else pl_reporting_region end pl_reporting_region, 			case when pl_reporting_region is null then ' ' when business_area is null then 'TOTAL' ||' '|| PL_REPORTING_REGION else business_area end business_area, 			Commissions, 			ytd_pnl 	from 			( 				 SELECT 						q.cob_date, 						q.ccc_pl_reporting_region as pl_reporting_region, 						q.ccc_business_area as business_area, 						case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end as Commissions, 						round(sum(q.ytd_pl),2)/1000000 as ytd_pnl 				 FROM 	cdwuser.u_pct_pnl_current q 				WHERE 	q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' AND NOT q.COB_DATE = '2017-01-03' 				 AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) 				GROUP BY GROUPING SETS((q.cob_date,q.ccc_pl_reporting_region,q.ccc_business_area,Commissions), (q.cob_date,q.ccc_pl_reporting_region,Commissions),(q.cob_date,Commissions)) 			) as temp_1 	 	UNION ALL 	 	select 			cob_date, 			case when pl_reporting_region is null then 'TOTAL excl. CVA, DVA, TCM' else pl_reporting_region end pl_reporting_region, 			case when pl_reporting_region is null then ' ' else 'TOTAL' ||' '|| PL_REPORTING_REGION ||' excl. CVA, DVA, TCM' end business_area, 			Commissions, 			ytd_pnl 	from 			( 				 SELECT 						q.cob_date, 						q.ccc_pl_reporting_region as pl_reporting_region, 						case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end as Commissions, 						round(sum(q.ytd_pl),2)/1000000 as ytd_pnl 				 FROM 	cdwuser.u_pct_pnl_current q 				WHERE 	q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' AND NOT q.COB_DATE = '2017-01-03' 				 AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) 				 AND q.ccc_strategy NOT IN ('MS CVA MPE - DERIVATIVES','MS CVA MNE - DERIVATIVES','MS DVA STR NOTES IED','TCM ALLOCATION IED','TCM ALLOCATION OFFSET','PB - TCM ALLOCATION','OTHER - TCM ALLOCATION','DERIVS - TCM ALLOCATION','CASH - TCM ALLOCATION','IWM - TCM ALLOCATION') 				GROUP BY GROUPING SETS((q.cob_date,q.ccc_pl_reporting_region,Commissions), (q.cob_date,Commissions)) 			) as temp_1 	) as temp_2 ) as temp where highest = 1 order by 4,2,3