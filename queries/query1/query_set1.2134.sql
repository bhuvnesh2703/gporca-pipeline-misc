SELECT a.COB_DATE, a.LE, a.CPTY, case when c.RANK_busi <= 10 then a.CCC_BUSINESS_AREA else 'OTHERS' end as CCC_BUSINESS_AREA, a.ctpy_netting_group_code, a.USD_PV01SPRD, b.RANK_cpty, c.RANK_busi FROM ( select a.COB_DATE , a.PARENT_LEGAL_ENTITY AS LE , case when a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. INTERNATIONAL PLC' and a.ctpy_netting_group_code <> '817559' then 'MSIP - not include' when a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC' and a.ctpy_netting_group_code <> '2351686' then 'MSCo - not include' when a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY BANK, N.A.' and a.ctpy_netting_group_code <> '1973288' then 'MSBNA - not include' when a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY CAPITAL GROUP INC.' and a.ctpy_netting_group_code <> '1856785' then 'MSCG - not include' else a.POSITION_CREDIT_PARTY_DARWIN_NAME end as CPTY , a.POSITION_CREDIT_PARTY_DARWIN_NAME , a.CCC_BUSINESS_AREA , ctpy_netting_group_code , sum(a.USD_PV01SPRD) as USD_PV01SPRD from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') and not (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') AND a.USD_PV01SPRD IS NOT NULL group by a.COB_DATE , a.PARENT_LEGAL_ENTITY , a.POSITION_CREDIT_PARTY_DARWIN_NAME , a.CCC_BUSINESS_AREA , ctpy_netting_group_code ) a left join ( select a.POSITION_CREDIT_PARTY_DARWIN_NAME , sum(a.USD_PV01SPRD) as USD_PV01SPRD , rank() over(ORDER BY abs(sum(coalesce(a.USD_PV01SPRD,0))) desc ) AS RANK_cpty from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') and not (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') AND a.USD_PV01SPRD IS NOT NULL group by a.POSITION_CREDIT_PARTY_DARWIN_NAME ) b on b.POSITION_CREDIT_PARTY_DARWIN_NAME = a.POSITION_CREDIT_PARTY_DARWIN_NAME left join ( select a.CCC_BUSINESS_AREA , sum(a.USD_PV01SPRD) as USD_PV01SPRD , rank() over(ORDER BY abs(sum(coalesce(a.USD_PV01SPRD,0))) desc ) AS RANK_busi from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') and not (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') AND a.USD_PV01SPRD IS NOT NULL group by a.CCC_BUSINESS_AREA ) c on c.CCC_BUSINESS_AREA = a.CCC_BUSINESS_AREA UNION ALL SELECT a.COB_DATE , a.PARENT_LEGAL_ENTITY AS LE , case when (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') then 'MSCO clear through CME' ELSE a.POSITION_CREDIT_PARTY_DARWIN_NAME END AS CPTY , a.CCC_BUSINESS_AREA , ctpy_netting_group_code , sum(a.USD_PV01SPRD) as USD_PV01SPRD , 0 as RANK_cpty , 0 as RANK_busi FROM OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND a.PARENT_LEGAL_ENTITY in ('0111') and (a.position_ultimate_credit_party_darwin_name not in ('MORGAN STANLEY') or (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC')) GROUP BY a.COB_DATE , a.PARENT_LEGAL_ENTITY , a.POSITION_CREDIT_PARTY_DARWIN_NAME , a.CCC_BUSINESS_AREA , ctpy_netting_group_code