WITH     fid_fx_kappa_flat AS     (         SELECT         a.COB_DATE,         a.USD_FX_KAPPA,         CASE              WHEN a.CURVE_CURRENCY_PAIR IN ('USDEUR', 'USDJPY', 'EURJPY', 'UBDBRL') THEN a.CURVE_CURRENCY_PAIR               WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) IN ('USD', 'EUR', 'JPY') THEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) || SUBSTR (CURVE_CURRENCY_PAIR,1,3)               WHEN SUBSTR (a.CURVE_CURRENCY_PAIR, 1,3) = a.CURVE_CURRENCY_PAIR THEN 'USD' || a.CURVE_CURRENCY_PAIR               WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) IN ('USD', 'EUR', 'JPY') THEN a.CURVE_CURRENCY_PAIR         ELSE a.CURVE_CURRENCY_PAIR END AS fx_ccy         FROM             cdwuser.U_FX_MSR a         WHERE       CCC_BANKING_TRADING IN ('TRADING') AND /*        (a.PRODUCT_TYPE_CODE IN ('BONDFUT', 'BONDFUTOPT') OR (a.VAR_EXCL_FL <> 'Y' AND a.MEASURE_VAR_EXCL_FL <> 'Y'))        AND*/ (a.COB_DATE = '2018-02-28' or a.COB_DATE = '2018-02-27') and A.CCC_TAPS_COMPANY in ('0362','0816') AND              a.CCC_DIVISION IN ('FIXED INCOME DIVISION') AND a.vertical_system LIKE ('FXOPT%') AND     /*a.CCC_BUSINESS_AREA NOT IN ('COMMODITIES') AND*/         a.USD_FX_KAPPA <> 0     )     ,     fid_fx_kappa_grid AS     (         SELECT         a.COB_DATE,         a.GRID_MEASURE_VALUE AS USD_FX_KAPPA,         CASE             WHEN a.CURVE_CURRENCY_PAIR IN ('USDEUR', 'USDJPY', 'EURJPY', 'UBDBRL') THEN a.CURVE_CURRENCY_PAIR              WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) IN ('USD', 'EUR', 'JPY') THEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) || SUBSTR (CURVE_CURRENCY_PAIR,1,3)             WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) = a.CURVE_CURRENCY_PAIR THEN 'USD' || a.CURVE_CURRENCY_PAIR             WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) IN ('USD', 'EUR', 'JPY') THEN a.CURVE_CURRENCY_PAIR         ELSE a.CURVE_CURRENCY_PAIR END AS fx_ccy         FROM             dwuser.U_GRID_MSR a         WHERE       CCC_BANKING_TRADING IN ('TRADING') AND /*        (a.PRODUCT_TYPE_CODE IN ('BONDFUT', 'BONDFUTOPT') OR         (a.VAR_EXCL_FL <> 'Y' AND a.MEASURE_VAR_EXCL_FL <> 'Y')) AND*/ (a.COB_DATE = '2018-02-28' or a.COB_DATE = '2018-02-27') and A.CCC_TAPS_COMPANY in ('0362','0816') AND              a.CCC_DIVISION IN ('FIXED INCOME DIVISION') AND     /*a.CCC_BUSINESS_AREA NOT IN ('COMMODITIES') AND*/         a.GRID_MEASURE_NAME IN ('USD_FX_KAPPA') AND         a.GRID_MEASURE_VALUE <> 0     ) SELECT     b.COB_DATE,     b.fx_ccy,     SUM (b.USD_FX_KAPPA) AS USD_FX_KAPPA FROM     fid_fx_kappa_flat b GROUP BY     b.COB_DATE,     b.fx_ccy UNION ALL SELECT     c.COB_DATE,     c.fx_ccy,     SUM (c.USD_FX_KAPPA) AS USD_FX_KAPPA FROM     fid_fx_kappa_grid c GROUP BY     c.COB_DATE,     c.fx_ccy