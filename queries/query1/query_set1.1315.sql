with x as (select cob_date, i.MEASURE_CURRENCY_CCY1 as currency, case when i.TERM_OF_MEASURE / 365 >= 0 and i.TERM_OF_MEASURE / 365 < 1 then '0-1' when i.TERM_OF_MEASURE / 365 >= 1 and i.TERM_OF_MEASURE / 365 < 3 then '1-3' when i.TERM_OF_MEASURE / 365 >= 3 and i.TERM_OF_MEASURE / 365 <5 then '3-5' when i.TERM_OF_MEASURE / 365 >= 5 and i.TERM_OF_MEASURE / 365 <10 then '5-10' when i.TERM_OF_MEASURE / 365 >= 10 then '10+' else 'N/A' end as Term_Bucket, sum(coalesce(i.USD_IR_UNIFIED_PV01,0)) as PV01 from cdwuser.U_IR_MSR_INTRPLT i where i.COB_DATE in ('2018-02-28', '2018-01-31') and i.DIVISION = 'IED' and i.CCC_BANKING_TRADING = 'TRADING' and i.CCC_PL_REPORTING_REGION = 'EMEA' group by cob_date, MEASURE_CURRENCY_CCY1, case when i.TERM_OF_MEASURE / 365 >= 0 and i.TERM_OF_MEASURE / 365 < 1 then '0-1' when i.TERM_OF_MEASURE / 365 >= 1 and i.TERM_OF_MEASURE / 365 < 3 then '1-3' when i.TERM_OF_MEASURE / 365 >= 3 and i.TERM_OF_MEASURE / 365 <5 then '3-5' when i.TERM_OF_MEASURE / 365 >= 5 and i.TERM_OF_MEASURE / 365 <10 then '5-10' when i.TERM_OF_MEASURE / 365 >= 10 then '10+' else 'N/A' end) , y as(select Rank() over (order by abs(sum(case when cob_date = '2018-02-28' then PV01 else 0 end)) desc)||'_'||'TopCCY' as Concentration, currency, sum(case when cob_date = '2018-02-28' then PV01 else 0 end) as PV01_COB, sum(case when cob_date = '2018-02-28' then PV01 else -PV01 end) as PV01_DOD from x group by currency fetch first 10 rows only) , term1 as(select currency, sum(case when cob_date ='2018-02-28' then PV01 else 0 end) as PV01_BUCKET from x where term_bucket = '0-1' group by currency) , term2 as(select currency, sum(case when cob_date ='2018-02-28' then PV01 else 0 end) as PV01_BUCKET from x where term_bucket = '1-3' group by currency) , term3 as(select currency, sum(case when cob_date ='2018-02-28' then PV01 else 0 end) as PV01_BUCKET from x where term_bucket = '3-5' group by currency) , term4 as( select currency, sum(case when cob_date ='2018-02-28' then PV01 else 0 end) as PV01_BUCKET from x where term_bucket = '5-10' group by currency) , term5 as(select currency, sum(case when cob_date ='2018-02-28' then PV01 else 0 end) as PV01_BUCKET from x where term_bucket = '10+' group by currency) , term6 as( select currency, sum(case when cob_date ='2018-02-28' then PV01 else 0 end) as PV01_BUCKET from x where term_bucket = 'N/A' group by currency) select y.Concentration, y.currency, y.PV01_COB, y.PV01_DOD, a.PV01_BUCKET as NO , b.PV01_BUCKET as One, c.PV01_BUCKET as Three, d.PV01_BUCKET as Five, e.PV01_BUCKET as Ten, f.PV01_BUCKET as Plus from y left outer join term6 a on y.currency = a.currency left outer join term1 b on y.currency = b.currency left outer join term2 c on y.currency = c.currency left outer join term3 d on y.currency = d.currency left outer join term4 e on y.currency = e.currency left outer join term5 f on y.currency = f.currency order by abs(PV01_COB) desc