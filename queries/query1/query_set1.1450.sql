WITH IED AS ( SELECT COB_DATE, PROCESS_ID ,POSITION_ID ,sum(D30RAW) AS D30RAW ,sum(D20RAW) AS D20RAW ,sum(D10RAW) AS D10RAW ,sum(D5RAW) AS D5RAW ,sum(D1RAW) AS D1RAW ,sum(P1RAW) AS P1RAW ,sum(P5RAW) AS P5RAW ,sum(P10RAW) AS P10RAW ,sum(P20RAW) AS P20RAW ,sum(P30RAW) AS P30RAW FROM ( SELECT e.COB_DATE, PROCESS_ID ,POSITION_ID ,sum(e.SLIDE_EQ_MIN_30_USD) AS D30RAW ,sum(e.SLIDE_EQ_MIN_20_USD) AS D20RAW ,sum(e.SLIDE_EQ_MIN_10_USD) AS D10RAW ,sum(e.SLIDE_EQ_MIN_05_USD) AS D5RAW ,sum(e.SLIDE_EQ_MIN_1_USD) AS D1RAW ,sum(e.SLIDE_EQ_PLS_1_USD) AS P1RAW ,sum(e.SLIDE_EQ_PLS_05_USD) AS P5RAW ,sum(e.SLIDE_EQ_PLS_10_USD) AS P10RAW ,sum(e.SLIDE_EQ_PLS_20_USD) AS P20RAW ,sum(e.SLIDE_EQ_PLS_30_USD) AS P30RAW FROM cdwuser.U_EQ_MSR e WHERE e.COB_DATE ='2018-02-28' AND e.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND e.CCC_BANKING_TRADING <> 'BANKING' AND e.CCC_HIERARCHY_LEVEL10 = 'ETP MAIN' AND e.CASH_ISSUE_TYPE NOT IN ('CMDT','FX') AND SILO_SRC = 'IED' GROUP BY e.PROCESS_ID ,POSITION_ID, e.COB_DATE ) a GROUP BY PROCESS_ID ,POSITION_ID, COB_DATE ) ,CountryWeights AS ( SELECT d.COB_DATE ,PROCESS_ID ,POSITION_ID ,CASE WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'OMX STOCKHOLM 30 INDEX' THEN 'SWE' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'DAX INDEX' THEN 'DEU' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'S&P 500 INDEX' THEN 'USA' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'NASDAQ 100 INDEX' THEN 'USA' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'NIKKEI 225 INDEX' THEN 'JPN' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'HANG SENG CHINA ENTERPRISES INDEX' THEN 'HKG' ELSE ISSUER_COUNTRY_CODE_DECOMP END AS COUNTRY ,abs(sum(PRODUCT_WEIGHT_DECOMP)) AS WEIGHT FROM cdwuser.U_DECOMP_MSR d WHERE d.COB_DATE ='2018-02-28' AND d.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND d.CCC_BANKING_TRADING <> 'BANKING' AND d.CCC_HIERARCHY_LEVEL10 = 'ETP MAIN' AND d.CASH_ISSUE_TYPE NOT IN ('CMDT','FX') AND SILO_SRC = 'IED' GROUP BY d.COB_DATE ,PROCESS_ID ,POSITION_ID ,CASE WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'OMX STOCKHOLM 30 INDEX' THEN 'SWE' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'DAX INDEX' THEN 'DEU' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'S&P 500 INDEX' THEN 'USA' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'NASDAQ 100 INDEX' THEN 'USA' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'NIKKEI 225 INDEX' THEN 'JPN' WHEN UNDERLIER_PRODUCT_DESCRIPTION = 'HANG SENG CHINA ENTERPRISES INDEX' THEN 'HKG' ELSE ISSUER_COUNTRY_CODE_DECOMP END ,ISSUER_COUNTRY_CODE_DECOMP HAVING sum(PRODUCT_WEIGHT_DECOMP) <> 0 ) ,GrossWeights AS ( SELECT x.COB_DATE ,PROCESS_ID ,POSITION_ID ,sum(abs(WEIGHT)) AS GROSS_WEIGHT FROM CountryWeights x GROUP BY x.COB_DATE ,PROCESS_ID ,POSITION_ID ) ,Decomp AS ( SELECT w.COB_DATE ,w.Process_ID ,w.Position_id ,COUNTRY ,abs(WEIGHT / GROSS_WEIGHT) AS WEIGHT FROM CountryWeights w INNER JOIN GrossWeights g ON ( w.cob_date = g.cob_date AND w.process_id = g.process_id AND w.position_id = g.position_id ) ) SELECT COUNTRY ,D30RAW ,D20RAW ,D10RAW ,D5RAW ,D1RAW ,P1RAW ,P5RAW ,P10RAW ,P20RAW ,P30RAW ,RANK() OVER(ORDER BY SLIDES_MIN ASC) AS RANK FROM ( SELECT COUNTRY ,sum(D30RAW) AS D30RAW ,sum(D20RAW) AS D20RAW ,sum(D10RAW) AS D10RAW ,sum(D5RAW) AS D5RAW ,sum(D1RAW) AS D1RAW ,sum(P1RAW) AS P1RAW ,sum(P5RAW) AS P5RAW ,sum(P10RAW) AS P10RAW ,sum(P20RAW) AS P20RAW ,sum(P30RAW) AS P30RAW ,LEAST(sum(D30RAW),sum(D20RAW),sum(D10RAW), sum(D5RAW), sum(P5RAW), sum(P10RAW), sum(P20RAW),sum(P30RAW)) as SLIDES_MIN FROM ( SELECT 'Decomp' AS VIEW, i.COB_DATE ,COUNTRY ,(D30RAW * WEIGHT) AS D30RAW ,(D20RAW * WEIGHT) AS D20RAW ,(D10RAW * WEIGHT) AS D10RAW ,(D5RAW * WEIGHT) AS D5RAW ,(D1RAW * WEIGHT) AS D1RAW ,(P1RAW * WEIGHT) AS P1RAW ,(P5RAW * WEIGHT) AS P5RAW ,(P10RAW * WEIGHT) AS P10RAW ,(P20RAW * WEIGHT) AS P20RAW ,(P30RAW * WEIGHT) AS P30RAW FROM IED i INNER JOIN Decomp d ON ( i.PROCESS_ID = d.PROCESS_ID AND i.POSITION_ID = d.POSITION_ID and i.COB_DATE = d.COB_DATE ) ) a GROUP BY COUNTRY ) a