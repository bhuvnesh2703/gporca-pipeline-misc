WITH FX_Table as ( SELECT a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA, CASE WHEN a.currency_of_measure ='CNH' THEN 'CNY' WHEN a.currency_of_measure IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.currency_of_measure ='KRX' THEN 'KRW' WHEN a.currency_of_measure in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.currency_of_measure END AS currency_of_measure, SUM (CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END)::numeric(30,10) AS FX_DELTA FROM CDWUSER.U_EXP_MSR a WHERE a.COB_DATE = '02/28/2018' AND a.PARENT_LEGAL_ENTITY IN ('0201(G)', '0111', '0105(G)', '5745', '0146', '0302(G)', '1633') AND a.currency_of_measure <> 'UNDEFINED' GROUP BY a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA, CASE WHEN a.currency_of_measure ='CNH' THEN 'CNY' WHEN a.currency_of_measure IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.currency_of_measure ='KRX' THEN 'KRW' WHEN a.currency_of_measure in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.currency_of_measure END HAVING SUM (a.USD_FX) >= 50000 OR SUM (a.USD_FX) <= -50000 ) SELECT B.currency_of_measure, B.CCC_BUSINESS_AREA, C.PARENT_LEGAL_ENTITY, C.FX_DELTA FROM( SELECT A.currency_of_measure, A.CCC_BUSINESS_AREA, SUM(A.FX_DELTA) AS FX_DELTA_NET_BUSI, SUM(ABS(A.FX_DELTA)) AS FX_DELTA_GROSS_BUSI, rank() over(order by abs(SUM(A.FX_DELTA) )/SUM(ABS(A.FX_DELTA)) asc) as rank FROM FX_TABLE A WHERE A.FX_DELTA <> 0 and A.currency_of_measure IN ( select distinct d.currency_of_measure from ( select distinct e.currency_of_measure from( SELECT f.currency_of_measure, SUM(f.FX_DELTA) AS FX_DELTA_NET_LE, sum(abs(f.fx_delta)) as fx_delta_gross_le FROM fx_table f GROUP BY f.currency_of_measure ) e where abs(e.fx_delta_net_le) <= 0.7* e.fx_delta_gross_le union select distinct g.currency_of_measure from( SELECT h.currency_of_measure, h.PARENT_LEGAL_ENTITY, SUM(h.FX_DELTA) AS FX_DELTA from fx_table h group by h.currency_of_measure, h.PARENT_LEGAL_ENTITY having abs(sum(h.fx_delta)) >= 100000 ) g ) d ) group by A.currency_of_measure, a.ccc_business_area ) b left join fx_table c on b.currency_of_measure = c.currency_of_measure and b.ccc_business_area = c.ccc_business_area where (abs(b.FX_DELTA_NET_busi) <= 0.25*b.fx_delta_gross_busi OR (b.rank <=10 and abs(b.FX_DELTA_NET_BUSI) <> b.FX_DELTA_GROSS_BUSI)) and b.currency_of_measure <> 'USD'