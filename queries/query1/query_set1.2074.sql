WITH TOP_EXP AS ( SELECT DISTINCT COUNTRY_CODE FROM ( SELECT X.*, RANK() OVER (PARTITION BY COB_DATE ORDER BY ABS(TOTAL) DESC) AS RANK FROM ( SELECT A.COB_DATE, A.COUNTRY_CODE, SUM(A.USD_IR_UNIFIED_PV01) AS TOTAL FROM CDWUSER.U_EXP_MSR A WHERE COB_DATE = '2018-02-28' AND PARENT_LEGAL_ENTITY = '0302(G)' AND CCC_DIVISION = 'FIXED INCOME DIVISION' AND VAR_EXCL_FL <> 'Y' AND BASEL_III_GROUP_BTI = 'TRADING' AND CCC_BUSINESS_AREA = 'LIQUID FLOW RATES' AND USD_IR_UNIFIED_PV01 IS NOT NULL GROUP BY A.COB_DATE, A.COUNTRY_CODE ) X ) Y WHERE RANK <=5 ) SELECT COB_DATE, CASE WHEN LEVEL = 'UNDEFINED' THEN 'RATEFUT & SWAPS' WHEN LEVEL = 'XS' THEN 'AGN' ELSE COALESCE(LEVEL,'Total') END AS LEVEL, CASE WHEN LEVEL = 'Others' THEN 2 ELSE 1 END AS RANK, TOTAL FROM ( SELECT A.COB_DATE, CASE WHEN A.COUNTRY_CODE = B.COUNTRY_CODE THEN A.COUNTRY_CODE ELSE 'Others' END AS LEVEL, SUM(A.USD_IR_UNIFIED_PV01) AS TOTAL FROM CDWUSER.U_EXP_MSR A LEFT JOIN TOP_EXP B ON A.COUNTRY_CODE = B.COUNTRY_CODE WHERE COB_DATE BETWEEN '2018-01-31' AND '2018-02-28' AND PARENT_LEGAL_ENTITY = '0302(G)' AND CCC_DIVISION = 'FIXED INCOME DIVISION' AND VAR_EXCL_FL <> 'Y' AND BASEL_III_GROUP_BTI = 'TRADING' AND CCC_BUSINESS_AREA = 'LIQUID FLOW RATES' GROUP BY A.COB_DATE, LEVEL ) Z