WITH FX_SLIDES AS ( SELECT a.CURRENCY_PAIR, a.CURRENCY_OF_MEASURE, a.CURRENCY_OF_RISK_CCY1, SUM(SLIDE_FXOPT_MIN_01PCT_USD) AS SLIDE_FXOPT_MIN_01PCT_USD, SUM(SLIDE_FXOPT_MIN_05PCT_USD) AS SLIDE_FXOPT_MIN_05PCT_USD, SUM(SLIDE_FXOPT_MIN_10PCT_USD) AS SLIDE_FXOPT_MIN_10PCT_USD, SUM(SLIDE_FXOPT_MIN_20PCT_USD) AS SLIDE_FXOPT_MIN_20PCT_USD, SUM(SLIDE_FXOPT_MIN_30PCT_USD) AS SLIDE_FXOPT_MIN_30PCT_USD, SUM(SLIDE_FXOPT_PLS_01PCT_USD) AS SLIDE_FXOPT_PLS_01PCT_USD, SUM(SLIDE_FXOPT_PLS_05PCT_USD) AS SLIDE_FXOPT_PLS_05PCT_USD, SUM(SLIDE_FXOPT_PLS_10PCT_USD) AS SLIDE_FXOPT_PLS_10PCT_USD, SUM(SLIDE_FXOPT_PLS_20PCT_USD) AS SLIDE_FXOPT_PLS_20PCT_USD, SUM(SLIDE_FXOPT_PLS_30PCT_USD) AS SLIDE_FXOPT_PLS_30PCT_USD, LEAST(SUM(SLIDE_FXOPT_MIN_05PCT_USD),SUM(SLIDE_FXOPT_MIN_10PCT_USD),SUM(SLIDE_FXOPT_MIN_20PCT_USD),SUM(SLIDE_FXOPT_MIN_30PCT_USD), SUM(SLIDE_FXOPT_PLS_05PCT_USD),SUM(SLIDE_FXOPT_PLS_10PCT_USD),SUM(SLIDE_FXOPT_PLS_20PCT_USD),SUM(SLIDE_FXOPT_PLS_30PCT_USD)) AS SLIDES_MIN FROM ( SELECT a.CURRENCY_PAIR, CASE WHEN LENGTH(a.CURRENCY_OF_MEASURE) > 3 THEN a.CURRENCY_OF_RISK_CCY1 ELSE a.CURRENCY_OF_MEASURE END AS CURRENCY_OF_MEASURE, a.CURRENCY_OF_RISK_CCY1, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_MIN_01PCT_USD,0)) END AS SLIDE_FXOPT_MIN_01PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_MIN_05PCT_USD,0)) END AS SLIDE_FXOPT_MIN_05PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_MIN_10PCT_USD,0)) END AS SLIDE_FXOPT_MIN_10PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_MIN_20PCT_USD,0)) END AS SLIDE_FXOPT_MIN_20PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_MIN_30PCT_USD,0)) END AS SLIDE_FXOPT_MIN_30PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_PLS_01PCT_USD,0)) END AS SLIDE_FXOPT_PLS_01PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_PLS_05PCT_USD,0)) END AS SLIDE_FXOPT_PLS_05PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_PLS_10PCT_USD,0)) END AS SLIDE_FXOPT_PLS_10PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_PLS_20PCT_USD,0)) END AS SLIDE_FXOPT_PLS_20PCT_USD, CASE WHEN a.CURRENCY_OF_MEASURE = a.CURRENCY_PAIR THEN SUM (COALESCE (a.SLIDE_FXOPT_PLS_30PCT_USD,0)) END AS SLIDE_FXOPT_PLS_30PCT_USD FROM CDWUSER.U_FX_MSR a WHERE a.COB_DATE ='2018-02-28' AND a.CCC_HIERARCHY_LEVEL10 = 'ETP MAIN' AND a.PRODUCT_TYPE_CODE = 'FXOPT' AND a.CURRENCY_OF_RISK_CCY1 <> 'UNDEFINED' AND ABS(coalesce(a.SLIDE_FXOPT_MIN_01PCT_USD,0)) > 0.1 GROUP BY a.CURRENCY_PAIR, CASE WHEN LENGTH(a.CURRENCY_OF_MEASURE) > 3 THEN a.CURRENCY_OF_RISK_CCY1 ELSE a.CURRENCY_OF_MEASURE END, a.CURRENCY_OF_MEASURE, a.CURRENCY_OF_RISK_CCY1 UNION ALL SELECT a.CURRENCY_PAIR, a.CURRENCY_OF_MEASURE, a.CURRENCY_OF_RISK_CCY1, SUM (COALESCE (a.USD_FX_Delta*(-0.01),0)) AS SLIDE_FXOPT_MIN_01PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(-0.05),0)) AS SLIDE_FXOPT_MIN_05PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(-0.1),0)) AS SLIDE_FXOPT_MIN_10PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(-0.2),0)) AS SLIDE_FXOPT_MIN_20PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(-0.3),0)) AS SLIDE_FXOPT_MIN_30PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(0.01),0)) AS SLIDE_FXOPT_PLS_01PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(0.05),0)) AS SLIDE_FXOPT_PLS_05PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(0.1),0)) AS SLIDE_FXOPT_PLS_10PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(0.2),0)) AS SLIDE_FXOPT_PLS_20PCT_USD, SUM (COALESCE (a.USD_FX_Delta*(0.3),0)) AS SLIDE_FXOPT_PLS_30PCT_USD FROM CDWUSER.U_FX_MSR a WHERE a.COB_DATE ='2018-02-28' AND a.CCC_HIERARCHY_LEVEL10 = 'ETP MAIN' AND a.PRODUCT_TYPE_CODE <> 'FXOPT' GROUP BY a.CURRENCY_PAIR, a.CURRENCY_OF_MEASURE, a.CURRENCY_OF_RISK_CCY1 ) a GROUP BY a.CURRENCY_PAIR, a.CURRENCY_OF_MEASURE, a.CURRENCY_OF_RISK_CCY1 ) SELECT CURRENCY_PAIR, CURRENCY_OF_MEASURE, CURRENCY_OF_RISK_CCY1, SLIDE_FXOPT_MIN_01PCT_USD, SLIDE_FXOPT_MIN_05PCT_USD, SLIDE_FXOPT_MIN_10PCT_USD, SLIDE_FXOPT_MIN_20PCT_USD, SLIDE_FXOPT_MIN_30PCT_USD, SLIDE_FXOPT_PLS_01PCT_USD, SLIDE_FXOPT_PLS_05PCT_USD, SLIDE_FXOPT_PLS_10PCT_USD, SLIDE_FXOPT_PLS_20PCT_USD, SLIDE_FXOPT_PLS_30PCT_USD, RANK() OVER(ORDER BY SLIDES_MIN ASC) AS RANK FROM FX_SLIDES