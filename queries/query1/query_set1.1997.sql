WITH     fid_fx_kappa_flat AS     (         SELECT             a.COB_DATE,             a.USD_FX_KAPPA,             CASE                 WHEN a.CURVE_CURRENCY_PAIR IN ('USDEUR', 'USDJPY', 'EURJPY', 'UBDBRL') THEN a.CURVE_CURRENCY_PAIR                  WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) IN ('USD', 'EUR', 'JPY') THEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) || SUBSTR (CURVE_CURRENCY_PAIR,1,3)                 WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) = a.CURVE_CURRENCY_PAIR THEN 'USD' || a.CURVE_CURRENCY_PAIR                 WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) IN ('USD', 'EUR', 'JPY') THEN a.CURVE_CURRENCY_PAIR             ELSE a.CURVE_CURRENCY_PAIR END AS fx_ccy         FROM             cdwuser.U_FX_MSR a         WHERE             (a.VAR_EXCL_FL <> 'Y' AND a.MEASURE_VAR_EXCL_FL <> 'Y') AND (a.COB_DATE = '2018-02-28') and             (                 CCC_PL_REPORTING_REGION IN ('JAPAN')             OR                 BOOK IN ('FXJVILDDIC')             ) AND             a.CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION') AND              a.vertical_system LIKE ('FXOPT%') AND             a.CCC_BUSINESS_AREA NOT IN ('COMMODITIES') AND             a.USD_FX_KAPPA <> 0     ),     fid_fx_kappa_grid AS     (         SELECT             a.COB_DATE,             a.GRID_MEASURE_VALUE AS USD_FX_KAPPA,             CASE                 WHEN a.CURVE_CURRENCY_PAIR IN ('USDEUR', 'USDJPY', 'EURJPY', 'UBDBRL') THEN a.CURVE_CURRENCY_PAIR                  WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) IN ('USD', 'EUR', 'JPY') THEN SUBSTR (a.CURVE_CURRENCY_PAIR,4,3) || SUBSTR (CURVE_CURRENCY_PAIR,1,3)                 WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) = a.CURVE_CURRENCY_PAIR THEN 'USD' || a.CURVE_CURRENCY_PAIR                 WHEN SUBSTR (a.CURVE_CURRENCY_PAIR,1,3) IN ('USD', 'EUR', 'JPY') THEN a.CURVE_CURRENCY_PAIR             ELSE a.CURVE_CURRENCY_PAIR END AS fx_ccy         FROM             dwuser.U_GRID_MSR a         WHERE             (a.VAR_EXCL_FL <> 'Y' AND a.MEASURE_VAR_EXCL_FL <> 'Y') AND (a.COB_DATE = '2018-02-28') and             (                 CCC_PL_REPORTING_REGION IN ('JAPAN')             OR                 BOOK IN ('FXJVILDDIC')             ) AND             a.CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION') AND              a.CCC_BUSINESS_AREA NOT IN ('COMMODITIES') AND             a.GRID_MEASURE_NAME IN ('USD_FX_KAPPA') AND             a.GRID_MEASURE_VALUE <> 0     ),     fid_fx_kappa_all AS     (     SELECT *     FROM fid_fx_kappa_flat     UNION ALL     SELECT *     FROM fid_fx_kappa_grid     ) SELECT     COB_DATE,     FX_CCY,     SUM(USD_FX_KAPPA) AS USD_FX_KAPPA FROM     fid_fx_kappa_all WHERE     /*CURRENCY_PAIRS*/     FX_CCY IN ('EURUSD','USDEUR','USDJPY','JPYUSD','GBPUSD','USDGBP','AUDUSD','USDAUD',                       'EURJPY','JPYEUR','JPYAUD','AUDJPY','NZDJPY','JPYNZD','GBPJPY','JPYGBP','CADJPY','JPYCAD',                       'CHFJPY','JPYCHF','SEKJPY','JPYSEK','TRYJPY','JPYTRY','ZARJPY','JPYZAR') GROUP BY     COB_DATE,     FX_CCY