SELECT CASE WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('GIB','CGY','IMN','JEY','LUX','MCO','VIR','VGB','MLT','CYP') THEN 'Other Advanced' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('ALB','AND','BLR','BIH','HRV','EST','ISL','LVA','LIE','LTU','MKD','MDA','MNE','ROU','SMR','SRB','SVK','SVN') THEN 'Other Emerging Europe' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('ATG','BHS','BRB','BLZ','BMU','BOL','CYM','COL','CRI','CUB','DMA','DOM','ECU','SLV','GRD','GTM','GUY','HTI','HND','JAM','NIC','PAN', 'PRY','PER','KNA','LCA','VCT','SUR','TTO','URY','VEN') THEN 'Other Latam' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('BGD','BTN','BRN','KHM','KAZ','KGZ','LAO','MDV','MNG','MMR','NPL','PRK','LKA','TJK','THA','TKM','UZB','VNM') THEN 'Other Asia' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('AFG','DZA','ARM','AZE','BHR','EGY','GEO','IRN','IRQ','JOR','KWT','LBN','LBY','MAR','OMN','PAK','QAT','SAU','SOM','SYR','TUN','ARE','YEM') THEN 'Other Middle East' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('AGO','BEN','BWA','BFA','BDI','CMR','CPV','CAF','TCD','COM','CIV','COD','DJI','GNQ','ERI','ETH','GAB','GMB','GHA','GIN','GNB','KEN','LSO','LBR','MDG', 'MWI','MLI','MRT','MUS','MOZ','NAM','NER','NGA','COG','RWA','SEN','SYC','SLE','SDN','SWZ','TZA','TGO','UGA','ZMB','ZWE') THEN 'Other Africa' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('XS','N/A','UNDEFINED','[NULL]') OR COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IS NULL THEN 'Other XS Indices' ELSE COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) END AS CCAR_COUNTRY, round(SUM(c.D50*COALESCE(WEIGHT3,1)),10) AS D50, round(SUM(c.D30*COALESCE(WEIGHT3,1)),10) AS D30, round(SUM(c.D20*COALESCE(WEIGHT3,1)),10) AS D20, round(SUM(c.D10*COALESCE(WEIGHT3,1)),10) AS D10, round(SUM(c.D05*COALESCE(WEIGHT3,1)),10) AS D05, round(SUM(c.P05*COALESCE(WEIGHT3,1)),10) AS P05, round(SUM(c.P10*COALESCE(WEIGHT3,1)),10) AS P10, round(SUM(c.P20*COALESCE(WEIGHT3,1)),10) AS P20 FROM ( SELECT POSITION_ID, PROCESS_ID, ISSUER_COUNTRY_CODE, SUM(CASE WHEN COALESCE(D50,0) = 0 THEN D30 ELSE D50 end) AS D50, SUM(D30) AS D30, SUM(D20) AS d20, SUM(D10) AS D10, SUM(D05) AS D05, SUM(P05) AS P05, SUM(P10) AS P10, SUM(P20) AS P20 FROM ( SELECT a.POSITION_ID, a.PROCESS_ID, a.ISSUER_COUNTRY_CODE, SUM(a.SLIDE_EQ_MIN_50_USD) AS D50, SUM(a.SLIDE_EQ_MIN_30_USD) AS D30, SUM(a.SLIDE_EQ_MIN_20_USD) AS D20, SUM(a.SLIDE_EQ_MIN_10_USD) AS D10, SUM(a.SLIDE_EQ_MIN_05_USD) AS D05, SUM(a.SLIDE_EQ_PLS_05_USD) AS P05, SUM(a.SLIDE_EQ_PLS_10_USD) AS P10, SUM(a.SLIDE_EQ_PLS_20_USD) AS P20 FROM cdwuser.U_EQ_MSR a WHERE COB_DATE = '02-27-2018' AND NOT a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.CCAR_BUSINESS_CATEGORY NOT LIKE 'NOT%' AND NOT (a.FEED_SOURCE_NAME = 'ER1' AND a.PRODUCT_TYPE_CODE = 'STOCK' AND a.CCC_BANKING_TRADING = 'BANKING' AND (a.CCC_DIVISION != 'INSTITUTIONAL EQUITY DIVISION' OR a.CCC_PRODUCT_LINE ='BUSINESS MODEL INVSTMNTS')) GROUP BY a.POSITION_ID, a.PROCESS_ID, a.ISSUER_COUNTRY_CODE) x GROUP BY POSITION_ID, PROCESS_ID,ISSUER_COUNTRY_CODE ) c LEFT JOIN ( Select a.PROCESS_ID, a.POSITION_ID, a.ISSUER_COUNTRY_CODE_DECOMP, a.TYPE_FLAG, WEIGHT/WEIGHT2 as WEIGHT3 FROM ( SELECT a.PROCESS_ID, a.POSITION_ID, a.ISSUER_COUNTRY_CODE_DECOMP, CASE WHEN PRODUCT_TYPE_CODE_DECOMP = 'COMM' THEN 'COMMOD' ELSE 'NON-COMMOD' END AS TYPE_FLAG, SUM(ABS(PRODUCT_WEIGHT_DECOMP)) as WEIGHT FROM cdwuser.U_DECOMP_MSR a WHERE COB_DATE = '02-27-2018' AND NOT a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.CCAR_BUSINESS_CATEGORY NOT LIKE 'NOT%' AND a.PRODUCT_WEIGHT_DECOMP IS NOT NULL AND NOT (a.FEED_SOURCE_NAME = 'ER1' AND a.PRODUCT_TYPE_CODE = 'STOCK' AND a.CCC_BANKING_TRADING = 'BANKING' AND NOT a.PRODUCT_WEIGHT_DECOMP = 0 AND (a.CCC_DIVISION != 'INSTITUTIONAL EQUITY DIVISION' OR a.CCC_PRODUCT_LINE ='BUSINESS MODEL INVSTMNTS')) AND (COALESCE(USD_EQ_DELTA_DECOMP,0) != 0 OR COALESCE(USD_CM_DELTA_DECOMP,0) != 0) GROUP BY a.PROCESS_ID, a.POSITION_ID, a.ISSUER_COUNTRY_CODE_DECOMP, CASE WHEN PRODUCT_TYPE_CODE_DECOMP = 'COMM' THEN 'COMMOD' ELSE 'NON-COMMOD' END ) a INNER JOIN ( SELECT a.PROCESS_ID, a.POSITION_ID, SUM(ABS(PRODUCT_WEIGHT_DECOMP)) as WEIGHT2 FROM cdwuser.U_DECOMP_MSR a WHERE COB_DATE = '02-27-2018' AND NOT a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.CCAR_BUSINESS_CATEGORY NOT LIKE 'NOT%' AND a.PRODUCT_WEIGHT_DECOMP IS NOT NULL AND NOT (a.FEED_SOURCE_NAME = 'ER1' AND a.PRODUCT_TYPE_CODE = 'STOCK' AND a.CCC_BANKING_TRADING = 'BANKING' AND NOT a.PRODUCT_WEIGHT_DECOMP = 0 AND (a.CCC_DIVISION != 'INSTITUTIONAL EQUITY DIVISION' OR a.CCC_PRODUCT_LINE ='BUSINESS MODEL INVSTMNTS')) AND (COALESCE(USD_EQ_DELTA_DECOMP,0) != 0 OR COALESCE(USD_CM_DELTA_DECOMP,0) != 0) GROUP BY a.PROCESS_ID, a.POSITION_ID ) b ON (a.process_id = b.process_id AND a.position_id = b.position_id) ) d ON (c.process_id = d.process_id AND c.position_id = d.position_id) AND NOT d.TYPE_FLAG = 'COMMOD' GROUP BY CASE WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('GIB','CGY','IMN','JEY','LUX','MCO','VIR','VGB','MLT','CYP') THEN 'Other Advanced' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('ALB','AND','BLR','BIH','HRV','EST','ISL','LVA','LIE','LTU','MKD','MDA','MNE','ROU','SMR','SRB','SVK','SVN') THEN 'Other Emerging Europe' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('ATG','BHS','BRB','BLZ','BMU','BOL','CYM','COL','CRI','CUB','DMA','DOM','ECU','SLV','GRD','GTM','GUY','HTI','HND','JAM','NIC','PAN', 'PRY','PER','KNA','LCA','VCT','SUR','TTO','URY','VEN') THEN 'Other Latam' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('BGD','BTN','BRN','KHM','KAZ','KGZ','LAO','MDV','MNG','MMR','NPL','PRK','LKA','TJK','THA','TKM','UZB','VNM') THEN 'Other Asia' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('AFG','DZA','ARM','AZE','BHR','EGY','GEO','IRN','IRQ','JOR','KWT','LBN','LBY','MAR','OMN','PAK','QAT','SAU','SOM','SYR','TUN','ARE','YEM') THEN 'Other Middle East' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('AGO','BEN','BWA','BFA','BDI','CMR','CPV','CAF','TCD','COM','CIV','COD','DJI','GNQ','ERI','ETH','GAB','GMB','GHA','GIN','GNB','KEN','LSO','LBR','MDG', 'MWI','MLI','MRT','MUS','MOZ','NAM','NER','NGA','COG','RWA','SEN','SYC','SLE','SDN','SWZ','TZA','TGO','UGA','ZMB','ZWE') THEN 'Other Africa' WHEN COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IN ('XS','N/A','UNDEFINED','[NULL]') OR COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) IS NULL THEN 'Other XS Indices' ELSE COALESCE(d.ISSUER_COUNTRY_CODE_DECOMP, c.ISSUER_COUNTRY_CODE) END