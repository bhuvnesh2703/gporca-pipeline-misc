with src as ( SELECT case when PARENT_LEGAL_ENTITY = '0302(G)' then 'MSIP' when PARENT_LEGAL_ENTITY = '0342' then 'MSSL' when PARENT_LEGAL_ENTITY = '0517(G)' then 'MSBIL' end as entity, POSITION_ISSUER_PARTY_DARWIN_NAME as ultimate_name, POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME as issuer, moody_rating as rating, ccc_business_area, tapscusip, SUM(coalesce(usd_exposure, 0)) as net_exposure FROM CDWUSER.U_CR_MSR a WHERE COB_DATE = '2018-02-28' AND PARENT_LEGAL_ENTITY in ('0302(G)', '0342', '0517(G)') AND product_hierarchy_level7 in (upper('Covered Bond-Other'), upper('Hypotheken Pfandbriefe'), upper('Jumbo Pfandbriefe'), upper('Offentlicke Pfandbriefe'), upper('Pfandbriefe')) AND var_excl_fl <> 'Y' AND ccc_product_line <> 'CORE PRIMARY' GROUP BY case when PARENT_LEGAL_ENTITY = '0302(G)' then 'MSIP' when PARENT_LEGAL_ENTITY = '0342' then 'MSSL' when PARENT_LEGAL_ENTITY = '0517(G)' then 'MSBIL' end, POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME, POSITION_ISSUER_PARTY_DARWIN_NAME, moody_rating, ccc_business_area, tapscusip ), ranked_entity as( SELECT case when rank >= 50 then 50 else rank end as rank, entity, case when rank >= 50 then 'Other' else ultimate_name end as ultimate_name, rating, ccc_business_area, sum(net_exposure) as net_exposure FROM ( SELECT rank_ultimate.rank, rank_ultimate.entity, rank_ultimate.ultimate_name, rating, ccc_business_area, sum(src.net_exposure) as net_exposure FROM ( SELECT rank() over(partition by entity order by abs(net_exposure) desc ) as rank, entity, ultimate_name FROM ( SELECT entity, ultimate_name, sum(net_exposure) as net_exposure FROM src group by entity, ultimate_name ) k) rank_ultimate, src WHERE src.entity = rank_ultimate.entity AND src.ultimate_name = rank_ultimate.ultimate_name group by rank_ultimate.rank, rank_ultimate.entity, rank_ultimate.ultimate_name, rating, ccc_business_area) s GROUP BY case when rank >= 50 then 50 else rank end, entity, case when rank >= 50 then 'Other' else ultimate_name end, rating, ccc_business_area ) , ba_of_lconc as ( SELECT entity, ultimate_name, rating, ccc_business_area FROM (SELECT rank() over(partition by entity, ultimate_name order by case when rating = 'N/A' then 1 else 0 end, abs(net_exposure) desc) as rank, entity, ultimate_name, rating, ccc_business_area FROM ranked_entity) k WHERE rank = 1 ), with_rollup as ( select entity, coalesce(rank, 51) as rank, coalesce(ultimate_name, 'Grand Total') as ultimate_name, issuer, rating, business_area_of_largest_conc, tapscusip, net_exposure from( select entity, rank, ultimate_name, issuer, rating, business_area_of_largest_conc, tapscusip, sum(net_exposure) as net_exposure FROM( select with_ba.rank, with_ba.entity, with_ba.ultimate_name, coalesce(src.issuer, 'Other') as issuer, with_ba.rating, with_ba.business_area_of_largest_conc, coalesce(src.tapscusip, 'Other') as tapscusip, coalesce(src.net_exposure, with_ba.net_exposure) as net_exposure from ( select ranked.rank, ranked.entity, ranked.ultimate_name, ba_of_lconc.rating, ba_of_lconc.ccc_business_area as business_area_of_largest_conc, ranked.net_exposure from ( select rank, entity, ultimate_name, sum(net_exposure) as net_exposure from ranked_entity group by rank, entity, ultimate_name ) ranked, ba_of_lconc where ranked.entity = ba_of_lconc.entity and ranked.ultimate_name = ba_of_lconc.ultimate_name) with_ba left join src on with_ba.entity=src.entity and with_ba.ultimate_name = src.ultimate_name ) w GROUP BY entity, rank, ultimate_name, issuer, rating, business_area_of_largest_conc, tapscusip ) e WHERE (ultimate_name is not null and issuer is null) or (entity is not null and rank is null) or tapscusip is not null ) select with_rollup.* from (select rank, count(rank) as nb_of_rows from with_rollup group by rank ) filt, with_rollup where with_rollup.rank = filt.rank and not (issuer is null and nb_of_rows = 2)