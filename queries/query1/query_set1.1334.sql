with x as ( select d.PRODUCT_DESCRIPTION_DECOMP as security_description, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0) + coalesce(d.USD_CM_DELTA_DECOMP,0)) as DELTA, d.ticker_decomp||'.'||d.EXCHANGE_DECOMP as tick, case when d.CCC_PL_REPORTING_REGION = 'EMEA' then 1 else 0 end as EU_FLAG, case when d.PRODUCT_TYPE_CODE_DECOMP = 'COMM' then 1 else 0 end as CM_Flag, case when d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP in ('0914.hk', '600585.ss', 'bbdc3.sa', 'bbdc4.sa', 'stncY.bo') then 1 else 0 end as EM_LargeCap_Flag, case when d.ISSUER_COUNTRY_CODE_DECOMP in ('DNK','BMU','CYM','AUS','AUT','BEL','CAN','CHE','DEU','ESP','FIN','FRA','GBR','GRC','IRL','ITA','JPN','LUX','NLD','NOR','NZL','PRT','SWE','USA','JEY','GGY','SUP','XS','XCI','VGB','CYP') then 0 when d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP in ('0005.HK', '005930.KS', '0388.HK', '0688.HK', '0700.HK', '0883.HK', '0939.HK', '0941.HK', '1299.HK', '1398.HK', '2628.HK', '2823.HK', '3988.HK', 'bbdc3.SA', 'bbdc4.SA', 'stncY.BO') then 0 else 1 end as EM_Flag, Case when ISSUER_COUNTRY_CODE_DECOMP in ('ARE', 'ARG', 'BGD', 'BGR', 'BHR', 'BRA', 'COL', 'EGY', 'GRC', 'HRV', 'HUN', 'IDN', 'IND', 'IRL', 'ISL', 'ITA', 'JOR', 'KAZ', 'KEN', 'KOR', 'KWT', 'LBN', 'LKA', 'LTU', 'MAR', 'MEX', 'MUS', 'MYS', 'NGA', 'OMN', 'PAK', 'PER', 'PHL', 'POL', 'PRI', 'PRT', 'ROU', 'RUS', 'THA', 'TUR', 'VEN', 'VNM', 'ZAF') then 'Tier 2' else 'N/A' end as ISSUER_COUNTRY_TIER, ISSUER_COUNTRY_CODE_DECOMP as ISSUER_COUNTRY_CODE from cdwuser.U_DECOMP_MSR d where d.division = 'IED' and d.ccc_banking_trading = 'TRADING'and d.COB_DATE = '2018-02-28' group by d.PRODUCT_DESCRIPTION_DECOMP, d.ticker_decomp||'.'||d.EXCHANGE_DECOMP, case when d.CCC_PL_REPORTING_REGION = 'EMEA' then 1 else 0 end, case when d.PRODUCT_TYPE_CODE_DECOMP = 'COMM' then 1 else 0 end, case when d.ISSUER_COUNTRY_CODE_DECOMP in ('DNK','BMU','CYM','AUS','AUT','BEL','CAN','CHE','DEU','ESP','FIN','FRA','GBR','GRC','IRL','ITA','JPN','LUX','NLD','NOR','NZL','PRT','SWE','USA','JEY','GGY','SUP','XS','XCI','VGB','CYP') then 0 when d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP in ('0005.HK', '005930.KS', '0388.HK', '0688.HK', '0700.HK', '0883.HK', '0939.HK', '0941.HK', '1299.HK', '1398.HK', '2628.HK', '2823.HK', '3988.HK', 'bbdc3.SA', 'bbdc4.SA', 'stncY.BO') then 0 else 1 end, case when d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP in ('0914.hk', '600585.ss', 'bbdc3.sa', 'bbdc4.sa', 'stncY.bo') then 1 else 0 end, Case when ISSUER_COUNTRY_CODE_DECOMP in ('ARE', 'ARG', 'BGD', 'BGR', 'BHR', 'BRA', 'COL', 'EGY', 'GRC', 'HRV', 'HUN', 'IDN', 'IND', 'IRL', 'ISL', 'ITA', 'JOR', 'KAZ', 'KEN', 'KOR', 'KWT', 'LBN', 'LKA', 'LTU', 'MAR', 'MEX', 'MUS', 'MYS', 'NGA', 'OMN', 'PAK', 'PER', 'PHL', 'POL', 'PRI', 'PRT', 'ROU', 'RUS', 'THA', 'TUR', 'VEN', 'VNM', 'ZAF') then 'Tier 2' else 'N/A' end, ISSUER_COUNTRY_CODE_DECOMP ) select * from( select 'TopCMDelta' as Concentration, x.security_description, sum(delta) as Measure from x where CM_Flag = 1 group by x.security_description order by abs(sum(delta)) desc fetch first 1 rows only ) a Union All select * from( select 'TopEMDelta' as Concentration, security_description, sum(delta) as Measure from x where em_flag = 1 group by security_description order by abs(sum(delta)) desc fetch first 1 rows only) a Union All select * from( select 'TopEMLargeCapDelta' as Concentration, security_description, sum(delta) as Measure from x where EM_LargeCap_Flag = 1 group by security_description order by abs(sum(delta)) desc fetch first 1 rows only) a Union All select * from( select 'TopNonEMDelta' as Concentration, security_description, sum(delta) as Measure from x where em_flag = 0 group by security_description order by abs(sum(delta)) desc fetch first 1 rows only) a Union All select * from( select 'TopT2Delta' as Concentration, ISSUER_COUNTRY_CODE as security_description, sum(delta) as Measure from x where ISSUER_COUNTRY_TIER = 'Tier 2' group by ISSUER_COUNTRY_CODE order by abs(sum(delta)) desc fetch first 1 rows only) a Union All select 'GrossCMDelta' as Concentration, 'N/A' as security_descpription, sum(abs(delta)) as Measure from (select sum(delta) as delta from x where cm_flag = 1 group by tick) a