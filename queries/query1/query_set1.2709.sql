SELECT y.COB_DATE         ,y.Type         ,CASE                  WHEN y.UL_Symbol IN (                                 'spx.us'                                 ,'spy.p'                                 ,'sptr1.msny'                                 )                         THEN 'SPX (g)'                 ELSE y.UL_Symbol                 END AS UL_Symbol,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_50_USD) ELSE 0 END) AS D50_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_MIN_50_USD) ELSE 0 END) AS D50_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_50_USD) ELSE - (coalesce(y.Weight * y.SLIDE_MIN_50_USD)) END) AS D50_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_30_USD) ELSE 0 END) AS D30_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_MIN_30_USD) ELSE 0 END) AS D30_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_30_USD) ELSE - (coalesce(y.Weight * y.SLIDE_MIN_30_USD)) END) AS D30_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_20_USD) ELSE 0 END) AS D20_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_MIN_20_USD) ELSE 0 END) AS D20_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_20_USD) ELSE - (coalesce(y.Weight * y.SLIDE_MIN_20_USD)) END) AS D20_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_10_USD) ELSE 0 END) AS D10_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_MIN_10_USD) ELSE 0 END) AS D10_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_10_USD) ELSE - (coalesce(y.Weight * y.SLIDE_MIN_10_USD)) END) AS D10_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_05_USD) ELSE 0 END) AS D05_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_MIN_05_USD) ELSE 0 END) AS D05_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_MIN_05_USD) ELSE - (coalesce(y.Weight * y.SLIDE_MIN_05_USD)) END) AS D05_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_PLS_05_USD) ELSE 0 END) AS U05_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_PLS_05_USD) ELSE 0 END) AS U05_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_PLS_05_USD) ELSE - (coalesce(y.Weight * y.SLIDE_PLS_05_USD)) END) AS U05_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_PLS_10_USD) ELSE 0 END) AS U10_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_PLS_10_USD) ELSE 0 END) AS U10_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_PLS_10_USD) ELSE - (coalesce(y.Weight * y.SLIDE_PLS_10_USD)) END) AS U10_RAW_CHANGE,  SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_PLS_20_USD) ELSE 0 END) AS U20_Raw_COB, SUM (CASE WHEN COB_DATE = '2018-02-27' THEN coalesce(y.Weight * y.SLIDE_PLS_20_USD) ELSE 0 END) AS U20_Raw_COMP, SUM (CASE WHEN COB_DATE = '2018-02-28' THEN coalesce(y.Weight * y.SLIDE_PLS_20_USD) ELSE - (coalesce(y.Weight * y.SLIDE_PLS_20_USD)) END) AS U20_RAW_CHANGE  FROM (         SELECT COB_DATE                 ,x.UNDERLIER_EXCH                 ,PROCESS_ID                 ,POSITION_KEY                 ,CASE                          WHEN x.UNDERLIER_EXCH IN ('z')                                 OR x.Partial_Decomp_Sector IN ('INDEX')                                 OR x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE IN (                                         'spx.us'                                         ,'spy.p'                                         ,'sptr1.msny'                                         ,''                                         ,'SPX (g)'                                         ,'itb.p'                                         ,'iyr.p'                                         ,'iyt.p'                                         ,'iyz.p'                                         ,'kbe.p'                                         ,'oih.p'                                         ,'smh.p'                                         ,'xhb.p'                                         ,'xlb.p'                                         ,'xle.p'                                         ,'xlf.p'                                         ,'xli.p'                                         ,'xlk.p'                                         ,'xlp.p'                                         ,'xlu.p'                                         ,'xlv.p'                                         ,'xly.p'                                         ,'xop.p'                                         ,'xrt.p'                                         ,'xme.p'                                         ,'xfn.to'                                         ,'ung.p'                                         ,'uso.p'                                         ,'ibb.q'                                         ,'kre.p'                                         ,'xbi.p'                                         )                                 THEN 'Index/Sector ETF'                         ELSE 'Other'                         END AS Type                 ,CASE                          WHEN (                                         x.Denominator > 0.00000001                                         AND x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE NOT IN (                                                 'abx.to'                                                 ,'bns.to'                                                 ,'td.to'                                                 ,'ry.to'                                                 )                                         )                                 THEN x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE                         WHEN (                                         x.Denominator > 0.00000001                                         AND x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE IN (                                                 'abx.to'                                                 ,'bns.to'                                                 ,'td.to'                                                 ,'ry.to'                                                 )                                         )                                 THEN x.PARTIAL_DECOMP_TICK || '.n'                         ELSE x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE                         END AS UL_Symbol                 ,CASE                          WHEN x.Denominator > 0.00000001                                 THEN abs(x.delta) / x.Denominator                         ELSE 1.0                         END AS Weight                 ,SLIDE_MIN_05_USD                 ,SLIDE_MIN_10_USD                 ,SLIDE_MIN_20_USD                 ,SLIDE_MIN_30_USD                 ,SLIDE_MIN_50_USD                 ,SLIDE_PLS_05_USD                 ,SLIDE_PLS_10_USD                 ,SLIDE_PLS_20_USD         FROM (                 SELECT COB_DATE                         ,UNDERLIER_EXCH                         ,PROCESS_ID                         ,POSITION_KEY                         ,ASSET_CLASS                         ,PARTIAL_DECOMP_SECTOR                         ,EXECUTIVE_MODEL                         ,PRODUCT_TYPE_CODE                         ,PARTIAL_DECOMP_TICK                         ,PARTIAL_DECOMP_EXCHANGE                         ,DELTA                         ,SUM(SLIDE_MIN_05_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_MIN_05_USD                         ,SUM(SLIDE_MIN_10_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_MIN_10_USD                         ,SUM(SLIDE_MIN_20_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_MIN_20_USD                         ,SUM(SLIDE_MIN_30_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_MIN_30_USD                         ,SUM(SLIDE_MIN_50_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_MIN_50_USD                         ,SUM(SLIDE_PLS_05_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_PLS_05_USD                         ,SUM(SLIDE_PLS_10_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_PLS_10_USD                         ,SUM(SLIDE_PLS_20_USD) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) SLIDE_PLS_20_USD                         ,SUM(Denominator) OVER (                                 PARTITION BY COB_DATE                                 ,POSITION_KEY                                 ) AS Denominator                 FROM (                         SELECT a.COB_DATE                                 ,a.UNDERLIER_EXCH                                 ,a.PROCESS_ID                                 ,a.POSITION_KEY                                 ,a.ASSET_CLASS                                 ,a.Partial_Decomp_Sector                                 ,a.EXECUTIVE_MODEL                                 ,a.PRODUCT_TYPE_CODE                                 ,a.PARTIAL_DECOMP_TICK                                 ,a.PARTIAL_DECOMP_EXCHANGE                                 ,sum(coalesce(a.USD_EQ_PARTIAL_DELTA, 0)) + sum(coalesce(a.USD_CM_PARTIAL_DELTA, 0)) AS DELTA                                 ,sum(abs(coalesce(a.USD_EQ_PARTIAL_DELTA, 0))) + sum(abs(coalesce(a.USD_CM_PARTIAL_DELTA, 0))) Denominator                                 ,sum(coalesce(a.SLIDE_EQ_MIN_05_USD, 0)) + sum(coalesce(a.SLIDE_CM_MIN_05_USD, 0)) AS SLIDE_MIN_05_USD                                 ,sum(coalesce(a.SLIDE_EQ_MIN_10_USD, 0)) + sum(coalesce(a.SLIDE_CM_MIN_10_USD, 0)) AS SLIDE_MIN_10_USD                                 ,sum(coalesce(a.SLIDE_EQ_MIN_20_USD, 0)) + sum(coalesce(a.SLIDE_cm_MIN_20_USD, 0)) AS SLIDE_MIN_20_USD                                 ,sum(coalesce(a.SLIDE_EQ_MIN_30_USD, 0)) + sum(coalesce(a.SLIDE_CM_MIN_30_USD, 0)) AS SLIDE_MIN_30_USD                                 ,sum(coalesce(a.SLIDE_EQ_MIN_50_USD, 0)) + sum(coalesce(a.SLIDE_CM_MIN_50_USD, 0)) AS SLIDE_MIN_50_USD                                 ,sum(coalesce(a.SLIDE_EQ_PLS_05_USD, 0)) + sum(coalesce(a.SLIDE_CM_PLS_05_USD, 0)) AS SLIDE_PLS_05_USD                                 ,sum(coalesce(a.SLIDE_EQ_PLS_10_USD, 0)) + sum(coalesce(a.SLIDE_CM_PLS_10_USD, 0)) AS SLIDE_PLS_10_USD                                 ,sum(coalesce(a.SLIDE_EQ_PLS_20_USD, 0)) + sum(coalesce(a.SLIDE_CM_PLS_20_USD, 0)) AS SLIDE_PLS_20_USD                         FROM cdwuser.U_EXP_MSR_PARTIAL a where a.cob_date in ('2018-02-28', '2018-02-27') AND                                  a.SILO_SRC = 'IED'                                 AND a.CCC_BANKING_TRADING = 'TRADING'                                 AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION'                                 AND a.CCC_STRATEGY = 'SINGLE NAME'                                 AND a.CCC_PL_REPORTING_REGION = 'AMERICAS'                         GROUP BY a.COB_DATE                                 ,a.UNDERLIER_EXCH                                 ,a.PROCESS_ID                                 ,a.POSITION_KEY                                 ,a.ASSET_CLASS                                 ,a.PRODUCT_TYPE_CODE                                 ,a.Partial_Decomp_Sector                                 ,a.EXECUTIVE_MODEL                                 ,a.PARTIAL_DECOMP_TICK                                 ,a.PARTIAL_DECOMP_EXCHANGE                         ) b                 ) x         GROUP BY COB_DATE                 ,x.UNDERLIER_EXCH                 ,PROCESS_ID                 ,POSITION_KEY                 ,CASE                          WHEN x.UNDERLIER_EXCH IN ('z')                                 OR x.Partial_Decomp_Sector IN ('INDEX')                                 OR x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE IN (                                         'spx.us'                                         ,'spy.p'                                         ,'sptr1.msny'                                         ,''                                         ,'SPX (g)'                                         ,'itb.p'                                         ,'iyr.p'                                         ,'iyt.p'                                         ,'iyz.p'                                         ,'kbe.p'                                         ,'oih.p'                                         ,'smh.p'                                         ,'xhb.p'                                         ,'xlb.p'                                         ,'xle.p'                                         ,'xlf.p'                                         ,'xli.p'                                         ,'xlk.p'                                         ,'xlp.p'                                         ,'xlu.p'                                         ,'xlv.p'                                         ,'xly.p'                                         ,'xop.p'                                         ,'xrt.p'                                         ,'xme.p'                                         ,'xfn.to'                                         ,'ung.p'                                         ,'uso.p'                                         ,'ibb.q'                                         ,'kre.p'                                         ,'xbi.p'                                         )                                 THEN 'Index/Sector ETF'                         ELSE 'Other'                         END                 ,CASE                          WHEN (                                         x.Denominator > 0.00000001                                         AND x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE NOT IN (                                                 'abx.to'                                                 ,'bns.to'                                                 ,'td.to'                                                 ,'ry.to'                                                 )                                         )                                 THEN x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE                         WHEN (                                         x.Denominator > 0.00000001                                         AND x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE IN (                                                 'abx.to'                                                 ,'bns.to'                                                 ,'td.to'                                                 ,'ry.to'                                                 )                                         )                                 THEN x.PARTIAL_DECOMP_TICK || '.n'                         ELSE x.PARTIAL_DECOMP_TICK || '.' || x.PARTIAL_DECOMP_EXCHANGE                         END                 ,CASE                          WHEN x.Denominator > 0.00000001                                 THEN abs(x.delta) / x.Denominator                         ELSE 1.0                         END                 ,SLIDE_MIN_05_USD                 ,SLIDE_MIN_10_USD                 ,SLIDE_MIN_20_USD                 ,SLIDE_MIN_30_USD                 ,SLIDE_MIN_50_USD                 ,SLIDE_PLS_05_USD                 ,SLIDE_PLS_10_USD                 ,SLIDE_PLS_20_USD         ) y GROUP BY y.COB_DATE         ,y.Type         ,CASE                  WHEN y.UL_Symbol IN (                                 'spx.us'                                 ,'spy.p'                                 ,'sptr1.msny'                                 )                         THEN 'SPX (g)'                 ELSE y.UL_Symbol                 END