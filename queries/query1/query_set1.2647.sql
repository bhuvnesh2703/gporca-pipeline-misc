WITH SRC AS ( SELECT V.*, CASE WHEN GROUP_LVL_2 = 'OTHER' THEN 2 ELSE 1 END AS GRP_LVL2_RANK, CASE WHEN CURRENCY IN ('USD', 'EUR', 'GBP', 'JPY') THEN 1 ELSE 2 END AS CURRENCY_RANK, SUM(USD_PV01_COB) OVER(PARTITION BY CURRENCY) AS PV01_COB_RANK, SUM(USD_PV01_COB) OVER(PARTITION BY CURRENCY,GROUP_LVL_1, GROUP_LVL_2) AS PV01_COB_GRP_RANK FROM ( SELECT case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end as currency, case when UPPER(CURVE_NAME) = 'KRWKTB' THEN 'Govts' when UPPER(sectype2) = 'GOVTS' then 'Govts' when UPPER(sectype2) = 'RATEFUTURE' then 'Total Swaps' when UPPER(sectype2) = 'SWAPS' then 'Total Swaps' else 'Others' end as group_lvl_1, CASE when UPPER(CURVE_NAME) = 'KRWKTB' THEN 'Other Govts' WHEN UPPER(sectype2) = 'GOVTS' THEN CASE WHEN UPPER(product_type_code) = 'BONDFUT' THEN 'Bond Futures' WHEN UPPER(product_type_code) = 'BONDOPT' THEN 'Bond Options' WHEN UPPER(product_type_code) IN ('GVTBOND', 'GVTBONDIL') THEN 'Govt Bonds' ELSE 'Other Govts' END WHEN UPPER(sectype2) = 'RATEFUTURE' then 'Rate Futures' WHEN UPPER(sectype2) = 'SWAPS' then 'Swaps' ELSE coalesce(sectype2,' - Missing - ') end as group_lvl_2, CASE WHEN TERM_NEW<0.25 THEN TERM_NEW WHEN TERM_NEW IN ('0.25', '0.5','0.75', '1', '2', '3','5', '7', '8', '10', '12', '15', '20',' 30', '40') THEN TERM_NEW ELSE 0 END AS TERM_NEW, SUM(CASE WHEN cob_date = '2018-02-28' THEN coalesce(usd_ir_unified_pv01, 0) ELSE 0 END) AS usd_pv01_cob, SUM(CASE WHEN cob_date = '2018-02-28' THEN coalesce(usd_ir_unified_pv01, 0) ELSE -coalesce(usd_ir_unified_pv01, 0) END) AS usd_pv01_change FROM CDWUSER.U_EXP_TRENDS t WHERE cob_date IN ('2018-02-28', '2018-02-27') AND VAR_EXCL_FL <> 'Y' AND PARENT_LEGAL_ENTITY = '1633' GROUP BY currency, group_lvl_1, group_lvl_2, term_new ) V ) SELECT CURRENCY, CURR_RANK, GROUP_LVL_1, CASE WHEN GRP_RANK >= 5 THEN 'OTHER' ELSE GROUP_LVL_2 END AS GROUP_LVL_2, CASE WHEN GRP_RANK >= 5 OR GROUP_LVL_1 <> 'Others' THEN 5 ELSE GRP_RANK END AS GRP_RANK, TERM_NEW, SUM(USD_PV01_COB) AS USD_PV01_COB, SUM(USD_PV01_CHANGE) AS USD_PV01_CHANGE FROM ( SELECT CURRENCY, CURR_RANK, DENSE_RANK() OVER(PARTITION BY CURRENCY, GROUP_LVL_1 ORDER BY GRP_LVL2_RANK, ABS(PV01_COB_GRP_RANK) DESC) AS GRP_RANK, GROUP_LVL_1, GROUP_LVL_2, TERM_NEW, USD_PV01_COB, USD_PV01_CHANGE FROM ( SELECT CASE WHEN CURR_RANK >= 8 THEN 'OTHER' ELSE CURRENCY END AS CURRENCY, CASE WHEN CURR_RANK >= 8 THEN 8 ELSE CURR_RANK END AS CURR_RANK, GROUP_LVL_1, GROUP_LVL_2, PV01_COB_GRP_RANK, TERM_NEW, GRP_LVL2_RANK, SUM(USD_PV01_COB) AS USD_PV01_COB, SUM(USD_PV01_CHANGE) AS USD_PV01_CHANGE FROM ( SELECT DENSE_RANK() OVER(ORDER BY CURRENCY_RANK, ABS(PV01_COB_RANK) DESC) AS CURR_RANK, SRC.* FROM SRC ) X GROUP BY CURRENCY,CURR_RANK, GROUP_LVL_1, GROUP_LVL_2, TERM_NEW,PV01_COB_GRP_RANK,GRP_LVL2_RANK ) Y ) Z group by currency, curr_rank, group_lvl_1, case when grp_rank >= 5 then 'OTHER' else group_lvl_2 end, case when grp_rank >= 5 or group_lvl_1 <> 'Others' then 5 else grp_rank end, term_new