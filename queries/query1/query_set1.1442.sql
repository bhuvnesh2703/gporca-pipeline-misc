SELECT u.COB_DATE, u.PRODUCT_DESCRIPTION_DECOMP, u.TICK, u.USD_EQ_DELTA_DECOMP, ABS(u.LIQUIDITY_DAYS_DECOMP) as LIQUIDITY_DAYS_DECOMP, ABS(u.USD_EQ_DELTA_DECOMP/u.LIQUIDITY_DAYS_DECOMP) as ADV, RANK() OVER(ORDER BY ABS(COALESCE(u.USD_EQ_DELTA_DECOMP,0)) DESC) as DELTA_RANK, RANK() OVER(ORDER BY ABS(COALESCE(u.LIQUIDITY_DAYS_DECOMP,0)) DESC) as LIQ_RANK FROM ( SELECT d.COB_DATE, d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP as TICK, d.PRODUCT_DESCRIPTION_DECOMP, SUM(d.LIQUIDITY_DAYS_DECOMP::double precision) as LIQUIDITY_DAYS_DECOMP, SUM(d.USD_EQ_DELTA_DECOMP::double precision)/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE ='2018-02-28' AND d.CCC_HIERARCHY_LEVEL10='ETP MAIN' AND (d.CASH_ISSUE_TYPE IN('STOCK', 'ADR', 'BASKET') OR d.UNDERLIER_TICK||'.'||d.UNDERLIER_EXCH='omxs30.stor') AND d.EXECUTIVE_MODEL IN( 'AMERICAN-OPTION', 'CONSTANTLEVERAGECERTIFICATE', 'DELTAONECERTIFICATE', 'EUROPEAN-OPTION', 'MINIFUTURECERTIFICATE', 'OPENENDEDTURBOCERTIFICATE', 'TERMEDTURBO', 'ZEROSTRUCKOPTION') AND d.USD_EQ_DELTA_DECOMP is not null AND d.LIQUIDITY_DAYS_DECOMP is not null GROUP BY d.COB_DATE, d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP, d.PRODUCT_DESCRIPTION_DECOMP HAVING ABS(SUM(d.USD_EQ_DELTA_DECOMP))>0 OR ABS(SUM(d.LIQUIDITY_DAYS_DECOMP))>0 ) u /*TEMPORARY LINE*/ WHERE u.TICK NOT IN('rrtl.de', 'aoi.st')