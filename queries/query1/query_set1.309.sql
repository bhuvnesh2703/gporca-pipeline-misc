select COB_DATE, QUARTERS, CCC_BUSINESS_AREA, TIME_BUCKET_CALENDAR, PRODUCT_TYPE_CODE, case when PRODUCT_SUB_TYPE_CODE in ('N EAST CONSUMPTI', 'N EAST CONSUMPTION') then 'N EAST CONSUMPTI' WHEN PRODUCT_SUB_TYPE_CODE IN ('N EAST APPALACHI', 'N EAST APPALACHIA') THEN 'N EAST APPALACHI' ELSE PRODUCT_SUB_TYPE_CODE END AS PRODUCT_SUB_TYPE_CODE, sum(DOLLAR_GREEK) as DOLLAR_GREEK, sum(RAW_GREEK) as RAW_GREEK FROM ( Select prod_pos_name_description, COB_DATE, ccc_business_area, product_type_code, time_bucket_calendar, EXPIRATION_DATE, time_bucket_quarter, sum(USD_CM_Delta) as dollar_greek, sum(RAW_CM_Delta) as raw_greek, case when EXPIRATION_DATE < ('2018-01-26') then time_bucket_quarter end as quarters, case when product_type_code in ('EAST OFF','EAST PEAK','MIDWEST OFF', 'MIDWEST PEAK','TEXAS OFF','TEXAS PEAK','WEST OFF','WEST PEAK','GRNPWR OFF','GRNPWR PEAK','EAST INTERCONNECT OF','EAST INTERCONNECT PE','TEXAS INTERCONNECT O', 'TEXAS INTERCONNECT P', 'ERCOT', 'WEST INTERCONNECT OF', 'WEST INTERCONNECT PE') then 'Electricity' when product_type_code in ('NATGAS','EUR NG','EURO PWR') then product_type_code end as GE_DETAIL0, CASE WHEN PRODUCT_SUB_TYPE_CODE IN ('NEPOOL O', 'NE_ISO_O') then 'NEPOOL O' WHEN PRODUCT_SUB_TYPE_CODE IN ('NEPOOL P', 'NE_ISO_P') then 'NEPOOL P' WHEN PRODUCT_SUB_TYPE_CODE IN ('NY O', 'NY_ISO_O') then 'NY O' WHEN PRODUCT_SUB_TYPE_CODE IN ('NY P', 'NY_ISO_P') then 'NY P' WHEN PRODUCT_SUB_TYPE_CODE IN ('PJMW O') OR PROD_POS_NAME_DESCRIPTION in ('DOMINION-O','PJMW-O','PPL-O', 'SOUTHWEST-O') THEN 'PJMW O' WHEN PRODUCT_SUB_TYPE_CODE IN ('PJMW P') OR PROD_POS_NAME_DESCRIPTION in ('DOMINION-P','PJMW-P','PPL-P', 'SOUTHEAST-P') THEN 'PJMW P' WHEN PRODUCT_SUB_TYPE_CODE IN ('PJME O') OR PROD_POS_NAME_DESCRIPTION in ('AEP-O','COMED-O','DAYTON-O','DQE-O','KAMMER-O','NIHUB-O','SOUTHWEST-O','BGE-O','JCPL-O','PJM_PECO-O','PJM_PEPCO-O','PJM_PSEG-O','PJM-AECO-O','PJM-EAGLE-O','PJME-O', 'MET EDISON-O', 'SOUTHEAST-O') then 'PJME O' WHEN PRODUCT_SUB_TYPE_CODE IN ('PJME P') OR PROD_POS_NAME_DESCRIPTION in ('AEP-P','COMED-P','DAYTON-P','DQE-P','KAMMER-P','NIHUB-P','SOUTHWEST-P','BGE-P','JCPL-P','PJM_PECO-P','PJM_PEPCO-P','PJM_PSEG-P','PJM_RECO-P','PJM-AECO-P','PJM-EAGLE-P','PJME-P') then 'PJME P' WHEN PRODUCT_SUB_TYPE_CODE IN ('SOUTHEAST O', 'SERC_O', 'SPP_O') then 'SOUTHEAST O' WHEN PRODUCT_SUB_TYPE_CODE IN ('SOUTHEAST P', 'SERC_P', 'SPP_P') then 'SOUTHEAST P' when PRODUCT_SUB_TYPE_CODE ='MISO PEAK' OR PROD_POS_NAME_DESCRIPTION in ('ALTE-P','ALTW-P','CINERGY-P','ILL HUB-P','MICH HUB-P','MINNHUB-P','MISO ENTERGY INTERFACE-P','MP-P') then 'miso peak' when PRODUCT_SUB_TYPE_CODE ='MISO OFF' OR PROD_POS_NAME_DESCRIPTION in ('ALTE-O','ALTW-O','CINHUB-O','ILL HUB-O','MICHHUB-O','MINNHUB-O','MISO ENTERGY INTERFACE-O','MP-O') then 'miso off' when PRODUCT_SUB_TYPE_CODE ='ERCOT H O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOTH-O') then 'ERCOT H O' when PRODUCT_SUB_TYPE_CODE ='ERCOT H P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOTH-P') then 'ERCOT H P' when PRODUCT_SUB_TYPE_CODE ='ERCOT N O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT N-O') then 'ERCOT N O' when PRODUCT_SUB_TYPE_CODE ='ERCOT N P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT N-P') then 'ERCOT N P' when PRODUCT_SUB_TYPE_CODE ='ERCOT W O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT W SCURRY WIND INDEX', 'ERCOTW-O') then 'ERCOT W O' when PRODUCT_SUB_TYPE_CODE ='ERCOT W P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOTW-P') then 'ERCOT W P' when PRODUCT_SUB_TYPE_CODE ='ERCOT S O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT S-O') then 'ERCOT S O' when PRODUCT_SUB_TYPE_CODE ='ERCOT S P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT S-P', 'ERCOT S 345KV-P') then 'ERCOT S P' WHEN PRODUCT_SUB_TYPE_CODE IN ('CALIFORNIA OFF', 'CAISO_O') then 'CALIFORNIA OFF' WHEN PRODUCT_SUB_TYPE_CODE IN ('CALIFORNIA PEAK', 'CAISO_P') then 'CALIFORNIA PEAK' WHEN PRODUCT_SUB_TYPE_CODE IN ('CANADA OFF', 'AESO_O') then 'CANADA OFF' WHEN PRODUCT_SUB_TYPE_CODE IN ('CANADA PEAK', 'AESO_P') then 'CANADA PEAK' WHEN PRODUCT_SUB_TYPE_CODE IN ('NORTHWEST OFF', 'WECC_NORTH_O') then 'NORTHWEST OFF' WHEN PRODUCT_SUB_TYPE_CODE IN ('NORTHWEST PEAK', 'WECC_NORTH_P') then 'NORTHWEST PEAK' WHEN PRODUCT_SUB_TYPE_CODE IN ('SOUTHWEST OFF', 'WECC_SOUTH_O') then 'SOUTHWEST OFF' WHEN PRODUCT_SUB_TYPE_CODE IN ('SOUTHWEST PEAK', 'WECC_SOUTH_P') then 'SOUTHWEST PEAK' WHEN PRODUCT_SUB_TYPE_CODE IN ('MIDWEST_O') then 'Midwest Off' WHEN PRODUCT_SUB_TYPE_CODE IN ('MIDWEST_P') then 'Midwest Peak' ELSE 'OTHER' END AS PRODUCT_SUB_TYPE_CODE FROM cdwuser.U_CM_MSR WHERE COB_DATE IN ('2018-02-28','2018-02-27','2018-01-31','2017-12-29','2017-09-29','2017-06-30') AND ((CCC_DIVISION='COMMODITIES' AND CCC_BUSINESS_AREA not in ('CREDIT','MS CVA MNE - COMMOD', 'INVESTMENTS AND STR TRANS','INVESTOR BUSINESS')) /*OLG LOGIC*/ OR (CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' and (CCC_PRODUCT_LINE NOT IN ('COMMOD EXOTICS', 'COMMOD INDEX') OR CCC_STRATEGY NOT IN ('MS CVA MNE - COMMOD')))) /* NEW LOGIC*/ AND PRODUCT_TYPE_CODE in ('EAST OFF','EAST PEAK','MIDWEST OFF', 'MIDWEST PEAK','TEXAS OFF','TEXAS PEAK','WEST OFF', 'WEST PEAK','GRNPWR OFF','GRNPWR PEAK','EAST INTERCONNECT OF','EAST INTERCONNECT PE','TEXAS INTERCONNECT O', 'TEXAS INTERCONNECT P', 'ERCOT', 'WEST INTERCONNECT OF', 'WEST INTERCONNECT PE') and NOT(INCLUDE_IN_REG_CAAP_FL = 'N' and PRODUCT_SUB_TYPE_CODE in ('N EAST CONSUMPTI', 'N EAST CONSUMPTION', 'N EAST APPALACHI', 'N EAST APPALACHIA') and BOOK = '18003') Group By prod_pos_name_description, COB_DATE,ccc_business_area, product_type_code, PRODUCT_SUB_TYPE_CODE, time_bucket_calendar, EXPIRATION_DATE,time_bucket_quarter )A GROUP BY COB_DATE, QUARTERS, CCC_BUSINESS_AREA, TIME_BUCKET_CALENDAR, PRODUCT_TYPE_CODE, PRODUCT_SUB_TYPE_CODE