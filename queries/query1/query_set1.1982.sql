WITH  IED_CR AS(     SELECT          a.COB_DATE,         a.ISSUER_COUNTRY_CODE,         CASE             WHEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' THEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME         ELSE SUBSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,1,CASE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(')                                                                                         WHEN 0 THEN LENGTH (a.UNDERLIER_PRODUCT_DESCRIPTION)                                                                                      ELSE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(') - 1 END) END AS ULT_NAME,         COALESCE(SUM(a.USD_EXPOSURE),0) AS usd_NET_exposure     FROM         CDWUSER.U_CR_MSR a     WHERE  COB_DATE = '2018-02-28' and A.CCC_PL_REPORTING_REGION in ('JAPAN') AND        CCC_BANKING_TRADING IN ('TRADING') AND         a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND         a.CREDIT_RISK_ISSUER_NAME NOT IN ('REPUBLIC OF INDONESIA', 'STEINHOFF FINANCE HOLDING GMBH',  'BAYER AG','MORGAN STANLEY') AND         a.CREDIT_RISK_ISSUER_NAME NOT LIKE 'BERKSHIRE HATHA%' AND         a.CREDIT_RISK_ISSUER_NAME NOT LIKE '%REPUBLIC OF CHINA' AND         (PRODUCT_TYPE_CODE IN ('SWAP','DEFSWAP','OPTION') OR PRODUCT_TYPE_CODE LIKE  '%BOND%' OR PRODUCT_TYPE_CODE LIKE 'CONVRT') AND         ticker NOT IN ('7048257', '7048274')     GROUP BY         a.COB_DATE,         a.ISSUER_COUNTRY_CODE,         CASE             WHEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' THEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME         ELSE SUBSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,1,CASE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(')                                                                                         WHEN 0 THEN LENGTH (a.UNDERLIER_PRODUCT_DESCRIPTION)                                                                                      ELSE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(') - 1 END) END ), IED_CR_PREV AS (     SELECT          a.COB_DATE,         a.ISSUER_COUNTRY_CODE,         CASE             WHEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' THEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME         ELSE SUBSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,1,CASE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(')                                                                                         WHEN 0 THEN LENGTH (a.UNDERLIER_PRODUCT_DESCRIPTION)                                                                                      ELSE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(') - 1 END) END AS ULT_NAME,         COALESCE(SUM(a.USD_EXPOSURE),0) AS usd_NET_exposure_PREV     FROM         CDWUSER.U_CR_MSR a     WHERE  COB_DATE = '2018-02-27' and A.CCC_PL_REPORTING_REGION in ('JAPAN') AND        CCC_BANKING_TRADING IN ('TRADING') AND         a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND         a.CREDIT_RISK_ISSUER_NAME NOT IN ('REPUBLIC OF INDONESIA', 'STEINHOFF FINANCE HOLDING GMBH',  'BAYER AG','MORGAN STANLEY') AND         a.CREDIT_RISK_ISSUER_NAME NOT LIKE 'BERKSHIRE HATHA%' AND         a.CREDIT_RISK_ISSUER_NAME NOT LIKE '%REPUBLIC OF CHINA' AND         (PRODUCT_TYPE_CODE IN ('SWAP','DEFSWAP','OPTION') OR PRODUCT_TYPE_CODE LIKE  '%BOND%' OR PRODUCT_TYPE_CODE LIKE 'CONVRT') AND         ticker NOT IN ('7048257', '7048274')     GROUP BY         a.COB_DATE,         a.ISSUER_COUNTRY_CODE,         CASE             WHEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' THEN a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME         ELSE SUBSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,1,CASE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(')                                                                                         WHEN 0 THEN LENGTH (a.UNDERLIER_PRODUCT_DESCRIPTION)                                                                                      ELSE POSSTR (a.UNDERLIER_PRODUCT_DESCRIPTION,'(') - 1 END) END ), IED_CR_RANK AS (     SELECT          A.COB_DATE,         A.ULT_NAME,         SUM(A.USD_NET_EXPOSURE)/1000 AS USD_NET_EXPOSURE,         RANK() OVER (ORDER BY ABS(SUM(A.USD_NET_EXPOSURE)) DESC) AS IED_CR_RANK,         ROUND(SUM(COALESCE(a.USD_NET_EXPOSURE, 0) - COALESCE(b.USD_NET_EXPOSURE_PREV, 0)),4) AS change     FROM         IED_CR A      LEFT JOIN         IED_CR_PREV B     ON         A.ULT_NAME=B.ULT_NAME     WHERE a.COB_DATE = '2018-02-28' and         1=1     GROUP BY          A.COB_DATE, A.ULT_NAME     HAVING SUM(USD_NET_EXPOSURE) IS NOT NULL )   SELECT      a.ULT_NAME ,     a.ISSUER_COUNTRY_CODE,     SUM(a.USD_NET_EXPOSURE) AS USD_NET_EXPOSURE,     B.CHANGE FROM     IED_CR a,     IED_CR_RANK b WHERE     a.ULT_NAME = b.ULT_NAME AND     b.IED_CR_RANK <= 20 AND     a.USD_NET_EXPOSURE <>0 GROUP BY      a.COB_DATE,     a.ULT_NAME,     a.ISSUER_COUNTRY_CODE,     b.IED_CR_RANK,     B.CHANGE ORDER BY     b.IED_CR_RANK FETCH FIRST 10 ROWS ONLY