WITH IED AS ( SELECT COB_DATE, PROCESS_ID ,POSITION_ID, sum(D10RAW) AS D10RAW from (SELECT e.COB_DATE, PROCESS_ID ,POSITION_ID, sum(e.SLIDE_EQ_MIN_10_USD) AS D10RAW FROM CDWUSER.U_EQ_MSR e WHERE e.cob_date in ('2018-02-28','2018-02-21') and CCC_PL_REPORTING_REGION in ('EMEA') AND e.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND e.CCC_BANKING_TRADING <> 'BANKING' AND SILO_SRC = 'IED' GROUP BY e.PROCESS_ID ,POSITION_ID, e.COB_DATE )sub_qry GROUP BY PROCESS_ID ,POSITION_ID, COB_DATE ) , CountryWeights AS ( SELECT d.COB_DATE ,PROCESS_ID ,POSITION_ID ,ISSUER_COUNTRY_CODE_DECOMP AS COUNTRY , abs(sum(PRODUCT_WEIGHT_DECOMP)) AS WEIGHT FROM CDWUSER.U_DECOMP_MSR d WHERE d.cob_date in ('2018-02-28','2018-02-21') and CCC_PL_REPORTING_REGION in ('EMEA') AND d.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND d.CCC_BANKING_TRADING <> 'BANKING' AND SILO_SRC = 'IED' GROUP BY d.COB_DATE ,PROCESS_ID ,POSITION_ID ,ISSUER_COUNTRY_CODE_DECOMP HAVING sum(PRODUCT_WEIGHT_DECOMP) <> 0 ) , GrossWeights AS ( SELECT x.COB_DATE ,PROCESS_ID ,POSITION_ID ,sum(abs(WEIGHT)) AS GROSS_WEIGHT FROM CountryWeights x GROUP BY x.COB_DATE ,PROCESS_ID ,POSITION_ID ) ,Decomp AS ( SELECT w.COB_DATE ,w.Process_ID ,w.Position_id ,COUNTRY , abs(WEIGHT / GROSS_WEIGHT) AS WEIGHT FROM CountryWeights w INNER JOIN GrossWeights g ON ( w.cob_date = g.cob_date AND w.process_id = g.process_id AND w.position_id = g.position_id ) ) SELECT VIEW, COB_DATE , CASE WHEN Country IN ('AUT','BEL','CYP','EST','FIN','FRA','DEU','LVA','LTU','LUX','NLD','SVK','SVN','GRC','IRL','ESP','PRT','ITA','GBR') THEN 'Euro_Zone' ELSE 'Other' END AS country_region , COUNTRY , sum(D10RAW) AS D10RAW from ( SELECT 'Decomp' AS VIEW, i.COB_DATE ,COUNTRY ,(D10RAW * WEIGHT) AS D10RAW FROM IED i INNER JOIN Decomp d ON ( i.PROCESS_ID = d.PROCESS_ID AND i.POSITION_ID = d.POSITION_ID and i.COB_DATE = d.COB_DATE ) )sub_qry GROUP BY VIEW ,Country ,COB_DATE