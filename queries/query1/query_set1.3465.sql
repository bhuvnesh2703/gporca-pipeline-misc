WITH rawTable  as (   Select B.* ,CASE WHEN B.PRODUCT_GROUP_DETAIL IN ('Savings', 'Deposits - Spot', 'Deposits - 3M Forward', 'Deposits - Beyond 3M', 'GWM BDP Personal Trust', 'Brokered CD', 'Promontory Deposits', 'Structured CD') THEN 'Deposits' WHEN B.PRODUCT_GROUP_DETAIL IN ('AFS Govt Bonds', 'AFS AGN Fixed', 'AFS AGN Float', 'AFS Credit Fixed', 'AFS Credit Float', 'HTM Govt Bonds', 'HTM Agency', 'Repo') THEN 'Investment Portfolio' WHEN B.PRODUCT_GROUP_DETAIL IN ('IR Swap', 'Swaption', 'IR Futures', 'Option on Futures' ) THEN 'IR Hedges' WHEN B.PRODUCT_GROUP_DETAIL IN ('Mortgages (HFI)', 'Mortgages (HFS)', 'PLA', 'LAL', 'Tailored Lending' ) THEN 'Lending' ELSE 'Other' END as PRODUCT_GROUP  from  (SELECT a.COB_DATE,a.TERM_OF_MEASURE    ,a.CURRENCY_OF_MEASURE  ,a.ACCOUNT  ,a.CCC_PRODUCT_LINE  ,a.VERTICAL_SYSTEM  ,a.BOOK  ,c.WM_BANKING_PRODUCT_SUB_GROUP AS PRODUCT_GROUP_DETAIL  ,(CASE WHEN A.CCC_TAPS_COMPANY = '1633' THEN 'MSBNA' WHEN A.CCC_TAPS_COMPANY = '6635' THEN 'MSPBNA' END) AS ASSET_TYPE  ,a.PRODUCT_TYPE_NAME  ,SUM(USD_PV01) AS USD_PV01 FROM (  SELECT a.POSITION_ID,a.TERM_OF_MEASURE   ,a.COB_DATE   ,a.ACCOUNT   ,a.CCC_PRODUCT_LINE   ,a.CCC_DIVISION   ,a.CCC_BUSINESS_AREA   ,a.VERTICAL_SYSTEM   ,a.BOOK   ,a.PRODUCT_TYPE_CODE   ,A.CCC_TAPS_COMPANY   ,a.PRODUCT_SUB_TYPE_CODE   ,a.CCC_HIERARCHY_LEVEL9   ,CCC_STRATEGY   ,a.PRODUCT_TYPE_NAME   ,a.CURRENCY_OF_MEASURE   ,SUM(COALESCE(USD_IR_UNIFIED_PV01, 0)) AS USD_PV01  FROM DWUSER.u_exp_msr a where COB_DATE in ('2018-02-28', '2018-01-31') AND  A.CCC_TAPS_COMPANY in ('1633','6635')   AND (    A.VAR_EXCL_FL <> 'Y'    OR A.BOOK IN (     'MSDPB3M'     ,'MSDPT3M'     )    )   AND (    A.ccc_banking_trading = 'BANKING'    OR (     A.CCC_HIERARCHY_LEVEL2 IN (      'WEALTH MANAGEMENT'      ,'GLOBAL WEALTH MANAGEMENT'      )     OR a.CCC_business_area = 'US BANKS-LIQUIDITY'     )    AND A.PRODUCT_TYPE_CODE = 'REPO'    AND A.CCC_BUSINESS_AREA NOT IN (     'NON CORE MARKETS'     ,'CORE MARKETS'     )    )  GROUP BY a.POSITION_ID,a.TERM_OF_MEASURE   ,a.COB_DATE   ,a.ACCOUNT   ,a.CCC_PRODUCT_LINE   ,a.CCC_DIVISION     ,a.CCC_BUSINESS_AREA   ,a.VERTICAL_SYSTEM   ,a.BOOK   ,a.PRODUCT_TYPE_CODE   ,a.PRODUCT_SUB_TYPE_CODE     ,a.CCC_HIERARCHY_LEVEL9     ,CCC_STRATEGY   ,a.PRODUCT_TYPE_NAME     ,a.CURRENCY_OF_MEASURE   ,A.CCC_TAPS_COMPANY  ) A      LEFT JOIN     (         SELECT             DISTINCT             b.COB_DATE,             b.book,             b.account,             b.WM_BANKING_PRODUCT_GROUP,             b.WM_BANKING_PRODUCT_SUB_GROUP         FROM DWUSER.U_DM_WM B         WHERE  COB_DATE in ('2018-02-28', '2018-01-31') AND              B.CCC_TAPS_COMPANY IN ('1633', '6635') AND             (B.VAR_EXCL_FL <> 'Y' OR              B.BOOK IN ('MSDPB3M', 'MSDPT3M')) AND             (B.ccc_banking_trading = 'BANKING' OR              (B.CCC_HIERARCHY_LEVEL2 IN ('WEALTH MANAGEMENT', 'GLOBAL WEALTH MANAGEMENT') OR               B.CCC_business_area = 'US BANKS-LIQUIDITY') AND              B.PRODUCT_TYPE_CODE = 'REPO' AND              B.CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS'))     )     AS C     ON         a.BOOK = c.book AND         a.account = c.account AND         a.COB_DATE = c.COB_DATE GROUP BY a.COB_DATE,a.TERM_OF_MEASURE   ,a.CURRENCY_OF_MEASURE  ,a.ACCOUNT  ,a.CCC_PRODUCT_LINE  ,a.CCC_DIVISION  ,a.CCC_BUSINESS_AREA  ,a.VERTICAL_SYSTEM  ,a.BOOK  ,a.PRODUCT_TYPE_NAME  ,A.CCC_TAPS_COMPANY    ,CCC_HIERARCHY_LEVEL9   ,CCC_STRATEGY   ,c.WM_BANKING_PRODUCT_SUB_GROUP) as B),   WEIGHT AS ( SELECT A.*, CASE WHEN TERM_OF_MEASURE/365 <= 0.25 THEN 0.25 ELSE TERM_OF_MEASURE/365 END AS TERM_OF_MEASURE_WEIGHT FROM rawtable A  ) , NEWWEIGHT AS ( SELECT A.*, CASE WHEN TERM_OF_MEASURE_WEIGHT >= 30 THEN 30  WHEN TERM_OF_MEASURE_WEIGHT >= 20 THEN 20 WHEN TERM_OF_MEASURE_WEIGHT >= 15 THEN 15  WHEN TERM_OF_MEASURE_WEIGHT >= 10 THEN 10  WHEN TERM_OF_MEASURE_WEIGHT >= 7 THEN 7 WHEN TERM_OF_MEASURE_WEIGHT >= 5 THEN 5 WHEN TERM_OF_MEASURE_WEIGHT >= 3 THEN 3 WHEN TERM_OF_MEASURE_WEIGHT >= 2 THEN 2 WHEN TERM_OF_MEASURE_WEIGHT >= 1 THEN 1  WHEN TERM_OF_MEASURE_WEIGHT >= 0.5 THEN 0.5  ELSE 0.25 END AS LOW_BUCKET ,CASE  WHEN TERM_OF_MEASURE_WEIGHT < 0.25 THEN 0.25 WHEN TERM_OF_MEASURE_WEIGHT < 0.5 THEN 0.5  WHEN TERM_OF_MEASURE_WEIGHT < 1 THEN 1 WHEN TERM_OF_MEASURE_WEIGHT < 2 THEN 2 WHEN TERM_OF_MEASURE_WEIGHT < 3 THEN 3 WHEN TERM_OF_MEASURE_WEIGHT < 5 THEN 5 WHEN TERM_OF_MEASURE_WEIGHT < 7 THEN 7  WHEN TERM_OF_MEASURE_WEIGHT < 10 THEN 10  WHEN TERM_OF_MEASURE_WEIGHT < 15 THEN 15 WHEN TERM_OF_MEASURE_WEIGHT < 20 THEN 20  WHEN TERM_OF_MEASURE_WEIGHT < 30 THEN 30 ELSE 30 END AS HIGH_BUCKET FROM WEIGHT A ) ,  FINAL_WEIGHT AS ( SELECT A.*, (HIGH_BUCKET - LOW_BUCKET) AS BUCKET_WIDTH ,CASE WHEN TERM_OF_MEASURE_WEIGHT <=0.25 THEN 1 WHEN TERM_OF_MEASURE_WEIGHT >=30 THEN 0 ELSE 1-((TERM_OF_MEASURE_WEIGHT - LOW_BUCKET)/(HIGH_BUCKET - LOW_BUCKET)) END AS LOW_BUCKET_WEIGHT ,CASE WHEN TERM_OF_MEASURE_WEIGHT <=0.25 THEN 0 WHEN TERM_OF_MEASURE_WEIGHT >=30 THEN 1 ELSE ((TERM_OF_MEASURE_WEIGHT - LOW_BUCKET)/(HIGH_BUCKET - LOW_BUCKET)) END AS HIGH_BUCKET_WEIGHT FROM NEWWEIGHT A  ) , RAWTABLE_WEIGHTED as ( SELECT  LOW_BUCKET AS term_new  ,i.product_group ,cob_date ,sum(i.USD_PV01*LOW_BUCKET_WEIGHT) AS USD_IR_UNIFIED_PV01 FROM FINAL_WEIGHT i group by  LOW_BUCKET  ,i.product_group ,cob_date  union all  SELECT  HIGH_BUCKET AS term_new  ,i.product_group ,cob_date ,sum(i.USD_PV01*HIGH_BUCKET_WEIGHT) AS USD_IR_UNIFIED_PV01 FROM FINAL_WEIGHT i group by  HIGH_BUCKET  ,i.product_group ,cob_date   ) select * from RAWTABLE_WEIGHTED