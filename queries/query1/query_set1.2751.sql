WITH VEGA_ALL AS ( SELECT cob_date, a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION AS PRODUCT_DESCRIPTION, a.PARTIAL_DECOMP_TICK AS TICKER, a.CCC_RISK_MANAGER_LOGIN AS CCC_RISK_MANAGER_LOGIN, SUM(USD_EQ_PARTIAL_KAPPA) AS KAPPA, ABS(SUM(USD_EQ_PARTIAL_KAPPA)) AS abs_KAPPA, RANK() OVER ( PARTITION BY cob_date,PARTIAL_DECOMP_PRODUCT_DESCRIPTION,PARTIAL_DECOMP_TICK ORDER BY ABS(SUM(COALESCE(USD_EQ_PARTIAL_KAPPA, 0))) DESC ) AS ranked_TICK, RANK() OVER ( PARTITION BY cob_date,PARTIAL_DECOMP_PRODUCT_DESCRIPTION,CCC_RISK_MANAGER_LOGIN ORDER BY ABS(SUM(COALESCE(USD_EQ_PARTIAL_KAPPA, 0))) DESC ) AS ranked_RM FROM CDWUSER.U_EXP_MSR_PARTIAL a where  COB_DATE IN ('2018-02-28','2018-02-27') AND A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND   ASSET_CLASS IN ('EQ') AND ( a.CCC_STRATEGY_DETAILS IN ('EMERGING MARKETS DSP', 'EMERGING MARKETS1', 'INVENTORY OPT EM', 'MSET EM DSP') OR a.CCC_RISK_MANAGER_LOGIN IN ('christeb', 'limaleo', 'portek', 'eliasc', 'pessoat', 'pintoand') ) AND a.ISSUER_COUNTRY_REGION = 'LATAM' AND a.ccc_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' OR a.ccc_banking_trading IS NULL ) AND (a.ccc_business_area NOT IN ('PROCESS DRIVEN TRADING')) AND 1 = 1 AND (USD_EQ_PARTIAL_KAPPA IS NOT NULL ) GROUP BY Cob_date,a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION,a.PARTIAL_DECOMP_TICK,a.CCC_RISK_MANAGER_LOGIN UNION SELECT cob_date, a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION AS PRODUCT_DESCRIPTION, a.PARTIAL_DECOMP_TICK AS TICKER, a.CCC_RISK_MANAGER_LOGIN AS CCC_RISK_MANAGER_LOGIN, SUM(usd_cm_kappa) AS CM_KAPPA, ABS(SUM(usd_cm_kappa)) AS abs_CM_KAPPA, RANK() OVER ( PARTITION BY cob_date,PARTIAL_DECOMP_PRODUCT_DESCRIPTION,PARTIAL_DECOMP_TICK ORDER BY ABS(SUM(COALESCE(usd_cm_kappa, 0))) DESC ) AS ranked_TICK, RANK() OVER ( PARTITION BY cob_date,PARTIAL_DECOMP_PRODUCT_DESCRIPTION,CCC_RISK_MANAGER_LOGIN ORDER BY ABS(SUM(COALESCE(usd_cm_kappa, 0))) DESC ) AS ranked_RM FROM CDWUSER.U_EXP_MSR_PARTIAL a where  COB_DATE IN ('2018-02-28','2018-02-27') AND A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND  ASSET_CLASS IN ('CM') AND ( a.CCC_STRATEGY_DETAILS IN ('EMERGING MARKETS DSP', 'EMERGING MARKETS1', 'INVENTORY OPT EM', 'MSET EM DSP') OR a.CCC_RISK_MANAGER_LOGIN IN ('christeb', 'limaleo', 'portek', 'eliasc', 'pessoat', 'pintoand') ) AND a.ISSUER_COUNTRY_REGION = 'LATAM' AND a.ccc_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' OR a.ccc_banking_trading IS NULL ) AND (a.ccc_business_area NOT IN ('PROCESS DRIVEN TRADING')) AND 1 = 1 AND ( USD_cm_KAPPA IS NOT NULL) GROUP BY Cob_date,a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION,a.PARTIAL_DECOMP_TICK,a.CCC_RISK_MANAGER_LOGIN ), VEGA AS ( SELECT COB_DATE,PRODUCT_DESCRIPTION,SUM(KAPPA)KAPPA,SUM(abs_KAPPA)abs_KAPPA, RANK() OVER ( ORDER BY ABS(SUM(COALESCE(KAPPA, 0))) DESC ) AS ranked FROM VEGA_ALL GROUP BY COB_DATE,PRODUCT_DESCRIPTION ) SELECT V.*, X.TICKER,X.CCC_RISK_MANAGER_LOGIN FROM VEGA_ALL X, VEGA V WHERE X.PRODUCT_DESCRIPTION=V.PRODUCT_DESCRIPTION AND X.COB_DATE=V.COB_DATE AND ranked_TICK=1 and ranked_RM=1 ORDER BY ranked