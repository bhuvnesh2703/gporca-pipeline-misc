with fid as (select CCC_DIVISION, ccc_business_area, mrd_rating as rating, sum (case when cob_date = '2018-02-28' then usd_pv01sprd else 0 end) as usd_pv01sprd, sum (case when cob_date = '2018-02-28' then usd_pv01sprd else -usd_pv01sprd end) as usd_pv01sprd_chng from CDWUSER.U_CR_MSR WHERE cob_date in ('2018-02-28', '2018-02-21') AND PARENT_LEGAL_ENTITY = '0302(G)' AND VAR_EXCL_FL <> 'Y' AND ccc_banking_trading = 'TRADING' GROUP BY CCC_DIVISION, ccc_business_area, mrd_rating), src as (select CCC_DIVISION as division, null as business_area, rating, sum(usd_pv01sprd) as usd_pv01sprd, sum(usd_pv01sprd_chng) as usd_pv01sprd_chng from fid GROUP BY CCC_DIVISION, rating union all select CCC_DIVISION as division, ccc_business_area as business_area, rating, sum(usd_pv01sprd) as usd_pv01sprd, sum(usd_pv01sprd_chng) as usd_pv01sprd_chng from fid where CCC_DIVISION = 'FIXED INCOME DIVISION' GROUP BY CCC_DIVISION, ccc_business_area, rating), ranked as (SELECT division, business_area, sum(case when rating = 'AAA' then usd_pv01sprd end) as spv01_aaa, sum(case when rating = 'AA' then usd_pv01sprd end) as spv01_aa, sum(case when rating = 'A' then usd_pv01sprd end) as spv01_a, sum(case when rating = 'BBB' then usd_pv01sprd end) as spv01_bbb, sum(case when rating = 'BB' then usd_pv01sprd end) as spv01_bb, sum(case when rating = 'B' then usd_pv01sprd end) as spv01_b, sum(case when rating in ('CCC','CC','C','D') then usd_pv01sprd end) as spv01_b_low, sum(case when coalesce(rating,'NR') not in ('AAA','AA','A', 'BBB','BB','B', 'CCC','CC','C','D') then usd_pv01sprd end) as spv01_nr, sum(usd_pv01sprd) AS pv01sprd, sum(case when rating = 'AAA' then usd_pv01sprd_chng end) as spv01_aaa_c, sum(case when rating = 'AA' then usd_pv01sprd_chng end) as spv01_aa_c, sum(case when rating = 'A' then usd_pv01sprd_chng end) as spv01_a_c, sum(case when rating = 'BBB' then usd_pv01sprd_chng end) as spv01_bbb_c, sum(case when rating = 'BB' then usd_pv01sprd_chng end) as spv01_bb_c, sum(case when rating = 'B' then usd_pv01sprd_chng end) as spv01_b_c, sum(case when rating in ('CCC','CC','C','D') then usd_pv01sprd_chng end) as spv01_b_low_c, sum(case when coalesce(rating,'NR') not in ('AAA','AA','A', 'BBB','BB','B', 'CCC','CC','C','D') then usd_pv01sprd_chng end) as spv01_nr_c, sum(usd_pv01sprd_chng) AS pv01sprd_c, least (rank() over(order by abs(sum(coalesce(case when business_area is null then usd_pv01sprd else 0 end,0))) desc ),20) as division_rank, rank() over(order by abs(sum(coalesce(case when business_area is not null then usd_pv01sprd else 0 end,0))) desc ) as fid_rank FROM src GROUP BY division, business_area) select * from (SELECT division_rank as rank, case division_rank when 20 then 'Other' else division end as division, business_area, sum(spv01_aaa) spv01_aaa, sum(spv01_aaa_c) spv01_aaa_c, sum(spv01_aa) spv01_aa, sum(spv01_aa_c) spv01_aa_c, sum(spv01_a) spv01_a, sum(spv01_a_c) spv01_a_c, sum(spv01_bbb) spv01_bbb, sum(spv01_bbb_c) spv01_bbb_c, sum(spv01_bb) spv01_bb, sum(spv01_bb_c) spv01_bb_c, sum(spv01_b) spv01_b, sum(spv01_b_c) spv01_b_c, sum(spv01_b_low) spv01_b_low, sum(spv01_b_low_c) spv01_b_low_c, sum(spv01_nr) spv01_nr, sum(spv01_nr_c) spv01_nr_c, sum(pv01sprd) pv01sprd, sum(pv01sprd_c) pv01sprd_c FROM ranked t WHERE business_area is null GROUP BY division_rank, case division_rank when 20 then 'Other' else division end, business_area union SELECT 20+fid_rank as rank, division, business_area, sum(spv01_aaa) spv01_aaa, sum(spv01_aaa_c) spv01_aaa_c, sum(spv01_aa) spv01_aa, sum(spv01_aa_c) spv01_aa_c, sum(spv01_a) spv01_a, sum(spv01_a_c) spv01_a_c, sum(spv01_bbb) spv01_bbb, sum(spv01_bbb_c) spv01_bbb_c, sum(spv01_bb) spv01_bb, sum(spv01_bb_c) spv01_bb_c, sum(spv01_b) spv01_b, sum(spv01_b_c) spv01_b_c, sum(spv01_b_low) spv01_b_low, sum(spv01_b_low_c) spv01_b_low_c, sum(spv01_nr) spv01_nr, sum(spv01_nr_c) spv01_nr_c, sum(pv01sprd) pv01sprd, sum(pv01sprd_c) pv01sprd_c FROM ranked t WHERE business_area is not null GROUP BY 20+fid_rank, division, business_area) B order by rank fetch first 20 rows only