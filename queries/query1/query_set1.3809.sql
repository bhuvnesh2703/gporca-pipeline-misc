SELECT a.COB_DATE, RANK() OVER( PARTITION BY a.COB_DATE ORDER BY sum(coalesce(a.USD_EXPOSURE,0)) desc) as RANK, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.FID1_SENIORITY, a.TAPSCUSIP, sum(coalesce(a.USD_EXPOSURE,0))/1000 as USD_EXPOSURE FROM cdwuser.U_EXP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.CCC_DIVISION = 'FIXED INCOME DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.CCC_BUSINESS_AREA = 'CREDIT-CORPORATES' AND a.CCC_PRODUCT_LINE NOT IN ('DISTRESSED TRADING') AND a.GICS_LEVEL_1_NAME = 'FINANCIALS' AND a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME NOT IN ('GAS NATURAL SDG, S.A.','AT SECURITIES B.V.') AND a.PAYOFF_MODEL = 'BONDSETCOCO' AND a.USD_EXPOSURE <> 0 AND a.CCC_TAPS_COMPANY = '0302' GROUP BY a.COB_DATE, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.FID1_SENIORITY, a.TAPSCUSIP