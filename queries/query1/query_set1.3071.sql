SELECT dense_rank() over (order by RANK_DATE asc) as RANK, FACILITY_TYPE, reset_date, CASE WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '1 month') THEN '1-Month ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '3 Year') THEN '3-Year ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '5 Year') THEN '5-Year ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '7 Year') THEN '7-Year ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '10 Year') THEN '10-Year ARM Jumbo' ELSE book END AS JUMBO_TYPE, RESET_Q, SUM(NOTIONAL) as NOTIONAL, SUM(PV01) as PV01, SUM(MARKET_VALUE) AS MARKET_VALUE, SUM((PV01/MARKET_VALUE)*-10000) as Duration From ( SELECT t.BOOK, t. FACILITY_TYPE, t.RESET_DATE, extract (year from t.RESET_DATE)||extract (quarter from t.RESET_DATE)||'Q' as RANK_DATE, extract (quarter from t.RESET_DATE)||'Q '||extract (year from t.RESET_DATE) as RESET_Q, SUM(t.NOTIONAL) ::numeric(15,5) as NOTIONAL, SUM(t.PV01) ::numeric(15,5)as PV01, SUM(t.MARKET_VALUE) ::numeric(15,5) AS MARKET_VALUE FROM ( SELECT a.book, a.FACILITY_TYPE, CASE WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '1 month') THEN (A.ISSUE_DATE + interval '1 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '3 Year') THEN (A.ISSUE_DATE + interval '36 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '5 Year') THEN (A.ISSUE_DATE + interval '60 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '7 Year') THEN (A.ISSUE_DATE + interval '84 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '10 Year') THEN (A.ISSUE_DATE + interval '120 month') ELSE A.ISSUE_DATE END AS RESET_DATE, SUM(A.USD_NOTIONAL) ::numeric(15,5) AS NOTIONAL, SUM(A.USD_MARKET_VALUE) ::numeric(15,5) AS MARKET_VALUE, SUM(A.USD_IR_UNIFIED_PV01) ::numeric(15,5) AS PV01 FROM cdwuser.U_DM_WM A WHERE A.COB_DATE = '2018-02-28' AND A.CCC_TAPS_COMPANY = '6635' AND A.VAR_EXCL_FL<> 'Y' AND (A.CCC_STRATEGY = 'HELD FOR INVESTMENT - (HFI)' OR A.CCC_DIVISION = 'HELD FOR INVESTMENT - (HFI)' ) AND A.CCC_PRODUCT_LINE = 'MSCC MORTGAGE LOAN ORIGINATIONS-GWMG' AND A.BOOK LIKE '%ARM%' group by a.book, a.FACILITY_TYPE, CASE WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '1 month') THEN (A.ISSUE_DATE + interval '1 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '3 Year') THEN (A.ISSUE_DATE + interval '36 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '5 Year') THEN (A.ISSUE_DATE + interval '60 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '7 Year') THEN (A.ISSUE_DATE + interval '84 month') WHEN SUBSTR(A.BOOK, STRPOS(A.BOOK, 'HTM') + 4, 2) IN (interval '10 Year') THEN (A.ISSUE_DATE + interval '120 month') ELSE A.ISSUE_DATE END ) t WHERE t.RESET_DATE >'2018-02-28' GROUP BY t.BOOK, t.FACILITY_TYPE, t.RESET_DATE, extract (quarter from t.RESET_DATE)||'Q '||extract (year from t.RESET_DATE), extract (year from t.RESET_DATE)|| extract (quarter from t.RESET_DATE)||'Q' ) t GROUP BY CASE WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '1 month') THEN '1-Month ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '3 Year') THEN '3-Year ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '5 Year') THEN '5-Year ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '7 Year') THEN '7-Year ARM Jumbo' WHEN SUBSTR(BOOK, STRPOS(BOOK, 'HTM') + 4, 2) IN (interval '10 Year') THEN '10-Year ARM Jumbo' ELSE book END, RESET_Q, FACILITY_TYPE, reset_date, RANK_DATE