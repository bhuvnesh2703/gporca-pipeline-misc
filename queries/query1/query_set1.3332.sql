select cob_date, currency, sum(usd_notional::numeric(15,5)) as usd_notional, BANK_FLAG, LIQUIDITY_SECTYPE, LIQUIDITY_SECTYPE2, case when LIQUIDITY_SECTYPE2 like '%Overnight Reverse repos%' or LIQUIDITY_SECTYPE2 like '%Overnight Reverse Repos%' then 'Overnight Reverse repos' when LIQUIDITY_SECTYPE2 like '%Term Reverse Repos%' then 'Term Reverse Repos' when LIQUIDITY_SECTYPE2 like '%Investment Portfolio%' then 'Investment Portfolio' else LIQUIDITY_SECTYPE2 END AS LIQUIDITY_SECTYPE3 from ( select COB_DATE, CURRENCY_OF_MEASURE AS CURRENCY, PRODUCT_TYPE_CODE, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') THEN 'OTHER BANK' ELSE 'NON-BANK' END AS BANK_FLAG, case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE in ('SWAP','CASH','MMF') then 'Cash' when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') AND CCC_GL_COMPANY_CODE in ('0101', '7622') THEN 'Parent Pool Securities' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') AND CCC_GL_COMPANY_CODE not in ('0101', '7622') THEN 'Subsidiary Pool Securities' end as LIQUIDITY_SECTYPE, case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE in ('SWAP','CASH','MMF') then 'Cash' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RPOTO','RPOAF') then 'Securities Pool - Term Reverse Repos - NY' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') then 'Securities Pool - Term Reverse Repos - LN' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK in ('RWILX') then 'Securities Pool - Term Reverse Repos - AP' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU') then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse repos' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book ='TSTPM' THEN 'Investment Portfolio - AFS' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book ='TSTJY' THEN 'Investment Portfolio - JGB' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book ='LIABB' THEN 'Investment Portfolio - US Gvt Bonds' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book not in ('TSTPM','TSTJY','LIABB') then 'Investment Portfolio - Other' end as LIQUIDITY_SECTYPE2, SUM(COALESCE(case when ccc_gl_company_code='0101' and CURRENCY_OF_MEASURE='USD' and counterparty_account='0889AHWC7' and product_type_code='SWAP' and extract(dow from cob_date) =6 and term_of_measure > 3 then 0 when ccc_gl_company_code='0101' and CURRENCY_OF_MEASURE='USD' and counterparty_account='0889AHWC7' and product_type_code='SWAP' and extract(dow from cob_date) <>6 and term_of_measure > 1 then 0 WHEN book in('SWPIN','TDET6', 'TAIRR', 'TAEMR', 'TEEMR', 'HKFAP', 'TTIRR', 'HKFAM', 'TKFVS', 'HKFAS', 'TBAGR') THEN -usd_notional WHEN (book in('CALLT', 'CALTB', 'LCALT', 'LCATB')) THEN usd_MARKET_VALUE else usd_notional END, 0)) as USD_NOTIONAL from cdwuser.U_OT_MSR a where cob_date in ('2018-02-28', '2018-02-27') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and CCC_BUSINESS_AREA = 'LIQUIDITY RESERVE1' and (a.CURRENCY_REGION_CD = 'ASIA' or a.CURRENCY_OF_MEASURE in ('JPY', 'NZD', 'AUD')) and not (BOOK in ('TSTJY') and PRODUCT_HIERARCHY_LEVEL7 = 'IR_SWAP 0 OR 1 LEG') and USD_NOTIONAL is not null and not (PRODUCT_TYPE_CODE in ('SWAP','CASH') and currency_of_measure in ('INR') and CCC_GL_COMPANY_CODE not in ('8976','0679','1050','0650')) and not (PRODUCT_TYPE_CODE in ('SWAP','CASH') and currency_of_measure in ('CNY') and CCC_GL_COMPANY_CODE not in ('6262','5848','8179','5254')) and not (PRODUCT_TYPE_CODE in ('SWAP','CASH') and currency_of_measure in ('KRW') and CCC_GL_COMPANY_CODE not in ('0853','4391')) and not (PRODUCT_TYPE_CODE in ('SWAP','CASH') and currency_of_measure in ('TWD') and CCC_GL_COMPANY_CODE not in ('0993')) and not (PRODUCT_TYPE_CODE in ('SWAP','CASH') and currency_of_measure in ('SGD') and CCC_GL_COMPANY_CODE in ('0884','0880','0991','1275','0879')) and not (PRODUCT_TYPE_CODE in ('SWAP','CASH') and currency_of_measure in ('AED','ARS','BDT','BGN','BHD','CLP','COP','CZK','EGP','HRK','HUF','IDR','ILS','ISK','KES','KWD','KZT','LKR','LTL','MAD','MXN','MYR','NGN','OMR','PEN','PHP','PKR','PLN','QAR','RON','RSD','RUB','SAR','THB','TND','TRY','UAH','VEF','VND','ZAR')) group by COB_DATE, CURRENCY_OF_MEASURE, ccc_gl_company_code, counterparty_account, product_type_code, term_of_measure, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') THEN 'OTHER BANK' ELSE 'NON-BANK' END, case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE in ('SWAP','CASH','MMF') then 'Cash' when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') AND CCC_GL_COMPANY_CODE in ('0101', '7622') THEN 'Parent Pool Securities' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') AND CCC_GL_COMPANY_CODE not in ('0101', '7622') THEN 'Subsidiary Pool Securities' end , case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE in ('SWAP','CASH','MMF') then 'Cash' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RPOTO','RPOAF') then 'Securities Pool - Term Reverse Repos - NY' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') then 'Securities Pool - Term Reverse Repos - LN' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK in ('RWILX') then 'Securities Pool - Term Reverse Repos - AP' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU') then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse repos' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book ='TSTPM' THEN 'Investment Portfolio - AFS' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book ='TSTJY' THEN 'Investment Portfolio - JGB' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book ='LIABB' THEN 'Investment Portfolio - US Gvt Bonds' when PRODUCT_TYPE_CODE not in ('REPO','CASH','SWAP','MMF') and book not in ('TSTPM','TSTJY','LIABB') then 'Investment Portfolio - Other' end union all select COB_DATE, CURRENCY_OF_MEASURE AS CURRENCY, PRODUCT_TYPE_CODE, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') THEN 'OTHER BANK' ELSE 'NON-BANK' END AS BANK_FLAG, case when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' end as LIQUIDITY_SECTYPE, case when PRODUCT_TYPE_CODE = 'REPO' AND (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse Repos' end as LIQUIDITY_SECTYPE2 , sum(coalesce(CASE WHEN book in('SWPIN','TDET6', 'TAIRR', 'TAEMR', 'TEEMR', 'HKFAP', 'TTIRR', 'HKFAM', 'TKFVS', 'HKFAS', 'TBAGR') THEN -usd_notional WHEN (book in('CALLT', 'CALTB', 'LCALT', 'LCATB')) THEN usd_MARKET_VALUE else usd_notional END, 0)) as USD_NOTIONAL from cdwuser.U_OT_MSR b where cob_date in ('2018-02-28', '2018-02-27') and CCC_DIVISION = 'OVERHEAD INTEREST' and (b.CURRENCY_REGION_CD = 'ASIA' or b.CURRENCY_OF_MEASURE in ('JPY', 'NZD', 'AUD')) and CCC_PRODUCT_LINE='MSSB TREASURY LIQUIDITY' and PRODUCT_TYPE_CODE='REPO' and USD_NOTIONAL is not null group by COB_DATE, CURRENCY_OF_MEASURE, PRODUCT_TYPE_CODE, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') THEN 'OTHER BANK' ELSE 'NON-BANK' END, case when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' end, case when PRODUCT_TYPE_CODE = 'REPO' AND (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse Repos' end union all select COB_DATE ,CURRENCY_OF_MEASURE AS CURRENCY ,PRODUCT_TYPE_CODE , Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') THEN 'OTHER BANK' ELSE 'NON-BANK' END AS BANK_FLAG , 'CASH' as LIQUIDITY_SECTYPE , 'CASH' as LIQUIDITY_SECTYPE2 , sum(coalesce(CASE WHEN book in('SWPIN','TDET6', 'TAIRR', 'TAEMR', 'TEEMR', 'HKFAP', 'TTIRR', 'HKFAM', 'TKFVS', 'HKFAS', 'TBAGR') THEN -usd_notional WHEN (book in('CALLT', 'CALTB', 'LCALT', 'LCATB')) THEN usd_MARKET_VALUE else usd_notional END, 0)) as USD_NOTIONAL from cdwuser.U_OT_MSR c where cob_date in ('2018-02-28', '2018-02-27') and CCC_DIVISION = 'WM UNALLOCATED OTH' and (c.CURRENCY_REGION_CD = 'ASIA'or c.CURRENCY_OF_MEASURE in ('JPY', 'NZD', 'AUD')) and CCC_BUSINESS_AREA='JV DIRECT UNALLOCATED OTHER' and PRODUCT_TYPE_CODE='MMF' and USD_NOTIONAL is not null and CCC_GL_COMPANY_CODE NOT IN ('1633','6635','0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') group by COB_DATE,CURRENCY_OF_MEASURE,PRODUCT_TYPE_CODE , Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171', '4391', '4512', '4562', '5848', '5849', '6262', '7012') THEN 'OTHER BANK' ELSE 'NON-BANK' END ) A group by cob_date, currency, BANK_FLAG, LIQUIDITY_SECTYPE, LIQUIDITY_SECTYPE2, case when LIQUIDITY_SECTYPE2 like '%Overnight Reverse repos%' or LIQUIDITY_SECTYPE2 like '%Overnight Reverse Repos%' then 'Overnight Reverse repos' when LIQUIDITY_SECTYPE2 like '%Term Reverse Repos%' then 'Term Reverse Repos' when LIQUIDITY_SECTYPE2 like '%Investment Portfolio%' then 'Investment Portfolio' else LIQUIDITY_SECTYPE2 END