SELECT x.PL_REPORTING_REGION as PNL_REGION, x.STRATEGY, 'Total' as Commissions, x.YTD_PNL as MAX_YTD_PNL, max(xx.PNL_DATE) as DATE_OF_MAX FROM ( select PL_REPORTING_REGION, STRATEGY, max(YTD_PNL) as YTD_PNL from ( SELECT q.cob_date as pnl_date, q.ccc_pl_reporting_region as pl_reporting_region, q.ccc_strategy as strategy, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' AND q.cob_date <= '2018-02-28' and NOT q.cob_date='2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_pl_reporting_region, q.ccc_strategy ) ax group by PL_REPORTING_REGION, STRATEGY ) x INNER JOIN ( SELECT q.cob_date as pnl_date, q.ccc_strategy as strategy, q.ccc_pl_reporting_region as pl_reporting_region, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' and NOT q.cob_date='2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_strategy, q.ccc_pl_reporting_region ) xx ON (x.STRATEGY, x.PL_REPORTING_REGION, x.YTD_PNL) = (xx.STRATEGY, xx.PL_REPORTING_REGION, xx.YTD_PNL) GROUP BY x.PL_REPORTING_REGION, x.STRATEGY, x.YTD_PNL UNION ALL SELECT x.PL_REPORTING_REGION as PNL_REGION, x.STRATEGY, x.Commissions, x.YTD_PNL as MAX_YTD_PNL, max(xx.PNL_DATE) as DATE_OF_MAX FROM ( select PL_REPORTING_REGION, STRATEGY, Commissions, max(YTD_PNL) as YTD_PNL from ( SELECT q.cob_date as pnl_date, q.ccc_pl_reporting_region as pl_reporting_region, q.ccc_strategy as strategy, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end as Commissions, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' AND q.cob_date <= '2018-02-28' and NOT q.cob_date='2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_pl_reporting_region, q.ccc_strategy, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end ) ax group by PL_REPORTING_REGION, STRATEGY, Commissions ) x INNER JOIN ( SELECT q.cob_date as pnl_date, q.ccc_strategy as strategy, q.ccc_pl_reporting_region as pl_reporting_region, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end as Commissions, round(sum(q.ytd_pl),2)/1000000 as YTD_PNL FROM cdwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >= '2018-01-01' and q.cob_date <= '2018-02-28' and NOT q.cob_date='2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) GROUP BY q.cob_date, q.ccc_strategy, q.ccc_pl_reporting_region, case when q.financial_element in ('AGENCY', 'MSCAP FEES', 'MSCI FEES', 'RISK') then 'Commissions' else 'Trading' end ) xx ON (x.STRATEGY, x.PL_REPORTING_REGION, x.YTD_PNL,x.Commissions) = (xx.STRATEGY, xx.PL_REPORTING_REGION, xx.YTD_PNL,xx.Commissions) GROUP BY x.PL_REPORTING_REGION, x.STRATEGY, x.Commissions, x.YTD_PNL