SELECT COB_DATE, CATEGORY, DIVISION_GROUP, CASE WHEN RANK_EQ < 8 THEN COUNTRY_OF_RISK ELSE 'OTHERS' END AS COUNTRY_OF_RISK, SUM(EQ_DELTA) AS SUM_EQ_DELTA, RANK_EQ FROM ( SELECT COB_DATE, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('STRUCTURED RATES', 'LIQUID FLOW RATES') THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING') THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP', 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT','COMMODITIES') THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN DIVISION_GROUP IN ('ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG') THEN DIVISION_GROUP WHEN CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION') AND DIVISION_GROUP IN ('ISG CORE', 'ISG NON CORE') THEN 'OTHER ISG' ELSE 'NON ISG' END AS CATEGORY, DIVISION_GROUP, COUNTRY_OF_RISK, EQ_DELTA, DENSE_RANK() OVER ( ORDER BY CASE WHEN EQ_DELTA_COB IS NULL THEN 1 ELSE 0 END ASC, ABS(EQ_DELTA_COB) DESC ) RANK_EQ FROM ( SELECT B.COB_DATE, B.COUNTRY_OF_RISK, B.CCC_DIVISION, B.CCC_BUSINESS_AREA, B.DIVISION_GROUP, B.EQ_DELTA, SUM(B.EQ_DELTA_COB) OVER (PARTITION BY COUNTRY_OF_RISK) EQ_DELTA_COB FROM ( SELECT COB_DATE, CASE WHEN ISSUER_COUNTRY_CODE IN ('XS', 'UNDEFINED') THEN A.CURRENCY_OF_MEASURE ELSE COALESCE(ISSUER_COUNTRY_CODE, A.CURRENCY_OF_MEASURE) END AS COUNTRY_OF_RISK, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION IN ( 'BANK RESOURCE MANAGEMENT','COMMODITIES','FID UNDEFINED', 'FIXED INCOME DIVISION','INSTITUTIONAL EQUITY DIVISION' ) THEN 'ISG CORE' ELSE 'NON_ISG CORE' END AS DIVISION_GROUP, SUM ( COALESCE ( CAST ( A.USD_EQ_DELTA_DECOMP AS NUMERIC (15,5) ) , 0 ) ) / 1000 AS EQ_DELTA, SUM ( CASE WHEN COB_DATE = '02/28/2018' THEN COALESCE ( CAST ( A.USD_EQ_DELTA_DECOMP AS NUMERIC (15,5) ) , 0 ) END ) EQ_DELTA_COB FROM CDWUSER.U_DM_EQ A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND A.CCC_BANKING_TRADING <> 'BANKING' GROUP BY COB_DATE, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION IN ( 'BANK RESOURCE MANAGEMENT','COMMODITIES','FID UNDEFINED', 'FIXED INCOME DIVISION','INSTITUTIONAL EQUITY DIVISION' ) THEN 'ISG CORE' ELSE 'NON_ISG CORE' END, CASE WHEN ISSUER_COUNTRY_CODE IN ('XS', 'UNDEFINED') THEN A.CURRENCY_OF_MEASURE ELSE COALESCE(ISSUER_COUNTRY_CODE, A.CURRENCY_OF_MEASURE) END ) B ) C ) D GROUP BY COB_DATE, CATEGORY, DIVISION_GROUP, CASE WHEN RANK_EQ < 8 THEN COUNTRY_OF_RISK ELSE 'OTHERS' END, RANK_EQ