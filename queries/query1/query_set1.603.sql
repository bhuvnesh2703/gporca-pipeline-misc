Select a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.PRODUCT_TYPE_CODE, CASE WHEN a.PRODUCT_SUB_TYPE_CODE IN ('N EAST CONSUMPTI', 'N EAST CONSUMPTION') THEN 'N EAST CONSUMPTI' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('N EAST APPALACHI', 'N EAST APPALACHIA') THEN 'N EAST APPALACHI' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('POLYPROPELENE HO', 'POLYPROPELENE HOMOPOLYMER') THEN 'POLYPROPELENE HO' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('POLYPROPYLENE CO', 'POLYPROPYLENE COPOLYMER') THEN 'POLYPROPYLENE CO' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('PURE TEREPHTHALI', 'PURE TEREPHTHALIC ACID') THEN 'PURE TEREPHTHALI' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('GSCI-PRECIOUS ME', 'GSCI-PRECIOUS METALS') THEN 'GSCI-PRECIOUS ME' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('ZERO PRICED EXPO', 'ZERO PRICED EXPOSURE') THEN 'ZERO PRICED EXPO' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('DJUBS-BASE METAL', 'DJUBS-BASE METALS') THEN 'DJUBS-BASE METAL' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('GAS SULFUR CREDI', 'GAS SULFUR CREDIT') THEN 'GAS SULFUR CREDI' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('GASOIL TIMESPREA', 'GASOIL TIMESPREAD') THEN 'GASOIL TIMESPREA' WHEN a.PRODUCT_SUB_TYPE_CODE IN ('USD INTEREST RAT', 'USD INTEREST RATE') THEN 'USD INTEREST RAT' ELSE a.PRODUCT_SUB_TYPE_CODE END AS PRODUCT_SUB_TYPE_CODE, a.TIME_BUCKET_CALENDAR, a.QUARTERS, SUM(a.DELTA_GREEK) as DELTA_GREEK, a.CurrentMonth, a.POSITION_EXPIRY_YEAR, SUM(a.LEASE_GREEK) as LEASE_GREEK, SUM(a.VEGA_GREEK) as VEGA_GREEK, SUM(a.GAMMA_GREEK) as GAMMA_GREEK, SUM(a.THETA_GREEK) as THETA_GREEK ,SUM(A.FX_DELTA) AS FX_DELTA, SUM(a.RHO_GREEK) AS RHO_GREEK FROM( Select PRODUCT_TYPE_CODE,CCC_PL_REPORTING_REGION, PRODUCT_SUB_TYPE_CODE, COB_DATE, EXPIRATION_DATE, time_bucket_quarter, TIME_BUCKET_CALENDAR, POSITION_EXPIRY_YEAR,POSITION_EXPIRY_QUARTER, SUM(cast(USD_CM_DELTA as numeric (15,5))) as DELTA_GREEK, SUM(cast(RAW_CM_LEASE_RATE/1000 as numeric(15,5))) as LEASE_GREEK, SUM (CASE WHEN PRODUCT_TYPE_CODE = 'TIMESPREAD' AND PROD_POS_NAME_DESCRIPTION = 'WCS POST SPREAD' THEN 0 WHEN (book = 'COMXO' and CCC_PRODUCT_LINE IN ('COMMOD EXOTICS')) then CAST(USD_CM_KAPPA_ABSOLUTE AS NUMERIC (15, 5)) ELSE CAST (RAW_CM_KAPPA AS NUMERIC (15, 5)) END) as VEGA_GREEK, SUM(cast(USD_CM_GAMMA/20 as numeric (15,5))) as GAMMA_GREEK, SUM(cast(USD_CM_THETA as numeric (15,5))) as THETA_GREEK, SUM(CAST(USD_FX_DELTA AS NUMERIC(15, 5))) AS FX_DELTA, SUM(CAST(coalesce(USD_IR_RHO,0) AS NUMERIC(15, 5)) + CAST(coalesce(USD_CM_LEASE_RATE,0) AS NUMERIC(15, 5)))/10 AS RHO_GREEK, case when EXPIRATION_DATE < ('2019-09-01')then extract(MONTH from (EXPIRATION_DATE)) end as CurrentMonth, case when EXPIRATION_DATE < ('2019-09-01')and time_bucket_quarter <> 'UNDEFINED' then time_bucket_quarter when EXPIRATION_DATE < ('2019-01-27')and time_bucket_quarter = 'UNDEFINED' then POSITION_EXPIRY_QUARTER end as quarters FROM cdwuser.U_EXP_MSR Where COB_DATE IN ('2018-02-28','2018-02-21') AND ((CCC_BUSINESS_AREA = 'INVESTOR BUSINESS' AND CCC_PRODUCT_LINE = 'IB INDEX' AND CCC_DIVISION IN ('COMMODITIES')) /*OLD LOGIC*/ OR (CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' and CCC_PRODUCT_LINE IN ('COMMOD INDEX'))) /*NEW LOGIC*/ AND CCC_PL_REPORTING_REGION = 'AMERICAS' AND PRODUCT_TYPE_CODE not in ('CVA', 'FVA','MISC') AND (CCC_PL_REPORTING_REGION IN ('EUROPE','EMEA')) GROUP BY PRODUCT_TYPE_CODE,CCC_PL_REPORTING_REGION, PRODUCT_SUB_TYPE_CODE, TIME_BUCKET_CALENDAR, EXPIRATION_DATE, COB_DATE, time_bucket_quarter,POSITION_EXPIRY_YEAR,POSITION_EXPIRY_QUARTER)A GROUP BY a.COB_DATE, a.PRODUCT_TYPE_CODE, a.CCC_PL_REPORTING_REGION, a.PRODUCT_SUB_TYPE_CODE, a.TIME_BUCKET_CALENDAR, a.QUARTERS, a.CurrentMonth, a.POSITION_EXPIRY_YEAR