WITH POPULATION AS( SELECT PRODUCT_DESCRIPTION, STRIPPED_PROD_DESC, ONE_X, ONE_X_POS, TWO_X, TWO_X_POS, IS_CLC, TICKER, PAYOFF_MODEL, sum(coalesce(USD_DELTA,0)) as USD_DELTA, sum(coalesce(ISSUANCE_SIZE,0)) * -1 as ISSUANCE_SIZE, sum(coalesce(LEVERAGE,0)) as LEVERAGE FROM ( SELECT CASE WHEN a.CCC_FULL_NAME1 LIKE '%FX%' THEN a.CURRENCY_PAIR ELSE a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE END as Ticker, a.PRODUCT_DESCRIPTION, CASE WHEN POSITION(' X' IN a.PRODUCT_DESCRIPTION)>0 THEN 1 ELSE 0 END as ONE_X, POSITION(' X' IN a.PRODUCT_DESCRIPTION) as ONE_X_POS, CASE WHEN POSITION(' X' IN SUBSTR(a.PRODUCT_DESCRIPTION, POSITION(' X' IN a.PRODUCT_DESCRIPTION)+2,LENGTH(a.PRODUCT_DESCRIPTION)-POSITION(' X' IN a.PRODUCT_DESCRIPTION)+2))>0 THEN 1 ELSE 0 END as TWO_X, POSITION(' X' IN SUBSTR(a.PRODUCT_DESCRIPTION, POSITION(' X' IN a.PRODUCT_DESCRIPTION)+2,LENGTH(a.PRODUCT_DESCRIPTION)-POSITION(' X' IN a.PRODUCT_DESCRIPTION)+2)) as TWO_X_POS, SUBSTR(a.PRODUCT_DESCRIPTION, POSITION(' X' IN a.PRODUCT_DESCRIPTION)+2,LENGTH(a.PRODUCT_DESCRIPTION)-POSITION(' X' IN a.PRODUCT_DESCRIPTION)+2) as STRIPPED_PROD_DESC, a.CCC_FULL_NAME1, a.PAYOFF_MODEL, CASE WHEN a.PAYOFF_MODEL = 'CONSTANTLEVERAGECERTIFICATE' THEN 1 ELSE 0 END as IS_CLC, CASE WHEN a.CCC_FULL_NAME1 LIKE '%FX%' THEN sum(coalesce(a.USD_FX_DELTA,0)) ELSE sum(coalesce(a.USD_DELTA,a.USD_CM_DELTA)) END as USD_DELTA, CASE WHEN (a.CCC_FULL_NAME1 LIKE '%ISSUANCE%' OR a.CCC_FULL_NAME1 = 'INDEX GERMANY DEALER') THEN sum(coalesce(a.USD_DELTA,a.USD_CM_DELTA,a.USD_FX_DELTA,0)) ELSE 0 END as ISSUANCE_SIZE, CASE WHEN a.CCC_FULL_NAME1 = 'ETP FX INVENTORY' AND POSITION('Long' IN a.PRODUCT_DESCRIPTION)<> 0 THEN ROUND((a.STRIKE+a.MARK_OF_POSITION)/a.MARK_OF_POSITION,2) WHEN a.CCC_FULL_NAME1 = 'ETP FX INVENTORY' AND POSITION('Mini' IN a.PRODUCT_DESCRIPTION)<> 0 THEN ROUND((a.STRIKE-a.MARK_OF_POSITION)/a.MARK_OF_POSITION,2) ELSE ROUND(ABS(a.UNDERLIER_PRICE/(a.STRIKE-a.UNDERLIER_PRICE)),2)/2 END as LEVERAGE, CASE WHEN a.CCC_FULL_NAME1 = 'ETP FX INVENTORY' THEN ABS(sum(coalesce(a.USD_FX_DELTA,0))) ELSE ABS(sum(coalesce(a.USD_DELTA,a.USD_CM_DELTA))) END as ABS_USD_DELTA FROM CDWUSER.U_EXP_MSR_PARTIAL a WHERE a.COB_DATE ='2018-02-28' AND a.CCC_HIERARCHY_LEVEL10 = 'ETP MAIN' AND a.PAYOFF_MODEL in ('MINIFUTURECERTIFICATE','CONSTANTLEVERAGECERTIFICATE','DELTAONECERTIFICATE','OPENENDEDTURBOCERTIFICATE') AND a.CCC_RISK_MANAGER_LOGIN = 'freemric' AND a.CURRENCY_PAIR <> 'USDUSD' AND a.CCC_FULL_NAME1 LIKE '%ETP FX%' AND a.CURRENCY_OF_MEASURE = 'SEK' GROUP BY CASE WHEN a.CCC_FULL_NAME1 LIKE '%FX%' THEN a.CURRENCY_PAIR ELSE a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE END, a.PRODUCT_DESCRIPTION, a.PAYOFF_MODEL, a.STRIKE, a.UNDERLIER_PRICE, a.CCC_FULL_NAME1, a.MARK_OF_POSITION ) a GROUP BY PRODUCT_DESCRIPTION, STRIPPED_PROD_DESC, ONE_X, ONE_X_POS, TWO_X, TWO_X_POS, IS_CLC, TICKER, PAYOFF_MODEL ) /*Extract leverage from product description*/ SELECT RANK() OVER(ORDER BY ABS(USD_DELTA) DESC) as RANK, PRODUCT_DESCRIPTION, TICKER, PAYOFF_MODEL, USD_DELTA, ISSUANCE_SIZE, LEVERAGE, CASE WHEN USD_DELTA<0 THEN-1*COALESCE(1/NULLIF(LEVERAGE,0),0) WHEN USD_DELTA>0 THEN COALESCE(1/NULLIF(LEVERAGE,0),0) ELSE 0 END AS GAP_UNDERLIER_MOVE, ABS(USD_DELTA) as ABS_USD_DELTA, ABS(ISSUANCE_SIZE) AS ABS_ISSUANCE_SIZE FROM ( SELECT CASE WHEN IS_CLC=1 AND TWO_X=1 AND SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2,1) IN('1','2','3','4','5','6','7','8','9') AND POSITION(' ' IN SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2))=0 THEN SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2)::double precision WHEN IS_CLC=1 AND TWO_X=1 AND SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2,1) IN('1','2','3','4','5','6','7','8','9') AND POSITION(' ' IN SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2))<>0 THEN SUBSTR(SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2),1,POSITION(' ' IN SUBSTR(STRIPPED_PROD_DESC, TWO_X_POS+2)))::double precision WHEN IS_CLC=1 AND ONE_X=1 AND SUBSTR(STRIPPED_PROD_DESC, 1,1) IN('1','2','3','4','5','6','7','8','9') AND POSITION(' ' IN STRIPPED_PROD_DESC)<>0 THEN SUBSTR(STRIPPED_PROD_DESC,1 ,POSITION(' ' IN STRIPPED_PROD_DESC))::double precision WHEN IS_CLC=1 AND ONE_X=1 AND SUBSTR(STRIPPED_PROD_DESC, 1,1) IN('1','2','3','4','5','6','7','8','9') AND POSITION(' ' IN STRIPPED_PROD_DESC)=0 THEN STRIPPED_PROD_DESC::double precision WHEN IS_CLC=1THEN 0 ELSE LEVERAGE END AS LEVERAGE, PRODUCT_DESCRIPTION, STRIPPED_PROD_DESC, TICKER, PAYOFF_MODEL, USD_DELTA, ISSUANCE_SIZE FROM POPULATION ) a WHERE ISSUANCE_SIZE<>0