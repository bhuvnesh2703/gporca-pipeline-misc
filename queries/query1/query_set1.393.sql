select A.COB_DATE, A.PROD_POS_NAME_DESCRIPTION, A.QUARTERS, CASE WHEN a.CCC_BUSINESS_AREA = 'COMMODITIES' THEN a.CCC_PRODUCT_LINE ELSE a.CCC_BUSINESS_AREA END AS CCC_BUSINESS_AREA, A.TIME_BUCKET_CALENDAR, A.PRODUCT_TYPE_CODE, CASE WHEN A.PRODUCT_SUB_TYPE_CODE IN ('N EAST CONSUMPTI', 'N EAST CONSUMPTION') THEN 'N EAST CONSUMPTION' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('N EAST APPALACHI', 'N EAST APPALACHIA') THEN 'N EAST APPALACHIA' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('POLYPROPELENE HO', 'POLYPROPELENE HOMOPOLYMER') THEN 'POLYPROPELENE HO' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('POLYPROPYLENE CO', 'POLYPROPYLENE COPOLYMER') THEN 'POLYPROPYLENE CO' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('PURE TEREPHTHALI', 'PURE TEREPHTHALIC ACID') THEN 'PURE TEREPHTHALI' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('GSCI-PRECIOUS ME', 'GSCI-PRECIOUS METALS') THEN 'GSCI-PRECIOUS ME' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('ZERO PRICED EXPO', 'ZERO PRICED EXPOSURE') THEN 'ZERO PRICED EXPO' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('DJUBS-BASE METAL', 'DJUBS-BASE METALS') THEN 'DJUBS-BASE METAL' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('GAS SULFUR CREDI', 'GAS SULFUR CREDIT') THEN 'GAS SULFUR CREDI' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('GASOIL TIMESPREA', 'GASOIL TIMESPREAD') THEN 'GASOIL TIMESPREA' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('USD INTEREST RAT', 'USD INTEREST RATE') THEN 'USD INTEREST RAT' ELSE A.PRODUCT_SUB_TYPE_CODE END AS PRODUCT_SUB_TYPE_CODE, sum(A.DOLLAR_GREEK) as DOLLAR_GREEK, sum(A.RAW_GREEK) as RAW_GREEK FROM (Select prod_pos_name_description,COB_DATE,ccc_business_area, CCC_PRODUCT_LINE, product_type_code,time_bucket_calendar, EXPIRATION_DATE,time_bucket_quarter, sum(cast(USD_CM_Delta as numeric(15,5))) as dollar_greek, sum(cast(RAW_CM_Delta as numeric(15,5))) as raw_greek, case when EXPIRATION_DATE < ('2019-09-01') then time_bucket_quarter end as quarters, case when product_type_code in ('EAST OFF','EAST PEAK','MIDWEST OFF', 'MIDWEST PEAK','TEXAS OFF','TEXAS PEAK','WEST OFF','WEST PEAK','GRNPWR OFF','GRNPWR PEAK','EAST INTERCONNECT OF','EAST INTERCONNECT PE','TEXAS INTERCONNECT O', 'TEXAS INTERCONNECT P', 'ERCOT', 'WEST INTERCONNECT OF', 'WEST INTERCONNECT PE') then 'Electricity' when product_type_code in ('NATGAS','EUR NG','EURO PWR') then product_type_code end as GE_DETAIL0, CASE WHEN PRODUCT_SUB_TYPE_CODE IN ('NEPOOL O', 'NE_ISO_O') then 'NE ISO' WHEN PRODUCT_SUB_TYPE_CODE IN ('NY O', 'NY_ISO_O') then 'NY ISO' WHEN PRODUCT_SUB_TYPE_CODE IN ('PJM_O') OR PROD_POS_NAME_DESCRIPTION in ('AEP-O','COMED-O','DAYTON-O','DQE-O','KAMMER-O','NIHUB-O','SOUTHWEST-O','BGE-O','DOMINION-O', 'JCPL-O', 'MET EDISON-O', 'PENNPOWER-O', 'PJM_DPL-O', 'PJM_PECO-O', 'PJM_PEPCO-O', 'PJM_PSEG-O', 'PJM-AECO-O', 'PJMW-O', 'PPL-O', 'SOUTHEAST-O') THEN 'PJM' WHEN PRODUCT_SUB_TYPE_CODE IN ('PJM_P') OR PROD_POS_NAME_DESCRIPTION in ('AEP-P','COMED-P','DAYTON-P','DQE-P','KAMMER-P','NIHUB-P','SOUTHWEST-P','BGE-P','DOMINION-P', 'JCPL-P', 'MET EDISON-P', 'PENNPOWER-P', 'PJM_DPL-P', 'PJM_PECO-P', 'PJM_PEPCO-P', 'PJM_PSEG-P', 'PJM-AECO-P', 'PJMW-P', 'PPL-P', 'SOUTHEAST-P') THEN 'PJM' WHEN PRODUCT_SUB_TYPE_CODE IN ('SERC_O') then 'SERC' WHEN PRODUCT_SUB_TYPE_CODE IN ('SERC_P') then 'SERC' WHEN PRODUCT_SUB_TYPE_CODE IN ('SPP_O') then 'SPP' WHEN PRODUCT_SUB_TYPE_CODE IN ('SPP_P') then 'SPP' WHEN PRODUCT_SUB_TYPE_CODE IN ('NEPOOL P', 'NE_ISO_P') then 'NE ISO' WHEN PRODUCT_SUB_TYPE_CODE IN ('NY P', 'NY_ISO_P') then 'NY ISO' WHEN PRODUCT_SUB_TYPE_CODE = 'MIDWEST_P' OR PROD_POS_NAME_DESCRIPTION IN ( 'ALTE-P', 'ALTW-P', 'CINERGY-P','ILL HUB-P', 'MICH HUB-P', 'MINNHUB-P', 'MISO ENTERGY INTERFACE-P', 'MP-P') THEN 'MIDWEST' WHEN PRODUCT_SUB_TYPE_CODE = 'MIDWEST_O' OR PROD_POS_NAME_DESCRIPTION IN ( 'ALTE-O', 'ALTW-O', 'CINERGY-O', 'ILL HUB-O', 'MICH HUB-O', 'MINNHUB-O', 'MISO ENTERGY INTERFACE-O', 'MP-O') THEN 'MIDWEST' when PRODUCT_SUB_TYPE_CODE ='ERCOT H O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOTH-O') then 'ERCOT H' when PRODUCT_SUB_TYPE_CODE ='ERCOT N O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT N-O') then 'ERCOT N' when PRODUCT_SUB_TYPE_CODE ='ERCOT W O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT W SCURRY WIND INDEX', 'ERCOTW-O') then 'ERCOT W' when PRODUCT_SUB_TYPE_CODE ='ERCOT S O' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT S-O') then 'ERCOT S' when PRODUCT_SUB_TYPE_CODE ='ERCOT N P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT N-P') then 'ERCOT N' when PRODUCT_SUB_TYPE_CODE ='ERCOT H P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOTH-P') then 'ERCOT H' when PRODUCT_SUB_TYPE_CODE ='ERCOT W P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOTW-P') then 'ERCOT W' when PRODUCT_SUB_TYPE_CODE ='ERCOT S P' OR PROD_POS_NAME_DESCRIPTION in ('ERCOT S-P', 'ERCOT S 345KV-P') then 'ERCOT S' WHEN PRODUCT_SUB_TYPE_CODE IN ('CALIFORNIA OFF', 'CAISO_O') then 'CAISO' WHEN PRODUCT_SUB_TYPE_CODE IN ('CANADA OFF', 'AESO_O') then 'AESO' WHEN PRODUCT_SUB_TYPE_CODE IN ('NORTHWEST OFF', 'WECC_NORTH_O') then 'WECC NORTH' WHEN PRODUCT_SUB_TYPE_CODE IN ('SOUTHWEST OFF', 'WECC_SOUTH_O') then 'WECC SOUTH' WHEN PRODUCT_SUB_TYPE_CODE IN ('CALIFORNIA PEAK', 'CAISO_P') then 'CAISO' WHEN PRODUCT_SUB_TYPE_CODE IN ('CANADA PEAK', 'AESO_P') then 'AESO' WHEN PRODUCT_SUB_TYPE_CODE IN ('NORTHWEST PEAK', 'WECC_NORTH_P') then 'WECC NORTH' WHEN PRODUCT_SUB_TYPE_CODE IN ('SOUTHWEST PEAK', 'WECC_SOUTH_P') then 'WECC SOUTH' ELSE 'OTHER' END AS PRODUCT_SUB_TYPE_CODE FROM cdwuser.U_CM_MSR Where COB_DATE IN ('2018-02-28','2018-02-27') AND ((CCC_DIVISION='COMMODITIES' AND CCC_BUSINESS_AREA not in ('CREDIT','MS CVA MNE - COMMOD', 'COMMODS FINANCING','INVESTMENTS AND STR TRANS','INVESTOR BUSINESS')) OR(CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' AND CCC_PRODUCT_LINE NOT IN ('COMMOD LENDING', 'COMMOD EXOTICS', 'COMMOD INDEX') AND CCC_STRATEGY NOT IN ('MS CVA MNE - COMMOD', 'CMD LEGACY LAONS & CLAIMS', 'CVA RISK MANAGEMENT', 'FVA RISK MANAGEMENT', 'FUNDING COLLATERAL COMM'))) /* NEW LOGIC*/ AND PRODUCT_TYPE_CODE in ('EAST OFF','EAST PEAK','MIDWEST OFF', 'MIDWEST PEAK','TEXAS OFF','TEXAS PEAK','WEST OFF', 'WEST PEAK','GRNPWR OFF', 'GRNPWR PEAK', 'EAST INTERCONNECT OF','EAST INTERCONNECT PE','TEXAS INTERCONNECT O', 'TEXAS INTERCONNECT P', 'ERCOT', 'WEST INTERCONNECT OF', 'WEST INTERCONNECT PE') AND (CCC_PL_REPORTING_REGION IN ('EUROPE','EMEA')) and NOT(INCLUDE_IN_REG_CAAP_FL = 'N' and PRODUCT_SUB_TYPE_CODE in ('N EAST CONSUMPTI', 'N EAST CONSUMPTION', 'N EAST APPALACHI', 'N EAST APPALACHIA') and BOOK = '18003') Group By prod_pos_name_description,COB_DATE, CCC_BUSINESS_AREA,CCC_PRODUCT_LINE, product_type_code,PRODUCT_SUB_TYPE_CODE,time_bucket_calendar, EXPIRATION_DATE,time_bucket_quarter)A GROUP BY A.COB_DATE, A.PROD_POS_NAME_DESCRIPTION, A.QUARTERS, CASE WHEN a.CCC_BUSINESS_AREA = 'COMMODITIES' THEN a.CCC_PRODUCT_LINE ELSE a.CCC_BUSINESS_AREA END, A.TIME_BUCKET_CALENDAR, A.PRODUCT_TYPE_CODE, A.PRODUCT_SUB_TYPE_CODE