select COB_DATE, EXPYEAR, EXPMONTH, CCC_BUSINESS_AREA, POWERGAS, CCC_TRD_BOOK, CCC_PRODUCT_LINE, CCC_STRATEGY, sum(DOLLAR_DELTA) as DOLLAR_DELTA FROM ( Select prod_pos_name_description,COB_DATE, ccc_business_area,product_type_code, EXTRACT (YEAR FROM EXPIRATION_DATE) as EXPYEAR, EXTRACT (month FROM EXPIRATION_DATE) AS EXPMONTH, EXPIRATION_DATE, CCC_TRD_BOOK,product_sub_type_code,CCC_PRODUCT_LINE, CCC_STRATEGY, sum(USD_CM_Delta) as DOLLAR_DELTA, sum(RAW_CM_Delta) as raw_greek, case when product_type_code in ('EAST OFF', 'EAST PEAK', 'MIDWEST OFF', 'MIDWEST PEAK', 'TEXAS OFF', 'TEXAS PEAK', 'WEST OFF', 'WEST PEAK','GRNPWR OFF', 'GRNPWR PEAK','EAST INTERCONNECT OF','EAST INTERCONNECT PE','TEXAS INTERCONNECT O', 'TEXAS INTERCONNECT P', 'ERCOT', 'WEST INTERCONNECT OF', 'WEST INTERCONNECT PE') then 'ELECTRICITY' when product_type_code in ('NATGAS') then 'NATGAS' else 'OTHER' end as POWERGAS FROM cdwuser.U_CM_MSR WHERE COB_DATE in ('2018-02-28','2018-01-31') AND ((CCC_BUSINESS_AREA in ('NA ELECTRICITYNATURAL GAS') AND CCC_DIVISION in ('COMMODITIES')) /* OLD LOGIC*/ or (CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' and CCC_PRODUCT_LINE IN ('NA POWER & GAS'))) /*NEW LOGIC*/ AND product_type_code in ('EAST OFF', 'EAST PEAK', 'MIDWEST OFF', 'MIDWEST PEAK', 'TEXAS OFF', 'TEXAS PEAK', 'WEST OFF', 'WEST PEAK','GRNPWR OFF','GRNPWR PEAK','EAST INTERCONNECT OF','EAST INTERCONNECT PE','TEXAS INTERCONNECT O', 'TEXAS INTERCONNECT P', 'ERCOT', 'WEST INTERCONNECT OF', 'WEST INTERCONNECT PE','NATGAS') and NOT(INCLUDE_IN_REG_CAAP_FL = 'N' and PRODUCT_SUB_TYPE_CODE in ('N EAST CONSUMPTI', 'N EAST CONSUMPTION', 'N EAST APPALACHI', 'N EAST APPALACHIA') and BOOK = '18003') Group By prod_pos_name_description,COB_DATE,ccc_business_area,product_type_code, EXPIRATION_DATE,CCC_PRODUCT_LINE, CCC_TRD_BOOK,CCC_STRATEGY, product_sub_type_code)A GROUP BY COB_DATE, CCC_BUSINESS_AREA, EXPYEAR, EXPMONTH,CCC_PRODUCT_LINE, CCC_STRATEGY, CCC_TRD_BOOK,POWERGAS