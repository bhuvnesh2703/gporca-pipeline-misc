WITH CONVRT_DESK AS ( SELECT a.POSITION_ISSUER_PARTY_DARWIN_NAME, SUM(COALESCE(a.USD_EXPOSURE,0))+SUM(COALESCE(a.USD_DELTA,0)) as JTD, SUM(a.USD_EXPOSURE) as USD_EXPOSURE, SUM(a.USD_DELTA) as USD_DELTA, SUM(CASE WHEN a.USD_EXPOSURE > 0 THEN a.USD_EXPOSURE END) as USD_EXPOSURE_LONG, AVG(a.CREDIT_SPREAD) as CREDIT_SPREAD, COALESCE(SUM(CASE WHEN a.USD_EXPOSURE > 0 THEN a.USD_EXPOSURE * a.CREDIT_SPREAD END)/SUM(CASE WHEN a.USD_EXPOSURE > 0 THEN a.USD_EXPOSURE END),AVG(a.CREDIT_SPREAD)) as CREDIT_SPREAD_ADJ FROM ( SELECT DISTINCT CASE WHEN a.POSITION_ISSUER_PARTY_DARWIN_NAME LIKE '%REPUBLIC OF CHINA' THEN a.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME ELSE a.POSITION_ISSUER_PARTY_DARWIN_NAME END AS POSITION_ISSUER_PARTY_DARWIN_NAME, a.UNDERLIER_TICK||'.'||a.UNDERLIER_EXCH as UL, CASE WHEN a.PRODUCT_TYPE_CODE in ('ASCOT','CDSOPTIDX','CONVRT','CRDINDEX','DEFSWAP') THEN a.USD_EXPOSURE ELSE NULL END AS USD_EXPOSURE, CASE WHEN a.PRODUCT_TYPE_CODE NOT IN ('ASCOT','CDSOPTIDX','CONVRT','CRDINDEX','DEFSWAP') THEN a.USD_DELTA ELSE NULL END AS USD_DELTA, a.CREDIT_SPREAD From CDWUSER.U_EXP_MSR_PARTIAL a WHERE a.COB_DATE IN ('2018-02-28') AND a.CCC_STRATEGY = 'CONVERTIBLES' And a.CCC_BANKING_TRADING = 'TRADING' ) a GROUP BY a.POSITION_ISSUER_PARTY_DARWIN_NAME ), CONVRT_SWAP_HEDGE_NAMES AS ( SELECT CASE WHEN a.POSITION_ISSUER_PARTY_DARWIN_NAME LIKE '%REPUBLIC OF CHINA' THEN a.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME ELSE a.POSITION_ISSUER_PARTY_DARWIN_NAME END AS POSITION_ISSUER_PARTY_DARWIN_NAME, a.TICKER||'.'||a.EXCHANGE as TICKER, a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE as PART_TICK From CDWUSER.U_EXP_MSR_PARTIAL a WHERE a.COB_DATE IN ('2018-02-28') AND a.CCC_STRATEGY <> 'CONVERTIBLES' And a.CCC_BANKING_TRADING = 'TRADING' AND (a.PRODUCT_TYPE_CODE IN ('ASCOT','CONVRT') OR a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE in ('ASCOT','CONVRT')) GROUP BY 1,2,3 ), NON_CONVRT_DESK AS ( SELECT a.POSITION_ISSUER_PARTY_DARWIN_NAME, SUM(COALESCE(a.USD_EXPOSURE,0))-SUM(COALESCE(a.USD_DELTA,0)) as JTD, SUM(a.USD_EXPOSURE) as USD_EXPOSURE, SUM(a.USD_DELTA) as USD_DELTA, SUM(CASE WHEN a.USD_EXPOSURE > 0 THEN a.USD_EXPOSURE END) as USD_EXPOSURE_LONG, AVG(a.CREDIT_SPREAD) as CREDIT_SPREAD, COALESCE(SUM(CASE WHEN a.USD_EXPOSURE > 0 THEN a.USD_EXPOSURE * a.CREDIT_SPREAD END)/SUM(CASE WHEN a.USD_EXPOSURE > 0 THEN a.USD_EXPOSURE END),AVG(a.CREDIT_SPREAD)) as CREDIT_SPREAD_ADJ FROM ( SELECT DISTINCT CASE WHEN a.POSITION_ISSUER_PARTY_DARWIN_NAME LIKE '%REPUBLIC OF CHINA' THEN a.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME WHEN a.POSITION_ISSUER_PARTY_DARWIN_NAME='UNDEFINED' THEN c.POSITION_ISSUER_PARTY_DARWIN_NAME ELSE a.POSITION_ISSUER_PARTY_DARWIN_NAME END AS POSITION_ISSUER_PARTY_DARWIN_NAME, a.POSITION_ISSUER_PARTY_DARWIN_NAME as UN_ADJ_POSITION_ISSUER_PARTY_DARWIN_NAME, a.TICKER||'.'||a.EXCHANGE as TICKER, a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE as PART_TICK, a.PRODUCT_TYPE_CODE, a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE, a.USD_EXPOSURE, a.USD_DELTA, a.CREDIT_SPREAD From CDWUSER.U_EXP_MSR_PARTIAL a left join CONVRT_SWAP_HEDGE_NAMES c ON a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE=c.TICKER WHERE a.COB_DATE IN ('2018-02-28') AND a.CCC_STRATEGY <> 'CONVERTIBLES' And a.CCC_BANKING_TRADING = 'TRADING' /*Original Line: AND a.PRODUCT_TYPE_CODE IN ('ASCOT','CDSOPTIDX','CONVRT','CRDINDEX','DEFSWAP')*/ /*All the Default Swap products have been Temporarily removed, generated high exposure most of them Sovereign*/ AND (a.PRODUCT_TYPE_CODE IN ('ASCOT','CONVRT') OR a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE in ('ASCOT','CONVRT')) ORDER BY ABS(a.USD_EXPOSURE) DESC ) a GROUP BY a.POSITION_ISSUER_PARTY_DARWIN_NAME ) SELECT * FROM ( SELECT RANK() OVER(PARTITION BY SPREAD_BUCKET ORDER BY JTD DESC) as JTD_RANK, a.CREDIT_SPREAD, a.CREDIT_SPREAD_ADJ, a.SPREAD_BUCKET, a.SPREAD_BUCKET_ORDER, a.POSITION_ISSUER_PARTY_DARWIN_NAME, a.USD_EXPOSURE, a.USD_EXPOSURE_LONG, a.USD_DELTA, a.JTD, a.JTD_LIMITS, (a.JTD/a.JTD_LIMITS) as USAGE, CASE WHEN a.JTD>a.JTD_LIMITS THEN 1 ELSE 0 END AS LIMIT_EXCESS FROM ( SELECT a.*, CASE WHEN a.CREDIT_SPREAD_ADJ <=100 THEN '<100' WHEN a.CREDIT_SPREAD_ADJ >100 AND a.CREDIT_SPREAD_ADJ <=250 THEN '100-250' WHEN a.CREDIT_SPREAD_ADJ >250 AND a.CREDIT_SPREAD_ADJ <=500 THEN '250-500' WHEN a.CREDIT_SPREAD_ADJ >500 THEN '>500' END AS SPREAD_BUCKET, CASE WHEN a.CREDIT_SPREAD_ADJ <=100 THEN 50 WHEN a.CREDIT_SPREAD_ADJ >100 AND a.CREDIT_SPREAD_ADJ <=250 THEN 40 WHEN a.CREDIT_SPREAD_ADJ >250 AND a.CREDIT_SPREAD_ADJ <=500 THEN 20 WHEN a.CREDIT_SPREAD_ADJ >500 THEN 10 END AS JTD_LIMITS, CASE WHEN a.CREDIT_SPREAD_ADJ <=100 THEN 1 WHEN a.CREDIT_SPREAD_ADJ >100 AND a.CREDIT_SPREAD_ADJ <=250 THEN 2 WHEN a.CREDIT_SPREAD_ADJ >250 AND a.CREDIT_SPREAD_ADJ <=500 THEN 3 WHEN a.CREDIT_SPREAD_ADJ >500 THEN 4 END AS SPREAD_BUCKET_ORDER FROM ( SELECT a.POSITION_ISSUER_PARTY_DARWIN_NAME, SUM(a.JTD)/1000 as JTD, SUM(a.USD_EXPOSURE)/1000 as USD_EXPOSURE, SUM(a.USD_DELTA)/1000 as USD_DELTA, SUM(a.USD_EXPOSURE_LONG)/1000 as USD_EXPOSURE_LONG, AVG(a.CREDIT_SPREAD) as CREDIT_SPREAD, COALESCE(SUM(a.USD_EXPOSURE_LONG * a.CREDIT_SPREAD_ADJ)/SUM(A.USD_EXPOSURE_LONG),AVG(a.CREDIT_SPREAD)) as CREDIT_SPREAD_ADJ FROM ( SELECT * FROM CONVRT_DESK UNION ALL SELECT * FROM NON_CONVRT_DESK ) a GROUP BY POSITION_ISSUER_PARTY_DARWIN_NAME )a )a ) a WHERE JTD_RANK<=5 OR LIMIT_EXCESS=1