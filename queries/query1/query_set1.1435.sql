SELECT RANK() OVER(ORDER BY ABS(SUM(D30)) DESC) as RANK, UNDERLIER_PRODUCT_DESCRIPTION, SUM(D30) AS D30, SUM(D20) AS D20, SUM(D10) AS D10, SUM(D05) AS D05, SUM(D02) AS D02, SUM(P02) AS P02, SUM(P05) AS P05, SUM(P10) AS P10, SUM(P20) AS P20 FROM ( SELECT CASE WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('bcoil.msny','spgsbrp.iomr') THEN 'BRENT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xau=.idnr','spgsgcp.iomr','sgld.l', 'xau.us', 'xau=.shd') THEN 'GOLD' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgssip.iomr','xag=.idnr', 'xag=.shd') THEN 'SILVER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpt=.shd','xpt=.idnr','spgsplp.iomr') THEN 'PLATINUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpd=.shd','xpd=.idnr','spgspap.iomr') THEN 'PALLADIUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('sb.msny','spgssbp.iomr') THEN 'SUGAR' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('wti.msdy','spgsclp.iomr') THEN 'WTI' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgscnp.iomr','ng-w-hh.shd', 'spgsngp.iomr') THEN 'NAT GAS' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgskcp.iomr','kc.msny') THEN 'COFFEE' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgswhp.iomr','2srw-kcm.idn') THEN 'WHEAT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cc.msny','spgsccp.iomr') THEN 'COCOA' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cttn.msny') THEN 'COTTON' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('c-us2y-kc.idn') THEN 'CORN' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cmcu3.lmer') THEN 'LME COPPER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('hg.msny','spgshgp.iomr') THEN 'HG COPPER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgshup.iomr') THEN 'GASOLINE' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgshop.iomr') THEN 'HEATING OIL' ELSE a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH END as UNDERLIER_PRODUCT_DESCRIPTION, a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH as Ticker, sum(coalesce(a.SLIDE_EQ_MIN_30_USD,0))/1000+sum(coalesce(a.SLIDE_CM_MIN_30_USD,0))/1000 as D30, sum(coalesce(a.SLIDE_EQ_MIN_20_USD,0))/1000+sum(coalesce(a.SLIDE_CM_MIN_20_USD,0))/1000 as D20, sum(coalesce(a.SLIDE_EQ_MIN_10_USD,0))/1000+sum(coalesce(a.SLIDE_CM_MIN_10_USD,0))/1000 as D10, sum(coalesce(a.SLIDE_EQ_MIN_05_USD,0))/1000+sum(coalesce(a.SLIDE_CM_MIN_05_USD,0))/1000 as D05, sum(coalesce(a.SLIDE_EQ_MIN_02_USD,0))/1000+sum(coalesce(a.SLIDE_CM_MIN_02_USD,0))/1000 as D02, sum(coalesce(a.SLIDE_EQ_PLS_02_USD,0))/1000+sum(coalesce(a.SLIDE_CM_PLS_02_USD,0))/1000 as P02, sum(coalesce(a.SLIDE_EQ_PLS_05_USD,0))/1000+sum(coalesce(a.SLIDE_CM_PLS_05_USD,0))/1000 as P05, sum(coalesce(a.SLIDE_EQ_PLS_10_USD,0))/1000+sum(coalesce(a.SLIDE_CM_PLS_10_USD,0))/1000 as P10, sum(coalesce(a.SLIDE_EQ_PLS_20_USD,0))/1000+sum(coalesce(a.SLIDE_CM_PLS_20_USD,0))/1000 as P20 FROM CDWUSER.U_EXP_MSR a WHERE a.COB_DATE ='2018-02-28' AND a.CCC_RISK_MANAGER_LOGIN = 'freemric' AND a.CCC_BOOK_DETAIL IN('DSP ETP COMMODITY', 'DE_COMMODITY') GROUP BY CASE WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('bcoil.msny','spgsbrp.iomr') THEN 'BRENT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xau=.idnr','spgsgcp.iomr','sgld.l', 'xau.us', 'xau=.shd') THEN 'GOLD' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgssip.iomr','xag=.idnr', 'xag=.shd') THEN 'SILVER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpt=.shd','xpt=.idnr','spgsplp.iomr') THEN 'PLATINUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpd=.shd','xpd=.idnr','spgspap.iomr') THEN 'PALLADIUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('sb.msny','spgssbp.iomr') THEN 'SUGAR' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('wti.msdy','spgsclp.iomr') THEN 'WTI' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgscnp.iomr','ng-w-hh.shd', 'spgsngp.iomr') THEN 'NAT GAS' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgskcp.iomr','kc.msny') THEN 'COFFEE' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgswhp.iomr','2srw-kcm.idn') THEN 'WHEAT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cc.msny','spgsccp.iomr') THEN 'COCOA' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cttn.msny') THEN 'COTTON' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('c-us2y-kc.idn') THEN 'CORN' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cmcu3.lmer') THEN 'LME COPPER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('hg.msny','spgshgp.iomr') THEN 'HG COPPER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgshup.iomr') THEN 'GASOLINE' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgshop.iomr') THEN 'HEATING OIL' ELSE a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH END, a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH ) a GROUP BY UNDERLIER_PRODUCT_DESCRIPTION