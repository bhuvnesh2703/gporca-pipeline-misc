SELECT * FROM ( SELECT a.COB_DATE, CASE WHEN (a.CCC_BUSINESS_AREA IN ('CPM TRADING (MPE)','CPM', 'CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') OR a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING')) THEN 'XVA' WHEN a.CCC_DIVISION in ('FIXED INCOME DIVISION','INSTITUTIONAL EQUITY DIVISION') then a.CCC_DIVISION when a.CCC_DIVISION in ('COMMODITIES','TREASURY CAPITAL MARKETS','BANK RESOURCE MANAGEMENT','FID DVA','FIC DVA','NON CORE') Then 'FID DVA,TCM,BRM' ELSE 'Others' END AS CCC_DIVISION, a.CCC_BUSINESS_AREA, a.CCC_PRODUCT_LINE, a.CCC_STRATEGY, a.RISK_MANAGER_LOCATION, CASE WHEN a.EXECUTIVE_MODEL = 'UNDEFINED' THEN a.BASE_MODEL_NAME ELSE a.EXECUTIVE_MODEL END AS MODEL, CASE when (a.ccc_division ='INSTITUTIONAL EQUITY DIVISION' and ( USD_IR_KAPPA<>0 or USD_EQ_KAPPA <>0 or USD_FX_KAPPA <>0)) then 'DERIVATIVES' WHEN a.PRODUCT_TYPE_CODE IN ('REPO','CONVBOND','ZBOND','BANKDEBT','BOND', 'CASH', 'EQUITY', 'FEE', 'FX', 'GVTBOND', 'PREF', 'TRS - BOND', 'TRS - GVTBOND', 'TRD_CLAIM', 'BOND ETF', 'BONDIL', 'CLNBOND','MUNI','STOCK','FUND','ETF','GVTBONDIL','ADR','AGN','FRN') THEN 'CASH' ELSE 'DERIVATIVES' END AS CATEGORY, case when CCC_STRATEGY_DETAILS = 'CMD CDS' then 'ExclCVA' when (CCC_BUSINESS_AREA in ('CPM TRADING (MPE)','CPM', 'CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') and a.CCC_STRATEGY_DETAILS not like '%HEDGE%' ) then 'CVA' when (a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING') and a.CCC_STRATEGY_DETAILS not like '%HEDGE%' ) then 'CVA' else'ExclCVA' end as Flagcva, case when a.RISK_MANAGER_LOCATION in ('LONDON') then 'Y' else 'N' end as IS_LONDON, sum(coalesce(a.USD_DELTA,0)+coalesce(a.USD_CM_DELTA,0))/1000 as USD_DELTA, sum(coalesce(a.USD_EQ_KAPPA,0)) as USD_EQ_KAPPA, sum((case when currency_of_measure not in ('USD', 'UBD') then coalesce(a.usd_fx,0) else 0 end))/1000 as USD_FX_DELTA, sum(coalesce(a.USD_FX_KAPPA,0)) as USD_FX_KAPPA, sum(coalesce(a.USD_EXPOSURE,0))/1000 as USD_EXPOSURE, sum(Case when A.FID1_SENIORITY IN ('AT1', 'SUBT1', 'SUBUT2') then 0 when A.CCC_PRODUCT_LINE IN ('DISTRESSED TRADING') then 0 else coalesce(A.USD_PV10_BENCH,a.USD_CREDIT_PV10PCT) end ) as USD_PV10, sum(coalesce(a.USD_IR_UNIFIED_PV01,0)) as USD_IR_UNIFIED_PV01, sum(coalesce(a.USD_IR_KAPPA,0))/10 as USD_IR_KAPPA FROM CDWUSER.U_EXP_MSR a WHERE a.COB_DATE IN ('2018-02-28','2018-02-21') AND a.LE_GROUP = 'UK' GROUP BY a.COB_DATE, CASE WHEN (a.CCC_BUSINESS_AREA IN ('CPM TRADING (MPE)','CPM', 'CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') OR a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING')) THEN 'XVA' WHEN a.CCC_DIVISION in ('FIXED INCOME DIVISION','INSTITUTIONAL EQUITY DIVISION') then a.CCC_DIVISION when a.CCC_DIVISION in ('COMMODITIES','TREASURY CAPITAL MARKETS','BANK RESOURCE MANAGEMENT','FID DVA','FIC DVA','NON CORE') Then 'FID DVA,TCM,BRM' ELSE 'Others' END , a.CCC_BUSINESS_AREA, a.CCC_PRODUCT_LINE, a.CCC_STRATEGY, a.RISK_MANAGER_LOCATION, CASE WHEN a.EXECUTIVE_MODEL = 'UNDEFINED' THEN a.BASE_MODEL_NAME ELSE a.EXECUTIVE_MODEL END, CASE when (a.ccc_division ='INSTITUTIONAL EQUITY DIVISION' and ( USD_IR_KAPPA<>0 or USD_EQ_KAPPA <>0 or USD_FX_KAPPA <>0)) then 'DERIVATIVES' WHEN a.PRODUCT_TYPE_CODE IN ('REPO','CONVBOND','ZBOND','BANKDEBT','BOND', 'CASH', 'EQUITY', 'FEE', 'FX', 'GVTBOND', 'PREF', 'TRS - BOND', 'TRS - GVTBOND', 'TRD_CLAIM', 'BOND ETF', 'BONDIL', 'CLNBOND','MUNI','STOCK','FUND','ETF','GVTBONDIL','ADR','AGN','FRN') THEN 'CASH' ELSE 'DERIVATIVES' END, case when CCC_STRATEGY_DETAILS = 'CMD CDS' then 'ExclCVA' when (CCC_BUSINESS_AREA in ('CPM TRADING (MPE)','CPM', 'CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') and a.CCC_STRATEGY_DETAILS not like '%HEDGE%' ) then 'CVA' when (a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING') and a.CCC_STRATEGY_DETAILS not like '%HEDGE%' ) then 'CVA' else'ExclCVA' end, case when a.RISK_MANAGER_LOCATION in ('LONDON') then 'Y' else 'N' end ) a WHERE ( ABS(coalesce(USD_DELTA,0))+ ABS(coalesce(USD_EQ_KAPPA,0))+ ABS(coalesce(USD_FX_DELTA,0))+ ABS(coalesce(USD_FX_KAPPA,0))+ ABS(coalesce(USD_EXPOSURE,0))+ ABS(coalesce(USD_PV10,0))+ ABS(coalesce(USD_IR_UNIFIED_PV01,0))+ ABS(coalesce(USD_IR_KAPPA,0)) ) <>0