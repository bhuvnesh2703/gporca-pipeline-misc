WITH data as ( SELECT product_description, tick, 'TopVega' Concentration0, CASE WHEN SN_FLAG = 1 THEN 'TopVegaStock' END Concentration1, CASE WHEN SN_FLAG = 1 and EMEAFlag = 1 THEN 'TopEuVegaStock' END Concentration2, CASE WHEN EMEAFlag = 1 THEN 'TopEuVega' END Concentration3, CASE WHEN EMEAFlag = 1 and VS_Flag = 1 THEN 'TopEuVsVega' END Concentration4, CASE WHEN SN_FLAG = 1 and MsipFlag = 1 and SynFlag = 0 THEN 'TopMsipExSVegaStock' END Concentration5, CASE WHEN MsipFlag = 1 and SynFlag = 0 THEN 'TopMsipExSVega' END Concentration6, CASE WHEN SN_FLAG = 1 and MsslFlag = 1 and SynFlag = 0 THEN 'TopMsslExSVegaStock' END Concentration7, CASE WHEN MsslFlag = 1 and SynFlag = 0 THEN 'TopMsslExSVega' END Concentration8, CASE WHEN SN_FLAG = 1 and MsipFlag = 1 THEN 'TopMsipVegaStock' END Concentration9, CASE WHEN MsipFlag = 1 THEN 'TopMsipVega' END Concentration10, CASE WHEN SN_FLAG = 1 and MsslFlag = 1 THEN 'TopMsslVegaStock' END Concentration11, CASE WHEN MsslFlag = 1 THEN 'TopMsslVega' END Concentration12, CASE WHEN SN_FLAG = 1 and MsbilFlag = 1 THEN 'TopMsbilVegaStock' END Concentration13, CASE WHEN MsbilFlag = 1 THEN 'TopMsbilVega' END Concentration14, VS_FLAG, desk, EXECUTIVE_MODEL, MsslFlag, SynFlag, MsbilFlag, KappaCOB, KappaCOMP, KappaDOD , EMEAFlag from ( select CASE WHEN e.DIVISION = 'IED' THEN 1 ELSE 0 END IS_INCLUDED, e.PARTIAL_DECOMP_PRODUCT_DESCRIPTION as product_description, e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE as tick, CASE WHEN e.CASH_ISSUE_TYPE in ('STOCK','ADR') or e.Partial_Decomp_Sector in ('STOCK','ADR') THEN 1 ELSE 0 END AS SN_FLAG, case when e.CCC_PL_REPORTING_REGION = 'EMEA' then 1 else 0 end as EMEAFlag, CASE WHEN UPPER(e.EXECUTIVE_MODEL) LIKE '%VAR-SWAP%' OR UPPER(e.EXECUTIVE_MODEL) LIKE '%VARIANCESWAP%' THEN 1 ELSE 0 END AS VS_FLAG, e.CCC_STRATEGY as desk, e.EXECUTIVE_MODEL, Case when e.CCC_TAPS_COMPANY = '0302' then 1 else 0 end as MsipFlag, Case when e.CCC_TAPS_COMPANY = '0342' then 1 else 0 end as MsslFlag, case when e.CCC_HIERARCHY_LEVEL8 in ('CORE PRIMARY', 'CORE PRIMARY1') then 1 else 0 end as SynFlag, case when e.CCC_TAPS_COMPANY = '0517' then 1 else 0 end as MsbilFlag, SUM(CASE WHEN COB_DATE= '2017-12-08' THEN coalesce(USD_EQ_KAPPA,0) ELSE 0 END) as KappaCOB, SUM(CASE WHEN COB_DATE= '2017-12-08' THEN 0 ELSE coalesce(USD_EQ_KAPPA,0) END) as KappaCOMP, SUM(CASE WHEN COB_DATE= '2017-12-08' THEN coalesce(USD_EQ_KAPPA,0) else -1*coalesce(USD_EQ_KAPPA,0) END) as KappaDOD from cdwuser.U_EXP_MSR_PARTIAL e WHERE e.COB_DATE = '2018-02-28' and e.CCC_BANKING_TRADING = 'TRADING' group by 1,2,3,4,5,6,7,8,9,10,11,12 ) tmp_01 where IS_INCLUDED = 1 ) select Concentration_Rank||'_'||Concentration as Concentration, PRODUCT_DESCRIPTION, TICK, DESK, KappaCOB, KappaCOMP, KappaDOD from ( SELECT DENSE_RANK() OVER (PARTITION BY Concentration ORDER BY ABS(KappaCOB) DESC) Concentration_Rank ,Concentration ,PRODUCT_DESCRIPTION ,TICK ,DESK ,DENSE_RANK() OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION ORDER BY ABS(KappaCOB_DESK) DESC) DESK_RANK ,KappaCOB ,KappaCOMP ,KappaDOD FROM ( SELECT distinct Concentration,PRODUCT_DESCRIPTION,TICK,DESK, sum(KappaCOB) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,TICK) KappaCOB, sum(KappaCOMP) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,TICK) KappaCOMP, sum(KappaDOD) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,TICK) KappaDOD, Sum(KappaCOB) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,DESK) KappaCOB_DESK FROM ( select Concentration, PRODUCT_DESCRIPTION, TICK, DESK, sum(KappaCOB) KappaCOB, sum(KappaCOMP) KappaCOMP, sum(KappaDOD) KappaDOD from ( SELECT PRODUCT_DESCRIPTION, TICK, DESK, EXECUTIVE_MODEL, UNNEST(ARRAY[Concentration0, Concentration1, Concentration2, Concentration3, Concentration4, Concentration5, Concentration6, Concentration7, Concentration8, Concentration9, Concentration10, Concentration11, Concentration12, Concentration13] ) AS Concentration, KappaCOB, KappaCOMP, KappaDOD FROM data )TMP_01 WHERE Concentration is not null group by Concentration, PRODUCT_DESCRIPTION, TICK, DESK )TMP_2 ) TMP_1 )tmp WHERE DESK_RANK = 1 and ( ( Concentration in ('TopVegaStock','TopVega','TopEuVegaStock','TopEuVega') AND Concentration_Rank <=15 ) or ( Concentration in ('TopEuVsVega') AND Concentration_Rank <=10 ) or ( Concentration NOT in ('TopEuModelVega','TopVegaStock','TopVega','TopEuVegaStock','TopEuVega','TopEuVsVega') AND Concentration_Rank <=6 ) ) UNION ALL select Concentration_Rank||'_'||Concentration as Concentration, PRODUCT_DESCRIPTION, TICK, DESK, KappaCOB, KappaCOMP, KappaDOD from ( SELECT DENSE_RANK() OVER (PARTITION BY Concentration ORDER BY ABS(CASE WHEN PRODUCT_DESCRIPTION <> 'Others' then KappaCOB else 0 END) DESC) Concentration_Rank ,Concentration ,PRODUCT_DESCRIPTION ,TICK ,DESK ,DENSE_RANK() OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION ORDER BY ABS(KappaCOB_DESK) DESC) DESK_RANK ,KappaCOB ,KappaCOMP ,KappaDOD FROM ( SELECT distinct Concentration,PRODUCT_DESCRIPTION,TICK,DESK, sum(KappaCOB) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,TICK) KappaCOB, sum(KappaCOMP) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,TICK) KappaCOMP, sum(KappaDOD) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,TICK) KappaDOD, Sum(KappaCOB) OVER(PARTITION BY Concentration,PRODUCT_DESCRIPTION,DESK) KappaCOB_DESK FROM ( SELECT 'TopEuModelVega' AS Concentration, case when ModelRank < 19 then EXECUTIVE_MODEL else 'Others' end as product_description, 'N/A' tick, Desk, sum(KappaCOB) KappaCOB, sum(KappaCOMP) KappaCOMP, sum(KappaDOD) KappaDOD from ( select EXECUTIVE_MODEL, Desk, KappaCOB, KappaCOMP, KappaDOD, DENSE_RANK() OVER(ORDER BY ABS(KappaCOB_model)desc) ModelRank FROM ( select EXECUTIVE_MODEL, Desk, KappaCOB, KappaCOMP, KappaDOD, sum(KappaCOB) over(partition by EXECUTIVE_MODEL) KappaCOB_model from ( Select EXECUTIVE_MODEL, Desk, sum(KappaCOB) KappaCOB, sum(KappaCOMP) KappaCOMP, sum(KappaDOD) KappaDOD from data where EMEAFlag = 1 group by EXECUTIVE_MODEL, Desk ) tmp_2 )tmp_1 )tmp group by Concentration, PRODUCT_DESCRIPTION, TICK, DESK ) TMP_1 )TMP_2 ) TMP where DESK_RANK =1