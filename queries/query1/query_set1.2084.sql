SELECT T.COB_DATE , CASE when T.CCC_TAPS_COMPANY in ( '0201','0103','0205','0206','0530','5924') then 'MSCO' when T.CCC_TAPS_COMPANY in ('0111') then 'MSCS' when T.CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') then 'MSCGI' when T.CCC_TAPS_COMPANY in ('0146') then 'MSDP' when T.CCC_TAPS_COMPANY in ('5745') then 'MSCAP' ELSE T.CCC_TAPS_COMPANY END AS LE , CASE WHEN T.CCC_BUSINESS_AREA NOT IN ('CREDIT-CORPORATES', 'DSP - CREDIT') THEN 'OTHER' ELSE T.CCC_BUSINESS_AREA END AS CCC_BUSINESS_AREA ,T.PRIMARY_NIG_FLAG ,T.RATING2 , sum(CASE WHEN T.product_type_code IN ('BONDFUT', 'CASH', 'REPO') OR T.ccc_strategy IN ('MS DVA - STR NOTES', 'FID SN DVA - FXEM', 'FID SN DVA - CDP', 'COM SN DVA', 'FID OTHER FVO DVA', 'FID SN DVA - IR') THEN 0 WHEN (T.ccc_strategy = 'DISTRESSED TRADING1' AND T.product_type_code = 'TRRSWAP') THEN (coalesce(T.USD_PV10_BENCH, 0)) ELSE (coalesce(T.USD_PV10_BENCH, 0) + coalesce(T.PV10_SYNTHETIC2, 0)) END) AS BPV10 FROM ( SELECT D.* , CASE WHEN (D.VAR_EXCL_FL = 'N' AND D.vertical_system NOT LIKE 'STS_%') OR (D.VAR_EXCL_FL = 'N' AND D.Product_Type_Code = 'SWAPIL') OR (D.usd_pv10_bench IS NOT NULL) THEN 0 ELSE coalesce(D.usd_pv01sprd, 0) * 0.1 * (CASE WHEN D.credit_spread <=0 THEN 0 ELSE D.credit_spread END) END AS PV10_SYNTHETIC2 FROM ( SELECT a.cob_date ,a.CCC_TAPS_COMPANY ,a.CCC_Strategy ,A.CCC_PRODUCT_LINE ,A.CCC_BUSINESS_AREA ,A.VERTICAL_SYSTEM ,a.Var_EXCL_FL ,a.product_type_code ,CASE WHEN a.MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG' ELSE 'NIG' END AS RATING2 , CASE WHEN A.CCC_PRODUCT_LINE LIKE '%PRIMARY - NIG%' THEN 'PRIMARY_NIG' ELSE 'OTHERS' END AS PRIMARY_NIG_FLAG ,SUM(USD_PV10_SYNTHETIC) AS USD_PV10_SYNTHETIC ,SUM(A.USD_PV10_BENCH) AS USD_PV10_BENCH ,sum(a.usd_pv01sprd) usd_pv01sprd ,min(a.credit_spread) credit_spread FROM CDWUSER.U_CR_MSR a WHERE a.cob_date in ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND a.VAR_EXCL_FL = 'N' AND A.vertical_system not like 'PIPELINE%' AND a.issuer_country_tier = '1' AND (a.CREDIT_TYPE_CD = 'CREDIT-CORP_T1T2' OR a.ccc_product_line IN ('PRIMARY - BONDS')) AND a.division_group <> 'TREASURY' AND a.ccc_division NOT IN ('FIC OTHER', 'FIC DVA','FID DVA', 'MGD FUTURES', 'WM CAPITAL MARKETS') and a.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME NOT IN ('FEDERAL FARM CREDIT BANK', 'FEDERAL FARM CREDIT BANKS FUNDING CORPORATION', 'FEDERAL HOME LOAN BANK SYSTEM', 'FEDERAL HOME LOAN MORTGAGE CORPORATION','FEDERAL NATIONAL MORTGAGE ASSOCIATION') and a.CCC_PRODUCT_LINE <> 'DISTRESSED TRADING' and a.PRODUCT_TYPE_CODE NOT IN ('GVTBOND', 'ETF', 'OPTION', 'CRDINDEX') AND a.CCC_STRATEGY not IN ('US AGENCIES','AGENCY DEBT TRADING') AND a.CCC_BUSINESS_AREA not IN ('SECURITIZED PRODUCTS GRP','MUNICIPAL SECURITIES') GROUP BY a.cob_date ,a.CCC_TAPS_COMPANY ,a.CCC_Strategy ,A.CCC_PRODUCT_LINE ,A.CCC_BUSINESS_AREA ,A.VERTICAL_SYSTEM ,a.Var_EXCL_FL ,a.product_type_code ,CASE WHEN a.MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG' ELSE 'NIG' END ,CASE WHEN A.CCC_PRODUCT_LINE LIKE '%PRIMARY - NIG%' THEN 'PRIMARY_NIG' ELSE 'OTHERS' END UNION SELECT b.Cob_date ,b.CCC_TAPS_COMPANY ,b.CCC_Strategy ,B.CCC_PRODUCT_LINE ,B.CCC_BUSINESS_AREA ,B.VERTICAL_SYSTEM ,B.Var_EXCL_FL ,b.product_type_code ,CASE WHEN b.MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG' ELSE 'NIG' END AS RATING2 , CASE WHEN b.CCC_PRODUCT_LINE LIKE '%PRIMARY - NIG%' THEN 'PRIMARY_NIG' ELSE 'OTHERS' END AS PRIMARY_NIG_FLAG ,SUM(b.USD_PV10_SYNTHETIC) AS USD_PV10_SYNTHETIC ,Sum(CASE WHEN B.product_type_code IN ('ASCOT', 'CONVRT') THEN Coalesce(usd_credit_pv10pct, 0) ELSE 0 END) AS USD_PV10_BENCH ,0 AS usd_pv01sprd ,0 AS credit_spread FROM CDWUSER.u_cr_msr B INNER JOIN CDWUSER.U_IED_POSITION C ON B.COB_DATE = C.COB_DATE AND B.PROCESS_ID = C.PROCESS_ID AND B.POSITION_ID = C.POSITION_ID WHERE b.cob_date in ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND (b.ccc_division IN ('COMMODITIES', 'INT RATE CREDIT CURRENCY', 'FIXED INCOME DIVISION', 'NON CORE', 'INSTITUTIONAL EQUITY DIVISION') OR B.CCC_BUSINESS_AREA IN ('COMMODITIES') ) AND B.silo_src = 'IED' AND C.PRODUCT_TYPE_CODE IN ('ASCOT', 'CONVRT') AND C.PRODUCT_LEVEL = 'POS' AND b.Vertical_System not like 'PIPELINE%' AND b.VAR_EXCL_FL <> 'Y' AND b.issuer_country_tier = '1' AND (b.CREDIT_TYPE_CD = 'CREDIT-CORP_T1T2' OR b.ccc_product_line IN ('PRIMARY - BONDS')) AND b.division_group <> 'TREASURY' AND b.ccc_division NOT IN ('FIC OTHER', 'FIC DVA','FID DVA', 'MGD FUTURES', 'WM CAPITAL MARKETS') and b.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME NOT IN ('FEDERAL FARM CREDIT BANK', 'FEDERAL FARM CREDIT BANKS FUNDING CORPORATION', 'FEDERAL HOME LOAN BANK SYSTEM', 'FEDERAL HOME LOAN MORTGAGE CORPORATION','FEDERAL NATIONAL MORTGAGE ASSOCIATION') and b.CCC_PRODUCT_LINE <> 'DISTRESSED TRADING' and b.PRODUCT_TYPE_CODE NOT IN ('GVTBOND', 'ETF', 'OPTION', 'CRDINDEX') AND B.CCC_STRATEGY not IN ('US AGENCIES','AGENCY DEBT TRADING') AND B.CCC_BUSINESS_AREA not IN ('SECURITIZED PRODUCTS GRP','MUNICIPAL SECURITIES') GROUP BY b.Cob_date ,b.CCC_TAPS_COMPANY ,b.CCC_Strategy ,B.CCC_PRODUCT_LINE ,B.CCC_BUSINESS_AREA ,B.VERTICAL_SYSTEM ,B.Var_EXCL_FL ,b.product_type_code ,CASE WHEN b.MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG' ELSE 'NIG' END , CASE WHEN b.CCC_PRODUCT_LINE LIKE '%PRIMARY - NIG%' THEN 'PRIMARY_NIG' ELSE 'OTHERS' END ) D ) T where T.cob_date in ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND T.CCC_TAPS_COMPANY in ( '0201','0103','0205','0206','0530','5924') AND T.CCC_BUSINESS_AREA NOT LIKE 'CPM%' group by T.COB_DATE , CASE when T.CCC_TAPS_COMPANY in ( '0201','0103','0205','0206','0530','5924') then 'MSCO' when T.CCC_TAPS_COMPANY in ('0111') then 'MSCS' when T.CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') then 'MSCGI' when T.CCC_TAPS_COMPANY in ('0146') then 'MSDP' when T.CCC_TAPS_COMPANY in ('5745') then 'MSCAP' ELSE T.CCC_TAPS_COMPANY END , CASE WHEN T.CCC_BUSINESS_AREA NOT IN ('CREDIT-CORPORATES', 'DSP - CREDIT') THEN 'OTHER' ELSE T.CCC_BUSINESS_AREA END ,T.PRIMARY_NIG_FLAG ,T.RATING2