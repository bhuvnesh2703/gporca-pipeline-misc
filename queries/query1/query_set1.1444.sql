SELECT RANK, TICKER, ROW_NUMBER() OVER(PARTITION BY TICKER ORDER BY TICKER ASC) as NUM_TICK, PAYOFF_CLASS, CASH_ISSUE_TYPE, USD_DELTA, USD_GAMMA, USD_VEGA FROM ( SELECT RANK() OVER(PARTITION BY CASH_ISSUE_TYPE ORDER BY ABS(sum(coalesce(USD_DELTA,0))) DESC) as RANK, TICKER, PAYOFF_CLASS, CASH_ISSUE_TYPE, sum(coalesce(USD_DELTA,0)) as USD_DELTA, sum(coalesce(USD_GAMMA,0)) as USD_GAMMA, sum(coalesce(USD_VEGA,0)) as USD_VEGA FROM ( SELECT a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE as Ticker, a.PRODUCT_DESCRIPTION, a.PAYOFF_MODEL, CASE WHEN a.CASH_ISSUE_TYPE IN ('COMM','CMDT') THEN 'COMM' ELSE a.CASH_ISSUE_TYPE END as CASH_ISSUE_TYPE, CASE WHEN a.PAYOFF_MODEL='EUROPEAN-OPTION' THEN 'Warrant' ELSE 'Other' END as PAYOFF_CLASS, sum(coalesce(a.USD_DELTA,0))+sum(coalesce(a.USD_CM_DELTA,0)) as USD_DELTA, sum(coalesce(a.USD_EQ_GAMMA,0))+sum(coalesce(a.USD_CM_GAMMA,0)) as USD_GAMMA, sum(coalesce(a.USD_EQ_KAPPA,0))+sum(coalesce(a.USD_CM_KAPPA,0)) as USD_VEGA FROM CDWUSER.U_EXP_MSR_PARTIAL a WHERE a.COB_DATE ='2018-02-28' AND a.CCC_HIERARCHY_LEVEL10 = 'ETP MAIN' AND a.CCC_RISK_MANAGER_LOGIN = 'freemric' AND a.EXECUTIVE_MODEL IN('AMERICAN-OPTION','EUROPEAN-OPTION') GROUP BY CASE WHEN a.CASH_ISSUE_TYPE IN ('COMM','CMDT') THEN 'COMM' ELSE a.CASH_ISSUE_TYPE END, a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE, a.PRODUCT_DESCRIPTION, a.CASH_ISSUE_TYPE, PAYOFF_MODEL, a.STRIKE, a.UNDERLIER_PRICE, a.MARK_OF_POSITION ) a GROUP BY TICKER, PAYOFF_CLASS, CASH_ISSUE_TYPE ORDER BY CASH_ISSUE_TYPE, RANK ) a