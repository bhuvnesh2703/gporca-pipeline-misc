SELECT MAIN.*, CASE WHEN ISSUER_COUNTRY_GROUP = 'OTHERS' THEN 2 ELSE 1 END AS RANK FROM ( SELECT COB_DATE, LE, ISSUER_COUNTRY_CODE_DECOMP, CASE WHEN TOP4 < 5 THEN ISSUER_COUNTRY_CODE_DECOMP ELSE 'OTHERS' END AS ISSUER_COUNTRY_GROUP, SUM(EQ_DELTA_DECOMP) EQ_DELTA_DECOMP FROM ( SELECT COB_DATE, LE, ISSUER_COUNTRY_CODE_DECOMP, EQ_DELTA_DECOMP, DENSE_RANK() OVER(ORDER BY CASE WHEN MSIP_EQ_DELTA_CURRENT IS NOT NULL THEN 1 ELSE 0 END DESC, MSIP_EQ_DELTA_CURRENT DESC ) TOP4 FROM ( SELECT COB_DATE, LE, ISSUER_COUNTRY_CODE_DECOMP, EQ_DELTA_DECOMP, SUM(MSIP_EQ_DELTA_CURRENT)OVER(PARTITION BY ISSUER_COUNTRY_CODE_DECOMP) MSIP_EQ_DELTA_CURRENT FROM ( SELECT CASE WHEN B.PARENT_LEGAL_ENTITY LIKE '0302(G)%' THEN 'MSIP' WHEN B.PARENT_LEGAL_ENTITY LIKE '0201(G)%' THEN 'MSCO' END AS LE, B.COB_DATE, B.ISSUER_COUNTRY_CODE_DECOMP, SUM(B.USD_EQ_DELTA_DECOMP) AS EQ_DELTA_DECOMP, ABS(SUM(CASE WHEN COB_DATE = '2018-02-28' AND PARENT_LEGAL_ENTITY IN ('0302(G)') THEN B.USD_EQ_DELTA_DECOMP END )) MSIP_EQ_DELTA_CURRENT FROM CDWUSER.U_DECOMP_MSR B WHERE B.COB_DATE IN ('2018-02-28','2018-01-31','2017-12-29','2017-11-30','2017-10-31','2017-09-29','2017-08-31','2017-07-31','2017-06-30','2017-05-31','2017-04-28','2017-03-31','2017-02-28') AND B.CCC_PL_REPORTING_REGION = 'AMERICAS' AND B.VAR_EXCL_FL <> 'Y' AND B.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND USD_EQ_DELTA_DECOMP IS NOT NULL GROUP BY CCC_DIVISION,CCC_PL_REPORTING_REGION, LE, B.COB_DATE, B.ISSUER_COUNTRY_CODE_DECOMP ) TMP_1 where LE is NOT NULL ) TMP_2 )TMP GROUP BY COB_DATE, LE, ISSUER_COUNTRY_CODE_DECOMP, ISSUER_COUNTRY_GROUP ) MAIN