select a.COB_DATE, a.ACCOUNT, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, Case when a.WM_BANKING_PRODUCT_SUB_GROUP like '%AGN%' then 'Agency' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Credit%' then 'Credit' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Govt%' then 'Treasury' else 'Other' end as Group from ( select a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.CCC_BUSINESS_AREA, a.CCC_DIVISION, a.CCC_STRATEGY, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.PRODUCT_SUB_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_TYPE_NAME from cdwuser.u_dm_wm_position a WHERE A.COB_DATE in ( '2015-12-31' ) AND A.CCC_TAPS_COMPANY in ('1633', '6635') AND (A.VAR_EXCL_FL<> 'Y' OR A.BOOK IN ('MSDPB3M','MSDPT3M')) AND (A.ccc_banking_trading = 'BANKING' OR (A.CCC_HIERARCHY_LEVEL2 IN ('WEALTH MANAGEMENT', 'GLOBAL WEALTH MANAGEMENT') or a.CCC_business_area = 'US BANKS-LIQUIDITY') AND A.PRODUCT_TYPE_CODE ='REPO' AND A.CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS','CORE MARKETS')) group by a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.CCC_BUSINESS_AREA, a.CCC_DIVISION, a.CCC_STRATEGY, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.PRODUCT_SUB_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_TYPE_NAME ) A where a.WM_BANKING_PRODUCT_GROUP in ('AFS') GROUP BY a.COB_DATE, a.ACCOUNT, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, Case when a.WM_BANKING_PRODUCT_SUB_GROUP like '%AGN%' then 'Agency' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Credit%' then 'Credit' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Govt%' then 'Treasury' else 'Other' end UNION ALL select a.COB_DATE, a.ACCOUNT, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, Case when a.WM_BANKING_PRODUCT_SUB_GROUP like '%AGN%' then 'Agency' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Credit%' then 'Credit' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Govt%' then 'Treasury' else 'Other' end as Group from ( select a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.PRODUCT_SUB_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_TYPE_NAME from cdwuser.u_dm_wm_position a WHERE A.COB_DATE in ( '2018-02-28', '2015-12-31' ) AND A.CCC_TAPS_COMPANY in ('1633', '6635') AND (A.VAR_EXCL_FL<> 'Y' OR A.BOOK IN ('MSDPB3M','MSDPT3M')) AND (A.ccc_banking_trading = 'BANKING' OR (A.CCC_HIERARCHY_LEVEL2 IN ('WEALTH MANAGEMENT', 'GLOBAL WEALTH MANAGEMENT') or a.CCC_business_area = 'US BANKS-LIQUIDITY') AND A.PRODUCT_TYPE_CODE ='REPO' AND A.CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS','CORE MARKETS')) group by a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.PRODUCT_SUB_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_TYPE_NAME ) A where a.WM_BANKING_PRODUCT_GROUP in ('AFS') GROUP BY a.COB_DATE, a.ACCOUNT, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, Case when a.WM_BANKING_PRODUCT_SUB_GROUP like '%AGN%' then 'Agency' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Credit%' then 'Credit' when a.WM_BANKING_PRODUCT_SUB_GROUP like '%Govt%' then 'Treasury' else 'Other' end