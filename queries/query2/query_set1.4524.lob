WITH TAPSCUSIP_CHNG (TAPSCUSIP_NEW) AS ( SELECT NEWCOB.TAPSCUSIP AS TAPSCUSIP_NEW FROM ( SELECT TAPSCUSIP FROM ( SELECT TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE FROM CDWUSER.U_CR_MSR GROUP BY TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE UNION ALL SELECT TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE FROM CDWUSER.U_IR_MSR GROUP BY TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE UNION ALL SELECT TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE FROM CDWUSER.U_OT_MSR GROUP BY TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE ) X WHERE CCC_BUSINESS_AREA IN ('CREDIT-SECURITIZED PRODS', 'SECURITIZED PRODUCTS GRP', 'RESIDENTIAL', 'COMMERCIAL RE (PTG)') AND CCC_BANKING_TRADING='TRADING' AND PARENT_LEGAL_ENTITY LIKE '0302(G)' AND COB_DATE IN ('2018-02-28' ) AND DETACHMENT=1 AND ATTACHMENT=0 AND SECURITIZATION_TYPE = 'Y' GROUP BY TAPSCUSIP ) NEWCOB FULL OUTER JOIN ( SELECT TAPSCUSIP AS TAPSCUSIP FROM ( SELECT TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE FROM CDWUSER.U_CR_MSR a GROUP BY TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE UNION ALL SELECT TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE FROM CDWUSER.U_IR_MSR a GROUP BY TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE UNION ALL SELECT TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE FROM CDWUSER.U_OT_MSR a GROUP BY TAPSCUSIP, CCC_BUSINESS_AREA,CCC_BANKING_TRADING,PARENT_LEGAL_ENTITY,COB_DATE,DETACHMENT,ATTACHMENT,SECURITIZATION_TYPE ) Z WHERE CCC_BUSINESS_AREA IN ('CREDIT-SECURITIZED PRODS', 'SECURITIZED PRODUCTS GRP', 'RESIDENTIAL', 'COMMERCIAL RE (PTG)') AND CCC_BANKING_TRADING='TRADING' AND PARENT_LEGAL_ENTITY LIKE '0302(G)' AND COB_DATE IN ('2018-02-21' ) AND DETACHMENT=1 AND ATTACHMENT=0 AND SECURITIZATION_TYPE = 'Y' GROUP BY TAPSCUSIP ) OLDCOB ON NEWCOB.TAPSCUSIP=OLDCOB.TAPSCUSIP WHERE NEWCOB.TAPSCUSIP IS NULL OR OLDCOB.TAPSCUSIP IS NULL ) /**** end of with *****/ SELECT COB_DATE, TAPSCUSIP, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, SUM (NET_EXPOSURE) AS NET_EXPOSURE, SUM (NOTIONAL) AS NOTIONAL, SUM (PV01) AS PV01, SUM (PV01_SPREAD) AS PV01_SPREAD FROM ( SELECT SUM (USD_EXPOSURE) AS NET_EXPOSURE, 0 AS NOTIONAL, 0 AS PV01, SUM (USD_PV01SPRD) AS PV01_SPREAD, COB_DATE, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, VERTICAL_SYSTEM, TAPSCUSIP, POSITION_ULTIMATE_CREDIT_PARTY_DARWIN FROM CDWUSER.U_CR_MSR a GROUP BY COB_DATE, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, VERTICAL_SYSTEM, TAPSCUSIP, POSITION_ULTIMATE_CREDIT_PARTY_DARWIN UNION ALL SELECT 0 AS NET_EXPOSURE, 0 AS NOTIONAL, SUM (USD_IR_UNIFIED_PV01) AS PV01, 0 AS PV01_SPREAD, COB_DATE, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, VERTICAL_SYSTEM, TAPSCUSIP, POSITION_ULTIMATE_CREDIT_PARTY_DARWIN FROM CDWUSER.U_IR_MSR A GROUP BY COB_DATE, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, VERTICAL_SYSTEM, TAPSCUSIP, POSITION_ULTIMATE_CREDIT_PARTY_DARWIN UNION ALL SELECT 0 AS NET_EXPOSURE, SUM (USD_NOTIONAL) AS NOTIONAL, 0 AS PV01, 0 AS PV01_SPREAD, COB_DATE, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, VERTICAL_SYSTEM, TAPSCUSIP, POSITION_ULTIMATE_CREDIT_PARTY_DARWIN FROM CDWUSER.U_OT_MSR a GROUP BY COB_DATE, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE, VERTICAL_SYSTEM, TAPSCUSIP, POSITION_ULTIMATE_CREDIT_PARTY_DARWIN ) N WHERE CCC_BUSINESS_AREA IN ('CREDIT-SECURITIZED PRODS', 'SECURITIZED PRODUCTS GRP', 'RESIDENTIAL', 'COMMERCIAL RE (PTG)') AND CCC_BANKING_TRADING='TRADING' AND PARENT_LEGAL_ENTITY LIKE '0302(G)' AND COB_DATE IN ('2018-02-28' ) AND DETACHMENT=1 AND ATTACHMENT=0 AND SECURITIZATION_TYPE = 'Y' AND TAPSCUSIP IN (SELECT TAPSCUSIP_NEW FROM TAPSCUSIP_CHNG) GROUP BY COB_DATE, TAPSCUSIP, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_BANKING_TRADING, PARENT_LEGAL_ENTITY, CCC_PRODUCT_LINE, CCC_STRATEGY, BOOK, CURRENCY_OF_MEASURE, CONSOLIDATED_RATING, SPG_DESC, PRODUCT_DESCRIPTION, PRODUCT_TYPE_CODE, VINTAGE, INSURER_RATING, COUNTRY_CD_OF_RISK, POSITION_ISSUER_PARTY_DARWIN_NAME, SPG_PRODUCT_TYPE, SPG_PRODUCT_TYPE_GROUP, DETACHMENT, ATTACHMENT, SECURITIZATION_TYPE