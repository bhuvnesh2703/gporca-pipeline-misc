SELECT case when a.currency_pair='USD/JPY' then 1 when a.currency_pair='USD/EUR' then 2 when a.currency_pair='USD/GBP' then 3 when a.currency_pair='USD/CHF' then 4 when a.currency_pair='USD/CAD' then 5 when a.currency_pair='USD/SEK' then 6 when a.currency_pair='USD/AUD' then 7 when a.currency_pair='USD/NZD' then 8 when a.currency_pair='USD/DKK' then 9 when a.currency_pair='USD/NOK' then 10 else 11 end AS ORDERFORPIVOT, CASE when a.currency_pair is null then case when b.currency_pair is null then case when c.currency_pair is null then d.currency_pair else c.currency_pair end else b.currency_pair end else a.currency_pair end as "Currency", sum(coalesce(fxdelta1,0)) AS "FX Delta +1% Current", sum(coalesce(fxdelta1_prior,0)) AS "FX Delta +1% Prior", (sum(coalesce(fxdelta1,0)) - sum(coalesce(fxdelta1_prior,0))) AS "FX Delta +1% Change", sum(coalesce(fxdelta2,0)) AS "FX Delta +5% Current", sum(coalesce(fxdelta2_prior,0)) AS "FX Delta +5% Prior", (sum(coalesce(fxdelta2,0)) - sum(coalesce(fxdelta2_prior,0))) AS "FX Delta +5% Change", sum(coalesce(fxvega1,0)) AS "FX Vega +1% abs:Ln Current", sum(coalesce(fxvega1_prior,0)) AS "FX Vega +1% abs:Ln Prior", (sum(coalesce(fxvega1,0)) - sum(coalesce(fxvega1_prior,0))) AS "FX Vega +1% abs:Ln Change", sum(coalesce(fxvega2,0)) AS "FX Vega +5% abs:Ln Current", sum(coalesce(fxvega2_prior,0)) AS "FX Vega +5% abs:Ln Prior", (sum(coalesce(fxvega2,0)) - sum(coalesce(fxvega2_prior,0))) AS "FX Vega +5% abs:Ln Change" from (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxdelta1 from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-02-16') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Delta') and ATTRIBUTE10 IN ('+1%') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) a FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxdelta2 from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-02-16') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Delta') and ATTRIBUTE10 IN ('+5%') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) b on (a.currency_pair = b.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxvega1 from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-02-16') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Vega') and ATTRIBUTE10 IN ('+1% abs:Ln') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) c on (a.currency_pair = c.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxvega2 from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-02-16') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Vega') and ATTRIBUTE10 IN ('+5% abs:Ln') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) d on (a.currency_pair = d.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxdelta1_prior from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-01-19') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Delta') and ATTRIBUTE10 IN ('+1%') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) e on (a.currency_pair = e.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxdelta2_prior from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-01-19') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Delta') and ATTRIBUTE10 IN ('+5%') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) f on (a.currency_pair = f.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxvega1_prior from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-01-19') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Vega') and ATTRIBUTE10 IN ('+1% abs:Ln') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) g on (a.currency_pair = g.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, SUM(VALUE1)/1000 AS fxvega2_prior from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-01-19') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Vega') and ATTRIBUTE10 IN ('+5% abs:Ln') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) h on (a.currency_pair = h.currency_pair) FULL JOIN (SELECT ATTRIBUTE19 as currency_pair, rank() over(order by abs(SUM(VALUE1)/1000) desc) as ccy_rank from CDWUSER.U_GENERIC_DATA where cob_date IN ('2018-02-16') and analytic_group = 'FDSF' and analytics = 'SENSITIVITIES' and ATTRIBUTE9 IN ('FX Delta') and ATTRIBUTE19 NOT IN ('USD/JPY','USD/EUR','USD/GBP','USD/CHF','USD/CAD','USD/SEK','USD/AUD','USD/NZD','USD/DKK','USD/NOK') and ATTRIBUTE10 IN ('+1%') and ATTRIBUTE1 IN ('FX') group by ATTRIBUTE19) i on (a.currency_pair = i.currency_pair) where a.currency_pair in ('USD/JPY','USD/EUR','USD/GBP','USD/CHF','USD/CAD','USD/SEK','USD/AUD','USD/NZD','USD/DKK','USD/NOK') or ccy_rank < 11 group by a.currency_pair,b.currency_pair,c.currency_pair,d.currency_pair order by case when a.currency_pair='USD/JPY' then 1 when a.currency_pair='USD/EUR' then 2 when a.currency_pair='USD/GBP' then 3 when a.currency_pair='USD/CHF' then 4 when a.currency_pair='USD/CAD' then 5 when a.currency_pair='USD/SEK' then 6 when a.currency_pair='USD/AUD' then 7 when a.currency_pair='USD/NZD' then 8 when a.currency_pair='USD/DKK' then 9 when a.currency_pair='USD/NOK' then 10 else 11 end, abs(sum(coalesce(fxdelta1,0))) desc