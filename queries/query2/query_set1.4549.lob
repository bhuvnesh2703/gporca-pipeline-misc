SELECT CURRENCY_OF_MEASURE AS PV_CURRENCY, SUM(PV01) AS SUM_PV01, DENSE_RANK() OVER ( ORDER BY CASE WHEN CURRENCY_OF_MEASURE IN ('USD', 'EUR') THEN 1 ELSE 2 END, CASE WHEN SUM(PV01) IS NULL THEN 1 ELSE 0 END ASC, ABS(SUM(PV01)) DESC ) AS RANK_PV01 FROM ( SELECT COB_DATE, CURRENCY_OF_MEASURE, SUM(CAST(A.USD_IR_UNIFIED_PV01 AS NUMERIC (15,5))) AS PV01 FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE = '02/28/2018' AND VAR_EXCL_FL <> 'Y' AND BU_RISK_SYSTEM <> 'PIPELINE_NY' AND BU_RISK_RUN_CUSTOM1 <> 'STORAGE' AND BU_RISK_SYSTEM NOT LIKE '%EQUITYSD%' AND CCC_DIVISION NOT IN ('FIC DVA','FID DVA') AND NOT ( A.CCC_BUSINESS_AREA = 'SECURITIZED PRODUCTS GRP' AND SPG_CATEGORY = 'WAREHOUSE_FINAL' ) GROUP BY COB_DATE, CURRENCY_OF_MEASURE ) A GROUP BY CURRENCY_OF_MEASURE