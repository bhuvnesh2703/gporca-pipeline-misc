SELECT * FROM ( SELECT COB_DATE, RANK () OVER (PARTITION BY COB_DATE ORDER BY abs(sum(coalesce(NET_USD_EXPOSURE,0))) desc) as RANK, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, sum(coalesce(NET_USD_EXPOSURE,0)) as NET_USD_EXPOSURE, sum(coalesce(LONG_EXPOSURE,0)) as LONG_EXPOSURE, sum(coalesce(SHORT_EXPOSURE,0)) as SHORT_EXPOSURE, sum(coalesce(ABS_USD_EXPOSURE,0)) as ABS_USD_EXPOSURE FROM ( SELECT COB_DATE, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, FLAG_LONG_SHORT, CASE WHEN FLAG_LONG_SHORT = 'LONG' THEN sum(coalesce(USD_EXPOSURE,0)) END AS LONG_EXPOSURE, CASE WHEN FLAG_LONG_SHORT = 'SHORT' THEN sum(coalesce(USD_EXPOSURE,0)) END AS SHORT_EXPOSURE, sum(USD_EXPOSURE) as NET_USD_EXPOSURE, abs(sum(USD_EXPOSURE)) as ABS_USD_EXPOSURE FROM ( SELECT COB_DATE, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, CASE WHEN USD_EXPOSURE>0 THEN 'LONG' ELSE 'SHORT' END AS FLAG_LONG_SHORT, USD_EXPOSURE FROM ( SELECT a.COB_DATE, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.FID1_SENIORITY, a.TAPSCUSIP, sum(coalesce(a.USD_EXPOSURE,0))/1000 as USD_EXPOSURE FROM cdwuser.U_EXP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.CCC_DIVISION = 'FIXED INCOME DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.PRODUCT_TYPE_CODE IN ('BOND','BONDFUT','BONDFUTOPT','BONDIL','BONDOPT','PREF') AND a.CCC_PRODUCT_LINE NOT IN ('DISTRESSED TRADING') AND a.GICS_LEVEL_1_NAME = 'FINANCIALS' AND a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME NOT IN ('GAS NATURAL SDG, S.A.','AT SECURITIES B.V.') AND a.FID1_SENIORITY IN ('AT1','SUBT1','SUBUT2') AND a.USD_EXPOSURE <> 0 AND a.CCC_TAPS_COMPANY = '0302' GROUP BY a.COB_DATE, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.FID1_SENIORITY, a.TAPSCUSIP ) a GROUP BY COB_DATE, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, CASE WHEN USD_EXPOSURE >0 THEN 'LONG' ELSE 'SHORT' END, USD_EXPOSURE ) b GROUP BY COB_DATE, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, FLAG_LONG_SHORT ) c GROUP BY COB_DATE, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME ) d