With x as ( SELECT a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH as TickExch, a.ISSUE_ID_DECOMP, a.PRODUCT_DESCRIPTION_DECOMP, a.PRODUCT_TYPE_CODE_DECOMP, a.TICKER_DECOMP, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0)) as USD_EQ_PARTIAL_DELTA, ABS(sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) as ABS_USD_EQ_PARTIAL_DELTA FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.SILO_SRC = 'IED' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.ASSET_CLASS = 'EQ' AND a.LE_GROUP = 'UK' AND a.CCC_BANKING_TRADING = 'TRADING' GROUP BY a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH, a.ISSUE_ID_DECOMP, a.PRODUCT_DESCRIPTION_DECOMP, a.PRODUCT_TYPE_CODE_DECOMP, a.TICKER_DECOMP ), y as ( SELECT TickExch, sum(ABS_USD_EQ_PARTIAL_DELTA) as TOT_ABS_USD_EQ_PARTIAL_DELTA FROM x WHERE x.ABS_USD_EQ_PARTIAL_DELTA <> 0 GROUP BY TickExch ), z as ( SELECT a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH as TICKEXCH, sum(coalesce(a.SLIDE_EQ_MIN_30_USD, 0)) as SLIDE_EQ_MIN_30_USD, sum(coalesce(a.SLIDE_EQ_MIN_20_USD, 0)) as SLIDE_EQ_MIN_20_USD, sum(coalesce(a.SLIDE_EQ_MIN_10_USD, 0)) as SLIDE_EQ_MIN_10_USD, sum(coalesce(a.SLIDE_EQ_MIN_05_USD,0)) as SLIDE_EQ_MIN_05_USD, sum(coalesce(a.SLIDE_EQ_PLS_05_USD, 0)) as SLIDE_EQ_PLS_05_USD, sum(coalesce(a.SLIDE_EQ_PLS_10_USD, 0)) as SLIDE_EQ_PLS_10_USD, sum(coalesce(a.SLIDE_EQ_PLS_20_USD, 0)) as SLIDE_EQ_PLS_20_USD FROM CDWUSER.U_EQ_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.SILO_SRC = 'IED' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.LE_GROUP = 'UK' AND a.ASSET_CLASS = 'EQ' AND a.SLIDE_EQ_PLS_20_USD <> 0 AND a.CCC_BANKING_TRADING = 'TRADING' GROUP BY a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH ) SELECT RANK () OVER (ORDER BY GREATEST ((-1)* (SUM(z.SLIDE_EQ_MIN_30_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.SLIDE_EQ_MIN_20_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.SLIDE_EQ_MIN_10_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.SLIDE_EQ_MIN_05_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.SLIDE_EQ_PLS_05_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.SLIDE_EQ_PLS_10_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.SLIDE_EQ_PLS_20_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA))) DESC) || '_' || 'TopDeltaSlide' AS Concentration, x.PRODUCT_DESCRIPTION_DECOMP, x.TICKER_DECOMP, SUM(z.SLIDE_EQ_MIN_30_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as D30_Decomp, SUM(z.SLIDE_EQ_MIN_20_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as D20_Decomp, SUM(z.SLIDE_EQ_MIN_10_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as D10_Decomp, SUM(z.SLIDE_EQ_MIN_05_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as D05_Decomp, SUM(z.SLIDE_EQ_PLS_05_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as P05_Decomp, SUM(z.SLIDE_EQ_PLS_10_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as P10_Decomp, SUM(z.SLIDE_EQ_PLS_20_USD*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as P20_Decomp FROM x INNER JOIN y ON x.TICKEXCH = y.TICKEXCH INNER JOIN z ON y.TICKEXCH = z.TICKEXCH Group by x.ISSUE_ID_DECOMP, x.PRODUCT_DESCRIPTION_DECOMP, x.TICKER_DECOMP Fetch first 15 rows only