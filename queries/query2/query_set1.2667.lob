WITH SLIDES AS ( SELECT DISTINCT PROCESS_ID || '.' || POSITION_ID AS PROCESS_POSITION, CCC_BUSINESS_AREA, CCC_PRODUCT_LINE, SLIDE_EQ_MIN_10_USD, SLIDE_EQ_PLS_10_USD FROM cdwuser.U_EQ_MSR A WHERE A.COB_DATE = '2018-02-28' AND A.CCC_DIVISION ='INSTITUTIONAL EQUITY DIVISION' AND A.CCC_BANKING_TRADING = 'TRADING' AND SLIDE_EQ_MIN_10_USD IS NOT NULL AND SLIDE_EQ_PLS_10_USD IS NOT NULL ), ABS_PARTIAL_DELTA AS ( SELECT PROCESS_ID || '.' || POSITION_ID AS PROCESS_POSITION, a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE AS TICKER, ABS(A.USD_EQ_PARTIAL_DELTA) AS abs_partial_delta FROM cdwuser.U_EXP_MSR_PARTIAL A WHERE A.COB_DATE = '2018-02-28' AND A.CCC_DIVISION ='INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND A.USD_EQ_PARTIAL_DELTA <> 0 AND A.ASSET_CLASS='EQ' GROUP BY PROCESS_ID || '.' || POSITION_ID, a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE, USD_EQ_PARTIAL_DELTA ), TOTAL AS ( SELECT PROCESS_ID || '.' || POSITION_ID AS PROCESS_POSITION, SUM(ABS(A.USD_EQ_PARTIAL_DELTA)) AS TOTAL_PARTIAL_DELTA FROM cdwuser.U_EQ_MSR A WHERE A.COB_DATE = '2018-02-28' AND A.CCC_DIVISION ='INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND A.USD_EQ_PARTIAL_DELTA <> 0 GROUP BY PROCESS_ID || '.' || POSITION_ID ) SELECT * FROM ( SELECT SLIDES.PROCESS_POSITION AS PROCESS_POSITION, ABS_PARTIAL_DELTA.TICKER AS TICKER, CCC_BUSINESS_AREA, CCC_PRODUCT_LINE, SLIDE_EQ_MIN_10_USD, SLIDE_EQ_PLS_10_USD, ABS_PARTIAL_DELTA.ABS_PARTIAL_DELTA, TOTAL.TOTAL_PARTIAL_DELTA, ABS_PARTIAL_DELTA.ABS_PARTIAL_DELTA / TOTAL.TOTAL_PARTIAL_DELTA AS WEIGHT, (ABS_PARTIAL_DELTA.ABS_PARTIAL_DELTA / TOTAL.TOTAL_PARTIAL_DELTA) * SLIDE_EQ_MIN_10_USD AS WEIGHTED_SLIDE_MIN10, (ABS_PARTIAL_DELTA.ABS_PARTIAL_DELTA / TOTAL.TOTAL_PARTIAL_DELTA) * SLIDE_EQ_PLS_10_USD AS WEIGHTED_SLIDE_PLS10 FROM SLIDES LEFT JOIN ABS_PARTIAL_DELTA ON ABS_PARTIAL_DELTA.PROCESS_POSITION = SLIDES.PROCESS_POSITION LEFT JOIN TOTAL ON TOTAL.PROCESS_POSITION = SLIDES.PROCESS_POSITION ) x WHERE TICKER IN ('ftse.lder','tftse.lder','ftmc.lder')