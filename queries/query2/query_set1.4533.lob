WITH PV01_Table as ( SELECT a.COB_DATE, a.PARENT_LEGAL_ENTITY, A.CCC_BUSINESS_AREA, a.CURVE_CURRENCY, SUM (a.USD_IR_UNIFIED_PV01)::numeric(30,10) AS USD_IR_UNIFIED_PV01 FROM CDWUSER.U_IR_MSR a WHERE a.COB_DATE = '02/28/2018' AND a.PARENT_LEGAL_ENTITY IN ('0201(G)', '0111', '0105(G)', '5745', '0146', '0302(G)', '1633') AND a.CURVE_CURRENCY <> 'UNDEFINED' and a.BU_RISK_SYSTEM NOT LIKE 'EQUITYSD%' GROUP BY a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CURVE_CURRENCY, A.CCC_BUSINESS_AREA HAVING SUM (a.USD_IR_UNIFIED_PV01) >= 50 OR SUM (a.USD_IR_UNIFIED_PV01) <= -50 ) SELECT B.CURVE_CURRENCY, B.CCC_BUSINESS_AREA, C.PARENT_LEGAL_ENTITY, C.USD_IR_UNIFIED_PV01 FROM( SELECT A.CURVE_CURRENCY, A.CCC_BUSINESS_AREA, SUM(A.USD_IR_UNIFIED_PV01) AS USD_IR_UNIFIED_PV01_NET_BUSI, SUM(ABS(A.USD_IR_UNIFIED_PV01)) AS USD_IR_UNIFIED_PV01_GROSS_BUSI, rank() over(order by abs(SUM(A.USD_IR_UNIFIED_PV01))/SUM(ABS(A.USD_IR_UNIFIED_PV01)) asc) as rank FROM PV01_TABLE A WHERE A.USD_IR_UNIFIED_PV01 <> 0 and A.CURVE_CURRENCY IN ( select distinct d.CURVE_CURRENCY from ( select distinct e.CURVE_CURRENCY from( SELECT f.CURVE_CURRENCY, SUM(f.USD_IR_UNIFIED_PV01) AS USD_IR_UNIFIED_PV01_NET_LE, sum(abs(f.USD_IR_UNIFIED_PV01)) as USD_IR_UNIFIED_PV01_gross_le FROM PV01_TABLE f GROUP BY f.CURVE_CURRENCY ) e where abs(e.USD_IR_UNIFIED_PV01_net_le) <= 0.7* e.USD_IR_UNIFIED_PV01_gross_le union select distinct g.CURVE_CURRENCY from( SELECT h.CURVE_CURRENCY, h.PARENT_LEGAL_ENTITY, SUM(h.USD_IR_UNIFIED_PV01) AS USD_IR_UNIFIED_PV01 from PV01_TABLE h group by h.CURVE_CURRENCY, h.PARENT_LEGAL_ENTITY having abs(sum(h.USD_IR_UNIFIED_PV01)) >= 100 ) g ) d ) group by A.CURVE_CURRENCY, a.ccc_business_area ) b left join PV01_TABLE c on b.CURVE_CURRENCY = c.CURVE_CURRENCY and b.ccc_business_area = c.ccc_business_area where abs(b.USD_IR_UNIFIED_PV01_NET_busi) <= 0.25*b.USD_IR_UNIFIED_PV01_gross_busi OR (b.rank <=10 and abs(b.USD_IR_UNIFIED_PV01_NET_BUSI) <> b.USD_IR_UNIFIED_PV01_GROSS_BUSI)