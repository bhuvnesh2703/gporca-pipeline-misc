WITH a AS(     SELECT         a.COB_DATE,         a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION,         SUM(COALESCE(a.USD_EQ_KAPPA, 0)) AS KAPPA     FROM         cdwuser.U_EXP_MSR_PARTIAL a     WHERE a.COB_DATE = '2018-02-28' AND         (a.CCC_BANKING_TRADING = 'TRADING' OR a.CCC_BANKING_TRADING IS NULL) AND A.CCC_TAPS_COMPANY in ('1050') AND          a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND         (a.ccc_business_area <> 'INTERNATIONAL WEALTH MGMT') AND         ABS(a.USD_EQ_KAPPA) > 0     GROUP BY         a.COB_DATE,         a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION     ORDER BY         ABS(SUM(COALESCE(a.USD_EQ_KAPPA, 0)))         DESC ), b AS(     SELECT         a.COB_DATE,         a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION,         SUM(COALESCE(a.USD_EQ_KAPPA, 0)) AS KAPPA     FROM         cdwuser.U_EXP_MSR_PARTIAL a     WHERE a.COB_DATE = '2018-02-27' AND         (a.CCC_BANKING_TRADING = 'TRADING' OR a.CCC_BANKING_TRADING IS NULL) AND A.CCC_TAPS_COMPANY in ('1050') AND          a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND         (a.ccc_business_area <> 'INTERNATIONAL WEALTH MGMT') AND         ABS(a.USD_EQ_KAPPA) > 0     GROUP BY         a.COB_DATE,         a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION     ORDER BY         ABS(SUM(COALESCE(a.USD_EQ_KAPPA, 0)))         DESC ), c AS(     SELECT         *     FROM (         SELECT             a.COB_DATE,             a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION,             SUM(COALESCE(a.USD_EQ_KAPPA, 0)) AS KAPPA,             RANK() OVER (  PARTITION BY PARTIAL_DECOMP_PRODUCT_DESCRIPTION ORDER BY ABS(SUM(COALESCE(a.USD_EQ_KAPPA, 0))) DESC) AS RANKED         FROM             cdwuser.U_EXP_MSR_PARTIAL a         WHERE  a.COB_DATE = '2018-02-28' AND             (a.CCC_BANKING_TRADING = 'TRADING' OR a.CCC_BANKING_TRADING IS NULL) AND A.CCC_TAPS_COMPANY in ('1050') AND              a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND             (a.ccc_business_area <> 'INTERNATIONAL WEALTH MGMT') AND             ABS(a.USD_EQ_KAPPA) > 0         GROUP BY             a.COB_DATE,             a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION         ) cu     WHERE         RANKED = 1     ORDER BY ABS(KAPPA) DESC ), d AS(     SELECT         *     FROM (         SELECT             a.COB_DATE,             a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION,             SUM(COALESCE(a.USD_EQ_KAPPA, 0)) AS KAPPA,             RANK() OVER (PARTITION BY PARTIAL_DECOMP_PRODUCT_DESCRIPTION ORDER BY ABS(SUM(COALESCE(a.USD_EQ_KAPPA, 0))) DESC) AS RANKED         FROM             cdwuser.U_EXP_MSR_PARTIAL a         WHERE a.COB_DATE = '2018-02-28' AND             (a.CCC_BANKING_TRADING = 'TRADING' OR a.CCC_BANKING_TRADING IS NULL) AND A.CCC_TAPS_COMPANY in ('1050') AND              a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND             (a.ccc_business_area <> 'INTERNATIONAL WEALTH MGMT') AND             ABS(a.USD_EQ_KAPPA) > 0         GROUP BY             a.COB_DATE,             a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION         ) du     WHERE         RANKED = 1     ORDER BY ABS(KAPPA) DESC ) SELECT      COALESCE(a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION, B.PARTIAL_DECOMP_PRODUCT_DESCRIPTION) AS SECURITY_DESCRIPTION_OR_ISSUER,     SUM(COALESCE(a.kappa, 0)) AS EqVega,     SUM(COALESCE(a.kappa, 0) - COALESCE(b.kappa, 0)) AS change,     ABS(SUM(COALESCE(a.kappa, 0))) AS ABS_EqVega FROM B FULL JOIN A ON a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION = b.PARTIAL_DECOMP_PRODUCT_DESCRIPTION FULL JOIN c ON a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION = c.PARTIAL_DECOMP_PRODUCT_DESCRIPTION FULL JOIN d ON d.PARTIAL_DECOMP_PRODUCT_DESCRIPTION = c.PARTIAL_DECOMP_PRODUCT_DESCRIPTION GROUP BY      COALESCE(a.PARTIAL_DECOMP_PRODUCT_DESCRIPTION, B.PARTIAL_DECOMP_PRODUCT_DESCRIPTION) ORDER BY     ABS(SUM(COALESCE(a.kappa, 0)))     DESC FETCH FIRST 15 ROWS ONLY