SELECT cob_date , CASE WHEN ( CCC_DIVISION IN ('PRIVATE BANKING GROUP') AND PRODUCT_TYPE_CODE = 'REPO' AND CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS') ) THEN 'BANKING' ELSE UPPER(ccc_banking_trading) END AS CAPITAL_BOOK ,CASE WHEN a.CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING') and a.CCC_PL_REPORTING_REGION in ('AMERICAS') THEN ('US_FXEM_MACRO') ELSE 'OTHER' END AS FLAG , SUM((USD_FX) :: numeric(15,5)) AS FX , SUM(CASE WHEN feed_source_name <> 'CORISK' THEN coalesce(((USD_FX_KAPPA) :: numeric(15,5)), 0) + coalesce(((usd_fx_partial_kappa) :: numeric(15,5)), 0) WHEN feed_source_name = 'CORISK' AND PRODUCT_TYPE_CODE = 'CURRENCY' THEN coalesce(((LCY_FX_KAPPA) :: numeric(15,5)), 0) / 1000 ELSE 0 END) AS fxVega FROM cdwuser.u_exp_msr a WHERE cob_date IN ( '2018-02-28', '2018-02-27', '2018-01-31', '2017-12-29', '2017-11-30', '2017-10-31' ) AND currency_of_measure NOT IN ('UBD', 'USD', 'US1') AND parent_legal_entity IN ('1633') AND var_excl_fl <> 'Y' GROUP BY cob_date , CASE WHEN ( CCC_DIVISION IN ('PRIVATE BANKING GROUP') AND PRODUCT_TYPE_CODE = 'REPO' AND CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS') ) THEN 'BANKING' ELSE UPPER(ccc_banking_trading) END ,CASE WHEN a.CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING') and a.CCC_PL_REPORTING_REGION in ('AMERICAS') THEN ('US_FXEM_MACRO') ELSE 'OTHER' END