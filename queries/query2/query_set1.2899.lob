WITH DIVISIONALRANK AS( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_DIVISION, RANK() OVER(ORDER BY ABS(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))/1000 DESC) AS DIV_RANK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_DIVISION ), DIVISION_SHORTNAME AS( SELECT d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END AS DIVISION FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') GROUP BY d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END ), GROSS_DELTA AS ( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, 'TOTAL' AS CCC_DIVISION, 'TOTAL' AS CCC_BUSINESS_AREA, sum(abs(d.USD_EQ_DELTA_DECOMP)) as GROSS_DELTA_DECOMP FROM ( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END AS ISSUE_ID_DECOMP, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END ) d GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING UNION ALL SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA, sum(abs(d.USD_EQ_DELTA_DECOMP)) as GROSS_DELTA_DECOMP FROM ( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, 'TOTAL' AS CCC_BUSINESS_AREA, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END AS ISSUE_ID_DECOMP, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END UNION ALL SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_DIVISION as CCC_BUSINESS_AREA, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END AS ISSUE_ID_DECOMP, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='BANKING' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END ) d GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA UNION ALL SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA, sum(abs(d.USD_EQ_DELTA_DECOMP)) as GROSS_DELTA_DECOMP FROM ( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_DIVISION as CCC_BUSINESS_AREA, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END AS ISSUE_ID_DECOMP, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' AND d.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END UNION ALL SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END AS ISSUE_ID_DECOMP, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' AND d.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK<>1) GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.ISSUE_ID_DECOMP END ) d GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA ), RISK_METRICS AS( SELECT e.COB_DATE, e.CCC_DIVISION AS CCC_BUSINESS_AREA, e.LE_GROUP, COALESCE(e.CCC_BANKING_TRADING, 'TOTAL') AS CCC_BANKING_TRADING, COALESCE(e.CCC_DIVISION, 'TOTAL') AS CCC_DIVISION, SUM(COALESCE(e.USD_DELTA,0))/1000 AS USD_DELTA_POS, SUM(COALESCE(e.USD_EQ_KAPPA,0))/1000 AS USD_EQ_KAPPA, SUM(COALESCE(e.USD_EQ_PARTIAL_KAPPA,0))/1000 AS USD_EQ_PARTIAL_KAPPA, SUM(COALESCE(e.USD_EQ_KAPPA_PLS100BP_TIMEADJ,0))/1000 AS USD_EQ_KAPPA_PLS100BP_TIMEADJ, SUM(COALESCE(e.USD_THETA_GAMMA,0))/1000 AS THETA_GAMMA, SUM(COALESCE(e.USD_EQ_GAMMA,0))/1000 AS USD_EQ_GAMMA, SUM(COALESCE(e.CORR_EQEQ,0))/1000000 AS CORR_EQEQ, SUM(COALESCE(e.USD_EQ_DISC_RISK,0))/1000 AS USD_EQ_DISC_RISK, SUM(COALESCE(e.SLIDE_EQ_MIN_30_USD,0))/1000 AS USD_EQ_SLIDE_D30, SUM(COALESCE(e.SLIDE_EQ_MIN_20_USD,0))/1000 AS USD_EQ_SLIDE_D20, SUM(COALESCE(e.SLIDE_EQ_MIN_10_USD,0))/1000 AS USD_EQ_SLIDE_D10, SUM(COALESCE(e.SLIDE_EQ_MIN_05_USD,0))/1000 AS USD_EQ_SLIDE_D05 FROM CDWUSER.U_EXP_MSR e WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='BANKING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION UNION ALL SELECT e.COB_DATE, e.CCC_DIVISION AS CCC_BUSINESS_AREA, e.LE_GROUP AS LE_GROUP, e.CCC_BANKING_TRADING AS CCC_BANKING_TRADING, e.CCC_DIVISION, SUM(COALESCE(e.USD_DELTA,0))/1000 AS USD_DELTA_POS, SUM(COALESCE(e.USD_EQ_KAPPA,0))/1000 AS USD_EQ_KAPPA, SUM(COALESCE(e.USD_EQ_PARTIAL_KAPPA,0))/1000 AS USD_EQ_PARTIAL_KAPPA, SUM(COALESCE(e.USD_EQ_KAPPA_PLS100BP_TIMEADJ,0))/1000 AS USD_EQ_KAPPA_PLS100BP_TIMEADJ, SUM(COALESCE(e.USD_THETA_GAMMA,0))/1000 AS THETA_GAMMA, SUM(COALESCE(e.USD_EQ_GAMMA,0))/1000 AS USD_EQ_GAMMA, SUM(COALESCE(e.CORR_EQEQ,0))/1000000 AS CORR_EQEQ, SUM(COALESCE(e.USD_EQ_DISC_RISK,0))/1000 AS USD_EQ_DISC_RISK, SUM(COALESCE(e.SLIDE_EQ_MIN_30_USD,0))/1000 AS USD_EQ_SLIDE_D30, SUM(COALESCE(e.SLIDE_EQ_MIN_20_USD,0))/1000 AS USD_EQ_SLIDE_D20, SUM(COALESCE(e.SLIDE_EQ_MIN_10_USD,0))/1000 AS USD_EQ_SLIDE_D10, SUM(COALESCE(e.SLIDE_EQ_MIN_05_USD,0))/1000 AS USD_EQ_SLIDE_D05 FROM CDWUSER.U_EXP_MSR e WHERE e.COB_DATE IN ('2018-02-28') AND e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION UNION ALL SELECT e.COB_DATE, COALESCE(e.CCC_BUSINESS_AREA, 'TOTAL') AS CCC_BUSINESS_AREA, e.LE_GROUP, e.CCC_BANKING_TRADING, COALESCE(e.CCC_DIVISION, 'TOTAL') AS CCC_DIVISION, SUM(COALESCE(e.USD_DELTA,0))/1000 AS USD_DELTA_POS, SUM(COALESCE(e.USD_EQ_KAPPA,0))/1000 AS USD_EQ_KAPPA, SUM(COALESCE(e.USD_EQ_PARTIAL_KAPPA,0))/1000 AS USD_EQ_PARTIAL_KAPPA, SUM(COALESCE(e.USD_EQ_KAPPA_PLS100BP_TIMEADJ,0))/1000 AS USD_EQ_KAPPA_PLS100BP_TIMEADJ, SUM(COALESCE(e.USD_THETA_GAMMA,0))/1000 AS THETA_GAMMA, SUM(COALESCE(e.USD_EQ_GAMMA,0))/1000 AS USD_EQ_GAMMA, SUM(COALESCE(e.CORR_EQEQ,0))/1000000 AS CORR_EQEQ, SUM(COALESCE(e.USD_EQ_DISC_RISK,0))/1000 AS USD_EQ_DISC_RISK, SUM(COALESCE(e.SLIDE_EQ_MIN_30_USD,0))/1000 AS USD_EQ_SLIDE_D30, SUM(COALESCE(e.SLIDE_EQ_MIN_20_USD,0))/1000 AS USD_EQ_SLIDE_D20, SUM(COALESCE(e.SLIDE_EQ_MIN_10_USD,0))/1000 AS USD_EQ_SLIDE_D10, SUM(COALESCE(e.SLIDE_EQ_MIN_05_USD,0))/1000 AS USD_EQ_SLIDE_D05 FROM CDWUSER.U_EXP_MSR e WHERE e.COB_DATE IN ('2018-02-28') AND e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK<>1) AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.CCC_BUSINESS_AREA ), VAR AS( SELECT v.COB_DATE, CASE WHEN v.LEVEL1='Banking Internal' THEN 'BANKING' WHEN v.LEVEL1='Trading Internal' THEN 'TRADING' ELSE COALESCE(v.LEVEL1,'TOTAL') END AS CCC_BANKING_TRADING, CASE WHEN v.LEVEL2='0302(G) - Morgan Stanley & Co. International plc' THEN 'UK' ELSE 'NONE' END AS LE_GROUP, CASE WHEN v.LEVEL5='EQUITY' THEN 'INSTITUTIONAL EQUITY DIVISION' ELSE COALESCE(v.LEVEL5, 'TOTAL') END AS CCC_DIVISION, CASE WHEN v.LEVEL5='EQUITY' AND v.LEVEL6 IS NULL THEN 'INSTITUTIONAL EQUITY DIVISION' WHEN v.LEVEL5 IS NULL AND v.LEVEL6 IS NULL THEN 'TOTAL' ELSE COALESCE(v.LEVEL6, v.LEVEL5) END AS CCC_BUSINESS_AREA, (v.VAR05*-1)/1000 AS eqdeltaspline FROM CDWUSER.U_VAR_ID_FLAT_VIEW v WHERE v.COB_DATE IN ('2018-02-28') AND v.HIERARCHY_GROUP_NAME='MS_EXTENDED_CV' AND v.HIERARCHY_NAME='parent_le_greek_business' AND v.LEVEL1='Banking Internal' AND v.LEVEL2='0302(G) - Morgan Stanley & Co. International plc' AND v.LEVEL3='eq' AND v.LEVEL4='deltaspline' AND v.LEVEL7 IS NULL UNION ALL SELECT v.COB_DATE, CASE WHEN v.LEVEL1='Banking Internal' THEN 'BANKING' WHEN v.LEVEL1='Trading Internal' THEN 'TRADING' ELSE COALESCE(v.LEVEL1,'TOTAL') END AS CCC_BANKING_TRADING, CASE WHEN v.LEVEL2='0302(G) - Morgan Stanley & Co. International plc' THEN 'UK' ELSE 'NONE' END AS LE_GROUP, CASE WHEN v.LEVEL5='EQUITY' THEN 'INSTITUTIONAL EQUITY DIVISION' ELSE COALESCE(v.LEVEL5, 'TOTAL') END AS CCC_DIVISION, CASE WHEN v.LEVEL5='EQUITY' AND v.LEVEL6 IS NULL THEN 'INSTITUTIONAL EQUITY DIVISION' ELSE COALESCE(v.LEVEL6, 'TOTAL') END AS CCC_BUSINESS_AREA, (v.VAR05*-1)/1000 AS eqdeltaspline FROM CDWUSER.U_VAR_ID_FLAT_VIEW v WHERE v.COB_DATE IN ('2018-02-28') AND v.HIERARCHY_GROUP_NAME='MS_EXTENDED_CV' AND v.HIERARCHY_NAME='parent_le_greek_business' AND v.LEVEL1='Trading Internal' AND v.LEVEL2='0302(G) - Morgan Stanley & Co. International plc' AND v.LEVEL3='eq' AND v.LEVEL4='deltaspline' AND v.LEVEL7 IS NULL ) SELECT d.DIV_RANK, RANK() OVER(PARTITION BY r.CCC_BANKING_TRADING ORDER BY ABS(r.USD_DELTA_POS) DESC) TR_RANK, n.DIVISION, r.*, COALESCE(g.GROSS_DELTA_DECOMP, 0) AS GROSS_DELTA_DECOMP/*, COALESCE(v.eqdeltaspline,0) AS eqdeltaspline*/ FROM RISK_METRICS r LEFT JOIN GROSS_DELTA g ON r.COB_DATE=g.COB_DATE AND r.LE_GROUP=g.LE_GROUP AND r.CCC_BANKING_TRADING=g.CCC_BANKING_TRADING AND r.CCC_DIVISION=g.CCC_DIVISION AND r.CCC_BUSINESS_AREA=g.CCC_BUSINESS_AREA LEFT JOIN VAR v ON g.COB_DATE=v.COB_DATE AND g.LE_GROUP=v.LE_GROUP AND g.CCC_BANKING_TRADING=v.CCC_BANKING_TRADING AND g.CCC_DIVISION=v.CCC_DIVISION AND g.CCC_BUSINESS_AREA=v.CCC_BUSINESS_AREA INNER JOIN DIVISIONALRANK d ON r.COB_DATE=d.COB_DATE AND r.LE_GROUP=d.LE_GROUP AND r.CCC_DIVISION=d.CCC_DIVISION INNER JOIN DIVISION_SHORTNAME n ON r.COB_DATE=n.COB_DATE AND r.CCC_DIVISION=n.CCC_DIVISION WHERE (r.CCC_BANKING_TRADING<>'TRADING' OR r.CCC_BUSINESS_AREA<>'TOTAL') AND ( ABS(r.USD_DELTA_POS)>0 OR ABS(r.USD_EQ_KAPPA)>0 OR ABS(r.USD_EQ_PARTIAL_KAPPA)>0 OR ABS(r.USD_EQ_KAPPA_PLS100BP_TIMEADJ)>0 OR ABS(r.THETA_GAMMA)>0 OR ABS(r.USD_EQ_GAMMA)>0 OR ABS(r.CORR_EQEQ)>0 OR ABS(r.USD_EQ_DISC_RISK)>0 OR ABS(r.USD_EQ_SLIDE_D30)>0 OR ABS(r.USD_EQ_SLIDE_D20)>0 OR ABS(r.USD_EQ_SLIDE_D10)>0 OR ABS(r.USD_EQ_SLIDE_D05)>0 OR g.GROSS_DELTA_DECOMP>0 /*OR v.eqdeltaspline>0*/ )