SELECT COB_DATE, CASE WHEN CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN CCC_TAPS_COMPANY in ('0111') THEN 'MSCS' WHEN CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN CCC_TAPS_COMPANY in ('0146') THEN 'MSDP' WHEN CCC_TAPS_COMPANY in ('5745') THEN 'MSCAP' ELSE CCC_TAPS_COMPANY END AS LE, CASE WHEN CCC_BUSINESS_AREA in ('NA ELECTRICITYNATURAL GAS') or CCC_PRODUCT_LINE IN ('NA POWER & GAS') THEN 'NAPG' WHEN CCC_BUSINESS_AREA in ('OIL LIQUIDS') OR CCC_PRODUCT_LINE IN ('OIL & PRODUCTS') THEN 'OIL' WHEN CCC_BUSINESS_AREA IN ('INVESTOR BUSINESS') OR CCC_PRODUCT_LINE IN ('COMMOD INDEX','COMMOD EXOTICS') THEN 'CM Exotics and Index' WHEN CCC_BUSINESS_AREA IN ('COMMODS FINANCING') OR CCC_PRODUCT_LINE IN ('COMMOD LENDING','COMMOD - FUNDING') THEN 'CM Lending and Funding' WHEN CCC_PRODUCT_LINE IN ('PRECIOUS METALS') THEN 'Precious Metals' WHEN CCC_BUSINESS_AREA = 'CPM TRADING (MPE)' THEN 'CPM' ELSE ( case when CCC_BUSINESS_AREA in ('COMMODITIES') THEN CCC_PRODUCT_LINE ELSE CCC_BUSINESS_AREA END ) END AS BUSINESS_AREA, SUM(CASE WHEN CCC_TAPS_COMPANY IN ('0111') and CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(USD_FX,0) END) AS FX_DELTA, SUM(CASE WHEN feed_source_name <> 'CORISK' THEN COALESCE(USD_FX_KAPPA, 0) + COALESCE(usd_fx_partial_kappa,0) WHEN feed_source_name = 'CORISK' AND PRODUCT_TYPE_CODE = 'CURRENCY' THEN COALESCE(LCY_FX_KAPPA, 0)/1000 ELSE 0 END) as FX_KAPPA, rank() over( PARTITION BY COB_DATE, CASE WHEN CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN CCC_TAPS_COMPANY in ('0111') THEN 'MSCS' WHEN CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN CCC_TAPS_COMPANY in ('0146') THEN 'MSDP' WHEN CCC_TAPS_COMPANY in ('5745') THEN 'MSCAP' ELSE CCC_TAPS_COMPANY END ORDER BY ABS(SUM(CASE WHEN CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(USD_FX,0) END)) DESC, CASE WHEN CCC_BUSINESS_AREA in ('NA ELECTRICITYNATURAL GAS') or CCC_PRODUCT_LINE IN ('NA POWER & GAS') THEN 'NAPG' WHEN CCC_BUSINESS_AREA in ('OIL LIQUIDS') OR CCC_PRODUCT_LINE IN ('OIL & PRODUCTS') THEN 'OIL' WHEN CCC_BUSINESS_AREA IN ('INVESTOR BUSINESS') OR CCC_PRODUCT_LINE IN ('COMMOD INDEX','COMMOD EXOTICS') THEN 'CM Exotics and Index' WHEN CCC_BUSINESS_AREA IN ('COMMODS FINANCING') OR CCC_PRODUCT_LINE IN ('COMMOD LENDING','COMMOD - FUNDING') THEN 'CM Lending and Funding' WHEN CCC_PRODUCT_LINE IN ('PRECIOUS METALS') THEN 'Precious Metals' WHEN CCC_BUSINESS_AREA = 'CPM TRADING (MPE)' THEN 'CPM' ELSE ( case when CCC_BUSINESS_AREA in ('COMMODITIES') THEN CCC_PRODUCT_LINE ELSE CCC_BUSINESS_AREA END ) END ) as FX_DELTA_RANK, rank() over( PARTITION BY COB_DATE, CASE WHEN CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN CCC_TAPS_COMPANY in ('0111') THEN 'MSCS' WHEN CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN CCC_TAPS_COMPANY in ('0146') THEN 'MSDP' WHEN CCC_TAPS_COMPANY in ('5745') THEN 'MSCAP' ELSE CCC_TAPS_COMPANY END ORDER BY ABS(SUM(CASE WHEN feed_source_name <> 'CORISK' THEN COALESCE(USD_FX_KAPPA, 0) + COALESCE(usd_fx_partial_kappa,0) WHEN feed_source_name = 'CORISK' AND PRODUCT_TYPE_CODE = 'CURRENCY' THEN COALESCE(LCY_FX_KAPPA, 0)/1000 ELSE 0 END)) DESC, CASE WHEN CCC_BUSINESS_AREA in ('NA ELECTRICITYNATURAL GAS') or CCC_PRODUCT_LINE IN ('NA POWER & GAS') THEN 'NAPG' WHEN CCC_BUSINESS_AREA in ('OIL LIQUIDS') OR CCC_PRODUCT_LINE IN ('OIL & PRODUCTS') THEN 'OIL' WHEN CCC_BUSINESS_AREA IN ('INVESTOR BUSINESS') OR CCC_PRODUCT_LINE IN ('COMMOD INDEX','COMMOD EXOTICS') THEN 'CM Exotics and Index' WHEN CCC_BUSINESS_AREA IN ('COMMODS FINANCING') OR CCC_PRODUCT_LINE IN ('COMMOD LENDING','COMMOD - FUNDING') THEN 'CM Lending and Funding' WHEN CCC_PRODUCT_LINE IN ('PRECIOUS METALS') THEN 'Precious Metals' WHEN CCC_BUSINESS_AREA = 'CPM TRADING (MPE)' THEN 'CPM' ELSE ( case when CCC_BUSINESS_AREA in ('COMMODITIES') THEN CCC_PRODUCT_LINE ELSE CCC_BUSINESS_AREA END ) END ) as FX_KAPPA_RANK FROM CDWUSER.U_EXP_MSR where cob_date in ('02/28/2018') AND ( CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924','0111','0146','5745') OR CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') ) GROUP BY COB_DATE, CASE WHEN CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN CCC_TAPS_COMPANY in ('0111') THEN 'MSCS' WHEN CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN CCC_TAPS_COMPANY in ('0146') THEN 'MSDP' WHEN CCC_TAPS_COMPANY in ('5745') THEN 'MSCAP' ELSE CCC_TAPS_COMPANY END, CASE WHEN CCC_BUSINESS_AREA in ('NA ELECTRICITYNATURAL GAS') or CCC_PRODUCT_LINE IN ('NA POWER & GAS') THEN 'NAPG' WHEN CCC_BUSINESS_AREA in ('OIL LIQUIDS') OR CCC_PRODUCT_LINE IN ('OIL & PRODUCTS') THEN 'OIL' WHEN CCC_BUSINESS_AREA IN ('INVESTOR BUSINESS') OR CCC_PRODUCT_LINE IN ('COMMOD INDEX','COMMOD EXOTICS') THEN 'CM Exotics and Index' WHEN CCC_BUSINESS_AREA IN ('COMMODS FINANCING') OR CCC_PRODUCT_LINE IN ('COMMOD LENDING','COMMOD - FUNDING') THEN 'CM Lending and Funding' WHEN CCC_PRODUCT_LINE IN ('PRECIOUS METALS') THEN 'Precious Metals' WHEN CCC_BUSINESS_AREA = 'CPM TRADING (MPE)' THEN 'CPM' ELSE ( case when CCC_BUSINESS_AREA in ('COMMODITIES') THEN CCC_PRODUCT_LINE ELSE CCC_BUSINESS_AREA END ) END