SELECT COB_DATE, ISSUER_PARTY_DARWIN_NAME , PRODUCT_TYPE_CODE , MRD_RATING , sum(coalesce(delta,0)) AS delta, SUM(coalesce(SPREAD_PV01_USD,0)) AS SPREAD_PV01_USD, SUM(coalesce(USD_PV10,0)) AS USD_PV10, SUM(coalesce(USD_NET_EXPOSURE,0)) AS USD_NET_EXPOSURE, SUM(CASE WHEN USD_NET_EXPOSURE IS NULL THEN coalesce(DELTA,0) ELSE coalesce(USD_NET_EXPOSURE,0) END) AS JTD from ( SELECT A.COB_DATE, B.ISSUER_PARTY_DARWIN_ID AS ISSUER_PARTY_DARWIN_ID, case when b.CREDIT_RISK_ISSUER_NAME in ('UNDEFINED') THEN B.ULT_ISSUER_PARTY_DARWIN_NAME||'*'||'' ELSE B.CREDIT_RISK_ISSUER_NAME END AS ISSUER_PARTY_DARWIN_NAME, a.CCC_PL_REPORTING_REGION AS pnl_region, a.CURRENCY_OF_POSITION AS currency, CASE WHEN A.PRODUCT_TYPE_CODE IN ( 'ADR' ,'FUTURE' ,'OPTION' ,'STOCK' ,'WARRANT' ,'SWAP' ,'WARRNT' ,'ETF' ) THEN 'EQUITY' WHEN A.PRODUCT_TYPE_CODE IN ( 'BOND' ,'ASCOT' ,'CONVRT' ) THEN 'CONVERT' WHEN A.PRODUCT_TYPE_CODE IN ( 'DEFSWAP' ,'CRDINDEX' ,'CANCDFS' ) THEN 'CDS' ELSE A.PRODUCT_TYPE_CODE END AS PRODUCT_TYPE_CODE, CASE WHEN a.MRD_RATING IS NULL THEN 'NA' WHEN a.mrd_rating IN ( 'NR' ,'UNDEFINED' ,'D' ,'CC' ) THEN 'NA' ELSE a.MRD_RATING END AS MRD_RATING, CASE WHEN b.FID1_INDUSTRY_NAME_LEVEL4 = 'COMMERCIAL BANKS' THEN 'FINANCIAL: BANKS' WHEN b.FID1_INDUSTRY_NAME_LEVEL2 = 'FINANCIALS' AND b.FID1_INDUSTRY_NAME_LEVEL4 <> 'COMMERCIAL BANKS' THEN 'FINANCIAL: NON-BANKS' WHEN b.FID1_INDUSTRY_NAME_LEVEL2 IS NULL THEN 'N/A' WHEN b.FID1_INDUSTRY_NAME_LEVEL2 = 'Incomplete' THEN 'N/A' ELSE b.FID1_INDUSTRY_NAME_LEVEL2 END AS INDUSTRY_SECTOR, B.ISSUER_COUNTRY_CODE_DECOMP AS COUNTRY, CASE WHEN a.CREDIT_SPREAD_MARK <= 50 THEN '<50' WHEN a.CREDIT_SPREAD_MARK > 50 AND a.CREDIT_SPREAD_MARK <= 150 THEN '50-150' WHEN a.CREDIT_SPREAD_MARK > 150 AND a.CREDIT_SPREAD_MARK <= 250 THEN '150-250' WHEN a.CREDIT_SPREAD_MARK > 250 AND a.CREDIT_SPREAD_MARK <= 500 THEN '250-500' WHEN a.CREDIT_SPREAD_MARK > 500 AND a.CREDIT_SPREAD_MARK <= 1000 THEN '500-1000' WHEN a.CREDIT_SPREAD_MARK > 1000 THEN '>1000' ELSE 'NA' END AS CREDIT_SPREAD_BUCKETED, sum(a.usd_market_value) AS usd_market_value, SUM(B.PRODUCT_WEIGHT_DECOMP * A.USD_NET_EXPOSURE) AS USD_NET_EXPOSURE, SUM(COALESCE(B.USD_EQ_DELTA_DECOMP,0))+SUM(COALESCE(B.USD_CM_DELTA_DECOMP,0)) AS DELTA, SUM(A.USD_EQ_GAMMA) AS GAMMA ,SUM(A.USD_VEGA) AS VEGA ,SUM(A.USD_PV01SPRD) AS SPREAD_PV01_USD, sum(a.USD_CREDIT_PV10PCT) AS USD_PV10, SUM(a.CREDIT_SPREAD_MARK * a.USD_NET_EXPOSURE) AS NET_EXPOSURE_X_SPREAD FROM CDWUSER.u_IED_VIEW A ,CDWUSER.U_DECOMP_MSR B WHERE a.COB_DATE = '2017-08-10' and A.CCC_TAPS_COMPANY in ('7800','4068','8962','8961','8959','8941','8790','8789','8772','8757','8627','8564','8537','8524','8441','8292','8290','8284','8275','8253','8237','8179','8174','7716','7705','7704','7458','7435','7416','7281','7280','7043','7016','6899','6893','6838','6837','6590','6589','6384','6383','6376','6374','6367','6325','6316','6262','6158','6157','6120','6114','6036','5869','5856','5656','5614','5357','5310','5274','5254','5181','5180','5148','5121','5104','5103','4884','4880','4876','4863','4859','4858','4857','4590','4564','4562','4545','4543','4536','4391','4267','4241','4092','4086','4067','4044','4043','1718','1709','1498','1480','1472','1438','1433','1344','1322','1317','1314','1313','1311','1308','0993','0856','0853','0726','0721','0715','0713','0621','0620','0517','0347','0342','0328','0319','0314','0313','0302') AND A.COB_DATE = B.COB_DATE AND A.POSITION_ID = B.POSITION_ID AND A.PROCESS_ID = B.PROCESS_ID AND a.CCC_DIVISION IN ('INSTITUTIONAL EQUITY DIVISION') AND a.CCC_PRODUCT_LINE IN ('CONVERTIBLE PRODUCTS') AND A.CCC_BANKING_TRADING IN ('TRADING') AND a.SILO_SRC IN ('IED') GROUP BY A.COB_DATE, B.ISSUER_PARTY_DARWIN_ID, case when b.CREDIT_RISK_ISSUER_NAME in ('UNDEFINED') THEN B.ULT_ISSUER_PARTY_DARWIN_NAME||'*'||'' ELSE B.CREDIT_RISK_ISSUER_NAME END , a.CCC_PL_REPORTING_REGION , a.CURRENCY_OF_POSITION , CASE WHEN A.PRODUCT_TYPE_CODE IN ( 'ADR' ,'FUTURE' ,'OPTION' ,'STOCK' ,'WARRANT' ,'SWAP' ,'WARRNT' ,'ETF' ) THEN 'EQUITY' WHEN A.PRODUCT_TYPE_CODE IN ( 'BOND' ,'ASCOT' ,'CONVRT' ) THEN 'CONVERT' WHEN A.PRODUCT_TYPE_CODE IN ( 'DEFSWAP' ,'CRDINDEX' ,'CANCDFS' ) THEN 'CDS' ELSE A.PRODUCT_TYPE_CODE END , CASE WHEN a.MRD_RATING IS NULL THEN 'NA' WHEN a.mrd_rating IN ( 'NR' ,'UNDEFINED' ,'D' ,'CC' ) THEN 'NA' ELSE a.MRD_RATING END , CASE WHEN b.FID1_INDUSTRY_NAME_LEVEL4 = 'COMMERCIAL BANKS' THEN 'FINANCIAL: BANKS' WHEN b.FID1_INDUSTRY_NAME_LEVEL2 = 'FINANCIALS' AND b.FID1_INDUSTRY_NAME_LEVEL4 <> 'COMMERCIAL BANKS' THEN 'FINANCIAL: NON-BANKS' WHEN b.FID1_INDUSTRY_NAME_LEVEL2 IS NULL THEN 'N/A' WHEN b.FID1_INDUSTRY_NAME_LEVEL2 = 'Incomplete' THEN 'N/A' ELSE b.FID1_INDUSTRY_NAME_LEVEL2 END , B.ISSUER_COUNTRY_CODE_DECOMP, CASE WHEN a.CREDIT_SPREAD_MARK <= 50 THEN '<50' WHEN a.CREDIT_SPREAD_MARK > 50 AND a.CREDIT_SPREAD_MARK <= 150 THEN '50-150' WHEN a.CREDIT_SPREAD_MARK > 150 AND a.CREDIT_SPREAD_MARK <= 250 THEN '150-250' WHEN a.CREDIT_SPREAD_MARK > 250 AND a.CREDIT_SPREAD_MARK <= 500 THEN '250-500' WHEN a.CREDIT_SPREAD_MARK > 500 AND a.CREDIT_SPREAD_MARK <= 1000 THEN '500-1000' WHEN a.CREDIT_SPREAD_MARK > 1000 THEN '>1000' ELSE 'NA' END )sub_qry GROUP BY COB_DATE, ISSUER_PARTY_DARWIN_NAME , PRODUCT_TYPE_CODE , MRD_RATING