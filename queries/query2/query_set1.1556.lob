SELECT Z.*, DOLLAR_DELTA, RAW_DELTA, RAW_VEGA, FX_DELTA, RHO, USD_DELTA_COB - USD_DELTA_PCOB AS USD_DELTA_CHG, RAW_DELTA_COB - RAW_DELTA_PCOB AS RAW_DELTA_CHG, RAW_VEGA_COB - RAW_VEGA_PCOB AS RAW_VEGA_CHG, FX_DELTA_COB - FX_DELTA_PCOB AS FX_DELTA_CHG, RHO_COB - RHO_PCOB AS RHO_CHG, CASE WHEN PRODUCT_TYPE_CODE = 'CURRENCY' THEN PRODUCT_TYPE_CODE ELSE 'Other' END AS PRODUCT_TYPE_CODE_FX_DELTA, CASE WHEN PRODUCT_TYPE_CODE IN ('CURRENCY','INTEREST RATE') THEN PRODUCT_TYPE_CODE ELSE 'Other' END AS PRODUCT_TYPE_CODE_RHO, CASE WHEN PRODUCT_SUB_TYPE_CODE IN ('EUR','GBP','USD') THEN PRODUCT_SUB_TYPE_CODE ELSE 'Other' END AS PRODUCT_SUB_TYPE_CODE_FX_DELTA, CASE WHEN TIME_BUCKET_RANK <= 4 THEN QUARTER_FORMATTED WHEN TIME_BUCKET_YEAR = COB_YEAR_1 THEN TIME_BUCKET_YEAR WHEN TIME_BUCKET_YEAR > COB_YEAR_1 AND TIME_BUCKET_YEAR <= COB_YEAR_4 THEN COB_YEAR_2||'-'||COB_YEAR_4 ELSE COB_YEAR_4||'+' END AS TIME_BUCKET_GROUP, CASE WHEN TIME_BUCKET_RANK <= 4 THEN TIME_BUCKET_RANK WHEN TIME_BUCKET_YEAR = COB_YEAR_1 THEN 100 WHEN TIME_BUCKET_YEAR >= COB_YEAR_2 AND TIME_BUCKET_YEAR <= COB_YEAR_4 THEN 102 ELSE 103 END AS FINAL_RANK FROM ( SELECT PRODUCT_TYPE_CODE, PRODUCT_SUB_TYPE_CODE, PRODUCT_SUB_TYPE_NAME, PRODUCT_TYPE_NAME, COB_DATE, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CASE WHEN LOT_UNIT_OF_LABEL = 'MTHERM' THEN 'MM of therms' WHEN LOT_UNIT_OF_LABEL = 'KTON' THEN 'K of metric tonnes' WHEN LOT_UNIT_OF_LABEL = 'MT' THEN 'MM of metric tonnes' ELSE LOT_UNIT_OF_LABEL END AS LOT_UNIT_OF_LABEL, CONCAT(20,TIME_BUCKET_YEAR) AS TIME_BUCKET_YEAR, CONCAT(TIME_BUCKET_QUARTER,TIME_BUCKET_YEAR) AS QUARTER_FORMATTED, DENSE_RANK() OVER (ORDER BY TIME_BUCKET_CALENDAR, TIME_BUCKET_QUARTER ASC) AS TIME_BUCKET_RANK, EXTRACT('year' FROM (COB_DATE + INTERVAL '1 year')) AS COB_YEAR_1, EXTRACT('year' FROM (COB_DATE + INTERVAL '2 years')) AS COB_YEAR_2, EXTRACT('year' FROM (COB_DATE + INTERVAL '3 years')) AS COB_YEAR_3, EXTRACT('year' FROM (COB_DATE + INTERVAL '4 years')) AS COB_YEAR_4, CASE WHEN COB_DATE = '2018-02-28' THEN 'Y' ELSE 'N' END AS IS_COB, SUM(DOLLAR_DELTA) AS DOLLAR_DELTA, SUM(RAW_DELTA) AS RAW_DELTA, SUM(RAW_VEGA) AS RAW_VEGA, SUM(FX_DELTA) AS FX_DELTA, SUM(RHO) AS RHO, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN DOLLAR_DELTA ELSE 0 END) AS USD_DELTA_COB, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN RAW_DELTA ELSE 0 END) AS RAW_DELTA_COB, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN RAW_VEGA ELSE 0 END) AS RAW_VEGA_COB, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN FX_DELTA ELSE 0 END) AS FX_DELTA_COB, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN RHO ELSE 0 END) AS RHO_COB, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN DOLLAR_DELTA ELSE 0 END) AS USD_DELTA_PCOB, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN RAW_DELTA ELSE 0 END) AS RAW_DELTA_PCOB, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN RAW_VEGA ELSE 0 END) AS RAW_VEGA_PCOB, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN FX_DELTA ELSE 0 END) AS FX_DELTA_PCOB, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN RHO ELSE 0 END) AS RHO_PCOB FROM ( SELECT COB_DATE, PRODUCT_TYPE_CODE, PRODUCT_SUB_TYPE_CODE, PRODUCT_SUB_TYPE_NAME, PRODUCT_TYPE_NAME, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, LOT_UNIT_OF_LABEL, TIME_BUCKET_CALENDAR, TO_NUMBER( CASE WHEN CHAR_LENGTH(TIME_BUCKET_ANNUAL) > 10 THEN SUBSTRING(TIME_BUCKET_ANNUAL FROM 10 FOR 2) ELSE SUBSTRING(TIME_BUCKET_ANNUAL FROM 5 FOR 2) END, '99G999D9S') AS TIME_BUCKET_YEAR, SUM(USD_CM_DELTA) AS DOLLAR_DELTA, SUM(RAW_CM_DELTA) AS RAW_DELTA, SUM(RAW_CM_KAPPA) AS RAW_VEGA, sum(cast(coalesce(USD_FX_DELTA,0) as numeric(15,5))) as FX_DELTA, sum(cast(coalesce(USD_IR_RHO,0) as numeric(15,5)) + cast(coalesce(USD_CM_LEASE_RATE,0) as numeric(15,5)))/10 as RHO FROM CDWUSER.U_EXP_MSR A WHERE cob_date IN ('2018-02-28','2018-02-27') AND CCC_BUSINESS_AREA = 'COMMODITIES' AND CCC_PRODUCT_LINE = 'EU POWER & GAS' AND PRODUCT_TYPE_CODE NOT IN ('INFLATION', 'TBD', 'MISC','CVA', 'FVA', 'ERROR') GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9 ) Y GROUP BY COB_DATE, COB_YEAR_1, COB_YEAR_2, COB_YEAR_3, COB_YEAR_4, IS_COB, PRODUCT_TYPE_CODE, PRODUCT_SUB_TYPE_CODE, PRODUCT_SUB_TYPE_NAME, PRODUCT_TYPE_NAME, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, LOT_UNIT_OF_LABEL, TIME_BUCKET_YEAR, TIME_BUCKET_CALENDAR ) Z