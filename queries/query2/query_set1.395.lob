with x as ( SELECT SUM (COALESCE (v.USD_DIV_RHO,0)) as Div_Rho , v.PARTIAL_DECOMP_TICK, v.PARTIAL_DECOMP_SECURITY_DESCRIPTION From CDWUSER.U_IED_COMP_MSR v WHERE COB_DATE = '2017-08-10' and v.CCC_BANKING_TRADING = 'TRADING' and v.division = 'IED' and v.ccc_business_area NOT IN ('INTERNATIONAL WEALTH MGMT', 'SENIOR LENDING', 'PROCESS DRIVEN TRADING') and v.ccc_taps_company in ('0302', '0313', '0314', '0319', '0328', '0342', '0347', '0517', '0620', '0621', '0646', '0711', '0713', '0715', '0721', '0726', '0853', '0856', '0993', '1308', '1311', '1313', '1314', '1317', '1322', '1344', '1433', '1438', '1472', '1480', '1498', '1709', '1718', '4043', '4044', '4067', '4068', '4086', '4092', '4241', '4267', '4391', '4536', '4543', '4545', '4562', '4564', '4588', '4590', '4857', '4858', '4859', '4863', '4876', '4880', '4884', '5103', '5104', '5121', '5148', '5180', '5181', '5254', '5274', '5310', '5357', '5614', '5656', '5856', '5869', '6036', '6114', '6120', '6152', '6156', '6157', '6158', '6262', '6316', '6325', '6367', '6374', '6376', '6383', '6384', '6589', '6590', '6837', '6838', '6893', '6899', '7016', '7280', '7281', '7416', '7435', '7458', '7704', '8174', '8179', '8237', '8253', '8275', '8284', '8290', '8292', '8441', '8524', '8537', '8564', '8627', '8757', '8772', '8789', '8790', '8941', '8942', '8943', '8959', '8961', '8962', '8963') GROUP by v.USD_DIV_RHO, v.PARTIAL_DECOMP_TICK, v.PARTIAL_DECOMP_SECURITY_DESCRIPTION ) ( SELECT RANK () over (ORDER BY ( ABS(Div_Rho) ) DESC ) || '_' || 'TopDivRho' AS Concentration, PARTIAL_DECOMP_TICK, PARTIAL_DECOMP_SECURITY_DESCRIPTION, Div_Rho from ( SELECT x.PARTIAL_DECOMP_TICK, x.PARTIAL_DECOMP_SECURITY_DESCRIPTION, SUM(COALESCE(Div_Rho,0)) as Div_Rho FROM X GROUP BY x.PARTIAL_DECOMP_TICK, x.PARTIAL_DECOMP_SECURITY_DESCRIPTION )sub_qry FETCH FIRST 30 rows only )