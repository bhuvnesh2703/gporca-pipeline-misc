SELECT CURRENCY_OF_MEASURE AS PV_CURRENCY, EM_GROUP, G10_GROUP, SUM(USD_FX) AS SUM_USD_FX, DENSE_RANK() OVER ( ORDER BY CASE WHEN EM_GROUP = 'G10' THEN 1 ELSE 2 END, ABS(SUM(USD_FX)) DESC ) AS RANK_FX_HARD, DENSE_RANK() OVER ( ORDER BY CASE WHEN G10_GROUP = 'Non-G10' THEN 1 ELSE 2 END, ABS(SUM(USD_FX)) DESC ) AS RANK_FX_LOCAL FROM ( SELECT CASE WHEN CURRENCY_OF_MEASURE = 'CNH' THEN 'CNY' WHEN CURRENCY_OF_MEASURE = 'KRX' THEN 'KRW' WHEN CURRENCY_OF_MEASURE IN ('BRX', 'BR1') THEN 'BRL' WHEN CURRENCY_OF_MEASURE IN ('RBX', 'RU1') THEN 'RUB' ELSE CURRENCY_OF_MEASURE END AS CURRENCY_OF_MEASURE, G10_GROUP, CASE WHEN A.EM_GROUP IN ('Other', 'EM ex CNY, CNH') THEN 'EM ex CNY, CNH' ELSE A.EM_GROUP END AS EM_GROUP, SUM(COALESCE(USD_FX, 0)) / 1000 AS USD_FX FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE = '02/28/2018' AND CCC_BUSINESS_AREA NOT IN ('COMMODS FINANCING', 'CREDIT') AND A.CCC_PRODUCT_LINE NOT IN ('COMMOD LEGACY NON-TRADING','COMMOD LENDING') AND A.CURRENCY_OF_MEASURE NOT IN ('UBD', 'USD', 'UB1') AND VAR_EXCL_FL <> 'Y' AND BU_RISK_SYSTEM <> 'PIPELINE_NY' AND BU_RISK_RUN_CUSTOM1 <> 'STORAGE' AND CCC_DIVISION NOT IN ('FIC DVA','FID DVA') GROUP BY CURRENCY_OF_MEASURE, G10_GROUP, CASE WHEN A.EM_GROUP IN ('Other', 'EM ex CNY, CNH') THEN 'EM ex CNY, CNH' ELSE A.EM_GROUP END ) a GROUP BY CURRENCY_OF_MEASURE, G10_GROUP, EM_GROUP