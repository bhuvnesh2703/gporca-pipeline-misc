SELECT D.CCC_DIVISION, CASE WHEN D.DIVISION_RANK < 10 THEN D.DIVISION_RANK ELSE 10 END AS DIVISION_RANK, CASE WHEN D.DIVISION_RANK < 10 THEN D.CURRENCY ELSE 'OTHER' END AS DIVISION_CURRENCY, CASE WHEN D.TOTAL_RANK < 10 THEN D.TOTAL_RANK ELSE 10 END AS TOTAL_RANK, CASE WHEN D.TOTAL_RANK < 10 THEN D.CURRENCY ELSE 'OTHER' END AS TOTAL_CURRENCY, E.TERM_NEW, E.USD_PV01_COB AS USD_PV01_COB, E.USD_PV01_CHANGE AS USD_PV01_CHANGE FROM (SELECT C.*, RANK() OVER (PARTITION BY C.CCC_DIVISION ORDER BY CASE WHEN C.CURRENCY = 'USD' THEN 1 WHEN C.CURRENCY = 'EUR' THEN 2 WHEN C.CURRENCY = 'GBP' THEN 3 WHEN C.CURRENCY = 'JPY' THEN 4 ELSE 5 END, ABS(C.USD_PV01_COB) DESC) AS DIVISION_RANK FROM (SELECT B.CCC_DIVISION, B.CURRENCY, SUM(B.USD_PV01_COB) AS USD_PV01_COB , SUM(B.USD_PV01_CHANGE) AS USD_PV01_CHANGE, TOTAL_RANK FROM (SELECT RANK() OVER (ORDER BY CASE WHEN CURRENCY = 'USD' THEN 1 WHEN CURRENCY = 'EUR' THEN 2 WHEN CURRENCY = 'GBP' THEN 3 WHEN CURRENCY = 'JPY' THEN 4 ELSE 5 END, ABS(USD_PV01_COB) DESC) AS TOTAL_RANK, CURRENCY FROM ( SELECT case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end as currency, SUM(CASE WHEN cob_date = '2018-02-28' THEN COALESCE(usd_ir_unified_pv01,0) ELSE 0 END ) AS USD_PV01_COB, SUM(CASE WHEN cob_date = '2018-02-28' THEN COALESCE(usd_ir_unified_pv01,0) ELSE -COALESCE(usd_ir_unified_pv01,0) END ) AS USD_PV01_CHANGE FROM CDWUSER.U_EXP_TRENDS WHERE cob_date IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND LENGTH (currency_code) < 4 AND VAR_EXCL_FL <> 'Y' AND ccc_banking_trading = 'TRADING' GROUP BY case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end ) Z ) A, ( SELECT case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end as currency, CASE WHEN CCC_DIVISION IN ('FIXED INCOME DIVISION', 'INSTITUTIONAL EQUITY DIVISION','TREASURY CAPITAL MARKETS') THEN CCC_DIVISION ELSE 'OTHER' END AS CCC_DIVISION, SUM(CASE WHEN cob_date = '2018-02-28' THEN COALESCE(usd_ir_unified_pv01,0) ELSE 0 END ) AS USD_PV01_COB, SUM(CASE WHEN cob_date = '2018-02-28' THEN COALESCE(usd_ir_unified_pv01,0) ELSE -COALESCE(usd_ir_unified_pv01,0) END ) AS USD_PV01_CHANGE FROM CDWUSER.U_EXP_TRENDS WHERE cob_date IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND LENGTH (currency_code) < 4 AND VAR_EXCL_FL <> 'Y' AND ccc_banking_trading = 'TRADING' GROUP BY case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end, CCC_DIVISION ) B WHERE A.CURRENCY = B.CURRENCY GROUP BY B.CCC_DIVISION, B.CURRENCY, TOTAL_RANK ) C )D, ( SELECT case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end as currency, CASE WHEN CCC_DIVISION IN ('FIXED INCOME DIVISION', 'INSTITUTIONAL EQUITY DIVISION', 'TREASURY CAPITAL MARKETS') THEN CCC_DIVISION ELSE 'OTHER' END AS CCC_DIVISION, case when term_new<0.25 then term_new when term_new in ('0.25', '0.5','0.75', '1', '2', '3','5', '7', '8', '10', '12', '15', '20',' 30', '40') then term_new else 0 end as term_new, SUM(CASE WHEN cob_date = '2018-02-28' THEN COALESCE(usd_ir_unified_pv01,0) ELSE 0 END ) AS USD_PV01_COB, SUM(CASE WHEN cob_date = '2018-02-28' THEN COALESCE(usd_ir_unified_pv01,0) ELSE -COALESCE(usd_ir_unified_pv01,0) END ) AS USD_PV01_CHANGE FROM CDWUSER.u_EXP_TRENDS WHERE cob_date IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND LENGTH (currency_code) < 4 AND VAR_EXCL_FL <> 'Y' AND ccc_banking_trading = 'TRADING' GROUP BY case when currency_code = 'CNY' and onshore_fl = 'N' then 'CNH' when currency_code = 'KRW' and onshore_fl = 'N' then 'KRX' when currency_code = 'BRL' and onshore_fl = 'N' then 'BRX' else currency_code end , CASE WHEN CCC_DIVISION IN ('FIXED INCOME DIVISION', 'INSTITUTIONAL EQUITY DIVISION', 'TREASURY CAPITAL MARKETS') THEN CCC_DIVISION ELSE 'OTHER' END, case when term_new<0.25 then term_new when term_new in ('0.25', '0.5','0.75', '1', '2', '3','5', '7', '8', '10', '12', '15', '20',' 30', '40') then term_new else 0 end ) E WHERE D.CCC_DIVISION = E.CCC_DIVISION AND D.CURRENCY = E.CURRENCY AND ((ABS(COALESCE(E.USD_PV01_COB, 0)) + ABS(COALESCE(E.USD_PV01_COB, 0)) <> 0) OR (D.CURRENCY IN ('USD', 'EUR', 'GBP', 'JPY')))