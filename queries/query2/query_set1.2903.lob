WITH DIVISIONALRANK AS( SELECT e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, RANK() OVER(ORDER BY ABS(sum(coalesce(e.USD_EQ_KAPPA,0)))/1000 DESC) AS DIV_RANK, sum(coalesce(e.USD_EQ_KAPPA,0))/1000 as USD_EQ_KAPPA FROM CDWUSER.U_EXP_MSR_PARTIAL e WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION ), DIVISION_SHORTNAME AS( SELECT d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END AS DIVISION FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') GROUP BY d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END ), ASSET_LIST AS( SELECT e.COB_DATE, /*e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.CCC_BUSINESS_AREA,*/ CASE WHEN e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE='UNDEFINED.UNDEFINED' THEN e.TICKER ELSE e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE END AS TICK, RANK() OVER(ORDER BY ABS(sum(coalesce(e.USD_EQ_KAPPA,0)))DESC) as RANK, sum(coalesce(e.USD_EQ_KAPPA,0))/1000 as USD_EQ_KAPPA FROM CDWUSER.U_EXP_MSR_PARTIAL e WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' AND e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK<>1) GROUP BY e.COB_DATE, /*e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.CCC_BUSINESS_AREA,*/ CASE WHEN e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE='UNDEFINED.UNDEFINED' THEN e.TICKER ELSE e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE END HAVING abs(sum(coalesce(e.USD_EQ_KAPPA,0)))>0 FETCH FIRST 10 ROWS ONLY ), EXP_MSR AS( SELECT e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.DIVISION, CASE WHEN e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) THEN e.CCC_DIVISION ELSE e.CCC_BUSINESS_AREA END AS CCC_BUSINESS_AREA, CASE WHEN e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE='UNDEFINED.UNDEFINED' THEN e.TICKER ELSE e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE END AS TICK, sum(coalesce(e.USD_EQ_KAPPA,0))/1000 as USD_EQ_KAPPA FROM CDWUSER.U_EXP_MSR_PARTIAL e WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.DIVISION, e.CCC_BUSINESS_AREA, CASE WHEN e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE='UNDEFINED.UNDEFINED' THEN e.TICKER ELSE e.PARTIAL_DECOMP_TICK||'.'||e.PARTIAL_DECOMP_EXCHANGE END ) SELECT e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.CCC_BUSINESS_AREA, e.TICK, e.USD_EQ_KAPPA, l.RANK, n.DIVISION FROM EXP_MSR e, ASSET_LIST l, DIVISION_SHORTNAME n WHERE e.TICK=l.TICK AND e.CCC_DIVISION=n.CCC_DIVISION