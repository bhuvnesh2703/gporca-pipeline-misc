Select A.COB_DATE, A.CCC_PL_REPORTING_REGION, A.PRODUCT_TYPE_CODE, CASE WHEN A.PRODUCT_SUB_TYPE_CODE IN ('N EAST CONSUMPTI', 'N EAST CONSUMPTION') THEN 'N EAST CONSUMPTI' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('N EAST APPALACHI', 'N EAST APPALACHIA') THEN 'N EAST APPALACHI' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('POLYPROPELENE HO', 'POLYPROPELENE HOMOPOLYMER') THEN 'POLYPROPELENE HO' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('POLYPROPYLENE CO', 'POLYPROPYLENE COPOLYMER') THEN 'POLYPROPYLENE CO' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('PURE TEREPHTHALI', 'PURE TEREPHTHALIC ACID') THEN 'PURE TEREPHTHALI' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('GSCI-PRECIOUS ME', 'GSCI-PRECIOUS METALS') THEN 'GSCI-PRECIOUS ME' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('ZERO PRICED EXPO', 'ZERO PRICED EXPOSURE') THEN 'ZERO PRICED EXPO' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('DJUBS-BASE METAL', 'DJUBS-BASE METALS') THEN 'DJUBS-BASE METAL' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('GAS SULFUR CREDI', 'GAS SULFUR CREDIT') THEN 'GAS SULFUR CREDI' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('GASOIL TIMESPREA', 'GASOIL TIMESPREAD') THEN 'GASOIL TIMESPREA' WHEN A.PRODUCT_SUB_TYPE_CODE IN ('USD INTEREST RAT', 'USD INTEREST RATE') THEN 'USD INTEREST RAT' ELSE A.PRODUCT_SUB_TYPE_CODE END AS PRODUCT_SUB_TYPE_CODE, A.TIME_BUCKET_CALENDAR, A.QUARTERS, SUM(A.DELTA_GREEK) as DELTA_GREEK, A.CurrentMonth, SUM(A.VEGA_GREEK) as VEGA_GREEK, SUM(A.GAMMA_GREEK) as GAMMA_GREEK, SUM(A.THETA_GREEK) as THETA_GREEK ,SUM(A.FX_DELTA) AS FX_DELTA, SUM(A.RHO_GREEK) AS RHO_GREEK FROM( Select PRODUCT_TYPE_CODE,CCC_PL_REPORTING_REGION, PRODUCT_SUB_TYPE_CODE, COB_DATE, EXPIRATION_DATE, time_bucket_quarter, TIME_BUCKET_CALENDAR, SUM(cast(USD_CM_DELTA as numeric(15,5))) as DELTA_GREEK, SUM (CASE WHEN PRODUCT_TYPE_CODE = 'TIMESPREAD' AND PROD_POS_NAME_DESCRIPTION = 'WCS POST SPREAD' THEN 0 WHEN (book = 'COMXO' and CCC_PRODUCT_LINE IN ('COMMOD EXOTICS')) then CAST(USD_CM_KAPPA_ABSOLUTE AS NUMERIC (15, 5)) ELSE CAST (RAW_CM_KAPPA AS NUMERIC (15, 5)) END) AS VEGA_GREEK, SUM(cast(USD_CM_GAMMA/20 as numeric(15,5))) as GAMMA_GREEK, SUM(cast(USD_CM_THETA as numeric(15,5))) as THETA_GREEK, SUM(CAST(USD_FX_DELTA AS NUMERIC(15, 5))) AS FX_DELTA, SUM(CAST(coalesce(USD_IR_RHO,0) AS NUMERIC(15, 5)) + CAST(coalesce(USD_CM_LEASE_RATE,0) AS NUMERIC(15, 5)))/10 AS RHO_GREEK, case when EXPIRATION_DATE < ('2019-09-01') then extract(MONTH from (EXPIRATION_DATE)) end as CurrentMonth, case when EXPIRATION_DATE < ('2019-09-01') then time_bucket_quarter end as quarters FROM cdwuser.U_EXP_MSR Where COB_DATE IN ('2018-02-28','2018-02-27') AND ((CCC_BUSINESS_AREA = 'INVESTOR BUSINESS' AND CCC_PRODUCT_LINE = 'IB STRUCTURED' AND CCC_DIVISION IN ('COMMODITIES')) /*OLD LOGIC*/ OR (CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' and CCC_PRODUCT_LINE IN ('COMMOD EXOTICS'))) /*NEW LOGIC*/ AND CCC_PL_REPORTING_REGION = 'AMERICAS' AND PRODUCT_TYPE_CODE not in ('CVA', 'FVA','MISC') GROUP BY PRODUCT_TYPE_CODE,CCC_PL_REPORTING_REGION, PRODUCT_SUB_TYPE_CODE, TIME_BUCKET_CALENDAR, EXPIRATION_DATE, COB_DATE, time_bucket_quarter)A GROUP BY A.COB_DATE, A.PRODUCT_TYPE_CODE, A.CCC_PL_REPORTING_REGION, A.PRODUCT_SUB_TYPE_CODE, A.TIME_BUCKET_CALENDAR, A.QUARTERS, A.CurrentMonth