SELECT COB_DATE, CCC_PRODUCT_LINE, SUM(CM_NET_EXP) AS SUM_CM_NET_EXP, DENSE_RANK() OVER ( ORDER BY CASE WHEN CM_NET_EXP IS NULL THEN 1 ELSE 0 END ASC, ABS(CM_NET_EXP) DESC ) AS RANK_CM FROM ( SELECT A.COB_DATE, A.CCC_PRODUCT_LINE, (SUM(A.CM_DELTA) + SUM(A.ER_CM_DELTA_DECOMP))/1000 AS CM_NET_EXP FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE = '02/28/2018' AND NOT ( A.PRODUCT_TYPE_CODE IN ('ZCS') AND A.CCC_PRODUCT_LINE IN ('IB STRUCTURED') ) GROUP BY A.COB_DATE, A.CCC_PRODUCT_LINE ) B GROUP BY COB_DATE, CCC_PRODUCT_LINE, CM_NET_EXP