select cob_date, entity, usd_delta, case when usd_delta < 0 then P5_cob - usd_delta else D5_cob + usd_delta end as slide, dividend from ( select cob_date, entity, sum(usd_delta) * 0.05 as usd_delta, sum(D5_cob) as D5_cob, sum(P5_cob) as P5_cob, sum(dividend) as dividend from ( select cob_date, case when parent_legal_entity = '0342' then 'MSSL' else 'MSIP' end as entity, sum( coalesce(slide_eq_min_30_usd,0) ) as D30_cob, sum( coalesce(slide_eq_min_20_usd,0) ) as D20_cob, sum( coalesce(slide_eq_min_10_usd,0) ) as D10_cob, sum( coalesce(slide_eq_min_05_usd,0) ) as D5_cob, sum( coalesce(slide_eq_pls_05_usd,0) ) as P5_cob, sum( coalesce(slide_eq_pls_10_usd,0) ) as P10_cob, sum( coalesce(slide_eq_pls_20_usd,0) ) as P20_cob, sum( case when FEED_SOURCE_NAME NOT IN ('CORISK', 'ER1') then coalesce(usd_delta,0) else 0 end) as usd_delta, sum( coalesce(USD_EQ_DISC_RISK,0) ) as dividend from cdwuser.u_eq_msr eq where cob_date = '2018-02-28' AND parent_legal_entity in ('0302(G)') AND ccc_banking_trading = 'TRADING' AND var_excl_fl <> 'Y' GROUP BY cob_date, case when parent_legal_entity = '0342' then 'MSSL' else 'MSIP' end UNION select cob_date, case when parent_legal_entity = '0342' then 'MSSL' else 'MSIP' end as entity, 0 as D30_cob, 0 as D20_cob, 0 as D10_cob, 0 as D5_cob, 0 as P5_cob, 0 as P10_cob, 0 as P20_cob, sum( coalesce(USD_CM_DELTA,0) ) as usd_delta, 0 as dividend from cdwuser.u_cm_msr eq where cob_date = '2018-02-28' AND parent_legal_entity in ('0302(G)') AND ccc_banking_trading = 'TRADING' AND var_excl_fl <> 'Y' AND FEED_SOURCE_NAME = 'CORISK' AND PRODUCT_TYPE_CODE = 'EQUITY INDEX' GROUP BY cob_date, case when parent_legal_entity = '0342' then 'MSSL' else 'MSIP' end UNION select cob_date, case when parent_legal_entity = '0342' then 'MSSL' else 'MSIP' end as entity, 0 as D30_cob, 0 as D20_cob, 0 as D10_cob, 0 as D5_cob, 0 as P5_cob, 0 as P10_cob, 0 as P20_cob, sum( coalesce(USD_EQ_DELTA_DECOMP,0) ) as usd_delta, 0 as dividend from cdwuser.u_decomp_msr eq where cob_date = '2018-02-28' AND parent_legal_entity in ('0302(G)') AND ccc_banking_trading = 'TRADING' AND var_excl_fl <> 'Y' AND FEED_SOURCE_ID = 301 AND COALESCE (PRODUCT_TYPE_CODE_DECOMP, '') <> 'COMM' AND COALESCE (CASH_ISSUE_TYPE, '') <> 'COMM' GROUP BY cob_date, case when parent_legal_entity = '0342' then 'MSSL' else 'MSIP' end ) a group by cob_date, entity ) b