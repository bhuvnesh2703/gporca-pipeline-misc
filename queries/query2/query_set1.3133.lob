With x as ( SELECT a.CCC_PL_REPORTING_REGION || '|' || CASE WHEN a.CCC_BUSINESS_AREA = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN a.CCC_BUSINESS_AREA = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE a.CCC_BUSINESS_AREA END as ID, a.COB_DATE as COB_DATE, a.CCC_PL_REPORTING_REGION as REGION, CASE WHEN a.CCC_BUSINESS_AREA = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN a.CCC_BUSINESS_AREA = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE a.CCC_BUSINESS_AREA END as BUSINESS_AREA, ROUND(sum(coalesce(a.YTD_PL,0))/1000000,2) as YTD_PNL, ROUND(sum(coalesce(a.DAILY_PL,0))/1000000,2) as DAILY_PNL FROM CDWUSER.U_PCT_PNL_CURRENT a WHERE a.COB_DATE >= '2016-01-01' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND (a.ACCOUNT_PURPOSE_CODE <> 'J' or a.ACCOUNT_PURPOSE_CODE is null) GROUP BY a.COB_DATE || '|' || a.CCC_PL_REPORTING_REGION || '|' || CASE WHEN a.CCC_BUSINESS_AREA = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN a.CCC_BUSINESS_AREA = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE a.CCC_BUSINESS_AREA END, a.COB_DATE, a.CCC_PL_REPORTING_REGION, CASE WHEN a.CCC_BUSINESS_AREA = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN a.CCC_BUSINESS_AREA = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE a.CCC_BUSINESS_AREA END ), y as ( SELECT LEVEL1 || '|' || CASE WHEN LEVEL3 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN LEVEL3 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE LEVEL3 END as ID, a.COB_DATE, LEVEL1 as REGION, CASE WHEN LEVEL3 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN LEVEL3 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE LEVEL3 END as BUSINESS_AREA, CASE WHEN (LEVEL1 IS NOT NULL AND LEVEL2 IS NULL AND LEVEL3 IS NULL AND LEVEL4 IS NULL AND LEVEL5 IS NULL) THEN 0 ELSE ROUND(VALUE/1000000,2) END AS GNURAMV FROM CDWUSER.U_AGGREGATION_DETAIL a, CDWUSER.U_AGGREGATION_SCHEMA s WHERE a.COB_DATE >= '2016-01-01' AND a.HIERARCHY_ID = 2 AND a.LEVEL3 IS NOT NULL AND a.LEVEL4 IS NULL AND a.COB_DATE = s.COB_DATE AND a.AGGREGATION_NAME = s.AGGREGATION_NAME AND a.HIERARCHY_ID = s.HIERARCHY_ID AND a.VERSION_ID = s.VERSION_ID AND s.IS_LATEST = 1 GROUP BY LEVEL1 || '|' || CASE WHEN LEVEL3 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN LEVEL3 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE LEVEL3 END, a.COB_DATE, LEVEL1, CASE WHEN LEVEL3 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN LEVEL3 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE LEVEL3 END, CASE WHEN (LEVEL1 IS NOT NULL AND LEVEL2 IS NULL AND LEVEL3 IS NULL AND LEVEL4 IS NULL AND LEVEL5 IS NULL) THEN 0 ELSE ROUND(VALUE/1000000,2) END ), z as ( SELECT v.level1 || '|' || CASE WHEN level2 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN level2 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE level2 END as ID, level1, CASE WHEN level2 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN level2 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE level2 END as level2, cob_date, -ROUND(var05/1000,2) as VAR05, -ROUND(var01/1000,2) as VAR01, ROUND(STDDEV/1000,2) as STDDEV FROM CDWUSER.U_VAR_ID_FLAT_VIEW v WHERE (hierarchy_group_name='EQUITY_CV') AND (hierarchy_name='region') AND v.LEVEL2 IS NOT NULL AND v.LEVEL3 IS NULL AND COB_DATE >= '2016-01-01' AND -var05 > 20 ORDER BY v.level1 || '|' || CASE WHEN level2 = 'DELTA ONE' THEN 'CASH EQUITIES' WHEN level2 = 'EQUITY FINANCING PRODUCTS' THEN 'PRIME BROKERAGE' ELSE level2 END, cob_date, hierarchy_group_name, hierarchy_name, COALESCE(LEVEL1,''), COALESCE(LEVEL2,'') ) SELECT x.COB_DATE, x.REGION, x.BUSINESS_AREA, x.YTD_PNL, x.DAILY_PNL, y.GNURAMV, z.VAR01, z.VAR05, z.STDDEV FROM x join y ON x.ID = y.ID and x.cob_date = y.cob_date join z ON x.ID = z.ID and x.cob_date = z.cob_date