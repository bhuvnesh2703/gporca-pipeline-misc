WITH rawTable AS (SELECT raw.tapscusip ,raw.source_scn_name ,raw.book ,raw.raw_pnl ,cob_date,position_currency ,term as TERM_OF_MEASURE ,CASE when CCC_DIVISION IN ('FIC DVA', 'FID DVA') OR CCC_BUSINESS_AREA = 'OTHER IED' then 'DVA' when book in ('EULT'  , 'RPOTO' , 'NYDI' , 'CT0101LIQ1' , 'TSTRP' , 'RPOAF' , 'RPOTP' , 'RPOTU' , 'TLGPP' , 'TSTHK') then 'Other Liabilities' when book in ('TSTJY') then 'Other Assets' when book in ('TSTLN') then 'Other Liabilities' when book in ('TSTNY') then 'Other Assets' when book in ('TSTCY') then 'Other Hedges' when book in ('TSTTK' , 'RWULT' , 'NYTU' , 'EUG7' , 'EUC5' , 'EUIP' , 'EUIS' , 'EUIF' , 'EUPS' , 'EUTF' , 'INDMF') then 'Other Liabilities' when book in ('LIABB') then 'Other Assets' when book in ('TSBR1' , 'RPOCO' , 'RPOEQ' , 'RWILX' , 'RWIKX' , 'TBDAP') then 'Other Liabilities' when book in ('TNSAP' , 'TNSLN' , 'TNSNY') then 'Other Assets' when book in ('TSTDP' , 'TSTTO' , 'RWUIS' , 'RWUIP') then 'Other Liabilities' when book in ('TMSSC') then 'Other Assets' when book in ('NYN2' , 'NYCO' , 'RPOCT' , 'TBSNY' , 'TTSNY' , 'RPOHF' , 'RPOHH' , 'TBSHK' , 'EUFA' , 'EUGY' , 'EUKK' , 'EUUK' , 'PROJECT KARL' , 'TBSAP' , 'TBSLN') then 'Other Liabilities' when book in ('TBSSG' , 'TDPSD') then 'Other Assets' when book in ('TDPSG' , 'TSAGD' , 'TSBAG' , 'TZUMD' , 'RWUUK' , 'EUFA' , 'RWUFA' , 'EUPB' , 'EUO1' , 'RWUPB' , 'RWPO1' , 'RWPO2' , 'RWPO3') then 'Other Liabilities' when book in ('MSBKD') then 'Other Assets' when book in ('RWIBK' , 'China Bank Capital on Treasury 2 - CHCA2-CHCA2' , 'CHINA BANK CAPITAL ON TSY-CHCAP') then 'Other Liabilities' when book in ('TBICD') then 'Other Assets' when book in ('RWBIC' , 'TSGSP') then 'Other Liabilities' when book in ('TSTPM') then 'Non-Bank Investment Portfolios' when book in ('CTFTB') then 'Other Assets' when book in ('MMPDS' , 'TSTMM' , 'EUHT' , 'LX' , 'NYKG' , 'NYKI' , 'NYN1' , 'RPOHE' , 'RPOKE' , 'TNYSL') then 'Other Liabilities' when book in ('TAPRZ' , 'TAPTY') then 'Other Assets' when book in ('TATUY' , 'TAPTZ' , 'TAPUZ' , 'TAPSZ') then 'Other Liabilities' when book in ('TAPUY') then 'Other Assets' when book in ('RPOHB' , 'RPOHG' , 'AEOUT' , 'BCDUT' , 'VNCDB' , 'UTCDS' , 'STRUCTURED CD' , 'MSDEP' , 'TAPBL' , 'TLNBL' , 'TSAGL' , 'TSGBL' , 'TZUML' , 'TBICL' , 'TNYBL' , 'TAPCP' , 'TNYCP') then 'Other Liabilities' when book in ('CFXEU' , 'CFXNA' , 'CT0101SWP' , 'CT0101SWP-AP' , 'CT0101SWP-LN' , 'CT0101SWP-TK' , 'CT0302SWP' , 'TLNFX' , 'TOMFS' , 'TSGFX' , 'TZUFX' , 'KRSWP' , 'CT1633SWP' , 'CT0362SWP' , 'CT0870SWP' , 'THKFX' , 'TICIP' , 'TICMS' , 'CT7713SWP' , 'CT7714SWP' , 'CT7715SWP') then 'Other Hedges' when book in ('EUGS' , 'TAPSS' , 'TLNSS') then 'Other Liabilities' when book in ('CT0302XE' , 'CT0101XE') then 'Other Hedges' when book in ('CAEMR' , 'TKFVL' , 'TAEMR' , 'CAIRR' , 'TAIRR' , 'CBAGR' , 'TBAGR' , 'CEEMR' , 'TEEMR' , 'COMSN' , 'CSCPR' , 'CTHKR' , 'CTIRR' , 'TTIRR' , 'CTNUR' , 'CTTKR' , 'TSYFE' , 'TSYRT' , 'TKFVS') then 'Other Liabilities' when book in ('CALLB' , 'CALTB') then 'Other Hedges' when book in ('LCALT' , 'LCATB' , 'TTIRP' , 'TSYCALL' , 'TSYCSNLN' , 'CTCNR' , 'MSMSR' , 'HKFAM' , 'HKFAP' , 'HKFAS' , 'ASIA ELN SWAPS' , 'ELNLT' , 'NBFCE' , 'LN ELNLT' , 'LNFVO' , 'ASIA ELNLT' , 'MS DVA STRUCTURED NO' , 'MS STRUCTURED NOTES' , 'ISSUANCE FUNDING' , 'TCM_TNY' , 'CLIENT STRUCTURES' , 'EQTRE' , 'FVONY' , 'LN_ELNLT' , 'NY_ELNLT' , 'AP_CALLABLES' , 'MSF_CALLABLES' , 'MSF_CALLABLES_BRM' , 'NY_CALLABLES' , 'NY_CALLABLES_BRM' , 'AEOEQ' , 'EQGRP') then 'Other Liabilities' when book in ('TDEBT' , 'LHRO1' , 'LHRO2') then 'ASC 815 Debt' when book in ('SWPIN' , 'SWPLH' , 'SUBIN' , 'SUBLH' , 'SWCOH' , 'SWCLH') then 'ASC 815 Hedges' when book in ('TDET4') then 'Other Hedges' when book in ('TDET7' , 'TDET8') then 'Other Liabilities' when book in ('AEO' , 'AEOCT' , 'AEOFF' , 'AEOTK' , 'SWPTR' , 'SUBTR' , 'TSTON') then 'Other Hedges' when book in ('TDET5') then 'Other Liabilities' when book in ('AEONE' , 'AEONF') then 'Other Hedges' when book in ('AEOST') then 'Other Liabilities' when book in ('TAPOZ' , 'TST31' , 'TSTOH' , 'TST3F' , 'TSTCH' , 'TSTGB' , 'TSTOF' , 'TSTOL') then 'Other Hedges' when book in ('TDET2' , 'TDET6' , 'TRPFD') then 'Other Liabilities' when book in ('PRFEQ') then 'Preferred Stock' when book in ('CT0201SPT' , 'CT0201SPT2' , 'FXNYDFLTC' , 'RVKRW' , 'TOMCP' , 'TSYFX' , 'TYBRL' , 'TYCNY' , 'TYHDG' , 'TYKRW' , 'TYTWD' , 'TYWON' , 'HNKRW' , 'TSRUB' , 'CT1633SPT' , 'TYBIC' , 'CT0101SPT' , 'GLFX1' , 'ROBIC' , 'CT0302SPT' , 'CT0101SPT6262' , 'CT0101FWD' , 'CT0101FWDP' , 'TYSJV') then 'Other Hedges' when book in ('CTA_PRE_TAX') then 'Other Liabilities' when book in ('TSTEU') then 'Other Hedges' when book in ('AEOAP') then 'Other Liabilities' when book in ('TSFRA') then 'Other Hedges' when book in ('TKFVM') then 'Other Liabilities' when book in ('TSHTM') then 'Non-Bank Investment Portfolios' when book in ('TSTSB') then 'Other Hedges' when book in ('FPDFX' , 'FTDFX' , 'PFDFX') then 'Other Liabilities' when book in ('CT101GAAP') then 'Other Hedges' when book in ('LN_MSMS' , 'TCM_BRL' , 'TCM_MSF' , 'TCM_MSF_CALL' , 'TCM_MSF_CALL_BRM' , 'TK_MSMS' , 'TMSFH' , 'TMSFL' , 'TMSFN' , 'TMSFT') then 'Other Liabilities' when book in ('UNKNOWN') then 'Other Hedges' when book in ('CMSFT' , 'CSTNT') then 'Other Liabilities' when book in ('SWOLH' , 'SUOLH') then 'ASC 815 Hedges' when book in ('SWOTR' , 'SUOTR') then 'Other Hedges' when book in ('SWOIN' , 'SUOIN') then 'ASC 815 Hedges' when book in ('NY_TREASURY_STRUCTUR' , 'TAPZU') then 'Other Liabilities' when book in ('CTA0101XE' , 'CTA0517XE') then 'Other Hedges' when book in ('RPOGI' , 'RPOSE' , 'TYGAS' , 'VNCDP') then 'Other Liabilities' when book in ('CVHL1' , 'CVHN1') then 'Other Hedges' when book in ('TDCLH') then 'ASC 815 Debt' when book in ('SWCLH' , 'SWCOH') then 'ASC 815 Hedges' when book in ('LCALB' , 'LACAB' , 'TCATB' , 'TKCAL') then 'Other Hedges' when book in ('TAPTH' , 'TAPUH' , 'STSTTO') then 'Other Assets' else 'Other Liabilities' end as product_group FROM dwuser.u_raw_scenario_pnl raw where COB_DATE in ('2018-02-28', '2018-01-31') AND   bu_risk_system LIKE 'C1_SCENARIOS_EVE_NY' AND raw.source_scn_name = 'Parallel IR 1.0 bps'), WEIGHT AS ( SELECT A.*, CASE WHEN TERM_OF_MEASURE/365 <= 0.25 THEN 0.25 ELSE TERM_OF_MEASURE/365 END AS TERM_OF_MEASURE_WEIGHT FROM rawtable A  ) , NEWWEIGHT AS ( SELECT A.*, CASE WHEN TERM_OF_MEASURE_WEIGHT >= 30 THEN 30  WHEN TERM_OF_MEASURE_WEIGHT >= 20 THEN 20 WHEN TERM_OF_MEASURE_WEIGHT >= 15 THEN 15  WHEN TERM_OF_MEASURE_WEIGHT >= 10 THEN 10  WHEN TERM_OF_MEASURE_WEIGHT >= 7 THEN 7 WHEN TERM_OF_MEASURE_WEIGHT >= 5 THEN 5 WHEN TERM_OF_MEASURE_WEIGHT >= 3 THEN 3 WHEN TERM_OF_MEASURE_WEIGHT >= 2 THEN 2 WHEN TERM_OF_MEASURE_WEIGHT >= 1 THEN 1  WHEN TERM_OF_MEASURE_WEIGHT >= 0.5 THEN 0.5  ELSE 0.25 END AS LOW_BUCKET ,CASE  WHEN TERM_OF_MEASURE_WEIGHT < 0.25 THEN 0.25 WHEN TERM_OF_MEASURE_WEIGHT < 0.5 THEN 0.5  WHEN TERM_OF_MEASURE_WEIGHT < 1 THEN 1 WHEN TERM_OF_MEASURE_WEIGHT < 2 THEN 2 WHEN TERM_OF_MEASURE_WEIGHT < 3 THEN 3 WHEN TERM_OF_MEASURE_WEIGHT < 5 THEN 5 WHEN TERM_OF_MEASURE_WEIGHT < 7 THEN 7  WHEN TERM_OF_MEASURE_WEIGHT < 10 THEN 10  WHEN TERM_OF_MEASURE_WEIGHT < 15 THEN 15 WHEN TERM_OF_MEASURE_WEIGHT < 20 THEN 20  WHEN TERM_OF_MEASURE_WEIGHT < 30 THEN 30 ELSE 30 END AS HIGH_BUCKET FROM WEIGHT A ) ,  FINAL_WEIGHT AS ( SELECT A.*, (HIGH_BUCKET - LOW_BUCKET) AS BUCKET_WIDTH ,CASE WHEN TERM_OF_MEASURE_WEIGHT <=0.25 THEN 1 WHEN TERM_OF_MEASURE_WEIGHT >=30 THEN 0 ELSE 1-((TERM_OF_MEASURE_WEIGHT - LOW_BUCKET)/(HIGH_BUCKET - LOW_BUCKET)) END AS LOW_BUCKET_WEIGHT ,CASE WHEN TERM_OF_MEASURE_WEIGHT <=0.25 THEN 0 WHEN TERM_OF_MEASURE_WEIGHT >=30 THEN 1 ELSE ((TERM_OF_MEASURE_WEIGHT - LOW_BUCKET)/(HIGH_BUCKET - LOW_BUCKET)) END AS HIGH_BUCKET_WEIGHT FROM NEWWEIGHT A  ) , RAWTABLE_WEIGHTED as ( SELECT  LOW_BUCKET AS term_new  ,i.product_group ,cob_date ,sum(i.raw_pnl*LOW_BUCKET_WEIGHT) AS USD_IR_UNIFIED_PV01 FROM FINAL_WEIGHT i group by  LOW_BUCKET ,i.product_group ,cob_date union all SELECT  HIGH_BUCKET AS term_new  ,i.product_group ,cob_date ,sum(i.raw_pnl*HIGH_BUCKET_WEIGHT) AS USD_IR_UNIFIED_PV01 FROM FINAL_WEIGHT i group by  HIGH_BUCKET ,i.product_group ,cob_date   ) select * from RAWTABLE_WEIGHTED