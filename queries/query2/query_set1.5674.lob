SELECT * FROM ( select COB_DATE, CURRENCY_OF_MEASURE, book, HEDGE_FLAG, CASE WHEN (usd_fx_Hedges_Pnl<>0 AND usd_fx_Hedges_PnL IS NOT NULL) OR (usd_fx_Assets_PnL<>0 AND usd_fx_Assets_PnL IS NOT NULL) THEN 'PNL' ELSE 'OCI_ONLY' END AS PNL_FLAG, SUM(usd_fx_Hedges_OCI) AS usd_fx_Hedges_OCI, SUM(usd_fx_Hedges_PnL) AS usd_fx_Hedges_PnL, SUM(usd_fx_Assets_OCI) AS usd_fx_Assets_OCI, SUM(usd_fx_Assets_PnL) AS usd_fx_Assets_PnL FROM ( select COB_DATE, CURRENCY_OF_MEASURE, book, HEDGE_FLAG, CASE WHEN sum(usd_fx_Hedges_OCI)=0 then 0 WHEN sum(usd_fx_Hedges_PnL)>0 THEN GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)-sum(usd_fx_Hedges_PnL)) WHEN sum(usd_fx_Hedges_PnL)<=0 THEN GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)) END AS usd_fx_Hedges_OCI, CASE WHEN (sum(usd_fx_Hedges_PnL)=0 AND sum(usd_fx_Hedges_OCI)>-sum(usd_fx_Assets)) then 0 WHEN sum(usd_fx_Hedges_PnL)>0 THEN sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)-sum(usd_fx_Hedges_PnL)) WHEN sum(usd_fx_Hedges_PnL)<=0 THEN sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)) END AS usd_fx_Hedges_PnL, CASE WHEN (sum(usd_fx_Hedges_PnL)>0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))=0) THEN sum(usd_fx_Assets)+sum(usd_fx_Hedges_PnL) WHEN (sum(usd_fx_Hedges_PnL)<=0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))=0) THEN sum(usd_fx_Assets) WHEN (sum(usd_fx_Hedges_PnL)>0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))<>0) THEN -GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)-sum(usd_fx_Hedges_PnL)) WHEN (sum(usd_fx_Hedges_PnL)<=0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))<>0) THEN -GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)) END as usd_fx_Assets_OCI, CASE WHEN (sum(usd_fx_Hedges_PnL)>0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))=0) THEN sum(usd_fx_Assets)-sum(usd_fx_Assets)+sum(usd_fx_Hedges_PnL) WHEN (sum(usd_fx_Hedges_PnL)<=0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))=0) THEN sum(usd_fx_Assets)-sum(usd_fx_Assets) WHEN (sum(usd_fx_Hedges_PnL)>0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))<>0) THEN sum(usd_fx_Assets)-(-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)-sum(usd_fx_Hedges_PnL)) ) WHEN (sum(usd_fx_Hedges_PnL)<=0 AND (sum(usd_fx_Hedges_PnL)+sum(usd_fx_Hedges_OCI)-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets)))<>0) THEN sum(usd_fx_Assets)-(-GREATEST(sum(usd_fx_Hedges_OCI),-sum(usd_fx_Assets))) END as usd_fx_Assets_PnL, sum(usd_fx_Hedges_OCI) as usd_fx_Hedges_OCI_before_manip, sum(usd_fx_Hedges_PnL) as usd_fx_Hedges_PnL_before_manip, sum(usd_fx_Assets) as usd_fx_Assets_before_manip FROM ( SELECT case when (f.COB_DATE = '2018-02-27') then '2018-02-28' else '2018-02-27' end as COB_DATE, f.CURRENCY_OF_MEASURE, f.book, SUM(CASE WHEN (f.CURRENCY_OF_MEASURE NOT IN ('UBD', 'USD') AND f.BOOK IN ('CT0101FWD','CTFW','TYSJV')) THEN f.USD_NOTIONAL ELSE 0 END)*1000 as usd_fx_Hedges_OCI, SUM(CASE WHEN (f.CURRENCY_OF_MEASURE NOT IN ('UBD', 'USD') AND f.BOOK IN ('CT0101FWDP')) THEN f.USD_NOTIONAL ELSE 0 END)*1000 as usd_fx_Hedges_PnL, 0 as usd_fx_Assets, CASE WHEN f.CURRENCY_OF_MEASURE IN ('AUD','BRL','CAD','CHF','EUR','GBP','HKD', 'HUF', 'INR','JPY','KRW','MXN','RUB','SEK','SGD','TWD','CNY','IDR') THEN 'Hedged' ELSE 'Not Hedged' END AS HEDGE_FLAG FROM cdwuser.U_OT_MSR f WHERE cob_date in ('2018-02-27', '2018-02-26') AND f.CCC_DIVISION = 'TREASURY CAPITAL MARKETS' AND f.BOOK IN ('CT0101FWD', 'CTFW', 'CT0101FWDP', 'TYSJV') GROUP BY case when (f.COB_DATE = '2018-02-27') then '2018-02-28' else '2018-02-27' end, f.CURRENCY_OF_MEASURE, f.book, CASE WHEN f.CURRENCY_OF_MEASURE IN ('AUD','BRL','CAD','CHF','EUR','GBP','HKD', 'HUF','INR','JPY','KRW','MXN','RUB','SEK','SGD','TWD','CNY','IDR') THEN 'Hedged' ELSE 'Not Hedged' END UNION ALL SELECT case when (f.COB_DATE = '2018-02-28') then '2018-02-28' else '2018-02-27' end as COB_DATE, f.CURRENCY_OF_MEASURE, f.book, 0 as usd_fx_Hedges_OCI, 0 as usd_fx_Hedges_PnL, SUM(CASE WHEN (f.CURRENCY_OF_MEASURE NOT IN ('UBD', 'USD') AND f.BOOK IN ('CTA_PRE_TAX')) THEN f.USD_NOTIONAL ELSE 0 END)*1000 as usd_fx_Assets, CASE WHEN f.CURRENCY_OF_MEASURE IN ('AUD','BRL','CAD','CHF','EUR','GBP','HKD', 'HUF','INR','JPY','KRW','MXN','RUB','SEK','SGD','TWD','CNY','IDR') THEN 'Hedged' ELSE 'Not Hedged' END AS HEDGE_FLAG FROM cdwuser.U_OT_MSR f WHERE cob_date in ('2018-02-28', '2018-02-27') AND f.CCC_DIVISION = 'TREASURY CAPITAL MARKETS' AND f.BOOK IN ('CTA_PRE_TAX') GROUP BY case when (f.COB_DATE = '2018-02-28') then '2018-02-28' else '2018-02-27' end, f.CURRENCY_OF_MEASURE, f.book, CASE WHEN f.CURRENCY_OF_MEASURE IN ('AUD','BRL','CAD','CHF','EUR','GBP','HKD', 'HUF','INR','JPY','KRW','MXN','RUB','SEK','SGD','TWD','CNY','IDR') THEN 'Hedged' ELSE 'Not Hedged' END ) a GROUP BY COB_DATE, CURRENCY_OF_MEASURE, book, HEDGE_FLAG ) b GROUP BY COB_DATE, CURRENCY_OF_MEASURE, book, HEDGE_FLAG, CASE WHEN (usd_fx_Hedges_PnL<>0 AND usd_fx_Hedges_PnL IS NOT NULL) OR (usd_fx_Assets_PnL<>0 AND usd_fx_Assets_PnL IS NOT NULL) THEN 'PNL' ELSE 'OCI_ONLY' END ) c where book in ('CTCTA','CTFW','CT0101FWDP', 'TYSJV', 'CT0101SPT', 'CTS1', 'CTZH', 'REVL', 'CT0302SPT', 'CT3L', 'CTBN', 'CTNY', 'CTSKB', 'HNKRW', 'ROBIC', 'RVKRW', 'FDNY', 'TSYS1', 'TSYS2', 'CTFTB', 'CT0101LIQ1', 'LIABB', 'TAPRZ', 'TAPTH', 'TAPTY', 'TAPUH', 'TAPUY', 'TSTJY', 'INDMF', 'RWILX', 'TSTJY', 'TMSSC', 'CT0101SWP', 'CT0101SWP-AP', 'CTF3', 'CTHK', 'CTHKB', 'CTSGB', 'CTSGD', 'CTL3', 'CT0101SWP-LN', 'CT0302SWP', 'CTF2', 'KRSWP', 'CTTK', 'CT0101SWP-TK', 'CTF4', 'CT0101XE', 'CT0302XE', 'TICIP', 'TICMS', 'SUBLH', 'AEOCT', 'AEONE', 'SUBIN', 'SUBTR', 'SWCLH', 'SWCOH', 'SWOLH', 'SWPIN', 'SWPLH', 'SWPTR', 'TAPOZ', 'TDCLH', 'TDEBT', 'TST31', 'TST3F', 'TSTCH', 'TSTEU', 'TSTGB', 'TSTOH', 'TSTOL')