select B.*, rank() over (partition by COUNTRY_OF_RISK_TIER, PRODUCT_SOVEREIGN_CD order by abs_ne desc) AS COUNTRY_RANK from ( SELECT A.*, ABS(SUM(USD_EXPOSURE) over (PARTITION BY COUNTRY_OF_RISK_TIER, PRODUCT_SOVEREIGN_CD, COUNTRY_CD_OF_RISK)) as abs_ne FROM ( SELECT COB_DATE, CASE WHEN A.CREDIT_TYPE_CD = 'CREDIT-HY_T1T2' OR A.CCC_PRODUCT_LINE = 'DISTRESSED TRADING' THEN 'HIGH_YIELD' ELSE NULL END AS CATEGORY, A.PRODUCT_SOVEREIGN_CD, A.COUNTRY_CD_OF_RISK, A.COUNTRY_OF_RISK_TIER, SUM(COALESCE(USD_EXPOSURE, 0))/1000000 AS USD_EXPOSURE FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE = '02/28/2018' AND VAR_EXCL_FL <> 'Y' AND BU_RISK_SYSTEM <> 'PIPELINE_NY' AND CCC_DIVISION NOT IN ('FIC DVA','FID DVA') AND CCC_BUSINESS_AREA <> 'GLOBAL STRUCT PRODUCTS' AND ( ( ( A.CREDIT_TYPE_CD = 'CREDIT-HY_T1T2' OR A.CCC_PRODUCT_LINE = 'DISTRESSED TRADING' ) AND DIVISION_GROUP NOT IN ('GWMG', 'WMG') ) OR COUNTRY_OF_RISK_TIER = '2' ) GROUP BY COB_DATE, CASE WHEN A.CREDIT_TYPE_CD = 'CREDIT-HY_T1T2' OR A.CCC_PRODUCT_LINE = 'DISTRESSED TRADING' THEN 'HIGH_YIELD' ELSE NULL END, A.PRODUCT_SOVEREIGN_CD, A.COUNTRY_CD_OF_RISK, A.COUNTRY_OF_RISK_TIER ) A ) B