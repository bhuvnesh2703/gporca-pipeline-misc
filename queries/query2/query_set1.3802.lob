SELECT a.COB_DATE, a.LE, a.POSITION_CREDIT_PARTY_DARWIN_NAME AS CPTY, case when c.rank_currency <= 10 then a.CURRENCY_BUCKET else 'OTHERS' end as CURRENCY_BUCKET, a.ctpy_netting_group_code, a.USD_IR_UNIFIED_PV01, b.rank, case when c.rank_currency <= 5 then c.rank_currency else 6 end as rank_currency FROM ( select a.COB_DATE , a.PARENT_LEGAL_ENTITY AS LE , a.POSITION_CREDIT_PARTY_DARWIN_NAME , CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END AS CURRENCY_BUCKET , ctpy_netting_group_code , sum(a.USD_IR_UNIFIED_PV01) as USD_IR_UNIFIED_PV01 from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') and not (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') and a.USD_IR_UNIFIED_PV01 is not null group by a.COB_DATE , a.PARENT_LEGAL_ENTITY , a.POSITION_CREDIT_PARTY_DARWIN_NAME , CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END , ctpy_netting_group_code ) a left join ( select a.POSITION_CREDIT_PARTY_DARWIN_NAME , sum(a.USD_IR_UNIFIED_PV01) as USD_IR_UNIFIED_PV01 , rank() over(ORDER BY abs(sum(coalesce(a.USD_IR_UNIFIED_PV01,0))) desc ) AS rank from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') and not (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') and a.USD_IR_UNIFIED_PV01 is not null group by a.POSITION_CREDIT_PARTY_DARWIN_NAME ) b on b.POSITION_CREDIT_PARTY_DARWIN_NAME = a.POSITION_CREDIT_PARTY_DARWIN_NAME left join ( select CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END AS CURRENCY_BUCKET , sum(a.USD_IR_UNIFIED_PV01) as USD_IR_UNIFIED_PV01 , rank() over(ORDER BY abs(sum(coalesce(a.USD_IR_UNIFIED_PV01,0))) desc ) as rank_currency from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') and not (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC') and a.USD_IR_UNIFIED_PV01 is not null group by CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END ) c on c.CURRENCY_BUCKET = a.CURRENCY_BUCKET UNION ALL SELECT a.COB_DATE , a.PARENT_LEGAL_ENTITY AS LE , case when a.ctpy_netting_group_code = '2526220' then 'MSCO clear through CME' ELSE a.POSITION_CREDIT_PARTY_DARWIN_NAME END AS CPTY , CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END AS CURRENCY_BUCKET , ctpy_netting_group_code , sum(a.USD_IR_UNIFIED_PV01) as USD_IR_UNIFIED_PV01 , 0 as rank , 0 as rank_currency FROM OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND a.PARENT_LEGAL_ENTITY in ('0111') and (a.position_ultimate_credit_party_darwin_name in ('LCH.CLEARNET LIMITED') or (a.ctpy_netting_group_code = '2526220' and a.POSITION_CREDIT_PARTY_DARWIN_NAME = 'MORGAN STANLEY & CO. LLC')) and a.USD_IR_UNIFIED_PV01 is not null GROUP BY a.COB_DATE , a.PARENT_LEGAL_ENTITY , a.POSITION_CREDIT_PARTY_DARWIN_NAME , a.CURRENCY_OF_MEASURE , ctpy_netting_group_code