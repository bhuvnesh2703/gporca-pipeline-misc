SELECT COB_DATE, PV01_DIVISION_GROUP, PV01_CATEGORY, PV01_CURRENCY, CASE WHEN RANK_PV01 < 7 THEN CURRENCY_OF_MEASURE ELSE 'OTHERS' END AS CURRENCY, SUM(PV01) AS PV_01 FROM ( SELECT COB_DATE, PV01_DIVISION_GROUP, PV01_CURRENCY, PV01_CATEGORY, CURRENCY_OF_MEASURE, PV01, DENSE_RANK() OVER(ORDER BY CASE WHEN CURRENCY_OF_MEASURE IN ('USD', 'EUR') THEN 1 ELSE 2 END, CASE WHEN PV01_COB is null then 1 else 0 end asc, ABS(PV01_COB) DESC ) RANK_PV01 FROM ( SELECT COB_DATE, PV01_DIVISION_GROUP, PV01_CURRENCY, PV01_CATEGORY, CURRENCY_OF_MEASURE, PV01, SUM(PV01_COB) OVER(PARTITION BY CURRENCY_OF_MEASURE) PV01_COB FROM ( SELECT COB_DATE, PV01_DIVISION_GROUP, CURRENCY_OF_MEASURE, PV01_CURRENCY, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('STRUCTURED RATES', 'LIQUID FLOW RATES') THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ( 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING' ) THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP', 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT', 'COMMODITIES' ) THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND PV01_DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND PV01_DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN PV01_DIVISION_GROUP IN ('ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG') THEN PV01_DIVISION_GROUP WHEN CCC_DIVISION NOT IN ( 'INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION' ) AND PV01_DIVISION_GROUP IN ('ISG CORE', 'ISG NON CORE') THEN 'OTHER ISG' ELSE 'NON ISG' END AS PV01_CATEGORY, SUM(A.USD_IR_UNIFIED_PV01) AS PV01, SUM ( CASE WHEN COB_DATE = '02/28/2018' THEN A.USD_IR_UNIFIED_PV01 END ) PV01_COB FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VAR_EXCL_FL <> 'Y' AND BU_RISK_SYSTEM <> 'PIPELINE_NY' AND BU_RISK_RUN_CUSTOM1 <> 'STORAGE' AND CCC_DIVISION NOT IN ('FIC DVA','FID DVA') AND BU_RISK_SYSTEM NOT LIKE '%EQUITYSD%' AND NOT ( A.CCC_BUSINESS_AREA = 'SECURITIZED PRODUCTS GRP' AND SPG_CATEGORY = 'WAREHOUSE_FINAL' ) GROUP BY COB_DATE, PV01_DIVISION_GROUP, PV01_CURRENCY, CURRENCY_OF_MEASURE, PV01_CURRENCY, PV01_CATEGORY ) A ) B )C GROUP BY COB_DATE, PV01_DIVISION_GROUP, PV01_CATEGORY, PV01_CURRENCY, CURRENCY