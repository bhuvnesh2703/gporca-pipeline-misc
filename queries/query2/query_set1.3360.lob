Select  cob_date, count(ticket) as failed_trades, case when SOURCE_SCN_NAME in ('BHC2017_S1_FX_ATM_Vol', 'BHC2017_S1_FX_Spot')  then 'BHC2017_S1_FX_ALL' end as stress_scenario, 'BHC adj.' as category, ccc_division, ccar_business_category, product_type, currency_pair, case  when bu_risk_system like '%FXOPT%' then 'FXOPT' else bu_risk_system end as vertical_system, SUM(RAW_PNL) /1000 as pnl FROM DWUSER.U_RAW_SCENARIO_PNL  WHERE COB_DATE = '2018-02-28' and SOURCE_SCN_NAME in (  'BHC2017_S1_FX_ATM_Vol',  'BHC2017_S1_FX_Spot'  ) and ticket in ( SELECT distinct ticket FROM DWUSER.U_MODULAR_SCENARIO_DQ WHERE COB_DATE = '2018-02-28' AND FULL_REVAL_SCENARIO_NAME = 'BHC2017_S1_FX_ALL'  and slice_name like '%FXOPT%'  ) and bu_risk_system like '%FXOPT%'  and product_type = 'FXOPT' and ccar_business_category <>'NOT_INCLUDED' group by  cob_date, SOURCE_SCN_NAME, product_type, currency_pair, ccc_division, ccar_business_category, bu_risk_system, ticket UNION ALL  SELECT cob_date, count(ticket) as failed_trades,  stress_scenario , 'FRB adj.' as category,   ccc_division,     ccar_business_category,     product_type,      case      when (scenario_dimension = 'FX PRICE' and length(measure_currency)=3 and measure_currency in ('EUR', 'AUD','GBP','NZD' ))  then concat(measure_currency,'USD')     when (scenario_dimension = 'FX PRICE' and length(measure_currency)=3 and measure_currency not in ('EUR', 'AUD','GBP','NZD' )) then concat('USD',measure_currency)      when (scenario_dimension = 'FX VOLATILITY' and length(measure_currency)=3 and measure_currency in ('EUR', 'AUD','GBP','NZD' ))  then concat(measure_currency,'USD')     when (scenario_dimension = 'FX VOLATILITY' and length(measure_currency)=3 and measure_currency not in ('EUR', 'AUD','GBP','NZD' )) then concat('USD',measure_currency)      else measure_currency     end as currency_pair,          CASE      WHEN risk_system LIKE '%BANKLOANS%' THEN 'BANKLOANS'      WHEN risk_system LIKE '%BT%' THEN 'BT'      WHEN risk_system LIKE '%C1%' THEN 'C1'      WHEN risk_system LIKE '%FXDDI%' THEN 'FXDDI'      WHEN risk_system LIKE '%FXOPT%' THEN 'FXOPT'      WHEN risk_system LIKE '%GWM%' THEN 'GWM'      WHEN risk_system LIKE '%IRD%' THEN 'STS'      WHEN risk_system LIKE '%PERSIST%' THEN 'PERSIST'      WHEN risk_system LIKE '%SPG%' OR risk_system LIKE '%MBS%' THEN 'SPG'      WHEN risk_system LIKE 'STS_%' THEN 'STS'      WHEN risk_system LIKE '%RETAIL%' THEN 'GWM'      WHEN risk_system LIKE '%REPO%' THEN 'REPO'      WHEN (RISK_SYSTEM LIKE 'EQUITY%' OR RISK_SYSTEM = 'R1') THEN 'GRS'      WHEN RISK_SYSTEM LIKE '%MSIM%' THEN 'MSIM'     ELSE (CASE WHEN ccc_division = 'COMMODITIES' THEN 'CORISK'      WHEN RISK_SYSTEM IN ('NY-EXTERN-STRATES', 'PM-FXPB', 'PM-IR', 'PM-OPTIONS') THEN 'CORISK'     ELSE 'OTHER' END)      END AS VERTICAL_SYSTEM,              SUM (     CASE WHEN          attribution = 'FX VEGA' AND          ccc_division = 'COMMODITIES' AND          (risk_system NOT LIKE '%BANKLOANS%' AND           risk_system NOT LIKE '%BT%' AND           risk_system NOT LIKE '%C1%' AND           risk_system NOT LIKE '%FXDDI%' AND           risk_system NOT LIKE '%FXOPT%' AND           risk_system NOT LIKE '%GWM%' AND           risk_system NOT LIKE '%IRD%' AND           risk_system NOT LIKE '%PERSIST%' AND           risk_system NOT LIKE '%SPG%' AND           risk_system NOT LIKE '%MBS%' AND           risk_system NOT LIKE 'STS_%' AND           risk_system NOT LIKE '%RETAIL%' AND           risk_system NOT LIKE '%REPO%')          THEN scenario_pnl / 10               ELSE scenario_pnl     END)/1000 AS pnl FROM dwuser.u_modular_scenarios_ccar WHERE COB_DATE = '2018-02-28'     AND stress_scenario in ('FRB2017_SA_FX_ALL')     AND SCENARIO_TYPE = 'GREEK'      and ticket in      (SELECT distinct ticket     FROM DWUSER.U_MODULAR_SCENARIO_DQ WHERE COB_DATE = '2018-02-28'     AND FULL_REVAL_SCENARIO_NAME = 'FRB2017_SA_FX_ALL'      and slice_name like '%FXOPT%')     AND RISK_SYSTEM  LIKE '%FXOPT%'     AND(CCAR_BUSINESS_CATEGORY NOT LIKE 'NOT%' OR BOOK = 'MBREIFUNDHEDGES')       GROUP BY     cob_date,     ccar_business_category,     stress_scenario,     ccc_division,     product_type,     risk_system,     scenario_dimension,     measure_currency, ticket