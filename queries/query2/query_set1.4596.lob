SELECT COB_DATE, CMBS_DIVISION_GROUP, CATEGORY, CASE WHEN CMBS_DIVISION_GROUP IN ('ISG CORE') THEN CMBS_DIVISION_GROUP WHEN CMBS_DIVISION_GROUP IN ('ISG NON CORE') THEN CMBS_DIVISION_GROUP ELSE 'OTHER' END AS DIVISION_GROUP_FILTER, SUM(CAST(EXPOSURE AS NUMERIC (15,5))) AS EXPOSURE FROM ( SELECT A.COB_DATE, A.CMBS_DIVISION_GROUP, CASE WHEN SPG_PRODUCT_TYPE_GROUP IN ('RESI- NON AGENCY', 'SUBPRIME') THEN 'RESI' WHEN SPG_PRODUCT_TYPE_GROUP IN ('CMBS') THEN 'CMBS' ELSE NULL END AS CATEGORY, SUM(CAST(A.USD_EXPOSURE AS NUMERIC (15,5)))/1000000 AS EXPOSURE FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VAR_EXCL_FL <> 'Y' AND BU_RISK_SYSTEM <> 'PIPELINE_NY' AND A.CCC_BUSINESS_AREA NOT LIKE ('CPM%') AND A.CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES') AND SPG_PRODUCT_TYPE_GROUP IN ('RESI- NON AGENCY', 'SUBPRIME', 'CMBS') AND SPG_DESC NOT LIKE '%AGENCY CMBS%' GROUP BY A.COB_DATE, A.CMBS_DIVISION_GROUP, CASE WHEN SPG_PRODUCT_TYPE_GROUP IN ('RESI- NON AGENCY', 'SUBPRIME') THEN 'RESI' WHEN SPG_PRODUCT_TYPE_GROUP IN ('CMBS') THEN 'CMBS' ELSE NULL END ) sub_qry GROUP BY COB_DATE, CMBS_DIVISION_GROUP, CATEGORY, CASE WHEN CMBS_DIVISION_GROUP IN ('ISG CORE') THEN CMBS_DIVISION_GROUP WHEN CMBS_DIVISION_GROUP IN ('ISG NON CORE') THEN CMBS_DIVISION_GROUP ELSE 'OTHER' END