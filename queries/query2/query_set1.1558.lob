SELECT EXP_MSR.COB_DATE , EXP_MSR.UNDERLIER_PRODUCT_DESCRIPTION, SUM(EXP_MSR.KAPPA) AS kappa, abs(sum(EXP_MSR.KAPPA)) AS abskappa FROM ( SELECT COB_DATE, ASSET_CLASS, CCC_TAPS_COMPANY, PARTIAL_DECOMP_PRODUCT_TYPE_CODE, PARTIAL_DECOMP_TICK, PARTIAL_DECOMP_EXCHANGE, PARTIAL_DECOMP_PRODUCT_DESCRIPTION AS UNDERLIER_PRODUCT_DESCRIPTION, SUM(COALESCE(USD_EQ_KAPPA,USD_CM_KAPPA)) AS KAPPA FROM CDWUSER.U_EXP_MSR_PARTIAL WHERE ASSET_CLASS IN ('CM','EQ') AND ( USD_CM_KAPPA <> 0 OR USD_EQ_KAPPA <> 0 ) AND COB_DATE IN ('2018-02-28','2018-02-27') AND PARTIAL_DECOMP_PRODUCT_DESCRIPTION <> 'UNDEFINED' GROUP BY COB_DATE, ASSET_CLASS, CCC_TAPS_COMPANY, PARTIAL_DECOMP_TICK, PARTIAL_DECOMP_EXCHANGE, PARTIAL_DECOMP_PRODUCT_DESCRIPTION, PARTIAL_DECOMP_PRODUCT_TYPE_CODE )EXP_MSR LEFT OUTER JOIN ( SELECT COB_DATE,UNDERLIER_TICK, UNDERLIER_EXCH FROM CDWUSER.U_IED_DECOMP Where COB_DATE IN ('2018-02-28','2018-02-27') AND DECOMP_PRODUCT_TYPE_CODE = 'COMM' AND PRODUCT_TYPE_CODE NOT IN ('COMM') AND CASH_ISSUE_TYPE IN ('ETF') AND UNDERLIER_TICK IS NOT NULL GROUP BY COB_DATE, UNDERLIER_TICK, UNDERLIER_EXCH ) COMM_TICK ON EXP_MSR.PARTIAL_DECOMP_TICK=COMM_TICK.UNDERLIER_TICK AND EXP_MSR.PARTIAL_DECOMP_EXCHANGE=COMM_TICK.UNDERLIER_EXCH and EXP_MSR.cob_date=COMM_TICK.cob_date WHERE ( ( EXP_MSR.asset_class='EQ' and ( EXP_MSR.PARTIAL_DECOMP_PRODUCT_TYPE_CODE = 'COMM' OR COMM_TICK.UNDERLIER_TICK is not null and asset_class = 'CM' ) ) OR ( EXP_MSR.ASSET_CLASS='CM' AND EXP_MSR.CCC_TAPS_COMPANY in ('0302','0342') ) ) GROUP BY EXP_MSR.asset_class, EXP_MSR.COB_DATE ,EXP_MSR.UNDERLIER_PRODUCT_DESCRIPTION