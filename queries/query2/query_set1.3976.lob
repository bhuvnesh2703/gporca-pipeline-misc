SELECT CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, case when CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' then CCC_PRODUCT_LINE else NULL end as CCC_PRODUCT_LINE, case when CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' then CCC_STRATEGY else NULL end as CCC_STRATEGY, NRAMV_cob, usd_eq_kappa_cob, usd_pv01_cob, dividend_cob, NRAMV_change, usd_eq_kappa_change, usd_pv01_change, dividend_change, div_rho_usd_cob, D30_cob, D20_cob, D10_cob, D5_cob, P5_cob, P10_cob, P20_cob, theta_usd_cob, div_rho_usd_change, D30_change, D20_change, D10_change, D5_change, P5_change, P10_change, P20_change, theta_usd__change FROM (select CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY, sum(case when COB_DATE = '2018-02-28' then coalesce(div_rho_usd,0) else 0 end ) as div_rho_usd_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_30_usd + (0.3 * delta_usd)) * 1000,0) else 0 end ) as D30_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_20_usd + (0.2 * delta_usd)) * 1000,0) else 0 end ) as D20_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_10_usd + (0.1 * delta_usd)) * 1000,0) else 0 end ) as D10_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_05_usd + (0.05 * delta_usd)) * 1000,0) else 0 end ) as D5_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_pls_05_usd - (0.05 * delta_usd)) * 1000,0) else 0 end ) as P5_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_pls_10_usd - (0.1 * delta_usd)) * 1000,0) else 0 end ) as P10_cob, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_pls_20_usd - (0.2 * delta_usd)) * 1000,0) else 0 end ) as P20_cob, sum(case when COB_DATE = '2018-02-28' then coalesce(theta_usd,0) else 0 end ) as theta_usd_cob, sum(case when COB_DATE = '2018-02-28' then coalesce(delta_usd,0) else 0 end ) as NRAMV_cob, sum(case when COB_DATE = '2018-02-28' then coalesce(usd_eq_kappa,0) else 0 end ) as usd_eq_kappa_cob, sum(case when COB_DATE = '2018-02-28' then coalesce(usd_pv01,0) else 0 end ) as usd_pv01_cob, sum(case when COB_DATE = '2018-02-28' then coalesce(dividend,0) else 0 end ) as dividend_cob, sum(case when COB_DATE = '2018-02-28' then coalesce(div_rho_usd,0) else -coalesce(div_rho_usd,0) end ) as div_rho_usd_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_30_usd + (0.3 * delta_usd)) * 1000,0) else -coalesce((slide_min_30_usd + (0.3 * delta_usd)) * 1000,0) end ) as D30_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_20_usd + (0.2 * delta_usd)) * 1000,0) else -coalesce((slide_min_20_usd + (0.2 * delta_usd)) * 1000,0) end ) as D20_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_10_usd + (0.1 * delta_usd)) * 1000,0) else -coalesce((slide_min_10_usd + (0.1 * delta_usd)) * 1000,0) end ) as D10_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_min_05_usd + (0.05 * delta_usd)) * 1000,0) else -coalesce((slide_min_05_usd + (0.05 * delta_usd)) * 1000,0) end ) as D5_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_pls_05_usd - (0.05 * delta_usd)) * 1000,0) else -coalesce((slide_pls_05_usd - (0.05 * delta_usd)) * 1000,0) end ) as P5_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_pls_10_usd - (0.1 * delta_usd)) * 1000,0) else -coalesce((slide_pls_10_usd - (0.1 * delta_usd)) * 1000,0) end ) as P10_change, sum(case when COB_DATE = '2018-02-28' then coalesce((slide_pls_20_usd - (0.2 * delta_usd)) * 1000,0) else -coalesce((slide_pls_20_usd - (0.2 * delta_usd)) * 1000,0) end ) as P20_change, sum(case when COB_DATE = '2018-02-28' then coalesce(theta_usd,0) else -coalesce(theta_usd,0) end ) as theta_usd__change, sum(case when COB_DATE = '2018-02-28' then coalesce(delta_usd,0) else -coalesce(delta_usd,0) end ) as NRAMV_change, sum(case when COB_DATE = '2018-02-28' then coalesce(usd_eq_kappa,0) else -coalesce(usd_eq_kappa,0) end ) as usd_eq_kappa_change, sum(case when COB_DATE = '2018-02-28' then coalesce(usd_pv01,0) else -coalesce(usd_pv01,0) end ) as usd_pv01_change, sum(case when COB_DATE = '2018-02-28' then coalesce(dividend,0) else -coalesce(dividend,0) end ) as dividend_change from ( SELECT cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY, sum(case when feed_source_name <> 'CORISK' then usd_eq_kappa else 0 end) as usd_eq_kappa, sum(case when feed_source_name not in ('CORISK', 'ER1') then usd_delta else 0 end) as delta_usd, sum(usd_div_rho) as div_rho_usd, sum(usd_eq_theta) as theta_usd, sum(SLIDE_EQ_MIN_30_USD) as slide_min_30_usd, sum(SLIDE_EQ_MIN_20_USD) as slide_min_20_usd, sum(SLIDE_EQ_MIN_10_USD) as slide_min_10_usd, sum(SLIDE_EQ_MIN_05_USD) as slide_min_05_usd, sum(SLIDE_EQ_PLS_05_USD) as slide_pls_05_usd, sum(SLIDE_EQ_PLS_10_USD) as slide_pls_10_usd, sum(SLIDE_EQ_PLS_20_USD) as slide_pls_20_usd, 0 as usd_pv01, sum(USD_EQ_DISC_RISK) as dividend FROM CDWUSER.u_exp_msr eq WHERE COB_DATE IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND var_excl_fl <> 'Y' AND ccc_banking_trading = 'TRADING' AND ccc_banking_trading = 'TRADING' GROUP BY cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY UNION SELECT cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY, SUM(coalesce(raw_cm_kappa, 0)) / 1000 as usd_eq_kappa, SUM(coalesce(USD_CM_DELTA, 0)) as delta_usd, 0 as div_rho_usd, 0 as theta_usd, 0 as slide_min_30_usd, 0 as slide_min_20_usd, 0 as slide_min_10_usd, 0 as slide_min_05_usd, 0 as slide_pls_05_usd, 0 as slide_pls_10_usd, 0 as slide_pls_20_usd, 0 as usd_pv01, 0 as dividend FROM CDWUSER.u_exp_msr WHERE COB_DATE IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND var_excl_fl <> 'Y' AND FEED_SOURCE_NAME = 'CORISK' AND PRODUCT_TYPE_CODE = 'EQUITY INDEX' AND ccc_banking_trading = 'TRADING' AND ccc_banking_trading = 'TRADING' GROUP BY cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY UNION SELECT cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY, 0 as usd_eq_kappa, SUM(coalesce(USD_EQ_DELTA_DECOMP, 0)) as delta_usd, 0 as div_rho_usd, 0 as theta_usd, 0 as slide_min_30_usd, 0 as slide_min_20_usd, 0 as slide_min_10_usd, 0 as slide_min_05_usd, 0 as slide_pls_05_usd, 0 as slide_pls_10_usd, 0 as slide_pls_20_usd, 0 as usd_pv01, 0 as dividend FROM CDWUSER.u_decomp_msr WHERE COB_DATE IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND var_excl_fl <> 'Y' AND FEED_SOURCE_ID = 301 AND COALESCE (PRODUCT_TYPE_CODE_DECOMP, '') <> 'COMM' AND COALESCE (CASH_ISSUE_TYPE, '') <> 'COMM' AND ccc_banking_trading = 'TRADING' AND ccc_banking_trading = 'TRADING' GROUP BY cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY UNION SELECT cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY, 0 as usd_eq_kappa, 0 as delta_usd, 0 as div_rho_usd, 0 as theta_usd, 0 as slide_min_30_usd, 0 as slide_min_20_usd, 0 as slide_min_10_usd, 0 as slide_min_05_usd, 0 as slide_pls_05_usd, 0 as slide_pls_10_usd, 0 as slide_pls_20_usd, sum(usd_ir_unified_pv01) as usd_pv01, 0 as dividend FROM CDWUSER.u_exp_msr WHERE COB_DATE IN ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND var_excl_fl <> 'Y' AND ccc_banking_trading = 'TRADING' AND ccc_banking_trading = 'TRADING' GROUP BY cob_date, CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY ) X GROUP BY CCC_DIVISION, CCC_BUSINESS_AREA, CCC_PL_REPORTING_REGION, CCC_PRODUCT_LINE, CCC_STRATEGY ) Y WHERE round(abs(coalesce(NRAMV_cob,0)),0) + round(abs(coalesce(usd_eq_kappa_cob,0)),0) + round(abs(coalesce(usd_pv01_cob,0)),0) + round(abs(coalesce(dividend_cob,0)),0) + round(abs(coalesce(NRAMV_change,0)),0) + round(abs(coalesce(usd_eq_kappa_change,0)),0) + round(abs(coalesce(usd_pv01_change,0)),0) + round(abs(coalesce(dividend_change,0)),0) + round(abs(coalesce(div_rho_usd_cob,0)),0) + round(abs(coalesce(D30_cob,0)),0) + round(abs(coalesce(D20_cob,0)),0) + round(abs(coalesce(D10_cob,0)),0) + round(abs(coalesce(D5_cob,0)),0) + round(abs(coalesce(P5_cob,0)),0) + round(abs(coalesce(P10_cob,0)),0) + round(abs(coalesce(P20_cob,0)),0) + round(abs(coalesce(theta_usd_cob,0)),0) + round(abs(coalesce(div_rho_usd_change,0)),0) + round(abs(coalesce(D30_change,0)),0) + round(abs(coalesce(D20_change,0)),0) + round(abs(coalesce(D10_change,0)),0) + round(abs(coalesce(D5_change,0)),0) + round(abs(coalesce(P5_change,0)),0) + round(abs(coalesce(P10_change,0)),0) + round(abs(coalesce(P20_change,0)),0) + round(abs(coalesce(theta_usd__change,0)),0) <> 0