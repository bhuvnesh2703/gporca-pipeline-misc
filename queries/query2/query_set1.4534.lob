WITH BPV10_Table AS (SELECT a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, SUM (A.USD_PV10_BENCH)::numeric(30,10) AS USD_PV10_BENCH FROM CDWUSER.U_CR_MSR a WHERE a.COB_DATE = '02/28/2018' AND a.PARENT_LEGAL_ENTITY IN ('0201(G)', '0111', '0105(G)', '5745', '0146', '0302(G)', '1633', '0525', '0517(G)') AND a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' GROUP BY a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.CCC_BUSINESS_AREA HAVING SUM (A.USD_PV01SPRD_BENCH) >= 50 OR SUM (A.USD_PV01SPRD_BENCH) <= -50 ) SELECT B.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, B.CCC_BUSINESS_AREA, C.PARENT_LEGAL_ENTITY, C.USD_PV10_BENCH FROM( SELECT A.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, A.CCC_BUSINESS_AREA, SUM(A.USD_PV10_BENCH) AS USD_PV10_BENCH_NET_BUSI, SUM(ABS(A.USD_PV10_BENCH)) AS USD_PV10_BENCH_GROSS_BUSI, rank() over(order by abs(SUM(A.USD_PV10_BENCH))/SUM(ABS(A.USD_PV10_BENCH)) asc) as rank FROM BPV10_Table A WHERE A.USD_PV10_BENCH <> 0 and A.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME IN ( select t.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME from ( select distinct E.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME from( SELECT F.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, SUM(F.USD_PV10_BENCH) AS USD_PV10_BENCH_NET_LE, sum(abs(F.USD_PV10_BENCH)) as USD_PV10_BENCH_gross_le FROM BPV10_Table F GROUP BY F.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME ) E where abs(E.USD_PV10_BENCH_net_le) <= 0.7* E.USD_PV10_BENCH_gross_le union select distinct G.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME from( SELECT H.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, H.PARENT_LEGAL_ENTITY, SUM(H.USD_PV10_BENCH) AS USD_PV10_BENCH from BPV10_Table H group by H.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, H.PARENT_LEGAL_ENTITY having abs(sum(H.USD_PV10_BENCH)) >= 100 ) G ) T ) group by A.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.ccc_business_area ) b left join BPV10_Table c on b.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME = c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME and b.ccc_business_area = c.ccc_business_area where abs(b.USD_PV10_BENCH_NET_busi) <= 0.3*b.USD_PV10_BENCH_gross_busi OR (b.rank <=10 and abs(b.USD_PV10_BENCH_NET_BUSI) <> b.USD_PV10_BENCH_GROSS_BUSI)