WITH DIVISIONALRANK AS( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, RANK() OVER(ORDER BY ABS(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))/1000 DESC) AS DIV_RANK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION ), DIVISION_SHORTNAME AS( SELECT d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END AS DIVISION FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') GROUP BY d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END ), DECOMP_LIST AS( SELECT d.COB_DATE, /*d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA,*/ CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP END AS TICK, RANK() OVER(ORDER BY ABS(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))DESC) as RANK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' AND d.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK<>1) GROUP BY d.COB_DATE, /*d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA,*/ CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP END HAVING abs(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))>0 FETCH FIRST 10 ROWS ONLY ), DECOMP AS( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.DIVISION, CASE WHEN d.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) THEN d.CCC_DIVISION ELSE d.CCC_BUSINESS_AREA END AS CCC_BUSINESS_AREA, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP END AS TICK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.DIVISION, d.CCC_BUSINESS_AREA, CASE WHEN d.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) THEN d.CCC_DIVISION ELSE d.CCC_BUSINESS_AREA END, CASE WHEN d.TICKER||'.'||d.EXCHANGE='UNDEFINED.UNDEFINED' THEN d.TICKER_DECOMP ELSE d.TICKER_DECOMP||'.'||d.EXCHANGE_DECOMP END ) SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, d.CCC_BUSINESS_AREA, d.TICK, d.USD_EQ_DELTA_DECOMP, l.RANK, n.DIVISION FROM DECOMP d, DECOMP_LIST l, DIVISION_SHORTNAME n WHERE d.TICK=l.TICK AND d.CCC_DIVISION=n.CCC_DIVISION