With x as (SELECT Underlier, SUM (ABS (vega)) AS Grossvega, Vega FROM ( SELECT UNDERLIER_TICK || '.' || UNDERLIER_EXCH AS Underlier, SUM (COALESCE (a.USD_EQ_PARTIAL_KAPPA, 0))/1000 AS vega FROM CDWUSER.U_EQ_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.LE_GROUP = 'UK' AND a.EXECUTIVE_MODEL IN ('VARIANCESWAP', 'CAPPEDVARIANCESWAP', 'VOLATILITYSWAP', 'CAPPEDVOLATILITYSWAP') GROUP BY UNDERLIER_TICK || '.' || UNDERLIER_EXCH ) x GROUP BY Underlier, Vega ORDER BY sum(ABS(vega)) desc FETCH FIRST 10 ROWS ONLY) SELECT CASE WHEN a.CCC_PL_REPORTING_REGION = 'EMEA' THEN 'EMEA' WHEN a.CCC_PL_REPORTING_REGION = 'AMERICAS' THEN 'AMERICAS' WHEN a.CCC_PL_REPORTING_REGION IN ('ASIA PACIFIC','JAPAN') THEN 'ASIA' ELSE 'OTHER' END AS CCC_PL_REPORTING_REGION, CASE WHEN a.CCC_TAPS_COMPANY = '0302' THEN 'MSIP' WHEN a.CCC_TAPS_COMPANY in ('4663','7281','5274','5254','8179','7280','6262','1311','8292','0721','4391','0517') THEN 'MSBIL' WHEN a.CCC_TAPS_COMPANY = '0319' THEN 'MSIM' ELSE 'OTHER' END as CCC_TAPS_COMPANY, UNDERLIER_TICK || '.' || UNDERLIER_EXCH AS Underlier, sum(a.USD_EQ_PARTIAL_KAPPA)/1000 as USD_EQ_PARTIAL_KAPPA FROM CDWUSER.U_EQ_MSR a WHERE a.COB_DATE = '2018-02-28' AND a.LE_GROUP = 'UK' AND a.EXECUTIVE_MODEL IN ('VARIANCESWAP', 'CAPPEDVARIANCESWAP', 'VOLATILITYSWAP', 'CAPPEDVOLATILITYSWAP') AND a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH IN (SELECT x.UNDERLIER FROM x) GROUP BY UNDERLIER_TICK || '.' || UNDERLIER_EXCH, CASE WHEN a.CCC_PL_REPORTING_REGION = 'EMEA' THEN 'EMEA' WHEN a.CCC_PL_REPORTING_REGION = 'AMERICAS' THEN 'AMERICAS' WHEN a.CCC_PL_REPORTING_REGION IN ('ASIA PACIFIC','JAPAN') THEN 'ASIA' ELSE 'OTHER' END, CASE WHEN a.CCC_TAPS_COMPANY = '0302' THEN 'MSIP' WHEN a.CCC_TAPS_COMPANY in ('4663','7281','5274','5254','8179','7280','6262','1311','8292','0721','4391','0517') THEN 'MSBIL' WHEN a.CCC_TAPS_COMPANY = '0319' THEN 'MSIM' ELSE 'OTHER' END