WITH     xSector         (             Tick,             Exch,             Symbol,             Sector,             Weight         )     AS (VALUES         (             '999908IR9',             'msdy',             '999908IR9.msdy',             'Financials',             '1'         ),         (             'cop1',             'msny',             'cop1.msny',             'ENERGY',             '1'         ),         (             'cvc_lcm',             'msny',             'cvc_lcm.msny',             'ENERGY',             '0.333333333333333'         ),         (             'cvc_lcm',             'msny',             'cvc_lcm.msny',             'Financials',             '0.333333333333333'         ),         (             'cvc_lcm',             'msny',             'cvc_lcm.msny',             'INFORMATION TECHNOLOGY',             '0.333333333333333'         ),         (             'efg_usd_nc',             'msny',             'efg_usd_nc.msny',             'INDUSTRIALS',             '0.4'         ),         (             'efg_usd_nc',             'msny',             'efg_usd_nc.msny',             '',             '0.2'         ),         (             'efg_usd_nc',             'msny',             'efg_usd_nc.msny',             'MATERIALS',             '0.2'         ),         (             'efg_usd_nc',             'msny',             'efg_usd_nc.msny',             'ENERGY',             '0.1'         ),         (             'efg_usd_nc',             'msny',             'efg_usd_nc.msny',             'Financials',             '0.1'         ),         (             'gdx',             'p',             'gdx.p',             'MATERIALS',             '1'         ),         (             'gld',             'p',             'gld.p',             'MATERIALS',             '1'         ),         (             'ilco_ta_usd',             'msln',             'ilco_ta_usd.msln',             'MATERIALS',             '1'         ),         (             'iyr',             'p',             'iyr.p',             'Financials',             '1'         ),         (             'lbty',             'msny',             'lbty.msny',             'TELECOMMUNICATION SERVICES',             '1'         ),         (             'MSNJCOTI',             'cbhk',             'MSNJCOTI.cbhk',             'CONSUMER STAPLES',             '1'         ),         (             'xhb',             'p',             'xhb.p',             'CONSUMER DISCRETIONARY',             '1'         ),         (             'xle',             'p',             'xle.p',             'ENERGY',             '1'         ),         (             'xlf',             'p',             'xlf.p',             'Financials',             '1'         ),         (             'xli',             'p',             'xli.p',             'INDUSTRIALS',             '1'         ),         (             'xlk',             'p',             'xlk.p',             'INFORMATION TECHNOLOGY',             '1'         ),         (             'xlv',             'p',             'xlv.p',             'HEALTH CARE',             '1'         ),         (             'MSOFHOME',             'cbny',             'MSOFHOME.cbny',             'CONSUMER DISCRETIONARY',             '0.65'         ),         (             'MSOFHOME',             'cbny',             'MSOFHOME.cbny',             'INDUSTRIALS',             '0.2'         ),         (             'MSOFHOME',             'cbny',             'MSOFHOME.cbny',             'MATERIALS',             '0.075'         ),         (             'MSOFHOME',             'cbny',             'MSOFHOME.cbny',             'Financials',             '0.075'         ),         (             '4300seUSD',             'cbln',             '4300seUSD.cbln',             'Financials',             '1'         ),         (             'glen',             'l',             'glen.l',             'MATERIALS',             '1'         ),         (             '9201',             'tyo',             '9201.tyo',             'INDUSTRIALS',             '1'         ),         (             'src',             'n',             'src.n',             'REITs',             '1'         ),         (             'dlgd',             'l',             'dlgd.l',             'Financials - ex. REITs',             '1'         ),         (             'etp1',             'msny',             'etp1.msny',             'ENERGY',             '1'         ),         (             'trmkQ',             'l',             'trmkQ.l',             'ENERGY',             '1'         ),         (             'mfonQ',             'l',             'mfonQ.l',             'TELECOMMUNICATION SERVICES',             '1'         ),         (             'xfn',             'to',             'xfn.to',             'Financials',             '1'         ),         (             'fei',             'n',             'fei.n',             'ENERGY',             '1'         ),         (             'mro1',             'msny',             'mro1.msny',             'ENERGY',             '1'         ),         (             'irlty',             'tyo',             'irlty.tyo',             'Financials',             '1'         ),         (             'rog',             'vx',             'rog.vx',             'HEALTH CARE',             '1'         ),         (             'vowg_P',             'de',             'vowg_P.de',             'CONSUMER DISCRETIONARY',             '1'         ),         (             'novn',             'vx',             'novn.vx',             'HEALTH CARE',             '1'         ),         (             'abt1',             'msny',             'abt1.msny',             'HEALTH CARE',             '1'         ),         (             'Q2CDTUSDB',             'msny',             'Q2CDTUSDB.msny',             'CONSUMER DISCRETIONARY',             '1'         ),         (             'MSNJPRH2',             'cbhk',             'MSNJPRH2.cbhk',             'Financials',             '1'         ),         (             '3668',             'hk',             '3668.hk',             'MATERIALS',             '1'         ),         (             'golg1',             'msny',             'golg1.msny',             'INFORMATION TECHNOLOGY',             '1'         ),         (             'twtr',             'n',             'twtr.n',             'INFORMATION TECHNOLOGY',             '1'         ),         (             'goog',             'q',             'goog.q',             'INFORMATION TECHNOLOGY',             '1'         ),         (             'amj',             'p',             'amj.p',             'ENERGY',             '1'         )),     measureTable AS (SELECT                          a.COB_DATE,                          a.PROCESS_ID,                          a.POSITION_ID,                          a.UNDERLIER_EXCH,                          a.ASSET_CLASS,                          a.Partial_Decomp_Sector,                          a.EXECUTIVE_MODEL,                          a.PARTIAL_DECOMP_TICK,                          a.PARTIAL_DECOMP_EXCHANGE,                          ROUND (SUM (COALESCE (a.USD_EQ_PARTIAL_DELTA,                                                0)),                                 5) + ROUND (SUM (COALESCE (a.USD_CM_PARTIAL_DELTA,                                                            0)),                                             5) AS delta,                          ROUND (SUM (COALESCE (a.USD_EQ_GAMMA,                                                0)),                                 5) + ROUND (SUM (COALESCE (a.USD_CM_GAMMA,                                                            0)),                                             5) AS gamma,                          ROUND (SUM (COALESCE (a.USD_EQ_KAPPA,                                                0)),                                 5) + ROUND (SUM (COALESCE (a.USD_CM_KAPPA,                                                            0)),                                             5) AS kappa,                          ROUND (SUM (COALESCE (a.USD_EQ_PARTIAL_KAPPA,                                                0)),                                 5) + ROUND (SUM (COALESCE (a.USD_CM_PARTIAL_KAPPA,                                                            0)),                                             5) AS partial_kappa,                          SUM (COALESCE (a.USD_JVOL_SKEW,                                         0)) AS jvol_skew,                          ROUND (SUM (COALESCE (a.USD_DIV_RHO,                                                0)),                                 5) + ROUND (SUM (COALESCE (a.USD_CM_DIV_RHO,                                                            0)),                                             5) AS div_rho,                          ROUND (SUM (COALESCE (a.USD_EQ_PARTIAL_KAPPA,                                                0) / SQRT (GREATEST (a.TERM_OF_MEASURE,                                                                     30.0) / 365.0)),                                 5) + ROUND (SUM (COALESCE (a.USD_CM_PARTIAL_KAPPA,                                                            0) / SQRT (GREATEST (a.TERM_OF_MEASURE,                                                                                 30.0) / 365.0)),                                             5) AS partial_kappa_ta                      FROM cdwuser.U_EXP_MSR_PARTIAL a                      WHERE a.cob_date in ('2018-02-28', '2018-02-27') AND                          a.SILO_SRC = 'IED' AND                          a.CCC_BANKING_TRADING = 'TRADING' AND                          a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND                          a.CCC_STRATEGY = 'SINGLE NAME' AND                          a.CCC_PL_REPORTING_REGION = 'AMERICAS' AND                          ASSET_CLASS IN ('EQ', 'CM')                      GROUP BY                          a.COB_DATE,                          a.PROCESS_ID,                          a.POSITION_ID,                          a.UNDERLIER_EXCH,                          a.ASSET_CLASS,                          a.Partial_Decomp_Sector,                          a.EXECUTIVE_MODEL,                          a.PARTIAL_DECOMP_TICK,                          a.PARTIAL_DECOMP_EXCHANGE) SELECT measureTable.cob_date,     CASE WHEN measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE IN ('spx.us', 'spy.p', 'sptr1.msny') THEN          'SPX (g)'     ELSE measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE END AS MSR_Symbol,     CASE WHEN measureTable.UNDERLIER_EXCH in ('z') OR measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE IN ('spx.us', 'spy.p', 'sptr1.msny', '',                                                                                                        'SPX (g)', 'itb.p', 'iyr.p', 'itb.z',                                                                                                       'iyt.p', 'iyz.p', 'kbe.p', 'oih.p'         , 'smh.p', 'xhb.p', 'xlb.p', 'xle.p', 'xlf.p', 'xli.p', 'xlk.p', 'xlp.p', 'xlu.p', 'xlv.p', 'xly.p', 'xop.p', 'xrt.p', 'xme.p',                                                                                                        'xfn.to', 'ung.p', 'uso.p',                                                                                                        'ibb.q', 'kre.p', 'xbi.p') THEN          'Index/Sector ETF' WHEN x4.Sector IS NOT NULL THEN x4.Sector WHEN     measureTable.Partial_Decomp_Sector IN ('INDEX') OR     measureTable.EXECUTIVE_MODEL IN ('EquitySwapOnDynamicProduct')     THEN 'Index/Sector ETF' WHEN measureTable.Partial_Decomp_Sector IN ('COMM') THEN 'COMM'     ELSE 'Other' END AS Sector,     measureTable.ASSET_CLASS,     CASE WHEN SUM (measureTable.delta) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_delta,     CASE WHEN SUM (measureTable.gamma) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_gamma,     CASE WHEN SUM (measureTable.kappa) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_kappa,     CASE WHEN SUM (measureTable.partial_kappa) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_partial_kappa,     CASE WHEN SUM (measureTable.jvol_skew) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_jvol_skew,     CASE WHEN SUM (measureTable.div_rho) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_div_rho,     CASE WHEN SUM (measureTable.partial_kappa_ta) < 0 THEN 'Short'     ELSE 'Long' END AS Long_Short_div_partial_kappa_ta,       SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(delta) ELSE 0 END) AS DELTA_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(delta) ELSE 0 END) AS DELTA_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(delta) ELSE - (coalesce(delta)) END) AS DELTA_CHANGE,       SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(gamma) ELSE 0 END) AS GAMMA_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(gamma) ELSE 0 END) AS GAMMA_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(gamma) ELSE - (coalesce(gamma)) END) AS GAMMA_CHANGE,       SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(kappa) ELSE 0 END) AS KAPPA_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(kappa) ELSE 0 END) AS KAPPA_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(kappa) ELSE - (coalesce(kappa)) END) AS KAPPA_CHANGE,       SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(partial_kappa) ELSE 0 END) AS PARTIAL_KAPPA_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(partial_kappa) ELSE 0 END) AS PARTIAL_KAPPA_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(partial_kappa) ELSE - (coalesce(partial_kappa)) END) AS PARTIAL_KAPPA_CHANGE,       SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(jvol_skew) ELSE 0 END) AS JVOL_SKEW_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(jvol_skew) ELSE 0 END) AS JVOL_SKEW_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(jvol_skew) ELSE - (coalesce(jvol_skew)) END) AS JVOL_SKEW_CHANGE,       SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(div_rho) ELSE 0 END) AS DIV_RHO_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(div_rho) ELSE 0 END) AS DIV_RHO_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(div_rho) ELSE - (coalesce(div_rho)) END) AS DIV_RHO_CHANGE,           SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(partial_kappa_ta) ELSE 0 END) AS PARTIAL_KAPPA_TA_COB,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-27' THEN coalesce(partial_kappa_ta) ELSE 0 END) AS PARTIAL_KAPPA_TA_COMP,      SUM (CASE WHEN MEASURETABLE.COB_DATE = '2018-02-28' THEN coalesce(partial_kappa_ta) ELSE - (coalesce(partial_kappa_ta)) END) AS PARTIAL_KAPPA_TA_CHANGE  FROM     measureTable     LEFT OUTER JOIN     (         SELECT             a.cob_date,             a.TICKER_DECOMP || '.' || a.EXCHANGE_DECOMP AS Decomp_Symbol,             CASE WHEN             (a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'FINANCIAL%' OR              a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'Financial%') AND             a.FID1_INDUSTRY_NAME_LEVEL4 LIKE '%REITS%'             THEN 'REITs' WHEN (a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'FINANCIAL%' OR                                a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'Financial%') THEN 'Financials - ex. REITs'             ELSE a.FID1_INDUSTRY_NAME_LEVEL2 END AS Sector         FROM cdwuser.U_DECOMP_MSR a         WHERE a.cob_date in ('2018-02-28', '2018-02-27') AND             a.DIVISION = 'IED' AND             a.SILO_SRC = 'IED' AND             a.CCC_BANKING_TRADING = 'TRADING' AND             a.TICKER_DECOMP IS NOT NULL AND             a.FID1_INDUSTRY_NAME_LEVEL2 IS NOT NULL AND             a.FID1_INDUSTRY_NAME_LEVEL2 <> 'UNDEFINED'         GROUP BY         a.cob_date,             a.TICKER_DECOMP || '.' || a.EXCHANGE_DECOMP,             CASE WHEN             (a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'FINANCIAL%' OR              a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'Financial%') AND             a.FID1_INDUSTRY_NAME_LEVEL4 LIKE '%REITS%'             THEN 'REITs' WHEN (a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'FINANCIAL%' OR                                a.FID1_INDUSTRY_NAME_LEVEL2 LIKE 'Financial%') THEN 'Financials - ex. REITs'             ELSE a.FID1_INDUSTRY_NAME_LEVEL2 END         UNION             SELECT '2018-02-28' AS COB_DATE,                 Symbol AS Decomp_Symbol,                 Sector             FROM xSector         UNION             SELECT '2018-02-27' AS COB_DATE,                 Symbol AS Decomp_Symbol,                 Sector             FROM xSector     )     x4     ON measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE = x4.Decomp_Symbol and     measureTable.cob_date=x4.cob_date GROUP BY measureTable.cob_date,     CASE WHEN measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE IN ('spx.us', 'spy.p', 'sptr1.msny') THEN          'SPX (g)'     ELSE measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE END,     CASE WHEN measureTable.UNDERLIER_EXCH in ('z') OR measureTable.PARTIAL_DECOMP_TICK || '.' || measureTable.PARTIAL_DECOMP_EXCHANGE IN ('spx.us', 'spy.p', 'sptr1.msny', '',                                                                                                        'SPX (g)', 'itb.p', 'iyr.p', 'itb.z',                                                                                                       'iyt.p', 'iyz.p', 'kbe.p', 'oih.p'         , 'smh.p', 'xhb.p', 'xlb.p', 'xle.p', 'xlf.p', 'xli.p', 'xlk.p', 'xlp.p', 'xlu.p', 'xlv.p', 'xly.p', 'xop.p', 'xrt.p', 'xme.p',                                                                                                        'xfn.to', 'ung.p', 'uso.p',                                                                                                        'ibb.q', 'kre.p', 'xbi.p') THEN          'Index/Sector ETF' WHEN x4.Sector IS NOT NULL THEN x4.Sector WHEN     measureTable.Partial_Decomp_Sector IN ('INDEX') OR     measureTable.EXECUTIVE_MODEL IN ('EquitySwapOnDynamicProduct')     THEN 'Index/Sector ETF' WHEN measureTable.Partial_Decomp_Sector IN ('COMM') THEN 'COMM'     ELSE 'Other' END,     measureTable.Partial_Decomp_Sector,     measureTable.ASSET_CLASS