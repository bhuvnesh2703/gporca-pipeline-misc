With x as ( SELECT 'cur' as Cut, a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_BUSINESS_AREA, a.CCC_STRATEGY, a.SCENARIO_NAME, CASE WHEN a.SCENARIO_NAME = 'BASE' THEN sum(coalesce(a.USD_DELTA,0))/1000 END as USD_DELTA, CASE WHEN a.SCENARIO_NAME = 'S-50%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS D50, CASE WHEN a.SCENARIO_NAME = 'S-40%SD' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS D40SD, CASE WHEN a.SCENARIO_NAME = 'S-30%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS D30, CASE WHEN a.SCENARIO_NAME = 'S-20%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D20, CASE WHEN a.SCENARIO_NAME = 'S-10%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D10, CASE WHEN a.SCENARIO_NAME = 'S-8%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D8, CASE WHEN a.SCENARIO_NAME = 'S-5%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D5, CASE WHEN a.SCENARIO_NAME = 'S-3%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D3, CASE WHEN a.SCENARIO_NAME = 'S-2%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D2, CASE WHEN a.SCENARIO_NAME = 'S-1%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D1, CASE WHEN a.SCENARIO_NAME = 'S+1%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P1, CASE WHEN a.SCENARIO_NAME = 'S+2%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P2, CASE WHEN a.SCENARIO_NAME = 'S+3%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P3, CASE WHEN a.SCENARIO_NAME = 'S+5%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P5, CASE WHEN a.SCENARIO_NAME = 'S+8%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P8, CASE WHEN a.SCENARIO_NAME = 'S+10%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P10, CASE WHEN a.SCENARIO_NAME = 'S+20%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS P20, CASE WHEN a.SCENARIO_NAME = 'S+30%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS P30, CASE WHEN a.SCENARIO_NAME = 'S+50%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS P50 FROM CDWUSER.U_SURFACE_MSR a WHERE a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.COB_DATE in ('2018-02-28') AND a.SCENARIO_NAME in ('S-50%','S-40%SD','S-30%','S-20%','S-10%','S-8%','S-5%','S-3%','S-2%','S-1%','S+1%','S+2%','S+3%','S+5%','S+8%','S+10%','S+20%','S+30%','S+50%','BASE') AND a.CCC_TAPS_COMPANY in ('0302','0347','0853','4863','4043','6120','6837','6899','4044','0856','5869','7458','7784') GROUP BY a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_BUSINESS_AREA, a.CCC_STRATEGY, a.SCENARIO_NAME UNION ALL SELECT 'post expiry' as Cut, a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_BUSINESS_AREA, a.CCC_STRATEGY, a.SCENARIO_NAME, CASE WHEN a.SCENARIO_NAME = 'BASE' THEN sum(coalesce(a.USD_DELTA,0))/1000 END as USD_DELTA, CASE WHEN a.SCENARIO_NAME = 'S-50%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS D50, CASE WHEN a.SCENARIO_NAME = 'S-40%SD' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS D40SD, CASE WHEN a.SCENARIO_NAME = 'S-30%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS D30, CASE WHEN a.SCENARIO_NAME = 'S-20%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D20, CASE WHEN a.SCENARIO_NAME = 'S-10%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D10, CASE WHEN a.SCENARIO_NAME = 'S-8%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D8, CASE WHEN a.SCENARIO_NAME = 'S-5%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D5, CASE WHEN a.SCENARIO_NAME = 'S-3%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D3, CASE WHEN a.SCENARIO_NAME = 'S-2%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D2, CASE WHEN a.SCENARIO_NAME = 'S-1%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS D1, CASE WHEN a.SCENARIO_NAME = 'S+1%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P1, CASE WHEN a.SCENARIO_NAME = 'S+2%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P2, CASE WHEN a.SCENARIO_NAME = 'S+3%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P3, CASE WHEN a.SCENARIO_NAME = 'S+5%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P5, CASE WHEN a.SCENARIO_NAME = 'S+8%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P8, CASE WHEN a.SCENARIO_NAME = 'S+10%' THEN sum(a.POS_TV_MINUS_BASE)/1000 END AS P10, CASE WHEN a.SCENARIO_NAME = 'S+20%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS P20, CASE WHEN a.SCENARIO_NAME = 'S+30%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS P30, CASE WHEN a.SCENARIO_NAME = 'S+50%' THEN sum(coalesce(a.POS_TV_MINUS_BASE,0))/1000 END AS P50 FROM CDWUSER.U_SURFACE_MSR a WHERE a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.COB_DATE in ('2018-02-28') AND a.SCENARIO_NAME in ('S-50%','S-40%SD','S-30%','S-20%','S-10%','S-8%','S-5%','S-3%','S-2%','S-1%','S+1%','S+2%','S+3%','S+5%','S+8%','S+10%','S+20%','S+30%','S+50%','BASE') AND (coalesce(a.EXPIRATION_DATE,'1970-01-01') > '2018-03-16') AND a.CCC_TAPS_COMPANY in ('0302','0347','0853','4863','4043','6120','6837','6899','4044','0856','5869','7458','7784') GROUP BY a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_BUSINESS_AREA, a.CCC_STRATEGY, a.SCENARIO_NAME ) , y as ( SELECT a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_BUSINESS_AREA, a.CCC_STRATEGY, a.SCENARIO_NAME, CASE WHEN a.SCENARIO_NAME = 'BASE' THEN sum(coalesce(a.USD_DELTA,0))/1000 END as USD_DELTA FROM CDWUSER.U_SURFACE_MSR a WHERE a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.COB_DATE in ('2018-02-28') AND a.SCENARIO_NAME in ('BASE') AND (coalesce(a.EXPIRATION_DATE,'1970-01-01') > '2018-03-16') AND a.CCC_TAPS_COMPANY in ('0302','0347','0853','4863','4043','6120','6837','6899','4044','0856','5869','7458','7784') GROUP BY a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_BUSINESS_AREA, a.CCC_STRATEGY, a.SCENARIO_NAME ) SELECT x.CUT, x.CCC_PL_REPORTING_REGION, x.CCC_BUSINESS_AREA, x.CCC_STRATEGY, x.SCENARIO_NAME, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-50%' THEN sum(coalesce(x.D50,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-50%' THEN sum(coalesce(x.D50,0)) + 0.5*sum(coalesce(y.USD_DELTA,0)) END AS D50, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-40%SD' THEN sum(coalesce(x.D40SD,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-40%SD' THEN sum(coalesce(x.D40SD,0)) + 0.4*sum(coalesce(y.USD_DELTA,0)) END AS D40SD, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-30%' THEN sum(coalesce(x.D30,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-30%' THEN sum(coalesce(x.D30,0)) + 0.3*sum(coalesce(y.USD_DELTA,0)) END AS D30, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-20%' THEN sum(coalesce(x.D20,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-20%' THEN sum(coalesce(x.D20,0)) + 0.2*sum(coalesce(y.USD_DELTA,0)) END AS D20, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-10%' THEN sum(coalesce(x.D10,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-10%' THEN sum(coalesce(x.D10,0)) + 0.1*sum(coalesce(y.USD_DELTA,0)) END AS D10, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-8%' THEN sum(coalesce(x.D8,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-8%' THEN sum(coalesce(x.D8,0)) + 0.08*sum(coalesce(y.USD_DELTA,0)) END AS D8, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-5%' THEN sum(coalesce(x.D5,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-5%' THEN sum(coalesce(x.D5,0)) + 0.05*sum(coalesce(y.USD_DELTA,0)) END AS D5, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-3%' THEN sum(coalesce(x.D3,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-3%' THEN sum(coalesce(x.D3,0)) + 0.03*sum(coalesce(y.USD_DELTA,0)) END AS D3, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-2%' THEN sum(coalesce(x.D2,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-2%' THEN sum(coalesce(x.D2,0)) + 0.02*sum(coalesce(y.USD_DELTA,0)) END AS D2, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S-1%' THEN sum(coalesce(x.D1,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S-1%' THEN sum(coalesce(x.D1,0)) + 0.01*sum(coalesce(y.USD_DELTA,0)) END AS D1, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+1%' THEN sum(coalesce(x.P1,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+1%' THEN sum(coalesce(x.P1,0)) - 0.01*sum(coalesce(y.USD_DELTA,0)) END AS P1, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+2%' THEN sum(coalesce(x.P2,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+2%' THEN sum(coalesce(x.P2,0)) - 0.02*sum(coalesce(y.USD_DELTA,0)) END AS P2, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+3%' THEN sum(coalesce(x.P3,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+3%' THEN sum(coalesce(x.P3,0)) - 0.03*sum(coalesce(y.USD_DELTA,0)) END AS P3, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+5%' THEN sum(coalesce(x.P5,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+5%' THEN sum(coalesce(x.P5,0)) - 0.05*sum(coalesce(y.USD_DELTA,0)) END AS P5, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+8%' THEN sum(coalesce(x.P8,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+8%' THEN sum(coalesce(x.P8,0)) - 0.08*sum(coalesce(y.USD_DELTA,0)) END AS P8, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+10%' THEN sum(coalesce(x.P10,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+10%' THEN sum(coalesce(x.P10,0)) - 0.1*sum(coalesce(y.USD_DELTA,0)) END AS P10, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+20%' THEN sum(coalesce(x.P20,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+20%' THEN sum(coalesce(x.P20,0)) - 0.2*sum(coalesce(y.USD_DELTA,0)) END AS P20, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+30%' THEN sum(coalesce(x.P30,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+30%' THEN sum(coalesce(x.P30,0)) - 0.3*sum(coalesce(y.USD_DELTA,0)) END AS P30, CASE WHEN x.CUT = 'cur' AND x.SCENARIO_NAME = 'S+50%' THEN sum(coalesce(x.P50,0)) WHEN x.CUT = 'post expiry' AND x.SCENARIO_NAME = 'S+50%' THEN sum(coalesce(x.P50,0)) - 0.5*sum(coalesce(y.USD_DELTA,0)) END AS P50 FROM x left join y ON (x.CCC_PL_REPORTING_REGION,x.CCC_BUSINESS_AREA,x.CCC_STRATEGY) = (y.CCC_PL_REPORTING_REGION,y.CCC_BUSINESS_AREA,y.CCC_STRATEGY) GROUP BY x.CUT, x.CCC_PL_REPORTING_REGION, x.CCC_BUSINESS_AREA, x.CCC_STRATEGY, x.SCENARIO_NAME