select cob_date, currency, book, sum(usd_notional::numeric(15,5)) as usd_notional, BANK_FLAG, LIQUIDITY_SECTYPE, LIQUIDITY_SECTYPE2, case when LIQUIDITY_SECTYPE2 like '%Overnight Reverse repos%' or LIQUIDITY_SECTYPE2 like '%Overnight Reverse Repos%' then 'Overnight Reverse repos' when LIQUIDITY_SECTYPE2 like '%Term Reverse Repos%' then 'Term Reverse Repos' when LIQUIDITY_SECTYPE2 like '%Investment Portfolio%' then 'Investment Portfolio' else LIQUIDITY_SECTYPE2 END AS LIQUIDITY_SECTYPE3 from ( select COB_DATE, CURRENCY_OF_MEASURE AS CURRENCY, book, PRODUCT_TYPE_CODE, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171','4344', '4391', '4512', '4562','5254','5707', '5848', '5849', '6257', '6262', '7012','7713','7714','7715','8179','8759') THEN 'OTHER BANK' ELSE 'NON-BANK' END AS BANK_FLAG, case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' when PRODUCT_TYPE_CODE not in ('REPO') AND CCC_GL_COMPANY_CODE in ('0101', '7622') THEN 'Parent Pool Securities' when PRODUCT_TYPE_CODE not in ('REPO') AND CCC_GL_COMPANY_CODE not in ('0101', '7622') THEN 'Subsidiary Pool Securities' end as LIQUIDITY_SECTYPE, case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RPOTO','RPOAF') then 'Securities Pool - Term Reverse Repos - NY' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') then 'Securities Pool - Term Reverse Repos - LN' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK in ('RWILX') then 'Securities Pool - Term Reverse Repos - AP' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU') then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse repos' when book ='TSTPM' THEN 'Investment Portfolio - AFS' when book ='TSTJY' THEN 'Investment Portfolio - JGB' when book ='LIABB' THEN 'Investment Portfolio - US Gvt Bonds' when book not in ('TSTPM','TSTJY','LIABB', 'TSHTM') then 'Investment Portfolio - Other' when book = 'TSHTM' then 'Investment Portfolio - HTM' end as LIQUIDITY_SECTYPE2, sum(coalesce(CASE WHEN book in('SWPIN','TDET6', 'TAIRR', 'TAEMR', 'TEEMR', 'HKFAP', 'TTIRR', 'HKFAM', 'TKFVS', 'HKFAS', 'TBAGR') THEN -usd_notional WHEN (book in('CALLT', 'CALTB', 'LCALT', 'LCATB')) THEN usd_MARKET_VALUE else usd_notional END, 0)) as USD_NOTIONAL from cdwuser.U_OT_MSR where cob_date in ('2018-02-28', '2018-01-31') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and CCC_BUSINESS_AREA = 'LIQUIDITY RESERVE1' and PRODUCT_TYPE_CODE not in ('CASH','SWAP','MMF') and USD_NOTIONAL is not null and CCC_HIERARCHY_LEVEL10 <> ('INELIGIBLE SEC POOL') group by COB_DATE, account, TERM_OF_POSITION, CURRENCY_OF_MEASURE, ccc_gl_company_code, book, product_type_code, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171','4344', '4391', '4512', '4562','5254','5707', '5848', '5849', '6257', '6262', '7012','7713','7714','7715','8179','8759') THEN 'OTHER BANK' ELSE 'NON-BANK' END, case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' when PRODUCT_TYPE_CODE not in ('REPO') AND CCC_GL_COMPANY_CODE in ('0101', '7622') THEN 'Parent Pool Securities' when PRODUCT_TYPE_CODE not in ('REPO') AND CCC_GL_COMPANY_CODE not in ('0101', '7622') THEN 'Subsidiary Pool Securities' end , case when account in ('070002D15', '07700A931', '070002D23', '07200B9V2', '07000AC59', '07000AC67', '07000AC75', '07000ACY6', '070002DZ0', '07000AC18', '07000AC26', '07000AC42', '07000ACZ3', '070002DZ1', '07000AC34', '07700EKT3', '07200B9V2') then 'Defunding' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RPOTO','RPOAF') then 'Securities Pool - Term Reverse Repos - NY' when PRODUCT_TYPE_CODE = 'REPO' and BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') then 'Securities Pool - Term Reverse Repos - LN' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK in ('RWILX') then 'Securities Pool - Term Reverse Repos - AP' when PRODUCT_TYPE_CODE = 'REPO' AND TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU') then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse repos' when PRODUCT_TYPE_CODE not in ('REPO') and book ='TSTPM' THEN 'Investment Portfolio - AFS' when PRODUCT_TYPE_CODE not in ('REPO') and book ='TSTJY' THEN 'Investment Portfolio - JGB' when PRODUCT_TYPE_CODE not in ('REPO') and book ='LIABB' THEN 'Investment Portfolio - US Gvt Bonds' when PRODUCT_TYPE_CODE not in ('REPO') and book not in ('TSTPM','TSTJY','LIABB', 'TSHTM') then 'Investment Portfolio - Other' when book = 'TSHTM' then 'Investment Portfolio - HTM' end union all select cob_date , CURRENCY_OF_MEASURE as CURRENCY , BOOK , PRODUCT_TYPE_CODE , Case WHEN SUBSTR(PRODUCT_DESCRIPTION, STRPOS(PRODUCT_DESCRIPTION, 'LE') + 3, 4) IN ('1633','6635') THEN 'US BANK' WHEN SUBSTR(PRODUCT_DESCRIPTION, STRPOS(PRODUCT_DESCRIPTION, 'LE') + 3, 4) IN ('0374', '0390', '0517', '0675', '0921', '4171','4344', '4391', '4512', '4562','5254','5707', '5848', '5849', '6257', '6262', '7012','7713','7714','7715','8179','8759') THEN 'OTHER BANK' ELSE 'NON-BANK' END AS BANK_FLAG , 'Cash' as LIQUIDITY_SECTYPE , 'Cash' as LIQUIDITY_SECTYPE2 , sum(coalesce(CASE WHEN book in('SWPIN','TDET6', 'TAIRR', 'TAEMR', 'TEEMR', 'HKFAP', 'TTIRR', 'HKFAM', 'TKFVS', 'HKFAS', 'TBAGR') THEN -usd_notional WHEN (book in('CALLT', 'CALTB', 'LCALT', 'LCATB')) THEN usd_MARKET_VALUE else usd_notional END, 0)) as USD_NOTIONAL from cdwuser.u_ot_msr where book in ('TSYGLRCSH','MSBKD','TBICD','TNSAP','TNSLN') and cob_date in ('2018-02-28', '2018-01-31') and CCC_HIERARCHY_LEVEL10 <> ('INELIGIBLE SEC POOL') group by cob_date ,CURRENCY_OF_MEASURE ,PRODUCT_TYPE_CODE , BOOK , Case WHEN SUBSTR(PRODUCT_DESCRIPTION, STRPOS(PRODUCT_DESCRIPTION, 'LE') + 3, 4) IN ('1633','6635') THEN 'US BANK' WHEN SUBSTR(PRODUCT_DESCRIPTION, STRPOS(PRODUCT_DESCRIPTION, 'LE') + 3, 4) IN ('0374', '0390', '0517', '0675', '0921', '4171','4344', '4391', '4512', '4562','5254','5707', '5848', '5849', '6257', '6262', '7012','7713','7714','7715','8179','8759') THEN 'OTHER BANK' ELSE 'NON-BANK' END union all select COB_DATE, CURRENCY_OF_MEASURE AS CURRENCY, book, PRODUCT_TYPE_CODE, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171','4344', '4391', '4512', '4562','5254','5707', '5848', '5849', '6257', '6262', '7012','7713','7714','7715','8179','8759') THEN 'OTHER BANK' ELSE 'NON-BANK' END AS BANK_FLAG, case when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' end as LIQUIDITY_SECTYPE, case when PRODUCT_TYPE_CODE = 'REPO' AND (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse Repos' end as LIQUIDITY_SECTYPE2 , sum(coalesce(CASE WHEN book in('SWPIN','TDET6', 'TAIRR', 'TAEMR', 'TEEMR', 'HKFAP', 'TTIRR', 'HKFAM', 'TKFVS', 'HKFAS', 'TBAGR') THEN -usd_notional WHEN (book in('CALLT', 'CALTB', 'LCALT', 'LCATB')) THEN usd_MARKET_VALUE else usd_notional END, 0)) as USD_NOTIONAL from cdwuser.U_OT_MSR where cob_date in ('2018-02-28', '2018-01-31') and CCC_DIVISION = 'OVERHEAD INTEREST' and CCC_PRODUCT_LINE='MSSB TREASURY LIQUIDITY' and CCC_HIERARCHY_LEVEL10 <> ('INELIGIBLE SEC POOL') and PRODUCT_TYPE_CODE='REPO' and USD_NOTIONAL is not null group by COB_DATE, CURRENCY_OF_MEASURE, book, PRODUCT_TYPE_CODE, Case WHEN CCC_GL_COMPANY_CODE IN ('1633','6635') THEN 'US BANK' WHEN CCC_GL_COMPANY_CODE IN ('0374', '0390', '0517', '0675', '0921', '4171','4344', '4391', '4512', '4562','5254','5707', '5848', '5849', '6257', '6262', '7012','7713','7714','7715','8179','8759') THEN 'OTHER BANK' ELSE 'NON-BANK' END, case when PRODUCT_TYPE_CODE = 'REPO' AND (BOOK = 'RPOTO' OR (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) OR BOOK in ('RWUIS', 'NYDI','RWUIP', 'RWULT','RWUUK') ) then 'Term Reverse Repo' when PRODUCT_TYPE_CODE = 'REPO' then 'Overnight Reverse Repo' end, case when PRODUCT_TYPE_CODE = 'REPO' AND (TERM_OF_POSITION/365 > 0.019 AND BOOK not in ('EULT','LX','EUG7','EUC5','NYN1','NYN2','RPOCO','RPOTU')) then 'Securities Pool - Term Reverse Repos - Other' when PRODUCT_TYPE_CODE = 'REPO' then 'Securities Pool - Overnight Reverse Repos' end ) A group by cob_date, currency, book, BANK_FLAG, LIQUIDITY_SECTYPE, LIQUIDITY_SECTYPE2, case when LIQUIDITY_SECTYPE2 like '%Overnight Reverse repos%' or LIQUIDITY_SECTYPE2 like '%Overnight Reverse Repos%' then 'Overnight Reverse repos' when LIQUIDITY_SECTYPE2 like '%Term Reverse Repos%' then 'Term Reverse Repos' when LIQUIDITY_SECTYPE2 like '%Investment Portfolio%' then 'Investment Portfolio' when LIQUIDITY_SECTYPE2 like '%Investment Portfolio%' then 'Investment Portfolio' else LIQUIDITY_SECTYPE2 END