SELECT a.COB_DATE, a.LE, a.POSITION_CREDIT_PARTY_DARWIN_NAME AS CPTY, case when c.rank_currency <= 10 then a.CURRENCY_BUCKET else 'OTHERS' end as CURRENCY_BUCKET, a.FX_DELTA, b.rank_cpty, c.rank_currency FROM ( select a.COB_DATE , a.PARENT_LEGAL_ENTITY AS LE , a.POSITION_CREDIT_PARTY_DARWIN_NAME , CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END AS CURRENCY_BUCKET , ctpy_netting_group_code , SUM(CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END) AS FX_DELTA from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') group by a.COB_DATE , a.PARENT_LEGAL_ENTITY , a.POSITION_CREDIT_PARTY_DARWIN_NAME , CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END , ctpy_netting_group_code ) a left join ( select a.POSITION_CREDIT_PARTY_DARWIN_NAME , SUM(CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END) AS FX_DELTA , rank() over(ORDER BY abs(SUM(CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END)) desc ) AS rank_cpty from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') group by a.POSITION_CREDIT_PARTY_DARWIN_NAME ) b on b.POSITION_CREDIT_PARTY_DARWIN_NAME = a.POSITION_CREDIT_PARTY_DARWIN_NAME left join ( select CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END AS CURRENCY_BUCKET , SUM(CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END) AS FX_DELTA , rank() over(ORDER BY abs(SUM(CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END)) desc ) as rank_currency from OERUSER.U_EXP_MSR a WHERE a.COB_DATE in ('2018-02-28') AND a.PARENT_LEGAL_ENTITY in ('0111') and a.position_ultimate_credit_party_darwin_name in ('MORGAN STANLEY') and a.POSITION_CREDIT_PARTY_DARWIN_NAME not in ('MORGAN STANLEY CAPITAL SERVICES LLC') group by CASE WHEN a.CURRENCY_OF_MEASURE ='CNH' THEN 'CNY' WHEN a.CURRENCY_OF_MEASURE IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.CURRENCY_OF_MEASURE ='KRX' THEN 'KRW' WHEN a.CURRENCY_OF_MEASURE in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.CURRENCY_OF_MEASURE END ) c on c.CURRENCY_BUCKET = a.CURRENCY_BUCKET