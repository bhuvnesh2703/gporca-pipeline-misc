with exposure as ( Select  cob_date, CCC_DIVISION, ccar_business_category, currency_pair, SUBSTRING(SOURCE_SCN_NAME,5,3) AS currency_of_measure,  product_type, bu_risk_system as vertical_system, CASE  WHEN (SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%CNY%' OR SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%KRW%') THEN 'Onshore'  WHEN (SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%CNH%' OR SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%KRX%') THEN 'Offshore'  WHEN (SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%BRX%' OR SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%RBX%') THEN 'Onshore' WHEN (SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%BRL%' OR SUBSTRING(SOURCE_SCN_NAME,5,3) LIKE '%RUB%') THEN 'Offshore' ELSE '' END AS onshore_flag,  '0' as fx_delta,  SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-90%' THEN RAW_PNL END) as NEG90, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-75%' THEN RAW_PNL END) as NEG75, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-50%' THEN RAW_PNL END) as NEG50, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-35%' THEN RAW_PNL END) as NEG35, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-25%' THEN RAW_PNL END) as NEG25, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-20%' THEN RAW_PNL END) as NEG20, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-15%' THEN RAW_PNL END) as NEG15, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '-10%' THEN RAW_PNL END) as NEG10, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '-5%' THEN RAW_PNL END) as NEG5, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '-2%' THEN RAW_PNL END) as NEG2, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,2) = '0%' THEN RAW_PNL END) as NO_SHOCK, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,2) = '2%' THEN RAW_PNL END) as POS2, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,2) = '5%' THEN RAW_PNL END) as POS5, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '10%' THEN RAW_PNL END) as POS10, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '15%' THEN RAW_PNL END) as POS15, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '20%' THEN RAW_PNL END) as POS20, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '35%' THEN RAW_PNL END) as POS35, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,3) = '50%' THEN RAW_PNL END) as POS50, SUM(CASE WHEN SUBSTRING(SOURCE_SCN_NAME,14,4) = '100%' THEN RAW_PNL END) as POS100  FROM DWUSER.U_RAW_SCENARIO_PNL WHERE COB_DATE = '2018-01-31' and SOURCE_SCN_NAME like 'USD/%x vol 0%' and (bu_risk_system like '%FXOPT%' and product_type='FXOPT') and ccar_business_category not like 'NOT_INCLUDED%' group by  cob_date, bu_risk_system, source_scn_name, ccar_business_category, currency_pair, product_type, currency_of_measure, CCC_DIVISION UNION ALL  SELECT   COB_DATE,  CCC_DIVISION, ccar_business_category, currency_pair, currency_of_measure, product_type_CODE AS product_type, VERTICAL_SYSTEM, CASE  WHEN (currency_of_measure LIKE '%CNY%' OR currency_of_measure LIKE '%KRW%') THEN 'Onshore'  WHEN (currency_of_measure LIKE '%CNH%' OR currency_of_measure LIKE '%KRX%') THEN 'Offshore'  WHEN VERTICAL_SYSTEM LIKE 'STS_%' AND (currency_of_measure LIKE '%BRL%' OR currency_of_measure LIKE '%RUB%') THEN 'Onshore'  WHEN VERTICAL_SYSTEM LIKE 'STS_%' AND (currency_of_measure LIKE '%BR1%' OR currency_of_measure LIKE '%RU1%') THEN 'Offshore'  WHEN VERTICAL_SYSTEM NOT LIKE 'STS_%' AND (currency_of_measure LIKE '%BR1%' OR currency_of_measure LIKE '%BRX%' OR currency_of_measure LIKE '%RBX%' OR currency_of_measure LIKE '%RU1%') THEN 'Onshore' WHEN VERTICAL_SYSTEM NOT LIKE 'STS_%' AND (currency_of_measure LIKE '%BRL%' OR currency_of_measure LIKE '%RUB%') THEN 'Offshore' ELSE '' END AS onshore_flag,  '0' as fx_delta,   sum(usd_fx * -0.9) ::numeric(30,10)  as neg90 ,   sum(usd_fx * -0.75) ::numeric(30,10) as neg75 ,    sum(usd_fx * -0.5) ::numeric(30,10)  as neg50 ,     sum(usd_fx * -0.35) ::numeric(30,10)  as neg35 ,       sum(usd_fx * -0.25) ::numeric(30,10)  as neg25 ,        sum(usd_fx * -0.20) ::numeric(30,10) as neg20 ,         sum(usd_fx * -0.15) ::numeric(30,10) as neg15 ,          sum(usd_fx * -0.10) ::numeric(30,10) as neg10 ,           sum(usd_fx * -0.05) ::numeric(30,10) as neg5 ,            sum(usd_fx * -0.02) ::numeric(30,10) as neg2 ,            '0' as no_shock,            sum(usd_fx * 0.02) ::numeric(30,10) as pos2 ,            sum(usd_fx * 0.05) ::numeric(30,10) as pos5 ,            sum(usd_fx * 0.1) ::numeric(30,10) as pos10 ,            sum(usd_fx * 0.15) ::numeric(30,10) as pos15 ,            sum(usd_fx * 0.2) ::numeric(30,10) as pos20 ,            sum(usd_fx * 0.35) ::numeric(30,10) as pos35,             sum(usd_fx * 0.5) ::numeric(30,10) as pos50,              sum(usd_fx * 1) ::numeric(30,10) as pos100 FROM dwuser.u_fx_msr WHERE COB_DATE = '2018-01-31' and not (vertical_system like '%FXOPT%' and PRODUCT_TYPE_CODE='FXOPT') and ccar_business_category not like 'NOT_INCLUDED%' and length(currency_of_measure)=3  group by    COB_DATE,  CCC_DIVISION,  ccar_business_category,  currency_pair,  currency_of_measure,  PRODUCT_TYPE_CODE,   vertical_system  UNION ALL  SELECT   COB_DATE,  CCC_DIVISION, ccar_business_category, currency_pair, currency_of_measure, product_type_CODE AS product_type, VERTICAL_SYSTEM, CASE  WHEN (currency_of_measure LIKE '%CNY%' OR currency_of_measure LIKE '%KRW%') THEN 'Onshore'  WHEN (currency_of_measure LIKE '%CNH%' OR currency_of_measure LIKE '%KRX%') THEN 'Offshore'  WHEN VERTICAL_SYSTEM LIKE 'STS_%' AND (currency_of_measure LIKE '%BRL%' OR currency_of_measure LIKE '%RUB%') THEN 'Onshore'  WHEN VERTICAL_SYSTEM LIKE 'STS_%' AND (currency_of_measure LIKE '%BR1%' OR currency_of_measure LIKE '%RU1%') THEN 'Offshore'  WHEN VERTICAL_SYSTEM NOT LIKE 'STS_%' AND (currency_of_measure LIKE '%BR1%' OR currency_of_measure LIKE '%BRX%' OR currency_of_measure LIKE '%RBX%' OR currency_of_measure LIKE '%RU1%') THEN 'Onshore' WHEN VERTICAL_SYSTEM NOT LIKE 'STS_%' AND (currency_of_measure LIKE '%BRL%' OR currency_of_measure LIKE '%RUB%') THEN 'Offshore' ELSE '' END AS onshore_flag,  sum(usd_fx) ::numeric(30,10)  as fx_delta,  '0' as neg90 ,  '0' as neg75 ,  '0' as neg50 ,  '0' as neg35 ,  '0' as neg25 ,  '0' as neg20 ,  '0' as neg15 ,  '0' as neg10 ,  '0' as neg5 ,  '0' as neg2 ,  '0' as no_shock,  '0' as pos2 ,  '0' as pos5 ,  '0' as pos10 ,  '0' as pos15 ,  '0' as pos20 ,  '0' as pos35,  '0' as pos50,  '0' as pos100 FROM dwuser.u_fx_msr WHERE COB_DATE = '2018-01-31' and ccar_business_category not like 'NOT_INCLUDED%' and length(currency_of_measure)=3  group by    COB_DATE,  CCC_DIVISION,  ccar_business_category,  currency_pair,  currency_of_measure,  PRODUCT_TYPE_CODE,   vertical_system  )  select    COB_DATE,   ccc_division,   ccar_business_category,   currency_pair,  case   when currency_of_measure = 'CNH' then 'CNY'  when currency_of_measure = 'KRX' then 'KRW'  when currency_of_measure in ('BRX','BR1') then 'BRL'  when currency_of_measure in ('RBX','RU1') then 'RUB'  else currency_of_measure end as currency_of_measure, onshore_flag, CASE WHEN currency_of_measure IN ('EUR','GBP','SEK','NOK','DKK','CHF','CAD','JPY','AUD','NZD') THEN 'G10' WHEN currency_of_measure IN ('CNY','CNH','AED','HKD','OMR','SAR','QAR','KWD','BHD') THEN 'EM (pegged)' ELSE 'EM' END AS CATEGORY,  CASE      WHEN vertical_system LIKE '%BANKLOANS%' THEN 'BANKLOANS'      WHEN vertical_system LIKE '%BT%' THEN 'BT'      WHEN vertical_system LIKE '%C1%' THEN 'C1'      WHEN vertical_system LIKE '%FXDDI%' THEN 'FXDDI'      WHEN vertical_system LIKE '%FXOPT%' THEN 'FXOPT'      WHEN vertical_system LIKE '%GWM%' THEN 'GWM'      WHEN vertical_system LIKE '%IRD%' THEN 'STS'      WHEN vertical_system LIKE 'STS_%' THEN 'STS'      WHEN vertical_system LIKE '%PERSIST%' THEN 'PERSIST'      WHEN vertical_system LIKE '%SPG%' OR vertical_system LIKE '%MBS%' THEN 'SPG'      WHEN vertical_system LIKE '%RETAIL%' THEN 'GWM'      WHEN vertical_system LIKE '%REPO%' THEN 'REPO'      WHEN (vertical_system LIKE 'EQUITY%' OR vertical_system = 'R1') THEN 'GRS'      WHEN vertical_system LIKE '%MSIM%' THEN 'MSIM'     ELSE (CASE WHEN ccc_division = 'COMMODITIES' THEN 'CORISK'      WHEN vertical_system IN ('NY-EXTERN-STRATES', 'PM-FXPB', 'PM-IR', 'PM-OPTIONS') THEN 'CORISK'     ELSE 'OTHER' END)      END AS vertical_system,     product_type,     sum(fx_delta) as fx_delta,  sum(neg90) as neg90,  sum(neg75) as neg75,  sum(neg50) as neg50,  sum(neg35) as neg35,  sum(neg25) as neg25,  sum(neg20) as neg20,   sum(neg15) as neg15,    sum(neg10) as neg10,     sum(neg5) as neg5,      sum(neg2) as neg2, '0' as no_shock,  sum(pos2) as pos2,  sum(pos5) as pos5,  sum(pos10) as pos10,  sum(pos15) as pos15,  sum(pos20) as pos20,  sum(pos35) as pos35,   sum(pos50) as pos50,    sum(pos100) as pos100  from exposure  where   currency_of_measure not in ('USD','UBD') and ccar_business_category='FXEM MACRO TRADING'  group by   COB_DATE,  currency_of_measure,  currency_pair,  onshore_flag,  vertical_system,  ccc_division,  ccar_business_category,  currency_pair,  product_type  order by currency_of_measure,CURRENCY_PAIR,onshore_flag,vertical_system