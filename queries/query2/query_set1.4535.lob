SELECT COB_DATE, DIVISION_GROUP, CNY_FLG, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('STRUCTURED RATES', 'LIQUID FLOW RATES') THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING') THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP', 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT','COMMODITIES') THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN DIVISION_GROUP IN ('ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG') THEN DIVISION_GROUP WHEN CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION') AND DIVISION_GROUP IN ('ISG CORE', 'ISG NON CORE') THEN 'OTHER ISG' ELSE 'NON ISG' END AS CATEGORY, SUM(CAST(USD_IR_KAPPA AS NUMERIC (15,5)))/1000 AS USD_IR_KAPPA, SUM(CAST(USD_CR_KAPPA AS NUMERIC (15,5)))/1000 AS USD_CR_KAPPA, SUM(CAST(USD_CM_KAPPA AS NUMERIC (15,5)))/1000 AS USD_CM_KAPPA, SUM(CAST(USD_EQ_KAPPA AS NUMERIC (15,5)))/1000 AS USD_EQ_KAPPA, SUM(CAST(FX_KAPPA AS NUMERIC (15,5)))/1000 AS FX_KAPPA, SUM(USD_IR_KAPPA + USD_CR_KAPPA + USD_CM_KAPPA + USD_EQ_KAPPA + FX_KAPPA)/1000 AS USD_TOTAL_KAPPA FROM ( SELECT COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END AS IS_FID, NULL AS CNY_FLG, SUM(COALESCE(USD_IR_KAPPA, 0)) / 10 AS USD_IR_KAPPA, 0 AS USD_CR_KAPPA, 0 AS USD_CM_KAPPA, SUM(COALESCE(USD_EQ_KAPPA, 0)) AS USD_EQ_KAPPA, 0 AS FX_KAPPA FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VERTICAL_SYSTEM <> 'PIPELINE_NY' AND VAR_EXCL_FL <> 'Y' AND PRODUCT_TYPE_CODE <> 'DEPOSIT' GROUP BY COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END UNION ALL SELECT COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END AS IS_FID, NULL AS CNY_FLG, 0 AS USD_IR_KAPPA, SUM(CAST(A.CR_KAPPA AS NUMERIC (15,5))) AS USD_CR_KAPPA, 0 AS USD_CM_KAPPA, 0 AS USD_EQ_KAPPA, 0 AS FX_KAPPA FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VERTICAL_SYSTEM <> 'PIPELINE_NY' AND VAR_EXCL_FL <> 'Y' AND PRODUCT_TYPE_CODE <> 'DEPOSIT' GROUP BY COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END UNION ALL SELECT COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END AS IS_FID, NULL AS CNY_FLG, 0 AS USD_IR_KAPPA, 0 AS USD_CR_KAPPA, SUM ( CASE WHEN FEED_SOURCE_NAME <> 'CORISK' THEN COALESCE(USD_CM_KAPPA, 0) ELSE CASE WHEN PRODUCT_TYPE_CODE = UPPER('EUR NG') THEN COALESCE(RAW_CM_KAPPA , 0) / 10000 WHEN PRODUCT_TYPE_CODE NOT IN (UPPER('EQUITY INDEX'), UPPER('CURRENCY'), UPPER('CREDIT')) THEN COALESCE(RAW_CM_KAPPA, 0) / 1000 ELSE 0 END END ) AS USD_CM_KAPPA, 0 AS USD_EQ_KAPPA, 0 AS FX_KAPPA FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VERTICAL_SYSTEM <> 'PIPELINE_NY' AND VAR_EXCL_FL <> 'Y' AND PRODUCT_TYPE_CODE NOT IN ( UPPER('INTEREST RATE'), UPPER('EURO PWR SPREAD'), UPPER('EURO GAS SPREAD'), UPPER('TIMESPREAD'), UPPER('TBD') ) AND CCC_DIVISION NOT IN ('FIC DVA','FID DVA', 'INSTITUTIONAL SECURITIES OTHER', 'MGD FUTURE') GROUP BY COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END UNION ALL SELECT COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END AS IS_FID, NULL AS CNY_FLG, 0 AS USD_IR_KAPPA, 0 AS USD_CR_KAPPA, 0 AS USD_CM_KAPPA, SUM(COALESCE(RAW_CM_KAPPA, 0)) / 1000 AS USD_EQ_KAPPA, 0 AS FX_KAPPA FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VERTICAL_SYSTEM <> 'PIPELINE_NY' AND VAR_EXCL_FL <> 'Y' AND FEED_SOURCE_NAME = 'CORISK' AND PRODUCT_TYPE_CODE = 'EQUITY INDEX' GROUP BY COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END UNION ALL SELECT COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END AS IS_FID, CASE WHEN A.EM_GROUP = 'CNY+CNH' THEN 'Y' END AS CNY_FLG, 0 AS USD_IR_KAPPA, 0 AS USD_CR_KAPPA, 0 AS USD_CM_KAPPA, 0 AS USD_EQ_KAPPA, SUM ( CASE WHEN FEED_SOURCE_NAME <> 'CORISK' AND A.VERTICAL_SYSTEM LIKE '%STS%' THEN A.USD_FX_PARTIAL_KAPPA WHEN FEED_SOURCE_NAME <> 'CORISK' AND A.VERTICAL_SYSTEM LIKE '%FXOPT%' THEN A.USD_FX_KAPPA WHEN FEED_SOURCE_NAME = 'CORISK' AND PRODUCT_TYPE_CODE = 'CURRENCY' THEN COALESCE(LCY_FX_KAPPA, 0) / 1000 ELSE 0 END ) AS FX_KAPPA FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND VERTICAL_SYSTEM <> 'PIPELINE_NY' AND VAR_EXCL_FL <> 'Y' AND CCC_DIVISION NOT IN ('FIC DVA', 'FID DVA','INSTITUTIONAL SECURITIES OTHER', 'MGD FUTURE') GROUP BY COB_DATE, DIVISION_GROUP, CCC_DIVISION, CCC_BUSINESS_AREA, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ('COMMODITIES') THEN 'FID' ELSE 'NON_FID' END, CASE WHEN A.EM_GROUP = 'CNY+CNH' THEN 'Y' END ) SUBQ GROUP BY COB_DATE, DIVISION_GROUP, CNY_FLG, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('STRUCTURED RATES', 'LIQUID FLOW RATES') THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING') THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP', 'FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT','COMMODITIES') THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN DIVISION_GROUP IN ('ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG') THEN DIVISION_GROUP WHEN CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION') AND DIVISION_GROUP IN ('ISG CORE', 'ISG NON CORE') THEN 'OTHER ISG' ELSE 'NON ISG' END