with shown_table as ( select case when rownum <= 93 then '0' else '1' end as shown,spg_group,spg_desc,net_exposure_cob_IG,net_exposure_change_IG,SPV01_cob_IG,SPV01_change_IG,PV01_cob_IG,PV01_change_IG, net_exposure_cob_NIG,net_exposure_change_NIG,SPV01_cob_NIG,SPV01_change_NIG,PV01_cob_NIG,PV01_change_NIG,net_exposure_cob_NR, net_exposure_change_NR,SPV01_cob_NR,SPV01_change_NR,PV01_cob_NR,PV01_change_NR,net_exposure_cob,net_exposure_change,SPV01_cob,SPV01_change, PV01_cob,PV01_change from( select row_number() over ( order by (abs(net_exposure_cob) + abs(SPV01_cob) + abs(PV01_cob)) / 3 desc) as rownum,a.* from ( select spg_group, spg_desc, sum(case when grade = 'IG' then net_exposure_cob else 0 end) as net_exposure_cob_IG, sum(case when grade = 'IG' then net_exposure_change else 0 end) as net_exposure_change_IG, sum(case when grade = 'IG' then SPV01_cob else 0 end) as SPV01_cob_IG, sum(case when grade = 'IG' then SPV01_change else 0 end) as SPV01_change_IG, sum(case when grade = 'IG' then PV01_cob else 0 end) as PV01_cob_IG, sum(case when grade = 'IG' then PV01_change else 0 end) as PV01_change_IG, sum(case when grade = 'NIG' then net_exposure_cob else 0 end) as net_exposure_cob_NIG, sum(case when grade = 'NIG' then net_exposure_change else 0 end) as net_exposure_change_NIG, sum(case when grade = 'NIG' then SPV01_cob else 0 end) as SPV01_cob_NIG, sum(case when grade = 'NIG' then SPV01_change else 0 end) as SPV01_change_NIG, sum(case when grade = 'NIG' then PV01_cob else 0 end) as PV01_cob_NIG, sum(case when grade = 'NIG' then PV01_change else 0 end) as PV01_change_NIG, sum(case when grade = 'NR' then net_exposure_cob else 0 end) as net_exposure_cob_NR, sum(case when grade = 'NR' then net_exposure_change else 0 end) as net_exposure_change_NR, sum(case when grade = 'NR' then SPV01_cob else 0 end) as SPV01_cob_NR, sum(case when grade = 'NR' then SPV01_change else 0 end) as SPV01_change_NR, sum(case when grade = 'NR' then PV01_cob else 0 end) as PV01_cob_NR, sum(case when grade = 'NR' then PV01_change else 0 end) as PV01_change_NR, sum(net_exposure_cob) as net_exposure_cob, sum(net_exposure_change) as net_exposure_change, sum(SPV01_cob) as SPV01_cob, sum(SPV01_change) as SPV01_change, sum(PV01_cob) as PV01_cob, sum(PV01_change) as PV01_change from ( SELECT a.banking_trading, a.grade, a.spg_group, a.spg_desc, sum(case when a.is_cob = 1 then coalesce(a.net_exposure, 0) else 0 end) as net_exposure_cob, sum(case when a.is_cob = 1 then coalesce(a.net_exposure, 0) else -coalesce(a.net_exposure, 0) end) as net_exposure_change, sum(case when a.is_cob = 1 then coalesce(a.SPV01, 0) else 0 end) as SPV01_cob, sum(case when a.is_cob = 1 then coalesce(a.SPV01, 0) else -coalesce(a.SPV01, 0) end) as SPV01_change, sum(case when a.is_cob = 1 then coalesce(a.PV01, 0) else 0 end) as PV01_cob, sum(case when a.is_cob = 1 then coalesce(a.PV01, 0) else -coalesce(a.PV01, 0) end) as PV01_change FROM( SELECT upper(ccc_banking_trading) as banking_trading, rating_grade_cd as grade, case when cob_date = '2017-09-29' then 1 else 0 end as is_cob, case when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Auto Loan & Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Credit Card Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Default Swap' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Floorplan Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Equipment Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Other Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Credit Basket' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Manufactured Housing Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Airplane Security' ) then 'Other ABS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('CMBS Default Swap' ) then 'CMBS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('CMBS Index' ) then 'CMBS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('CMBS Security' ) then 'CMBS' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate Bonds' ) then 'Single Names' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate CDO' ) then 'CLO Cash' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate CDO Default Swap' ) then 'CLO Synthetics' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate CDO Equity' ) then 'CLO Cash' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate CLO' ) then 'CLO Cash' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate Default Swap' ) then 'Single Names' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Corporate Index' ) then 'Corporate Index' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Government' ) then 'Swaps and Govt' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS CDO' ) then 'Non Conforming Resi' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS Non Conforming Default Swap' ) then 'Non Conforming Resi' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS Prime Default Swap' ) then 'PRIME Synthetics' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS Prime Residual' ) then 'PRIME Cash' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS Sub Prime Residual' ) then 'Non Conforming Resi' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('Swap' ) then 'Swaps and Govt' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('OTHER' ) then 'Other' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('CMBS Loan' ) then 'CMBS Loans' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('CMBS Mezzanine Loan' ) then 'CMBS Loans' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS MBX Index' ) then 'MBX Index' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS Option ARM IO' ) then 'Option ARM' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('RMBS Option ARM Security' ) then 'Option ARM' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Private Student Security' ) then 'ABS Private Student Loan' when ccc_pl_reporting_region ='EMEA' and spg_desc=upper('ABS Student Security' ) then 'ABS Student Loan' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Loan' ) then 'CMBS Loans' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Mezzanine Loan' ) then 'CMBS Loans' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Auto Loan & Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Credit Card Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Default Swap' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Equipment Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Franchise Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Floorplan Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Other Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Private Student Security' ) then 'ABS Private Student Loan' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Student Security' ) then 'ABS Student Loan' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Utility Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Credit Basket' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Manufactured Housing Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Airplane Security' ) then 'Other ABS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS CDO' ) then 'CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Credit Basket' ) then 'CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Default Swap' ) then 'CMBX CDS TRR' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS IO' ) then 'IO' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS IO Reremic' ) then 'IO' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Index' ) then 'CMBX CDS TRR' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Mezzanine Security' ) then 'CMBS Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Security' ) then 'CMBS Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Security Reremic' ) then 'CMBS Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('CMBS Total Return Swap' ) then 'CMBX CDS TRR' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate Bonds' ) then 'Single Names' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate CDO' ) then 'CLO Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate CDO Default Swap' ) then 'CLO Synthetics' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate CDO Equity' ) then 'CLO Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate CDO Preferred' ) then 'CLO Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate CLO' ) then 'CLO Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate Default Swap' ) then 'Single Names' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate Index' ) then 'Corporate Index' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate and CDS' ) then 'Single Names' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Government' ) then 'Swaps and Govt' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('OTHER' ) then 'Other' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Agency ARM Securities' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac Pool ARM' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae Pool ARM' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae Pool ARM' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac TBA ARM' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae TBA ARM' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae TBA ARM' ) then 'Agency Hybrid ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Agency CMO' ) then 'Agency CMO' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Agency Derivatives' ) then 'Agency Derivatives' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Alta IO' ) then 'AltA Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Alta Security' ) then 'AltA Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Alta Reremic' ) then 'AltA Reremic' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Alta Reremic TRS' ) then 'AltA Reremic' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS CDO' ) then 'Subprime CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS CDO Default Swap' ) then 'Subprime CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS CDO Preferred' ) then 'Subprime CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Default Swap' ) then 'Subprime Synthetics' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Index Tranche' ) then 'Subprime CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae Security' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac Security' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae Security' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae Pool' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac Pool' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae Pool' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac Pool FIX' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae Pool FIX' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae Pool FIX' ) then 'Agency Pool' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae TBA' ) then 'Agency TBA' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac TBA' ) then 'Agency TBA' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae TBA' ) then 'Agency TBA' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Freddie Mac TBA FIX' ) then 'Agency TBA' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Fannie Mae TBA FIX' ) then 'Agency TBA' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBS Ginnie Mae TBA FIX' ) then 'Agency TBA' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS PO Index' ) then 'Agency PO' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS NIMS' ) then 'Subprime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS POST NIM' ) then 'Subprime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Prime Residual' ) then 'Prime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Prime Security' ) then 'Prime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Prime Index' ) then 'Prime Index' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Prime Reremic' ) then 'Prime Reremic' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Prime Reremic TRS' ) then 'Prime Reremic' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS SD Loan' ) then 'Scratch Dent' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS SD Prepayment Penalty' ) then 'Scratch Dent' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS SD Residual' ) then 'Scratch Dent' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS SD Security' ) then 'Scratch Dent' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RPX' ) then 'Scratch Dent' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Second Residual' ) then 'Non Agency Others' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Second Security' ) then 'Non Agency Others' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS MBX Index' ) then 'MBX Index' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Option ARM IO' ) then 'Option ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Option ARM Security' ) then 'Option ARM' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Sub Prime First Pay' ) then 'Subprime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Sub Prime IO' ) then 'Subprime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Sub Prime Index' ) then 'Subprime Synthetics' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Sub Prime Security' ) then 'Subprime Cash' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Super Senior' ) then 'Subprime CDOs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Rate Futures' ) then 'Swaps and Govt' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Swap' ) then 'Swaps and Govt' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS IOS Index ' ) then 'Agency IOS' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('ABS Student ARN' ) then 'Student Loan ARNs' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Sub Prime Reremic' ) then 'Subprime Reremic' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('RMBS Subprime Reremic TRS' ) then 'Subprime Reremic' when ccc_pl_reporting_region ='AMERICAS' and spg_desc=upper('Corporate Index' ) then 'Corporate Index' when ccc_pl_reporting_region ='JAPAN' and spg_desc=upper('CMBS Security' ) then 'CMBS' else 'Other' end as SPG_group, spg_desc, sum(usd_exposure) as net_exposure, sum(case when cob_date='2017-07-31' and vertical_system like 'EQUITYSD%' then 0 else usd_ir_unified_pv01 end) as PV01, sum(usd_pv01sprd) as SPV01 FROM cdwuser.U_EXP_MSR WHERE COB_DATE in ('2018-02-28', '2018-01-31') AND var_excl_fl <> 'Y' and ccc_banking_trading in ('TRADING') AND ccc_taps_company in ('0201','0103','0205','0206','0530','5924') group by 1,2,3,4,5 ) a GROUP BY a.banking_trading, a.grade, a.spg_group, a.spg_desc )src group by rollup (spg_group,spg_desc) )a )a ) select ranked_table.rank, ranked_desc_table.rank_desc, shown_table.* from ( select rank() over(partition by shown order by case when spg_group is null then 2 when spg_group = 'Other' then 1 else 0 end, (abs(net_exposure_cob) + abs(SPV01_cob) + abs(PV01_cob)) / 3 desc, rownum) as rank, spg_group from (select row_number () over () as rownum,* from shown_table where spg_desc is null)n ) ranked_table, ( select spg_group, spg_desc, rank() over(partition by shown, spg_group order by case when spg_desc is null then 0 else 1 end, (abs(net_exposure_cob) + abs(SPV01_cob) + abs(PV01_cob)) / 3 desc, rownum) as rank_desc from(select row_number() over () as rownum,* from shown_table)n2 ) ranked_desc_table, shown_table where (shown_table.spg_group = ranked_table.spg_group and shown_table.spg_group = ranked_desc_table.spg_group and shown_table.spg_desc = ranked_desc_table.spg_desc) or (shown_table.spg_group = ranked_desc_table.spg_group and shown_table.spg_group = ranked_table.spg_group and shown_table.spg_desc is null and ranked_desc_table.spg_desc is null) or (shown_table.spg_group is null and ranked_table.spg_group is null and ranked_desc_table.spg_group is null) order by shown, rank, shown_table.spg_desc desc