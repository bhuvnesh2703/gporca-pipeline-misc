With x as (Select cob_date, d.PRODUCT_DESCRIPTION_DECOMP as description, d.PRODUCT_TYPE_CODE as type, d.ISSUER_COUNTRY_CODE_DECOMP as Country, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)) as EQ_DELTA from cdwuser.u_decomp_msr d where d.COB_DATE in ('2018-02-28','2018-02-27') and d.DIVISION = 'IED' and d.CCC_BANKING_TRADING = 'BANKING' and d.SILO_SRC = 'IED' and d.CCC_PL_REPORTING_REGION = 'EMEA' group by cob_date, d.PRODUCT_DESCRIPTION_DECOMP, d.PRODUCT_TYPE_CODE, d.ISSUER_COUNTRY_CODE_DECOMP) , y as(select description, type, Rank() over (partition by description order by abs(sum(case when cob_date = '2018-02-28' then EQ_DELTA else 0 end)) desc) as typeRank from x group by description, type) , z as( select description, country, Rank() over (partition by description order by abs(sum(case when cob_date = '2018-02-28' then EQ_DELTA else 0 end)) desc) as countryRank from x group by description, country) , aa as(select Rank() over (order by abs(sum(case when cob_date = '2018-02-28' then EQ_DELTA else 0 end)) desc)||'_'||'TopBankingDelta' as Concentration, description, sum(case when cob_date = '2018-02-28' then EQ_DELTA else 0 end) as DELTA_COB, sum(case when cob_date = '2018-02-28' then EQ_DELTA else -EQ_DELTA end) as DELTA_DOD from x group by description fetch first 10 rows only) select aa.concentration, aa.description, aa.delta_cob, aa.delta_dod, y.type, z.country from aa inner join y on (aa.description = y.description and typeRank = 1) inner join z on (aa.description = z.description and countryRank = 1) order by abs(delta_cob) desc