SELECT Cob_date, CCC_BUSINESS_AREA, LOCATION_GROUP, sum(USD_CM_Delta) as dollar_delta, sum(case when (a.PRODUCT_TYPE_CODE = 'TIMESPREAD' and a.PROD_POS_NAME_DESCRIPTION = 'WCS POST SPREAD' ) OR a.product_type_code in ('CLEAN FREIGHT','DIRTY FREIGHT','COAL','DRY FREIGHT','EMISSIONS-EU','IRON ORE','NATGAS','PLASTICS') then 0 else cast(a.RAW_CM_DELTA as numeric(15,5)) end) as raw_delta, Product_Type_Code, case when Product_Type_Code in ('DIST', 'JET') then 'Distillate' when Product_Type_Code in ('FUEL','GAS','CRUDE','NAPHTHA', 'ETHANOL', 'NGL') then Product_Type_Code when (a.PRODUCT_TYPE_CODE = 'TIMESPREAD' and a.PROD_POS_NAME_DESCRIPTION = 'WCS POST SPREAD' ) then 'CRUDE' else 'other' end as product_type, case when PRODUCT_SUB_TYPE_NAME in('STORAGE RELET', 'STORAGE CONTRACT') and cob_date >= a.EXPIRATION_DATE and BU_risk_run_custom1='STORAGE' then 0 when PRODUCT_SUB_TYPE_NAME in('FLEXDEAL','P_TANK-T' ,'PHYSICAL INVENTORY') and BU_risk_run_custom1 <>'STORAGE' then 0 when EXTRACT (month FROM cob_date) >= EXTRACT (month FROM a.EXPIRATION_DATE) and EXTRACT (year FROM cob_date) >= EXTRACT (year FROM a.EXPIRATION_DATE) then 1 when EXTRACT (year FROM a.EXPIRATION_DATE)>EXTRACT (year FROM cob_date)+1 then 99 else 12*(EXTRACT (year FROM a.EXPIRATION_DATE)-EXTRACT (year FROM cob_date))+EXTRACT (month FROM a.EXPIRATION_DATE)-EXTRACT (month FROM cob_date)+1 end as MTM , case when PRODUCT_SUB_TYPE_NAME in('STORAGE RELET', 'STORAGE CONTRACT') and cob_date >= a.EXPIRATION_DATE and BU_risk_run_custom1='STORAGE' then 'Tank' when PRODUCT_SUB_TYPE_NAME in('FLEXDEAL','P_TANK-T' ,'PHYSICAL INVENTORY') and BU_risk_run_custom1 <>'STORAGE' then 'Tank' else 'NoTank' end as Tank , case when PRODUCT_SUB_TYPE_NAME in('STORAGE RELET', 'STORAGE CONTRACT') and cob_date >= a.EXPIRATION_DATE and BU_risk_run_custom1='STORAGE' then 0 when PRODUCT_SUB_TYPE_NAME in('FLEXDEAL','P_TANK-T' ,'PHYSICAL INVENTORY') and BU_risk_run_custom1 <>'STORAGE' then 0 when EXTRACT (month FROM cob_date) >= EXTRACT (month FROM a.EXPIRATION_DATE)and EXTRACT (year FROM cob_date) >= EXTRACT (year FROM a.EXPIRATION_DATE) then 1 Else 12*(EXTRACT (year FROM a.EXPIRATION_DATE)-EXTRACT (year FROM cob_date))+EXTRACT (month FROM a.EXPIRATION_DATE)-EXTRACT (month FROM cob_date)+1 end as MTM_GRAPH, case when BU_risk_run_custom1='STORAGE' then 'Storage' else 'NoStorage' end as storage FROM cdwuser.U_CM_MSR a WHERE ((CCC_DIVISION='COMMODITIES' AND CCC_BUSINESS_AREA IN ('OIL LIQUIDS', 'TMG', 'OLYMPUS')) /*OLD LOGIC*/ OR (A.CCC_DIVISION = 'FIXED INCOME DIVISION' AND A.CCC_BUSINESS_AREA = 'COMMODITIES' and (A.CCC_PRODUCT_LINE IN ('OIL & PRODUCTS') or A.CCC_STRATEGY IN ('TMG', 'OLYMPUS')) )) /*NEW LOGIC*/ AND A.PRODUCT_TYPE_CODE NOT IN ('CURRENCY', 'INTEREST RATE', 'INFLATION', 'TBD', 'MISC','CVA', 'FVA', 'ERROR') AND A.COB_DATE IN ('2018-02-28','2018-02-27','2018-01-31','2017-12-29','2017-09-29','2017-06-30') Group By bu_risk_run_custom1, cob_date, a.EXPIRATION_DATE, LOCATION_GROUP, PRODUCT_TYPE_CODE, PRODUCT_SUB_TYPE_NAME, CCC_BUSINESS_AREA, a.PROD_POS_NAME_DESCRIPTION