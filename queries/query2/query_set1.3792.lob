SELECT b.COB_DATE, CASE WHEN b.currency_of_measure IN ('BR1','BRX') THEN 'LATAM' WHEN b.currency_of_measure = 'CNH' THEN 'ASIA' ELSE b.CURRENCY_REGION_CD END AS CURRENCY_REGION, b.LE, SUM (b.FX_DELTA) AS FX_DELTA, SUM(b.FX_KAPPA) AS FX_KAPPA FROM( SELECT a.COB_DATE, a.currency_of_measure, A.CURRENCY_REGION_CD, CASE WHEN a.CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN a.CCC_TAPS_COMPANY in ('0111') THEN 'MSCS' WHEN a.CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN a.CCC_TAPS_COMPANY in ('0146') THEN 'MSDP' WHEN a.CCC_TAPS_COMPANY in ('5745') THEN 'MSCAP' ELSE a.CCC_TAPS_COMPANY END AS LE, SUM(CASE WHEN A.CCC_TAPS_COMPANY IN ('0111') and A.CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN A.CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(A.USD_FX,0) END) AS FX_DELTA, SUM(CASE WHEN a.feed_source_name <> 'CORISK' THEN COALESCE(a.USD_FX_KAPPA, 0) + COALESCE(a.usd_fx_partial_kappa,0) WHEN a.feed_source_name = 'CORISK' AND a.PRODUCT_TYPE_CODE = 'CURRENCY' THEN COALESCE(a.LCY_FX_KAPPA, 0)/1000 ELSE 0 END) AS FX_KAPPA FROM CDWUSER.U_EXP_msr A where a.cob_date in ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND ( A.CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924','0111','0146','5745') OR A.CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') ) AND VAR_EXCL_FL <> 'Y' GROUP BY A.COB_DATE, a.currency_of_measure, A.CURRENCY_REGION_CD, CASE WHEN a.CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN a.CCC_TAPS_COMPANY in ('0111') THEN 'MSCS' WHEN a.CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN a.CCC_TAPS_COMPANY in ('0146') THEN 'MSDP' WHEN a.CCC_TAPS_COMPANY in ('5745') THEN 'MSCAP' ELSE a.CCC_TAPS_COMPANY END ) b GROUP BY b.COB_DATE, CASE WHEN b.currency_of_measure IN ('BR1','BRX') THEN 'LATAM' WHEN b.currency_of_measure = 'CNH' THEN 'ASIA' ELSE b.CURRENCY_REGION_CD END, b.LE