WITH SRC AS ( SELECT X.*, SUM(CM_DELTA_COB) OVER(PARTITION BY CCC_PRODUCT_LINE) AS CM_DELTA_COB_RANK FROM ( SELECT BUSS_LEVEL5, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CCC_PRODUCT_LINE, sum(case when caldate = '2018-02-28' then coalesce(CM_DELTA, 0) else 0 end) as CM_DELTA_cob, sum(case when caldate = '2018-02-28' then coalesce(CM_DELTA, 0) else -coalesce(CM_DELTA, 0) end) as CM_DELTA_change, sum(case when caldate = '2018-02-28' then coalesce(cm_kappa, 0) else 0 end) as cm_kappa_cob, sum(case when caldate = '2018-02-28' then coalesce(cm_kappa, 0) else -coalesce(cm_kappa, 0) end) as cm_kappa_change FROM ( SELECT COB_DATE AS CALDATE, PRODUCT_TYPE_CODE AS BUSS_LEVEL5, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CCC_PRODUCT_LINE, SUM(CASE WHEN PRODUCT_TYPE_CODE NOT IN ('EQUITY INDEX','CREDIT', 'CASH','MISC','ERROR','TBD','INTEREST RATE','CURRENCY') THEN COALESCE(USD_CM_DELTA,0) ELSE 0 END) AS CM_DELTA, SUM(CASE WHEN PRODUCT_TYPE_CODE NOT IN (UPPER('Interest Rate'),UPPER('euro pwr spread'),UPPER('euro gas spread'),UPPER('timespread'),UPPER('TBD')) THEN CASE WHEN PRODUCT_TYPE_CODE=UPPER('Eur ng') THEN COALESCE(RAW_CM_KAPPA,0) / 10000 WHEN PRODUCT_TYPE_CODE NOT IN(UPPER('equity index'),UPPER('Currency'), UPPER('Credit')) THEN COALESCE(RAW_CM_KAPPA,0) / 1000 ELSE 0 END ELSE 0 END ) CM_KAPPA FROM CDWUSER.U_CM_MSR CM WHERE cob_date in ('2018-02-28','2018-02-21') AND VAR_EXCL_FL <> 'Y' AND CCC_DIVISION NOT IN ('COMMODITIES') AND FEED_SOURCE_NAME = 'CORISK' AND PARENT_LEGAL_ENTITY = '0302(G)' AND ccc_banking_trading = 'TRADING' GROUP BY COB_DATE, PRODUCT_TYPE_CODE, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CCC_PRODUCT_LINE ) Z GROUP BY BUSS_LEVEL5, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CCC_PRODUCT_LINE ) X ) SELECT CASE WHEN RANK >= 10 THEN 10 ELSE RANK END AS RANK, CASE WHEN RANK >= 10 THEN 'Other' ELSE BUSS_LEVEL5 END AS BUSS_LEVEL5, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CCC_PRODUCT_LINE, SUM(CM_DELTA_COB) AS CM_DELTA_COB, SUM(CM_DELTA_CHANGE) AS CM_DELTA_CHANGE, SUM(CM_KAPPA_COB) AS CM_KAPPA_COB, SUM(CM_KAPPA_CHANGE) AS CM_KAPPA_CHANGE from ( SELECT DENSE_RANK() OVER(ORDER BY ABS(CM_DELTA_COB_RANK) DESC) AS RANK, SRC.* FROM SRC ) X GROUP BY CASE WHEN RANK >= 10 THEN 10 ELSE RANK END, CASE WHEN RANK >= 10 THEN 'Other' ELSE BUSS_LEVEL5 END, TIME_BUCKET_ANNUAL, TIME_BUCKET_QUARTER, CCC_PRODUCT_LINE