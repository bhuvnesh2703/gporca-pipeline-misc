WITH NE_Table as ( SELECT a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA,a.position_ult_issuer_party_darwin_name AS ULT_ISSUER_PARTY_DARWIN_NAME, a.ccc_banking_trading, CASE WHEN a.currency_of_measure ='CNH' THEN 'CNY' WHEN a.currency_of_measure IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.currency_of_measure ='KRX' THEN 'KRW' WHEN a.currency_of_measure in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.currency_of_measure END AS currency_of_measure, SUM(a.USD_EXPOSURE)::numeric(15,5) AS net_exposure FROM CDWUSER.U_EXP_MSR a WHERE a.COB_DATE = '02/28/2018' AND a.PARENT_LEGAL_ENTITY IN ('0201(G)', '0111', '0105(G)', '5745', '0146', '0302(G)', '1633') AND a.currency_of_measure <> 'UNDEFINED' AND a.CCC_BUSINESS_AREA = 'FXEM MACRO TRADING' AND a.position_ult_issuer_party_darwin_name <> 'UNDEFINED' GROUP BY a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA, a.position_ult_issuer_party_darwin_name, a.ccc_banking_trading, CASE WHEN a.currency_of_measure ='CNH' THEN 'CNY' WHEN a.currency_of_measure IN ('BRX','BR1','BRL') THEN 'BRL' WHEN a.currency_of_measure ='KRX' THEN 'KRW' WHEN a.currency_of_measure in ('RUB','RU1','RBX') THEN 'RUB' ELSE a.currency_of_measure END HAVING SUM (a.USD_EXPOSURE) >= 20000 OR SUM (a.USD_EXPOSURE) <= -20000 ) SELECT B.currency_of_measure, B.CCC_BUSINESS_AREA, B.ULT_ISSUER_PARTY_DARWIN_NAME, B.ccc_banking_trading, C.PARENT_LEGAL_ENTITY, C.net_exposure FROM( SELECT A.currency_of_measure, A.CCC_BUSINESS_AREA, A.ULT_ISSUER_PARTY_DARWIN_NAME, A.ccc_banking_trading, SUM(A.net_exposure) AS NET_EXPOSURE_NET_BUSI, SUM(ABS(A.net_exposure)) AS NET_EXPOSURE_GROSS_BUSI, rank() over(order by abs(SUM(A.net_exposure) )/SUM(ABS(A.net_exposure)) asc) as rank FROM NE_TABLE A WHERE A.net_exposure <> 0 group by A.currency_of_measure, a.ccc_business_area, a.ULT_ISSUER_PARTY_DARWIN_NAME, a.ccc_banking_trading) b LEFT JOIN ne_table c ON b.currency_of_measure = c.currency_of_measure AND b.ccc_business_area = c.ccc_business_area and b.ULT_ISSUER_PARTY_DARWIN_NAME = c.ULT_ISSUER_PARTY_DARWIN_NAME AND b.ccc_banking_trading = c.ccc_banking_trading where abs(b.NET_EXPOSURE_NET_BUSI) <> b.NET_EXPOSURE_GROSS_BUSI