with fid as ( SELECT case when product_type_code in ('BONDFUT', 'BONDOPT', 'GVTBONDIL', 'GVTBOND', 'BONDFUTOPT') then 'Govts' when upper(sectype2) = upper('Govts') then 'Govts' when upper(curve_name) = upper('krwktb') then 'Govts' when upper(sectype2) = upper('Swaps') then 'Total Swaps' when product_type_code in ('RATEFUT', upper('Swaps')) then 'Total Swaps' else 'Other' end as sectype_grouping, case product_type_code when 'BONDFUT' then 'Bond Futures' when 'GVTBOND' then 'Govt Bonds' when 'GVTBONDIL' then 'Govt Bonds' when 'RATEFUT' then 'Rate Future' else case when sectype2='OTHER' then product_type_code else sectype2 end end as sectype, term_new as term, SUM (CASE WHEN cob_date = '2018-02-28' THEN usd_ir_unified_pv01 ELSE 0 END) AS pv01, SUM (CASE WHEN cob_date = '2018-02-28' THEN usd_ir_unified_pv01 ELSE -usd_ir_unified_pv01 END) AS pv01_c FROM CDWUSER.U_EXP_TRENDS a where cob_date in ('2018-02-28','2018-02-21') AND var_excl_fl <> 'Y' AND PARENT_LEGAL_ENTITY = '0517(G)' AND COALESCE(usd_ir_unified_pv01,0) <> 0 AND ccc_banking_trading = 'TRADING' GROUP BY case when product_type_code in ('BONDFUT', 'BONDOPT', 'GVTBONDIL', 'GVTBOND', 'BONDFUTOPT') then 'Govts' when upper(sectype2) = upper('Govts') then 'Govts' when upper(curve_name) = upper('krwktb') then 'Govts' when upper(sectype2) = upper('Swaps') then 'Total Swaps' when product_type_code in ('RATEFUT', upper('Swaps')) then 'Total Swaps' else 'Other' end, case product_type_code when 'BONDFUT' then 'Bond Futures' when 'GVTBOND' then 'Govt Bonds' when 'GVTBONDIL' then 'Govt Bonds' when 'RATEFUT' then 'Rate Future' else case when sectype2='OTHER' then product_type_code else sectype2 end end, term_new), src as (select sectype_grouping, null as sectype, term, sum(pv01) as pv01, sum(pv01_c) as pv01_c from fid GROUP BY sectype_grouping, term union all select sectype_grouping, sectype, term, sum(pv01) as pv01, sum(pv01_c) as pv01_c from fid GROUP BY sectype_grouping, sectype, term), ranked as (SELECT sectype_grouping, sectype, sum(case when term = 0.083 then pv01 end) as pv01_0083, sum(case when term = 0.25 then pv01 end) as pv01_025, sum(case when term = 0.5 then pv01 end) as pv01_05, sum(case when term = 0.75 then pv01 end) as pv01_075, sum(case when term = 1 then pv01 end) as pv01_1, sum(case when term = 2 then pv01 end) as pv01_2, sum(case when term = 3 then pv01 end) as pv01_3, sum(case when term = 5 then pv01 end) as pv01_5, sum(case when term = 7 then pv01 end) as pv01_7, sum(case when term = 8 then pv01 end) as pv01_8, sum(case when term = 10 then pv01 end) as pv01_10, sum(case when term = 12 then pv01 end) as pv01_12, sum(case when term = 15 then pv01 end) as pv01_15, sum(case when term = 20 then pv01 end) as pv01_20, sum(case when term = 25 then pv01 end) as pv01_25, sum(case when term = 30 then pv01 end) as pv01_30, sum(case when term = 40 then pv01 end) as pv01_40, sum(case when term = 50 then pv01 end) as pv01_50, sum(case when term = 60 then pv01 end) as pv01_60, sum(case when term = 75 then pv01 end) as pv01_75, sum(pv01) as pv01, sum(case when term = 0.083 then pv01_c end) as pv01_0083_c, sum(case when term = 0.25 then pv01_c end) as pv01_025_c, sum(case when term = 0.5 then pv01_c end) as pv01_05_c, sum(case when term = 0.75 then pv01_c end) as pv01_075_c, sum(case when term = 1 then pv01_c end) as pv01_1_c, sum(case when term = 2 then pv01_c end) as pv01_2_c, sum(case when term = 3 then pv01_c end) as pv01_3_c, sum(case when term = 5 then pv01_c end) as pv01_5_c, sum(case when term = 7 then pv01_c end) as pv01_7_c, sum(case when term = 8 then pv01_c end) as pv01_8_c, sum(case when term = 10 then pv01_c end) as pv01_10_c, sum(case when term = 12 then pv01_c end) as pv01_12_c, sum(case when term = 15 then pv01_c end) as pv01_15_c, sum(case when term = 20 then pv01_c end) as pv01_20_c, sum(case when term = 25 then pv01_c end) as pv01_25_c, sum(case when term = 30 then pv01_c end) as pv01_30_c, sum(case when term = 40 then pv01_c end) as pv01_40_c, sum(case when term = 50 then pv01_c end) as pv01_50_c, sum(case when term = 60 then pv01_c end) as pv01_60_c, sum(case when term = 75 then pv01_c end) as pv01_75_c, sum(pv01_c) as pv01_c, case sectype_grouping when 'Govts' then 1 when 'Total Swaps' then 2 else 3 end as sectype_grouping_order, case when sectype is null then 100 else least(rank() over(partition by sectype_grouping order by abs(sum(coalesce(case when sectype is not null then pv01 else 0 end,0))) desc ) , case sectype_grouping when 'Govts' then 4 when 'Total Swaps' then 2 else 9 end) end as rank FROM src GROUP BY sectype_grouping, sectype) SELECT sectype_grouping_order, rank, sectype_grouping, case rank when case sectype_grouping when 'Govts' then 4 when 'Total Swaps' then 2 else 9 end then 'Other' else sectype end as sectype, sum(pv01_0083) pv01_0083, sum(pv01_0083_c) pv01_0083_c, sum(pv01_025) pv01_025, sum(pv01_025_c) pv01_025_c, sum(pv01_05) pv01_05, sum(pv01_05_c) pv01_05_c, sum(pv01_075) pv01_075, sum(pv01_075_c) pv01_075_c, sum(pv01_1) pv01_1, sum(pv01_1_c) pv01_1_c, sum(pv01_2) pv01_2, sum(pv01_2_c) pv01_2_c, sum(pv01_3) pv01_3, sum(pv01_3_c) pv01_3_c, sum(pv01_5) pv01_5, sum(pv01_5_c) pv01_5_c, sum(pv01_7) pv01_7, sum(pv01_7_c) pv01_7_c, sum(pv01_8) pv01_8, sum(pv01_8_c) pv01_8_c, sum(pv01_10) pv01_10, sum(pv01_10_c) pv01_10_c, sum(pv01_12) pv01_12, sum(pv01_12_c) pv01_12_c, sum(pv01_15) pv01_15, sum(pv01_15_c) pv01_15_c, sum(pv01_20) pv01_20, sum(pv01_20_c) pv01_20_c, sum(pv01_25) pv01_25, sum(pv01_25_c) pv01_25_c, sum(pv01_30) pv01_30, sum(pv01_30_c) pv01_30_c, sum(pv01_40) pv01_40, sum(pv01_40_c) pv01_40_c, sum(pv01_50) pv01_50, sum(pv01_50_c) pv01_50_c, sum(pv01_60) pv01_60, sum(pv01_60_c) pv01_60_c, sum(pv01_75) pv01_75, sum(pv01_75_c) pv01_75_c, sum(pv01) as pv01_total, sum(pv01_c) as pv01_total_c FROM ranked t GROUP BY sectype_grouping_order, rank, sectype_grouping, case rank when case sectype_grouping when 'Govts' then 4 when 'Total Swaps' then 2 else 9 end then 'Other' else sectype end