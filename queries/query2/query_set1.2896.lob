WITH DIVISIONALRANK AS( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, RANK() OVER(ORDER BY ABS(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))/1000 DESC) AS DIV_RANK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION ), DIVISION_SHORTNAME AS( SELECT d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END AS DIVISION FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') GROUP BY d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END ), PRD_TYPE_LIST AS( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.PRODUCT_TYPE_CODE, RANK() OVER(ORDER BY ABS(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))DESC) as RANK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' AND d.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK<>1) GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.PRODUCT_TYPE_CODE HAVING abs(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))>0 ) SELECT e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.PRODUCT_TYPE_CODE AS PRODUCT_TYPE_CODE_ORIG, n.DIVISION, CASE WHEN e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) THEN e.CCC_DIVISION ELSE e.CCC_BUSINESS_AREA END AS CCC_BUSINESS_AREA, CASE WHEN l.RANK<=5 THEN e.PRODUCT_TYPE_CODE ELSE 'Others' END as PRODUCT_TYPE_CODE, CASE WHEN l.RANK<=5 THEN l.RANK ELSE 6 END RANK, sum(coalesce(e.USD_DELTA,0))/1000 as USD_DELTA FROM CDWUSER.U_EQ_MSR e LEFT JOIN PRD_TYPE_LIST l ON e.PRODUCT_TYPE_CODE=l.PRODUCT_TYPE_CODE INNER JOIN DIVISION_SHORTNAME n ON e.CCC_DIVISION=n.CCC_DIVISION WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.PRODUCT_TYPE_CODE, CASE WHEN e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) THEN e.CCC_DIVISION ELSE e.CCC_BUSINESS_AREA END, CASE WHEN l.RANK<=5 THEN e.PRODUCT_TYPE_CODE ELSE 'Others' END, CASE WHEN l.RANK<=5 THEN l.RANK ELSE 6 END, n.DIVISION