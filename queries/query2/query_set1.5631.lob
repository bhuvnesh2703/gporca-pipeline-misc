SELECT COB_DATE, CURRENCY_OF_MEASURE, FUNDING_FLAG, term0, case when (CURRENCY_OF_MEASURE='MXN' and FUNDING_FLAG='Funding') then -term_USD_IRPV01SPRD else term_USD_IRPV01SPRD end as term_USD_IRPV01SPRD from ( select COB_DATE, CURRENCY_OF_MEASURE, FUNDING_FLAG, case when term < 0.0834 then '01. 1W' when term < 0.17 then '02. 1M' when term < 0.25 then '03. 2M' when term < 0.5 then '04. 3M' when term < 1 then '05. 6M' when term < 2 then '06. 1Y' when term < 3 then '07. 2Y' when term < 4 then '08. 3Y' when term < 5 then '09. 4Y' when term < 7 then '10. 5Y' when term < 10 then '11. 7Y' when term < 15 then '12. 10Y' when term < 20 then '13. 15Y' else '14. 20Y' end AS term0, case when TERM<0.02 then sum(USD_IRPV01SPRD::numeric(15,5)) when TERM<0.0834 then sum(USD_IRPV01SPRD::numeric(15,5))* (0.0834 - TERM)/(0.0834-0.02) when TERM<0.17 then sum(USD_IRPV01SPRD::numeric(15,5))* (0.17- TERM)/0.0834 when TERM<0.25 then sum(USD_IRPV01SPRD::numeric(15,5))* (0.25- TERM)/0.0834 when TERM<0.5 then sum(USD_IRPV01SPRD::numeric(15,5))* (0.5- TERM)/0.25 when TERM<1 then sum(USD_IRPV01SPRD::numeric(15,5))* (1- TERM)/0.5 when TERM<2 then sum(USD_IRPV01SPRD::numeric(15,5))* (2- TERM)/1 when TERM<3 then sum(USD_IRPV01SPRD::numeric(15,5))* (3- TERM)/1 when TERM<4 then sum(USD_IRPV01SPRD::numeric(15,5))* (4- TERM)/1 when TERM<5 then sum(USD_IRPV01SPRD::numeric(15,5))* (5- TERM)/1 when TERM<7 then sum(USD_IRPV01SPRD::numeric(15,5))* (7- TERM)/2 when TERM<10 then sum(USD_IRPV01SPRD::numeric(15,5))* (10- TERM)/3 when TERM<15 then sum(USD_IRPV01SPRD::numeric(15,5))* (15- TERM)/5 when TERM<20 then sum(USD_IRPV01SPRD::numeric(15,5))* (20- TERM)/5 when TERM<30 then sum(USD_IRPV01SPRD::numeric(15,5))* (30- TERM)/10 end as term_USD_IRPV01SPRD from ( select COB_DATE, CURRENCY_OF_MEASURE, 'Funding' as FUNDING_FLAG, term_of_measure/365 as term, case when LONG_SHORT='L' then (-USD_NOTIONAL * term_of_measure/365)/10000 else (USD_NOTIONAL * term_of_measure/365)/10000 end as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and book in ('TSGFX', 'THKFX') and COB_DATE < EXPIRATION_DATE and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365<30 and USD_NOTIONAL is not null and USD_NOTIONAL<>0 union all select COB_DATE, CURRENCY_OF_MEASURE, 'Funding' as FUNDING_FLAG, term_of_measure/365 as term, (-USD_NOTIONAL * term_of_measure/365)/10000 as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') AND CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and VERTICAL_SYSTEM LIKE '%FXDDI%' and CCC_BUSINESS_AREA in ('TSY DEBT') and CCC_PRODUCT_LINE in ('S-TERM DEBT', 'FX AND OTHER FUNDING') and CCC_STRATEGY in ('FX SWAPS') and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365<30 and USD_NOTIONAL is not null and COB_DATE < EXPIRATION_DATE and BOOK not in ('CT0101XE','CT0302XE') union all select COB_DATE, CURRENCY_OF_MEASURE, 'Funding' as FUNDING_FLAG, term_of_measure/365 as term, (-USD_MARKET_VALUE * term_of_measure/365)/10000 as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and BOOK='KRSWP' and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365<30 and USD_MARKET_VALUE is not null and COB_DATE < EXPIRATION_DATE union all select COB_DATE, CURRENCY_OF_MEASURE, 'XCCY' as FUNDING_FLAG, term_of_measure/365 as term, USD_IRPV01SPRD as USD_IRPV01SPRD from CDWUSER.U_IR_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and curve_type IN ('FXBASISYIELDCURVE', 'FXBASISYIELDCURVE') and USD_IRPV01SPRD is not null and CCC_BUSINESS_AREA not in ('MS BANK - PRIVATE BANK1') and CCC_STRATEGY not in ('STRUCTURED N', 'L-TERM DEBT SN', 'L-TERM DEBT SN ALLOC') and book not in ('AEOEQ','LIABB','TRPFD', 'PRFEQ','TDET2','TDET3','TDET4','TDET5','TDET6','TDET7','TDET8', 'TDEBT','TDCLH', 'TYCNY','TZUFX','TSGFX','TLNFX','TSTJY', 'THKFX') and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365<30 and COB_DATE < EXPIRATION_DATE union all select COB_DATE, CURRENCY_OF_MEASURE, 'FUNDING' as FUNDING_FLAG, term_of_measure/365 as term, (-USD_NOTIONAL * term_of_measure/365)/10000 as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and USD_NOTIONAL is not null and book in ('TZUFX','TLNFX') and term_of_measure/365<30 and CURRENCY_OF_MEASURE not in ('USD') and COB_DATE < EXPIRATION_DATE ) A GROUP BY COB_DATE, CURRENCY_OF_MEASURE, FUNDING_FLAG, TERM UNION ALL select COB_DATE, CURRENCY_OF_MEASURE, FUNDING_FLAG, case when term < 0.0834 then '02. 1M' when term < 0.17 then '03. 2M' when term < 0.25 then '04. 3M' when term < 0.5 then '05. 6M' when term < 1 then '06. 1Y' when term < 2 then '07. 2Y' when term < 3 then '08. 3Y' when term < 4 then '09. 4Y' when term < 5 then '10. 5Y' when term < 7 then '11. 7Y' when term < 10 then '12. 10Y' when term < 15 then '13. 15Y' when term < 20 then '14. 20Y' else '15. 30Y+' end AS term0, case when TERM<0.0834 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 0.02)/(0.0834-0.02) when TERM<0.17 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 0.0834)/0.0834 when TERM<0.25 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 0.17)/0.0834 when TERM<0.5 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 0.25)/0.25 when TERM<1 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 0.5)/0.5 when TERM<2 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 1)/1 when TERM<3 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 2)/1 when TERM<4 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 3)/1 when TERM<5 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 4)/1 when TERM<7 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 5)/2 when TERM<10 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 7)/3 when TERM<15 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 10)/5 when TERM<20 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 15)/5 when TERM<30 then sum(USD_IRPV01SPRD::numeric(15,5))* (TERM - 20)/5 end as term_USD_IRPV01SPRD FROM ( select COB_DATE, CURRENCY_OF_MEASURE, 'Funding' as FUNDING_FLAG, term_of_measure/365 as term, case when LONG_SHORT='L' then (-USD_NOTIONAL * term_of_measure/365)/10000 else (USD_NOTIONAL * term_of_measure/365)/10000 end as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and book in ('TSGFX', 'THKFX') and COB_DATE < EXPIRATION_DATE and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365>=0.02 and USD_NOTIONAL is not null and USD_NOTIONAL<>0 union all select COB_DATE, CURRENCY_OF_MEASURE, 'Funding' as FUNDING_FLAG, term_of_measure/365 as term, (-USD_NOTIONAL * term_of_measure/365)/10000 as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') AND CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and VERTICAL_SYSTEM LIKE '%FXDDI%' and CCC_BUSINESS_AREA in ('TSY DEBT') and CCC_PRODUCT_LINE in ('S-TERM DEBT', 'FX AND OTHER FUNDING') and CCC_STRATEGY in ('FX SWAPS') and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365>=0.02 and USD_NOTIONAL is not null and COB_DATE < EXPIRATION_DATE and BOOK not in ('CT0101XE','CT0302XE') union all select COB_DATE, CURRENCY_OF_MEASURE, 'Funding' as FUNDING_FLAG, term_of_measure/365 as term, (-USD_MARKET_VALUE * term_of_measure/365)/10000 as USD_IRPV01SPRD from CDWUSER.U_OT_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and BOOK='KRSWP' and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365>=0.02 and USD_MARKET_VALUE is not null and COB_DATE < EXPIRATION_DATE union all select COB_DATE, CURRENCY_OF_MEASURE, 'XCCY' as FUNDING_FLAG, term_of_measure/365 as term, USD_IRPV01SPRD as USD_IRPV01SPRD from CDWUSER.U_IR_MSR where COB_DATE IN ('2018-02-21', '2018-02-28') and CCC_DIVISION = 'TREASURY CAPITAL MARKETS' and curve_type IN ('FXBASISYIELDCURVE', 'FXBASISYIELDCURVE') and USD_IRPV01SPRD is not null and CCC_BUSINESS_AREA not in ('MS BANK - PRIVATE BANK1') and CCC_STRATEGY not in ('STRUCTURED N', 'L-TERM DEBT SN', 'L-TERM DEBT SN ALLOC') and book not in ('AEOEQ','LIABB','TRPFD', 'PRFEQ','TDET2','TDET3','TDET4','TDET5','TDET6','TDET7','TDET8', 'TDEBT','TDCLH', 'TYCNY','TZUFX','TSGFX','TLNFX','TSTJY', 'THKFX') and CURRENCY_OF_MEASURE not in ('USD') and term_of_measure/365>=0.02 and COB_DATE < EXPIRATION_DATE ) B GROUP BY COB_DATE, CURRENCY_OF_MEASURE, FUNDING_FLAG, TERM ) C