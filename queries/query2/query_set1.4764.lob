WITH IED AS ( SELECT e.COB_DATE , e.PROCESS_ID , e.POSITION_ID , case when e.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') then 'MSCO' ELSE 'MSIP' end as LE_GROUP , e.underlier_tick , sum(coalesce(e.SLIDE_EQ_MIN_20_USD,0))::NUMERIC(30,10) AS D20RAW , sum(coalesce(e.SLIDE_EQ_MIN_10_USD,0))::NUMERIC(30,10) AS D10RAW , sum(coalesce(e.SLIDE_EQ_MIN_05_USD,0))::NUMERIC(30,10) AS D05RAW , sum(coalesce(e.SLIDE_EQ_PLS_10_USD,0))::NUMERIC(30,10) AS P10RAW, sum(coalesce(e.SLIDE_EQ_PLS_05_USD,0))::NUMERIC(30,10) AS P05RAW , sum(coalesce(e.SLIDE_EQ_PLS_20_USD,0))::NUMERIC(30,10) AS P20RAW FROM cdwuser.U_EXP_MSR e WHERE e.cob_date >= '2018-02-14' and e.cob_date <= '2018-02-28' AND e.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND e.CCC_BUSINESS_AREA IN ('DERIVATIVES') AND e.CCC_PRODUCT_LINE IN ('EXOTIC PRODUCTS') and e.CCC_PL_REPORTING_REGION = 'AMERICAS' and e.CCC_BANKING_TRADING = 'TRADING' AND (e.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') or e.PARENT_LEGAL_ENTITY IN ('0302(G)')) GROUP BY e.PROCESS_ID , e.POSITION_ID , e.COB_DATE , e.underlier_tick , case when e.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') then 'MSCO' ELSE 'MSIP' end ) ,CountryWeights AS ( SELECT d.COB_DATE ,d.PROCESS_ID ,d.POSITION_ID ,case when d.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') then 'MSCO' ELSE 'MSIP' end as LE_GROUP ,d.ISSUER_COUNTRY_CODE_DECOMP AS COUNTRY ,abs(sum(d.PRODUCT_WEIGHT_DECOMP))::NUMERIC(30,10) AS WEIGHT FROM cdwuser.U_DECOMP_MSR d WHERE d.cob_date >= '2018-02-14' and d.cob_date <= '2018-02-28' AND d.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND d.CCC_BUSINESS_AREA IN ('DERIVATIVES') AND d.CCC_PRODUCT_LINE IN ('EXOTIC PRODUCTS') and d.CCC_PL_REPORTING_REGION = 'AMERICAS' and d.CCC_BANKING_TRADING = 'TRADING' AND (d.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') or d.PARENT_LEGAL_ENTITY IN ('0302(G)')) GROUP BY d.COB_DATE ,d.PROCESS_ID ,d.POSITION_ID , case when d.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') then 'MSCO' ELSE 'MSIP' end ,d.ISSUER_COUNTRY_CODE_DECOMP HAVING sum(d.PRODUCT_WEIGHT_DECOMP) <> 0 ) , GrossWeights AS ( SELECT x.COB_DATE ,x.PROCESS_ID ,x.POSITION_ID ,x.LE_GROUP ,sum(abs(x.WEIGHT))::NUMERIC(30,10) AS GROSS_WEIGHT FROM CountryWeights x GROUP BY x.COB_DATE ,x.PROCESS_ID ,x.POSITION_ID ,x.LE_GROUP ), Decomp AS ( SELECT w.COB_DATE ,w.LE_GROUP ,w.Process_ID ,w.Position_id ,w.COUNTRY ,abs(w.WEIGHT / g.GROSS_WEIGHT)::NUMERIC(30,10) AS WEIGHT FROM CountryWeights w INNER JOIN GrossWeights g ON ( w.cob_date = g.cob_date AND w.process_id = g.process_id AND w.position_id = g.position_id AND w.LE_GROUP = g.LE_GROUP ) ),Country_LE AS( SELECT g.COUNTRY, g.LE_GROUP, SUM(l.D20RAW * g.WEIGHT)::NUMERIC(30,10) as D20RAW_LE, SUM(l.P20RAW * g.WEIGHT)::NUMERIC(30,10) as P20RAW_LE, SUM(l.D10RAW * g.WEIGHT)::NUMERIC(30,10) as D10RAW_LE, SUM(l.P10RAW * g.WEIGHT)::NUMERIC(30,10) as P10RAW_LE, SUM(l.D05RAW * g.WEIGHT)::NUMERIC(30,10) as D05RAW_LE, SUM(l.P05RAW * g.WEIGHT)::NUMERIC(30,10) as P05RAW_LE FROM IED l INNER JOIN Decomp g ON ( l.PROCESS_ID = g.PROCESS_ID AND l.POSITION_ID = g.POSITION_ID AND l.COB_DATE = g.COB_DATE AND l.LE_GROUP = g.LE_GROUP ) WHERE l.COB_DATE = '2018-02-28' group by g.country, g.LE_GROUP ), country_selection AS ( SELECT K.COUNTRY FROM COUNTRY_LE K where K.COUNTRY <> 'USA' group by K.COUNTRY order by (sum(abs(k.D10RAW_LE))-abs(sum(k.D10RAW_LE))) desc fetch first 1 row only ) SELECT i.COB_DATE , j.COUNTRY ,i.LE_GROUP , sum(i.D20RAW * j.WEIGHT) as D20RAW ,sum(i.D10RAW * j.WEIGHT) AS D10RAW ,sum(i.D05RAW * j.WEIGHT) AS D05RAW ,sum(i.P10RAW * j.WEIGHT) AS P10RAW ,sum(i.P05RAW * j.WEIGHT) AS P05RAW ,sum(i.P20RAW * j.WEIGHT) AS P20RAW FROM IED i INNER JOIN Decomp j ON ( i.PROCESS_ID = j.PROCESS_ID AND i.POSITION_ID = j.POSITION_ID AND i.COB_DATE = j.COB_DATE AND i.LE_GROUP = j.LE_GROUP ) where j.country in ( 'USA' ) group by j.COUNTRY , i.LE_GROUP, i.COB_DATE union SELECT i.COB_DATE , j.COUNTRY ,i.LE_GROUP , sum(i.D20RAW * j.WEIGHT) as D20RAW ,sum(i.D10RAW * j.WEIGHT) AS D10RAW ,sum(i.D05RAW * j.WEIGHT) AS D05RAW ,sum(i.P10RAW * j.WEIGHT) AS P10RAW ,sum(i.P05RAW * j.WEIGHT) AS P05RAW ,sum(i.P20RAW * j.WEIGHT) AS P20RAW FROM IED i INNER JOIN Decomp j ON ( i.PROCESS_ID = j.PROCESS_ID AND i.POSITION_ID = j.POSITION_ID AND i.COB_DATE = j.COB_DATE AND i.LE_GROUP = j.LE_GROUP ) where j.country in ( select a.country from country_selection a ) group by j.COUNTRY , i.LE_GROUP, i.COB_DATE