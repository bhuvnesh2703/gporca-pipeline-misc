with EQ_Decomp_Table as ( SELECT a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA, a.ULT_ISSUER_PARTY_DARWIN_NAME AS ULT_ISSUER_PARTY_DARWIN_NAME, SUM(a.USD_EQ_DELTA_DECOMP)::numeric(30,10) AS USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '02/28/2018' AND a.USD_EQ_DELTA_DECOMP IS NOT NULL AND a.PARENT_LEGAL_ENTITY IN ('0201(G)', '0111', '0105(G)', '5745', '0146', '0302(G)', '1633','1928') AND a.ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' GROUP BY a.COB_DATE, a.PARENT_LEGAL_ENTITY, a.CCC_BUSINESS_AREA, a.ULT_ISSUER_PARTY_DARWIN_NAME HAVING SUM (a.USD_EQ_DELTA_DECOMP) >= 30000 OR SUM (a.USD_EQ_DELTA_DECOMP) <= -30000 ), EQ_MSR_TABLE as( select b.cob_date, b.PARENT_LEGAL_ENTITY, b.CCC_BUSINESS_AREA, b.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME as POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, b.USD_EQ_GAMMA, b.USD_EQ_KAPPA , b.SLIDE_EQ_MIN_05_USD, b.SLIDE_EQ_MIN_10_USD, b.SLIDE_EQ_MIN_1_USD, b.SLIDE_EQ_MIN_20_USD, b.SLIDE_EQ_MIN_30_USD, b.SLIDE_EQ_PLS_05_USD, b.SLIDE_EQ_PLS_10_USD, b.SLIDE_EQ_PLS_1_USD, b.SLIDE_EQ_PLS_20_USD, b.SLIDE_EQ_PLS_30_USD from CDWUSER.U_EQ_MSR b where b.COB_DATE = '02/28/2018' AND b.PARENT_LEGAL_ENTITY IN ('0201(G)', '0111', '0105(G)', '5745', '0146', '0302(G)', '1633','1928') AND b.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' ) SELECT n.CCC_BUSINESS_AREA, n.PARENT_LEGAL_ENTITY, n.ULT_ISSUER_PARTY_DARWIN_NAME, n.USD_EQ_DELTA_DECOMP, sum(m.USD_EQ_GAMMA) as USD_EQ_GAMMA, sum(m.USD_EQ_KAPPA) as USD_EQ_KAPPA, sum(m.SLIDE_EQ_MIN_05_USD) as SLIDE_EQ_MIN_05_USD, sum(m.SLIDE_EQ_MIN_10_USD) as SLIDE_EQ_MIN_10_USD, sum(m.SLIDE_EQ_MIN_1_USD) as SLIDE_EQ_MIN_1_USD, sum(m.SLIDE_EQ_MIN_20_USD) as SLIDE_EQ_MIN_20_USD, sum(m.SLIDE_EQ_MIN_30_USD) as SLIDE_EQ_MIN_30_USD, sum(m.SLIDE_EQ_PLS_05_USD) as SLIDE_EQ_PLS_05_USD, sum(m.SLIDE_EQ_PLS_10_USD) as SLIDE_EQ_PLS_10_USD, sum(m.SLIDE_EQ_PLS_1_USD) as SLIDE_EQ_PLS_1_USD, sum(m.SLIDE_EQ_PLS_20_USD) as SLIDE_EQ_PLS_20_USD, sum(m.SLIDE_EQ_PLS_30_USD) as SLIDE_EQ_PLS_30_USD from( select B.ULT_ISSUER_PARTY_DARWIN_NAME, B.CCC_BUSINESS_AREA, C.PARENT_LEGAL_ENTITY, C.USD_EQ_DELTA_DECOMP FROM( SELECT A.ULT_ISSUER_PARTY_DARWIN_NAME, A.CCC_BUSINESS_AREA, SUM(A.USD_EQ_DELTA_DECOMP) AS USD_EQ_DELTA_DECOMP_NET_BUSI, SUM(ABS(A.USD_EQ_DELTA_DECOMP)) AS USD_EQ_DELTA_DECOMP_GROSS_BUSI, rank() over(order by abs(SUM(A.USD_EQ_DELTA_DECOMP))/SUM(ABS(A.USD_EQ_DELTA_DECOMP)) asc) as rank FROM EQ_Decomp_Table A WHERE A.USD_EQ_DELTA_DECOMP <> 0 and A.ULT_ISSUER_PARTY_DARWIN_NAME IN ( select t.ULT_ISSUER_PARTY_DARWIN_NAME from ( select distinct E.ULT_ISSUER_PARTY_DARWIN_NAME from( SELECT F.ULT_ISSUER_PARTY_DARWIN_NAME, SUM(F.USD_EQ_DELTA_DECOMP) AS USD_EQ_DELTA_DECOMP_NET_LE, sum(abs(F.USD_EQ_DELTA_DECOMP)) as USD_EQ_DELTA_DECOMP_gross_le FROM EQ_Decomp_Table F GROUP BY F.ULT_ISSUER_PARTY_DARWIN_NAME ) E where abs(E.USD_EQ_DELTA_DECOMP_NET_LE) <= 0.7* E.USD_EQ_DELTA_DECOMP_gross_le union select distinct G.ULT_ISSUER_PARTY_DARWIN_NAME from( SELECT H.ULT_ISSUER_PARTY_DARWIN_NAME, H.PARENT_LEGAL_ENTITY, SUM(H.USD_EQ_DELTA_DECOMP) AS USD_EQ_DELTA_DECOMP from EQ_Decomp_Table H group by H.ULT_ISSUER_PARTY_DARWIN_NAME, H.PARENT_LEGAL_ENTITY having abs(sum(H.USD_EQ_DELTA_DECOMP)) >= 100000 ) G ) T ) group by A.ULT_ISSUER_PARTY_DARWIN_NAME, a.ccc_business_area ) b left join EQ_Decomp_Table c on b.ULT_ISSUER_PARTY_DARWIN_NAME = c.ULT_ISSUER_PARTY_DARWIN_NAME and b.ccc_business_area = c.ccc_business_area where abs(b.USD_EQ_DELTA_DECOMP_NET_BUSI) <= 0.25*b.USD_EQ_DELTA_DECOMP_GROSS_BUSI OR (b.rank <=10 and abs(b.USD_EQ_DELTA_DECOMP_NET_BUSI) <> b.USD_EQ_DELTA_DECOMP_GROSS_BUSI) ) n left join EQ_MSR_TABLE m on n.ULT_ISSUER_PARTY_DARWIN_NAME = m.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME and n.CCC_BUSINESS_AREA = m.CCC_BUSINESS_AREA and n.PARENT_LEGAL_ENTITY = m.PARENT_LEGAL_ENTITY where n.CCC_BUSINESS_AREA not in ('OTHER IED') group by n.CCC_BUSINESS_AREA, n.PARENT_LEGAL_ENTITY, n.ULT_ISSUER_PARTY_DARWIN_NAME, n.USD_EQ_DELTA_DECOMP