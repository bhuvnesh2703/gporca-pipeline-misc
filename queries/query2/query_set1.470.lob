with delta as ( SELECT a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP ,Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0)) AS nramv ,Abs(Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) AS abs_nramv, RANK () OVER (ORDER BY ABS (SUM (COALESCE (USD_EQ_DELTA_DECOMP,0))) DESC) AS ranked FROM CDWUSER.U_DECOMP_MSR a WHERE ( COB_DATE = '2018-02-28'    ) and  A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND  a.ccc_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' OR a.ccc_banking_trading IS NULL ) AND (a.CCC_STRATEGY_DETAILS in ('EMERGING MARKETS DSP','EMERGING MARKETS1','INVENTORY OPT EM','MSET EM DSP') OR a.CCC_RISK_MANAGER_LOGIN IN ('christeb','limaleo','portek','eliasc','pessoat','pintoand'))  AND a.ISSUER_COUNTRY_REGION ='LATAM'  AND a.USD_EQ_DELTA_DECOMP IS NOT NULL  GROUP BY a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP FETCH first 10 ROWS ONLY ) , deltacomp as ( SELECT a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP ,Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))  AS nramv ,Abs(Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) AS abs_nramv FROM CDWUSER.U_DECOMP_MSR a WHERE ( COB_DATE = '2018-02-27'  ) and  A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND  a.CCC_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' OR a.ccc_banking_trading IS NULL ) AND (a.CCC_STRATEGY_DETAILS in ('EMERGING MARKETS DSP','EMERGING MARKETS1','INVENTORY OPT EM','MSET EM DSP') OR a.CCC_RISK_MANAGER_LOGIN IN ('christeb','limaleo','portek','eliasc','pessoat','pintoand'))  AND a.ISSUER_COUNTRY_REGION ='LATAM'  AND a.USD_EQ_DELTA_DECOMP IS NOT NULL  GROUP BY a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP ORDER BY abs_nramv DESC ) , largestticker as ( SELECT a.cob_date ,a.issue_id_decomp ,a.TICKER_DECOMP, a.CCC_RISK_MANAGER_LOGIN ,a.PRODUCT_DESCRIPTION_DECOMP ,Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))  AS nramv ,Abs(Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) AS abs_nramv, RANK () OVER (PARTITION BY PRODUCT_DESCRIPTION_DECOMP ORDER BY ABS (SUM (COALESCE (USD_EQ_DELTA_DECOMP, 0))) DESC) AS ranked FROM CDWUSER.U_DECOMP_MSR a WHERE ( COB_DATE = '2018-02-28'  ) and  A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND  a.CCC_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' OR a.ccc_banking_trading IS NULL ) AND (a.CCC_STRATEGY_DETAILS in ('EMERGING MARKETS DSP','EMERGING MARKETS1','INVENTORY OPT EM','MSET EM DSP') OR a.CCC_RISK_MANAGER_LOGIN IN ('christeb','limaleo','portek','eliasc','pessoat','pintoand'))  AND a.ISSUER_COUNTRY_REGION ='LATAM'  AND a.USD_EQ_DELTA_DECOMP IS NOT NULL  GROUP BY a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP ,a.TICKER_DECOMP, a.CCC_RISK_MANAGER_LOGIN ),  largestRM as ( SELECT a.cob_date ,a.issue_id_decomp ,a.TICKER_DECOMP ,a.CCC_RISK_MANAGER_LOGIN ,a.PRODUCT_DESCRIPTION_DECOMP ,Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))  AS nramv ,Abs(Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) AS abs_nramv, RANK () OVER (PARTITION BY PRODUCT_DESCRIPTION_DECOMP ORDER BY ABS (SUM (COALESCE (USD_EQ_DELTA_DECOMP, 0))) DESC) AS ranked FROM CDWUSER.U_DECOMP_MSR a WHERE ( COB_DATE = '2018-02-28'  ) and  A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND   a.CCc_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' OR a.ccc_banking_trading IS NULL ) AND (a.CCC_STRATEGY_DETAILS in ('EMERGING MARKETS DSP','EMERGING MARKETS1','INVENTORY OPT EM','MSET EM DSP') OR a.CCC_RISK_MANAGER_LOGIN IN ('christeb','limaleo','portek','eliasc','pessoat','pintoand'))  AND a.ISSUER_COUNTRY_REGION ='LATAM'  AND a.USD_EQ_DELTA_DECOMP IS NOT NULL  GROUP BY a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP ,a.CCC_RISK_MANAGER_LOGIN ,a.TICKER_DECOMP )  SELECT x.ranked, X.PRODUCT_DESCRIPTION_DECOMP, X.nramv, X.nramv-Y.nramv as nramvchange, lt.TICKER_DECOMP, lm.CCC_RISK_MANAGER_LOGIN FROM DELTA X INNER JOIN deltacomp Y ON x.PRODUCT_DESCRIPTION_DECOMP=y.PRODUCT_DESCRIPTION_DECOMP and x.issue_id_decomp=y.issue_id_decomp INNER JOIN largestticker lt ON x.PRODUCT_DESCRIPTION_DECOMP = lt.PRODUCT_DESCRIPTION_DECOMP AND lt.ranked = 1 INNER JOIN largestRM lm ON X.PRODUCT_DESCRIPTION_DECOMP = lm.PRODUCT_DESCRIPTION_DECOMP AND lm.ranked = 1 order by x.ranked