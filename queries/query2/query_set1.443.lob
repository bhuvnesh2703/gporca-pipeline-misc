with x as  ( SELECT a.cob_date ,a.issue_id_decomp ,a.TICKER_DECOMP, a.CCC_RISK_MANAGER_LOGIN ,a.PRODUCT_DESCRIPTION_DECOMP ,Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))  AS nramv ,Abs(Sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) AS abs_nramv,  SUM (a.LIQUIDITY_days_DECOMP) AS liquidity_date FROM CDWUSER.U_DECOMP_MSR a WHERE ( COB_DATE = '2018-02-28'  ) and  A.CCC_PL_REPORTING_REGION in ('AMERICAS') AND  a.CCC_division IN ('INSTITUTIONAL EQUITY DIVISION') AND ( a.ccc_banking_trading <> 'BANKING' ) AND ( a.ccc_risk_manager_login IN ('eliasc') )  GROUP BY a.cob_date ,a.issue_id_decomp ,a.PRODUCT_DESCRIPTION_DECOMP ,a.TICKER_DECOMP,a.CCC_RISK_MANAGER_LOGIN order by abs_nramv desc ), snramv AS (SELECT x.PRODUCT_DESCRIPTION_DECOMP, x.TICKER_DECOMP, x.CCC_RISK_MANAGER_LOGIN, sum(coalesce(x.nramv,0)) as snramv, sum(coalesce(x.liquidity_date,0)) as s_liq_date, RANK () OVER (partition by product_description_decomp ORDER BY abs(sum(coalesce(x.nramv,0))) DESC) AS ranked FROM x where x.nramv<0 GROUP BY PRODUCT_DESCRIPTION_decomp, TICKER_DECOMP, CCC_RISK_MANAGER_LOGIN  ), snramv2 as (SELECT x.PRODUCT_DESCRIPTION_DECOMP, sum(coalesce(x.nramv,0)) as snramv, sum(coalesce(x.liquidity_date,0)) as s_liq_date FROM x where x.nramv<0 GROUP BY PRODUCT_DESCRIPTION_decomp )  SELECT snramv.product_description_decomp, snramv.ticker_decomp, snramv.CCC_RISK_MANAGER_LOGIN, snramv.s_LIQ_date, snramv2.snramv FROM snramv, snramv2 WHERE snramv.product_description_decomp=snramv2.product_description_decomp and snramv.snramv IS NOT NULL and snramv.ranked=1 order by abs(snramv2.snramv) desc fetch first 20 rows only