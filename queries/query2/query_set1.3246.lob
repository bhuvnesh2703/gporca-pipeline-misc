select a.*, b.Var95 as Var95_PrevCob, abs(a.Var95-b.Var95) as abs_daily_chg, abs(a.Var95-b.Var95)/a.Var95 as pct_daily_chg from ( select row_number() over (order by cob_date, coalesce(level2,'IED Total excl. Syndicate')) as row_id, cob_date, extract('year' from cob_date) ||' Q'|| extract('quarter' from cob_date) as quarter, extract('year' from cob_date) ||'-'|| lpad(extract('month' from cob_date),2,0) as month, level1, coalesce(level2,'IED Total excl. Syndicate') as level2, -var05 as Var95 from cdwuser.u_var_id_flat_view where hierarchy_group_name = 'EQUITY' and hierarchy_name = 'synd_region' and level1 = 'Ex-Syndicate' and (level2 is null or level3 is null) and cob_date >= '2015-02-02' ) a left join ( select row_number() over (order by cob_date, coalesce(level2,'IED Total excl. Syndicate')) as row_id, cob_date, extract('year' from cob_date) ||' Q'|| extract('quarter' from cob_date) as quarter, extract('year' from cob_date) ||'-'|| lpad(extract('month' from cob_date),2,0) as month, level1, coalesce(level2,'IED Total excl. Syndicate') as level2, -var05 as Var95 from cdwuser.u_var_id_flat_view where hierarchy_group_name = 'EQUITY' and hierarchy_name = 'synd_region' and level1 = 'Ex-Syndicate' and (level2 is null or level3 is null) and cob_date >= '2015-01-30' ) b on a.row_id = b.row_id and a.level2 = b.level2