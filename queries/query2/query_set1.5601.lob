SELECT X.Var_Inclusion, X.currency, X.term_months, X.BOOK, X.CCC_BUSINESS_AREA, X.COB_DATE, X.SPV01, X.TERM_BUCKET, X.STRATEGY, X.Term, SUM(X.usd_pv01::numeric(15,5)) AS usd_PV01 FROM ( SELECT Case when book in ('EULT' , 'RPOTO' , 'NYDI' , 'CT0101LIQ1' , 'TSTRP' , 'RPOAF' , 'RPOTP' , 'RPOTU' , 'TLGPP' , 'TSTHK') then 'Parent' when book in ('TSTJY') then 'Other Securities' when book in ('TSTLN' , 'TSTNY') then 'Parent' when book in ('TSTCY') then 'Funding Swaps' when book in ('TSTTK' , 'RWULT' , 'NYTU') then 'Parent' when book in ('EUG7' , 'EUC5' , 'EUIP' , 'EUIS' , 'EUIF' , 'EUPS' , 'EUTF' , 'INDMF' , 'LIABB' , 'TSBR1' , 'RPOCO' , 'RPOEQ' , 'RWILX' , 'RWIKX' , 'TBDAP' , 'TNSAP' , 'TNSLN' , 'TNSNY' , 'TSTDP' , 'TSTTO' , 'RWUIS' , 'RWUIP' , 'TMSSC' , 'NYN2' , 'NYCO') then 'Non Bank Subsidiary' when book in ('RPOCT' , 'TBSNY' , 'TTSNY') then 'US Bank overnight' when book in ('RPOHF' , 'RPOHH') then 'BDP Netting - Liquidity Out' when book in ('TBSHK' , 'EUFA' , 'EUGY' , 'EUKK' , 'EUUK' , 'PROJECT KARL' , 'TBSAP' , 'TBSLN' , 'TBSSG' , 'TDPSD' , 'TDPSG' , 'TSAGD' , 'TSBAG' , 'TZUMD' , 'RWUUK' , 'EUFA' , 'RWUFA' , 'EUPB' , 'EUO1' , 'RWUPB' , 'RWPO1' , 'RWPO2' , 'RWPO3' , 'MSBKD' , 'RWIBK') then 'Non-US Bank Subsidiaries' when book in ('China Bank Capital on Treasury 2 - CHCA2-CHCA2' , 'CHINA BANK CAPITAL ON TSY-CHCAP' , 'TBICD' , 'RWBIC' , 'TSGSP') then 'Inter Company Funding' when book in ('TSTPM') then 'Non-Bank Investment Portfolios' when book in ('CTFTB' , 'MMPDS' , 'TSTMM') then 'Other Securities' when book in ('EUHT' , 'LX' , 'NYKG' , 'NYKI' , 'NYN1' , 'RPOHE' , 'RPOKE' , 'TNYSL') then 'Spec Financing ISG' when book in ('TAPRZ' , 'TAPTY' , 'TATUY' , 'TAPTZ' , 'TAPUZ' , 'TAPSZ' , 'TAPUY') then 'MSAIL Assets' when book in ('RPOHB' , 'RPOHG') then 'BDP Netting - Liquidity In' when book in ('AEOUT' , 'BCDUT' , 'VNCDB' , 'UTCDS' , 'STRUCTURED CD') then 'Retail CDs / Institutional CDs' when book in ('MSDEP') then 'Third Party Deposit' when book in ('TAPBL' , 'TLNBL' , 'TSAGL' , 'TSGBL' , 'TZUML' , 'TBICL' , 'TNYBL') then 'Bank Loans' when book in ('TAPCP' , 'TNYCP') then 'Commercial Paper' when book in ('CFXEU' , 'CFXNA' , 'CT0101SWP' , 'CTF3' , 'CT0101SWP-LN' , 'CTF4' , 'CT0302SWP' , 'TLNFX' , 'TOMFS' , 'TSGFX' , 'TZUFX' , 'KRSWP' , 'CT1633SWP' , 'CTTK' , 'CTHK' , 'THKFX') then 'Funding Swaps' when book in ('TICIP' , 'TICMS') then 'IR Basis Swaps' when book in ('CTHKB' , 'CTSGB' , 'CTSGD') then 'Funding Swaps' when book in ('EUGS' , 'TAPSS' , 'TLNSS') then 'Specific Financing' when book in ('CT0302XE' , 'CT0101XE') then 'Funding Swaps' when book in ('CAEMR' , 'TKFVL' , 'TAEMR' , 'CAIRR' , 'TAIRR' , 'CBAGR' , 'TBAGR' , 'CEEMR' , 'TEEMR' , 'COMSN' , 'CSCPR' , 'CTHKR' , 'CTIRR' , 'TTIRR' , 'CTNUR' , 'CTTKR' , 'TSYFE' , 'TSYRT' , 'TKFVS' , 'CALLT' , 'CALTB' , 'LCALT' , 'LCATB' , 'TTIRP') then 'FRN FID' when book in ('TSYCALL' , 'TSYCSNLN') then 'Accrual Callable' when book in ('CTCNR' , 'MSMSR' , 'HKFAM' , 'HKFAP' , 'HKFAS') then 'FRN FID' when book in ('ASIA ELN SWAPS' , 'ELNLT' , 'NBFCE' , 'LN ELNLT' , 'LNFVO' , 'ASIA ELNLT' , 'MS DVA STRUCTURED NO' , 'MS STRUCTURED NOTES' , 'ISSUANCE FUNDING' , 'TCM_TNY' , 'CLIENT STRUCTURES' , 'EQTRE' , 'FVONY' , 'LN_ELNLT' , 'NY_ELNLT' , 'AP_CALLABLES' , 'MSF_CALLABLES' , 'MSF_CALLABLES_BRM' , 'NY_CALLABLES' , 'NY_CALLABLES_BRM') then 'FRN IED' when book in ('AEOEQ' , 'EQGRP') then 'IED non-FVO' when book in ('TDEBT' , 'LHRO1' , 'LHRO2') then 'ASC 815 Debt' when book in ('SWPIN' , 'SWPLH' , 'SUBIN' , 'SUBLH') then 'ASC 815 Hedges' when book in ('TDET4' , 'TDET7' , 'TDET8') then 'De-designated Debt' when book in ('AEO' , 'AEOCT' , 'AEOFF' , 'AEOTK' , 'SWPTR' , 'SUBTR') then 'Non-ASC 815 Hedges' when book in ('TSTON') then 'IR Basis Swaps' when book in ('TDET5') then 'Floating Rate' when book in ('AEONE') then 'Cross-Currency Swaps' when book in ('AEONF') then 'IR Basis Swaps' when book in ('AEOST') then 'Cross-Currency Swaps' when book in ('TAPOZ') then 'MSAIL OIS' when book in ('TST31' , 'TSTOH' , 'TST3F' , 'TSTCH' , 'TSTGB' , 'TSTOF' , 'TSTOL') then 'IR Basis Swaps' when book in ('TDET2') then 'Unhedged Fixed' when book in ('TDET6') then 'Floating Callable Debt' when book in ('TRPFD') then 'PP-E' when book in ('PRFEQ') then 'Preferred Stock' when book in ('CT0201SPT' , 'CT0201SPT2' , 'FXNYDFLTC' , 'RVKRW' , 'TOMCP' , 'TSYFX' , 'TYBRL' , 'TYCNY' , 'TYHDG' , 'TYKRW' , 'TYTWD' , 'TYWON' , 'HNKRW' , 'TSRUB' , 'CT1633SPT' , 'TYBIC' , 'CT0101SPT' , 'GLFX1' , 'ROBIC' , 'CT0302SPT' , 'CT0101SPT6262') then 'Reval Hedges' when book in ('CT0101FWD' , 'CT0101FWDP' , 'TYSJV') then 'CTA Hedges' when book in ('CTA_PRE_TAX') then 'CTA Assets' when book in ('TSTEU') then 'IR Basis Swaps' when book in ('AEOAP') then 'Cross-Currency Swaps' when book in ('TSFRA') then 'IR Basis Swaps' when book in ('TKFVM') then 'FRN FID' when book in ('TSHTM') then 'Non-Bank Investment Portfolios' when book in ('TSTSB') then 'IR Basis Swaps' when book in ('FPDFX' , 'FTDFX' , 'PFDFX') then 'Unhedged Fixed' when book in ('CT101GAAP') then 'Reval Hedges' when book in ('LN_MSMS' , 'TCM_BRL' , 'TCM_MSF' , 'TCM_MSF_CALL' , 'TCM_MSF_CALL_BRM' , 'TK_MSMS') then 'FRN IED' when book in ('TMSFH' , 'TMSFL' , 'TMSFN' , 'TMSFT') then 'FRN FID' when book in ('UNKNOWN') then 'Funding Swaps' when book in ('CMSFT' , 'CSTNT') then 'FRN FID' when book in ('SWOLH' , 'SUOLH') then 'ASC 815 Hedges' when book in ('SWOTR' , 'SUOTR') then 'Non-ASC 815 Hedges' when book in ('SWOIN' , 'SUOIN') then 'ASC 815 Hedges' when book in ('NY_TREASURY_STRUCTUR') then 'Retail CDs / Institutional CDs' when book in ('TAPZU') then 'MSAIL Assets' when book in ('CTA0101XE' , 'CTA0517XE') then 'CTA Hedges' when book in ('RPOGI' , 'RPOSE') then 'Non Bank Subsidiary' when book in ('TYGAS') then 'FRN FID' when book in ('VNCDP') then 'Retail CDs / Institutional CDs' when book in ('TSYS1' , 'TSYS2') then 'Reval Hedges' when book in ('TCALT' , 'TCATB') then 'FRN FID' when book in ('RPOAP') then 'Non Bank Subsidiary' when book in ('TBKLQ') then 'Non-US Bank Subsidiaries' when book in ('CT4391SPT') then 'Reval Hedges' when book in ('RPOBK') then 'Non Bank Subsidiary' when book in ('RWIKV') then 'Non-US Bank Subsidiaries' when book in ('CALFB' , 'CALFT' , 'CLNYA' , 'COMNY') then 'FRN FID' when book in ('FXLNDFLTC') then 'Funding Swaps' when book in ('RWIKB') then 'Non Bank Subsidiary' when book in ('CLLNA') then 'FRN FID' when book in ('CT7715SWP' , 'CT7714SWP' , 'CT7713SWP' , 'CT0870SWP' , 'CT0362SWP' , 'CT0101SWP-TK' , 'CT0101SWP-AP') then 'Funding Swaps' when book in ('TCM_SNOTES') then 'FRN IED' when book in ('CT') then 'Funding Swaps' when book in ('EUSF') then 'Non-US Bank Subsidiaries' when book in ('CTL3' , 'CTF2') then 'Funding Swaps' when book in ('RPOSV') then 'Non Bank Subsidiary' when book in ('CT3L' , 'CTBN' , 'CTS1' , 'CTZH' , 'FDNY' , 'REVL' , 'CTNY' , 'CTSKB') then 'Reval Hedges' when book in ('CTBIL' , 'CTCTA' , 'CTFW') then 'CTA Hedges' when book in ('FED') then 'Funding Swaps' when book in ('TYLON') then 'Bank Loans' when book in ('TDCLH') then 'ASC 815 Debt' when book in ('SWCLH' , 'SWCOH' , 'SWCIN') then 'ASC 815 Hedges' when book in ('SWCTR') then 'Non-ASC 815 Hedges' when book in ('CDHTA' , 'CDHTB') then 'FRN FID' when book in ('STRUCTURED CD NAM') then 'Retail CDs / Institutional CDs' when book in ('STRUCTURED NOTES EQUITY EUR' , 'STRUCTURED NOTES EQUITY JPN' , 'STRUCTURED NOTES EQUITY NAM' , 'STRUCTURED NOTES EQUITY NJA') then 'FRN IED' else 'Unmapped' end as STRATEGY, Case when term_months<'1.5' then '0-1M' when term_months<'3.5' then '1-3M' when term_months<'6.5' then '3-6M' when term_months<'9.5' then '6-9M' when term_months<'18' then '9-12M' when term_months<'30' then '1-2' when term_months<'42' then '2-3' when term_months<'65.5' then '3-5' when term_months<'90' then '5-7' when term_months<'132' then '7-10' when term_months<'210' then '10-15' when term_months<'270' then '15-20' when term_months<'330' then '20-25' when term_months<'420' then '25-30' when term_months<'540' then '30-40' else '40+' end as Term , a.BOOK, a.CCC_BUSINESS_AREA, a.COB_DATE, a.TERM_BUCKET, a.SPV01, a.Var_Inclusion, a.currency, a.term_months, a.usd_pv01 FROM ( Select cob_date, book, currency_code as currency, Case WHEN var_excl_fl ='Y' THEN 'Excluded' ELSE 'Included' END AS Var_Inclusion, CASE when vertical_system in ('C1_LN', 'C1_NY', 'FXDDI_MO', 'FXDDI_NY', 'FXDDITD_MO', 'FXDDITD_NY', 'STS_HK', 'STS_LN', 'STS_NY', 'STS_NYD', 'STS_SE', 'STS_TK', 'GWM_NY') then 12.*(VAL_FOR + VAL_IN) else 12.*term_of_measure/365 end as term_months, term_bucket, SUM(CASE when vertical_system in ('C1_LN', 'C1_NY', 'FXDDI_MO', 'FXDDI_NY', 'FXDDITD_MO', 'FXDDITD_NY', 'STS_HK', 'STS_LN', 'STS_NY', 'STS_NYD', 'STS_SE', 'STS_TK', 'GWM_NY') then GRID_MEASURE_VALUE else 0 end) as usd_pv01, CCC_BUSINESS_AREA, 0 as SPV01 FROM cdwuser.U_GRID_MSR where cob_date in ('2018-02-28', '2018-02-27') and ccc_division = 'TREASURY CAPITAL MARKETS' and GRID_MEASURE_NAME = 'USD_PV01' group by cob_date, book, currency_code, term_bucket, Case WHEN var_excl_fl ='Y' THEN 'Excluded' ELSE 'Included' END, CASE when vertical_system in ('C1_LN', 'C1_NY', 'FXDDI_MO', 'FXDDI_NY', 'FXDDITD_MO', 'FXDDITD_NY', 'STS_HK', 'STS_LN', 'STS_NY', 'STS_NYD', 'STS_SE', 'STS_TK', 'GWM_NY') then 12.*(VAL_FOR + VAL_IN) else 12.*term_of_measure/365 end, CCC_BUSINESS_AREA UNION ALL Select cob_date, book, currency_of_measure as currency, Case WHEN var_excl_fl ='Y' THEN 'Excluded' ELSE 'Included' END AS Var_Inclusion, 12.*term_of_measure/365 as term_months, term_bucket, sum(usd_ir_unified_pv01) as usd_pv01, CCC_BUSINESS_AREA, 0 as SPV01 FROM cdwuser.U_IR_MSR where cob_date in ('2018-02-28', '2018-02-27') and ccc_division = 'TREASURY CAPITAL MARKETS' and not (vertical_system in ('C1_LN', 'C1_NY', 'FXDDI_MO', 'FXDDI_NY', 'FXDDITD_MO', 'FXDDITD_NY', 'STS_HK', 'STS_LN', 'STS_NY', 'STS_NYD', 'STS_SE', 'STS_TK', 'GWM_NY')) group by cob_date, book, currency_of_measure, term_bucket, Case WHEN var_excl_fl ='Y' THEN 'Excluded' ELSE 'Included' END, 12.*term_of_measure/365, CCC_BUSINESS_AREA ) a ) x GROUP BY X.Var_Inclusion, X.currency, X.term_months, X.BOOK, X.CCC_BUSINESS_AREA, X.COB_DATE, X.SPV01, X.TERM_BUCKET, X.STRATEGY, X.Term