SELECT T.COB_DATE , T.LE , CASE WHEN T.MRD_RATING NOT IN ('AAA', 'AA', 'A', 'BBB', 'BB') THEN 'B AND LOWER' ELSE T.MRD_RATING END AS RATING , case when T.PRODUCT_TYPE_CODE in ('CVA','FVA') and T.LE in ('MSCS') then 'XVA' ELSE PRODUCT_TYPE_CODE END AS PRODUCT_TYPE_CODE , T.CCC_BUSINESS_AREA ,T.CCC_PRODUCT_LINE ,CASE WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA = 'CREDIT-CORPORATES' AND T.CCC_PRODUCT_LINE NOT IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') AND T.FID1_SENIORITY <> 'AT1' THEN 'CREDIT_CORP' WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA IN ('STRUCTURED RATES') THEN 'STRUCTURED_RATES' WHEN T.LE in ('MSCO') and T.CCC_DIVISION IN ('FIXED INCOME DIVISION') AND T.CCC_STRATEGY IN ('US AGENCIES','AGENCY DEBT TRADING') THEN 'AGN' WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA = 'LENDING' OR T.CCC_PRODUCT_LINE IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') THEN 'LENDING' WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA = 'MUNICIPAL SECURITIES' THEN 'MUNI' WHEN T.LE in ('MSCS') and T.ccc_business_area = 'CREDIT-CORPORATES' AND T.ccc_product_line NOT IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') AND T.fid1_seniority <> 'AT1' THEN 'CREDIT_CORP' WHEN T.LE in ('MSCS') and T.ccc_business_area IN ('LIQUID FLOW RATES', 'STRUCTURED RATES') THEN 'INTEREST_RATES' WHEN T.LE in ('MSCS') and T.ccc_business_area = 'LENDING' OR T.ccc_product_line IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') THEN 'LENDING' ELSE 'OTHER' END AS BUSI3 , SUM(CASE WHEN T.PRODUCT_TYPE_CODE IN ('BONDFUT', 'CASH', 'REPO') OR T.CCC_STRATEGY IN ('MS DVA - STR NOTES', 'FID SN DVA - FXEM', 'FID SN DVA - CDP', 'COM SN DVA', 'FID OTHER FVO DVA', 'FID SN DVA - IR') THEN 0 WHEN (T.CCC_STRATEGY = 'DISTRESSED TRADING1' AND T.PRODUCT_TYPE_CODE = 'TRRSWAP') THEN (COALESCE(T.USD_PV10_BENCH, 0)) ELSE (COALESCE(T.USD_PV10_BENCH, 0) + COALESCE(T.PV10_SYNTHETIC2, 0)) END) AS BPV10 FROM ( SELECT D.* , CASE WHEN (D.VAR_EXCL_FL = 'N' AND D.VERTICAL_SYSTEM NOT LIKE 'STS_%') OR (D.VAR_EXCL_FL = 'N' AND D.PRODUCT_TYPE_CODE = 'SWAPIL') OR (D.USD_PV10_BENCH IS NOT NULL) THEN 0 ELSE COALESCE(D.USD_PV01SPRD, 0) * 0.1 * (CASE WHEN D.CREDIT_SPREAD <=0 THEN 0 ELSE D.CREDIT_SPREAD END) END AS PV10_SYNTHETIC2 , CASE WHEN D.CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN D.CCC_TAPS_COMPANY IN ('0111') THEN 'MSCS' WHEN D.CCC_TAPS_COMPANY IN ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') THEN 'MSCGI' WHEN D.CCC_TAPS_COMPANY IN ('0146') THEN 'MSDP' WHEN D.CCC_TAPS_COMPANY IN ('5745') THEN 'MSCAP' ELSE D.CCC_TAPS_COMPANY END AS LE FROM ( SELECT A.DIVISION_GROUP ,A.CCC_TAPS_COMPANY ,A.CCC_DIVISION ,A.CCC_BUSINESS_AREA ,A.CCC_PRODUCT_LINE ,A.CCC_STRATEGY ,A.COB_DATE , A.MRD_RATING ,A.MARKET_DATA_SET_ID , A.PRODUCT_DESCRIPTION ,A.VERTICAL_SYSTEM ,A.VAR_EXCL_FL ,A.PRODUCT_TYPE_CODE ,A.FID1_SENIORITY ,SUM(USD_PV10_SYNTHETIC) AS USD_PV10_SYNTHETIC ,SUM(A.USD_PV10_BENCH) AS USD_PV10_BENCH ,SUM(A.USD_PV01SPRD) USD_PV01SPRD ,MIN(A.CREDIT_SPREAD) CREDIT_SPREAD FROM CDWUSER.U_CR_MSR A WHERE a.cob_date in ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND A.VAR_EXCL_FL = 'N' AND A.VERTICAL_SYSTEM NOT LIKE 'PIPELINE%' AND A.ISSUER_COUNTRY_TIER = '1' AND (A.CREDIT_TYPE_CD = 'CREDIT-CORP_T1T2' OR A.CCC_PRODUCT_LINE IN ('PRIMARY - BONDS')) AND A.DIVISION_GROUP <> 'TREASURY' AND A.CCC_DIVISION NOT IN ('FIC OTHER', 'FIC DVA','FID DVA', 'MGD FUTURES', 'WM CAPITAL MARKETS') AND A.CCC_BUSINESS_AREA NOT IN ('GLOBAL STRUCT PRODUCTS') AND A.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME NOT IN ('FEDERAL FARM CREDIT BANK', 'FEDERAL FARM CREDIT BANKS FUNDING CORPORATION', 'FEDERAL HOME LOAN BANK SYSTEM', 'FEDERAL HOME LOAN MORTGAGE CORPORATION','FEDERAL NATIONAL MORTGAGE ASSOCIATION') GROUP BY A.DIVISION_GROUP ,A.CCC_TAPS_COMPANY ,A.CCC_DIVISION ,A.CCC_BUSINESS_AREA ,A.CCC_PRODUCT_LINE ,A.CCC_STRATEGY ,A.COB_DATE , A.MRD_RATING ,A.MARKET_DATA_SET_ID , A.PRODUCT_DESCRIPTION ,A.VERTICAL_SYSTEM ,A.VAR_EXCL_FL ,A.PRODUCT_TYPE_CODE ,A.FID1_SENIORITY UNION SELECT B.DIVISION_GROUP ,B.CCC_TAPS_COMPANY ,B.CCC_DIVISION ,B.CCC_BUSINESS_AREA ,B.CCC_PRODUCT_LINE ,B.CCC_STRATEGY ,B.COB_DATE ,B.MRD_RATING ,B.MARKET_DATA_SET_ID ,B.PRODUCT_DESCRIPTION ,B.VERTICAL_SYSTEM ,B.VAR_EXCL_FL ,B.PRODUCT_TYPE_CODE ,B.FID1_SENIORITY ,SUM(B.USD_PV10_SYNTHETIC) AS USD_PV10_SYNTHETIC ,SUM(CASE WHEN B.PRODUCT_TYPE_CODE IN ('ASCOT', 'CONVRT') THEN COALESCE(USD_CREDIT_PV10PCT, 0) ELSE 0 END) AS USD_PV10_BENCH ,0 AS USD_PV01SPRD ,0 AS CREDIT_SPREAD FROM CDWUSER.U_CR_MSR B INNER JOIN CDWUSER.U_IED_POSITION C ON B.COB_DATE = C.COB_DATE AND B.PROCESS_ID = C.PROCESS_ID AND B.POSITION_ID = C.POSITION_ID WHERE B.cob_date in ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND B.CCC_DIVISION IN ('COMMODITIES', 'INT RATE CREDIT CURRENCY', 'FIXED INCOME DIVISION', 'NON CORE', 'INSTITUTIONAL EQUITY DIVISION') AND B.SILO_SRC = 'IED' AND C.PRODUCT_TYPE_CODE IN ('ASCOT', 'CONVRT') AND C.PRODUCT_LEVEL = 'POS' AND B.VERTICAL_SYSTEM not like 'PIPELINE%' AND B.VAR_EXCL_FL <> 'Y' AND B.ISSUER_COUNTRY_TIER = '1' AND (B.CREDIT_TYPE_CD = 'CREDIT-CORP_T1T2' OR B.CCC_PRODUCT_LINE IN ('PRIMARY - BONDS')) AND B.DIVISION_GROUP <> 'TREASURY' AND B.CCC_DIVISION NOT IN ('FIC OTHER', 'FIC DVA','FID DVA', 'MGD FUTURES', 'WM CAPITAL MARKETS') AND B.CCC_BUSINESS_AREA NOT IN ('GLOBAL STRUCT PRODUCTS') AND B.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME NOT IN ('FEDERAL FARM CREDIT BANK', 'FEDERAL FARM CREDIT BANKS FUNDING CORPORATION', 'FEDERAL HOME LOAN BANK SYSTEM', 'FEDERAL HOME LOAN MORTGAGE CORPORATION','FEDERAL NATIONAL MORTGAGE ASSOCIATION') GROUP BY B.DIVISION_GROUP ,B.CCC_TAPS_COMPANY ,B.CCC_DIVISION ,B.CCC_BUSINESS_AREA ,B.CCC_PRODUCT_LINE ,B.CCC_STRATEGY ,B.COB_DATE ,B.MRD_RATING ,B.MARKET_DATA_SET_ID ,B.PRODUCT_DESCRIPTION ,B.VERTICAL_SYSTEM ,B.VAR_EXCL_FL ,B.PRODUCT_TYPE_CODE ,B.FID1_SENIORITY ) D ) T WHERE T.COB_DATE IN ('03/31/2017','04/28/2017','05/31/2017','06/30/2017','07/31/2017','08/31/2017','09/29/2017','10/31/2017','11/30/2017','12/29/2017','01/31/2018','02/28/2018') AND T.CCC_TAPS_COMPANY IN ( '0201','0103','0205','0206','0530','5924','0111','5745','0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609','5745') AND T.CCC_BUSINESS_AREA NOT LIKE 'CPM%' GROUP BY T.COB_DATE , T.LE , CASE WHEN T.MRD_RATING NOT IN ('AAA', 'AA', 'A', 'BBB', 'BB') THEN 'B AND LOWER' ELSE T.MRD_RATING END , T.PRODUCT_TYPE_CODE , T.CCC_BUSINESS_AREA ,T.CCC_PRODUCT_LINE ,CASE WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA = 'CREDIT-CORPORATES' AND T.CCC_PRODUCT_LINE NOT IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') AND T.FID1_SENIORITY <> 'AT1' THEN 'CREDIT_CORP' WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA IN ('STRUCTURED RATES') THEN 'STRUCTURED_RATES' WHEN T.LE in ('MSCO') and T.CCC_DIVISION IN ('FIXED INCOME DIVISION') AND T.CCC_STRATEGY IN ('US AGENCIES','AGENCY DEBT TRADING') THEN 'AGN' WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA = 'LENDING' OR T.CCC_PRODUCT_LINE IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') THEN 'LENDING' WHEN T.LE in ('MSCO') and T.CCC_BUSINESS_AREA = 'MUNICIPAL SECURITIES' THEN 'MUNI' WHEN T.LE in ('MSCS') and T.ccc_business_area = 'CREDIT-CORPORATES' AND T.ccc_product_line NOT IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') AND T.fid1_seniority <> 'AT1' THEN 'CREDIT_CORP' WHEN T.LE in ('MSCS') and T.ccc_business_area IN ('LIQUID FLOW RATES', 'STRUCTURED RATES') THEN 'INTEREST_RATES' WHEN T.LE in ('MSCS') and T.ccc_business_area = 'LENDING' OR T.ccc_product_line IN ('PRIMARY - BONDS','PRIMARY - IG BONDS','PRIMARY - NIG BONDS') THEN 'LENDING' ELSE 'OTHER' END