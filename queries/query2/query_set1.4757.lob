SELECT * FROM ( SELECT COB_DATE, ISSUER_COUNTRY_CODE_DECOMP, CCC_PRODUCT_LINE, LE, USD_EQ_DELTA_DECOMP, DENSE_RANK() OVER(PARTITION BY CCC_PRODUCT_LINE ORDER BY SUM_1 - SUM_2 DESC ) RANK FROM ( SELECT COB_DATE, ISSUER_COUNTRY_CODE_DECOMP, CCC_PRODUCT_LINE, LE, USD_EQ_DELTA_DECOMP, SUM(ABS(coalesce(USD_EQ_DELTA_CURRENT,0))) OVER(PARTITION BY CCC_PRODUCT_LINE,ISSUER_COUNTRY_CODE_DECOMP) SUM_1, ABS(SUM(coalesce(USD_EQ_DELTA_CURRENT,0)) OVER(PARTITION BY CCC_PRODUCT_LINE,ISSUER_COUNTRY_CODE_DECOMP)) SUM_2 FROM ( select A.COB_DATE, A.ISSUER_COUNTRY_CODE_DECOMP, A.CCC_PRODUCT_LINE, CASE WHEN A.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') THEN 'MSCO' WHEN A.PARENT_LEGAL_ENTITY IN ('0302(G)') THEN 'MSIP' ELSE A.CCC_TAPS_COMPANY END AS LE, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0)) AS USD_EQ_DELTA_DECOMP, sum(CASE WHEN a.COB_DATE = '2018-02-28' THEN coalesce(a.USD_EQ_DELTA_DECOMP,0) END) AS USD_EQ_DELTA_CURRENT FROM cdwuser.U_DECOMP_MSR A where a.cob_date >= '2018-02-14' and a.cob_date <= '2018-02-28' AND ( a.CCC_TAPS_COMPANY IN ('0201','0103','0205','0206','0530','5924') or A.PARENT_LEGAL_ENTITY IN ('0302(G)') ) and a.CCC_PL_REPORTING_REGION = 'AMERICAS' and a.CCC_PRODUCT_LINE in ('EXOTIC PRODUCTS','INDEX PRODUCTS') GROUP BY A.COB_DATE, A.ISSUER_COUNTRY_CODE_DECOMP, A.CCC_PRODUCT_LINE, LE ) A ) B ) C WHERE RANK <= 4