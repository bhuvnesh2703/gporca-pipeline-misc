WITH EQ_SN_SLIDES AS( SELECT a.UNDERLIER_PRODUCT_DESCRIPTION, SUM (COALESCE (a.SLIDE_EQ_MIN_30_USD, 0)) AS SLIDE_EQ_MIN_30_USD, SUM (COALESCE (a.SLIDE_EQ_MIN_20_USD, 0)) AS SLIDE_EQ_MIN_20_USD, SUM (COALESCE (a.SLIDE_EQ_MIN_10_USD, 0)) AS SLIDE_EQ_MIN_10_USD, SUM (COALESCE (a.SLIDE_EQ_MIN_05_USD, 0)) AS SLIDE_EQ_MIN_05_USD, SUM (COALESCE (a.SLIDE_EQ_PLS_05_USD, 0)) AS SLIDE_EQ_PLS_05_USD, SUM (COALESCE (a.SLIDE_EQ_PLS_10_USD, 0)) AS SLIDE_EQ_PLS_10_USD, SUM (COALESCE (a.SLIDE_EQ_PLS_20_USD, 0)) AS SLIDE_EQ_PLS_20_USD FROM CDWUSER.U_EQ_MSR a WHERE a.COB_DATE ='2018-02-28' AND a.BOOK = 'ETP' AND a.EXECUTIVE_MODEL IN ('MINIFUTURECERTIFICATE', 'CONSTANTLEVERAGECERTIFICATE', 'DELTAONECERTIFICATE', 'OPENENDEDTURBOCERTIFICATE') AND a.MRD_ASSET_CLASS = 'EQ' AND a.CASH_ISSUE_TYPE = 'STOCK' AND a.CASH_ISSUE_TYPE <> 'CMDT' AND a.CCC_BOOK_DETAIL NOT IN ('DE_EQUITY', 'DE_INDEX') GROUP BY a.UNDERLIER_PRODUCT_DESCRIPTION UNION ALL SELECT a.UNDERLIER_PRODUCT_DESCRIPTION, SUM (COALESCE (a.SLIDE_EQ_MIN_30_USD, 0)) AS SLIDE_EQ_MIN_30_USD, SUM (COALESCE (a.SLIDE_EQ_MIN_20_USD, 0)) AS SLIDE_EQ_MIN_20_USD, SUM (COALESCE (a.SLIDE_EQ_MIN_10_USD, 0)) AS SLIDE_EQ_MIN_10_USD, SUM (COALESCE (a.SLIDE_EQ_MIN_05_USD, 0)) AS SLIDE_EQ_MIN_05_USD, SUM (COALESCE (a.SLIDE_EQ_PLS_05_USD, 0)) AS SLIDE_EQ_PLS_05_USD, SUM (COALESCE (a.SLIDE_EQ_PLS_10_USD, 0)) AS SLIDE_EQ_PLS_10_USD, SUM (COALESCE (a.SLIDE_EQ_PLS_20_USD, 0)) AS SLIDE_EQ_PLS_20_USD FROM CDWUSER.U_EQ_MSR a WHERE a.COB_DATE ='2018-02-28' AND a.BOOK = 'ETP' AND a.EXECUTIVE_MODEL NOT IN ('MINIFUTURECERTIFICATE', 'CONSTANTLEVERAGECERTIFICATE', 'DELTAONECERTIFICATE', 'OPENENDEDTURBOCERTIFICATE') AND a.MRD_ASSET_CLASS = 'EQ' AND a.CASH_ISSUE_TYPE = 'STOCK' AND a.CASH_ISSUE_TYPE <> 'CMDT' AND a.CCC_BOOK_DETAIL <> 'DSP ETP INDEX' AND a.CCC_BOOK_DETAIL NOT IN ('DE_EQUITY', 'DE_INDEX', 'DE_BASKET') GROUP BY a.UNDERLIER_PRODUCT_DESCRIPTION ) SELECT a.UNDERLIER_PRODUCT_DESCRIPTION, SLIDE_EQ_MIN_30_USD, SLIDE_EQ_MIN_20_USD, SLIDE_EQ_MIN_10_USD, SLIDE_EQ_MIN_05_USD, SLIDE_EQ_PLS_05_USD, SLIDE_EQ_PLS_10_USD, SLIDE_EQ_PLS_20_USD, RANK() OVER(ORDER BY SLIDES_MIN ASC) AS RANK FROM ( SELECT a.UNDERLIER_PRODUCT_DESCRIPTION, SUM(SLIDE_EQ_MIN_30_USD) AS SLIDE_EQ_MIN_30_USD, SUM(SLIDE_EQ_MIN_20_USD) AS SLIDE_EQ_MIN_20_USD, SUM(SLIDE_EQ_MIN_10_USD) AS SLIDE_EQ_MIN_10_USD, SUM(SLIDE_EQ_MIN_05_USD) AS SLIDE_EQ_MIN_05_USD, SUM(SLIDE_EQ_PLS_05_USD) AS SLIDE_EQ_PLS_05_USD, SUM(SLIDE_EQ_PLS_10_USD) AS SLIDE_EQ_PLS_10_USD, SUM(SLIDE_EQ_PLS_20_USD) AS SLIDE_EQ_PLS_20_USD, LEAST(SUM(SLIDE_EQ_MIN_30_USD), SUM(SLIDE_EQ_MIN_20_USD), SUM(SLIDE_EQ_MIN_10_USD), SUM(SLIDE_EQ_MIN_05_USD), SUM(SLIDE_EQ_PLS_05_USD), SUM(SLIDE_EQ_PLS_10_USD), SUM(SLIDE_EQ_PLS_20_USD)) AS SLIDES_MIN FROM EQ_SN_SLIDES a GROUP BY a.UNDERLIER_PRODUCT_DESCRIPTION ) a