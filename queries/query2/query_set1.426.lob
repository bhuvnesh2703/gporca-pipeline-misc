SELECT*FROM( SELECT B.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME,rating2, B.net_exp, RANK() OVER (PARTITION BY rating2 ORDER BY B.net_exp DESC) AS RANKS FROM(SELECT a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, (CASE WHEN a.MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG' ELSE 'NIG' END) as rating2, sum(COALESCE (a.USD_EXPOSURE,0)) as net_exp FROM CDWUSER.U_EXP_MSR a where COB_DATE='2018-02-28' AND A.CCC_DIVISION='INSTITUTIONAL EQUITY DIVISION' AND A.CCC_BANKING_TRADING='TRADING' AND A.ISSUER_COUNTRY_CODE='BRA' AND CCC_BUSINESS_AREA NOT LIKE '%CPM%' AND A.USD_EXPOSURE IS NOT NULL GROUP BY A.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, (CASE WHEN A.MRD_RATING IN ('AAA','AA','A','BBB') THEN 'IG' ELSE 'NIG' END) ) B) C WHERE C.RANKS<4