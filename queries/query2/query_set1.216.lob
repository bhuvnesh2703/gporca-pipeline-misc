WITH ALL_MSMS_EQ_DELTA AS (     SELECT         a.COB_DATE,         a.CCC_PL_REPORTING_REGION,         a.CCC_BUSINESS_AREA,         a.CCC_PRODUCT_LINE,         a.CCC_STRATEGY,         a.CCC_RISK_MANAGER_LOGIN,         a.CCC_BANKING_TRADING,         a.LIQUIDITY_DAYS_DECOMP,         a.ISSUE_ID_DECOMP,         a.ISSUER_COUNTRY_CODE_DECOMP,         a.PRODUCT_DESCRIPTION_DECOMP,         a.TICKER_DECOMP,         a.EXCHANGE_DECOMP,         SUM (a.USD_EQ_DELTA_DECOMP) AS USD_EQ_DELTA,         SUM (a.LIQUIDITY_DAYS_DECOMP) AS liquidity_days     FROM         CDWUSER.U_DECOMP_MSR a     WHERE         1 = 1 AND (a.COB_DATE = '2018-02-28' or a.COB_DATE = '2018-02-27') and A.CCC_TAPS_COMPANY in ('1050') AND          (a.ccc_business_area <> 'INTERNATIONAL WEALTH MGMT') AND         a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND         a.USD_EQ_DELTA_DECOMP IS NOT NULL AND         CCC_BANKING_TRADING = 'TRADING'     GROUP BY         a.COB_DATE,         a.CCC_PL_REPORTING_REGION,         a.CCC_BUSINESS_AREA,         a.CCC_PRODUCT_LINE,         a.CCC_STRATEGY,         a.CCC_RISK_MANAGER_LOGIN,         a.CCC_BANKING_TRADING,         a.LIQUIDITY_DAYS_DECOMP,         a.ISSUE_ID_DECOMP,         a.ISSUER_COUNTRY_CODE_DECOMP,         a.PRODUCT_DESCRIPTION_DECOMP,         a.TICKER_DECOMP,         a.EXCHANGE_DECOMP         HAVING SUM (a.USD_EQ_DELTA_DECOMP) <> 0 ), EQ_ISSUE AS (     SELECT         COB_DATE,         ISSUE_ID_DECOMP,         PRODUCT_DESCRIPTION_DECOMP,         SUM (USD_EQ_DELTA) AS USD_EQ_DELTA     FROM         ALL_MSMS_EQ_DELTA     GROUP BY         COB_DATE,         ISSUE_ID_DECOMP,         PRODUCT_DESCRIPTION_DECOMP ), EQ_DELTA_ADJUST_BY_ISSUE (     COB_DATE,     ISSUE_ID_DECOMP,     ISSUER_COUNTRY_CODE_DECOMP,     USD_EQ_DELTA,     LIQUIDITY_DAYS ) AS (VALUES ( '2015-5-22', 'GAX19LNK3203', 'JPN', 61000.0, 4.1592) ), EQ_DELTA_BY_RAW AS (     SELECT         COB_DATE,         ISSUE_ID_DECOMP,         ISSUER_COUNTRY_CODE_DECOMP,         USD_EQ_DELTA,         LIQUIDITY_DAYS     FROM         ALL_MSMS_EQ_DELTA     WHERE 1 = 1 ), EQ_DELTA_BY_ISSUE AS (     SELECT         COB_DATE,         ISSUE_ID_DECOMP,         ISSUER_COUNTRY_CODE_DECOMP,         SUM (USD_EQ_DELTA) AS USD_EQ_DELTA,         SUM (LIQUIDITY_DAYS) AS LIQUIDITY_DAYS     FROM EQ_DELTA_BY_RAW         WHERE 1 = 1     GROUP BY         COB_DATE,         ISSUE_ID_DECOMP,         ISSUER_COUNTRY_CODE_DECOMP ), EQ_NET_GROSS_DELTA AS (     SELECT         COB_DATE,         ISSUER_COUNTRY_CODE_DECOMP,         SUM (USD_EQ_DELTA) AS USD_EQ_DELTA,         SUM (CASE             WHEN USD_EQ_DELTA < 0 THEN - 1 * USD_EQ_DELTA         ELSE USD_EQ_DELTA END) AS USD_GROSS_DELTA     FROM         EQ_DELTA_BY_ISSUE     GROUP BY         COB_DATE,         ISSUER_COUNTRY_CODE_DECOMP ), EQ_DELTA_RANKED AS (     SELECT         COB_DATE,         ISSUE_ID_DECOMP,         SUM (USD_EQ_DELTA) AS USD_EQ_DELTA,         RANK () OVER (             PARTITION BY                 COB_DATE             ORDER BY ABS (SUM (USD_EQ_DELTA)) DESC) AS EQ_DELTA_RANK     FROM         EQ_DELTA_BY_RAW     GROUP BY         COB_DATE,         ISSUE_ID_DECOMP ), EQ_DELTA_RISKMGR_RANKED AS (     SELECT         COB_DATE,         ISSUE_ID_DECOMP,         CCC_RISK_MANAGER_LOGIN,         SUM (USD_EQ_DELTA) AS USD_EQ_DELTA,         RANK () OVER (             PARTITION BY                 COB_DATE,                 ISSUE_ID_DECOMP             ORDER BY ABS (SUM (USD_EQ_DELTA)) DESC) AS EQ_ISSUE_RISKMGR_RANK     FROM         all_msms_eq_delta     WHERE         1 = 1     GROUP BY         COB_DATE,         ISSUE_ID_DECOMP,         CCC_RISK_MANAGER_LOGIN ), EQ_TOP_CONC AS (     SELECT         a.COB_DATE,         a.issue_id_decomp,         d.PRODUCT_DESCRIPTION_DECOMP,         a.ISSUER_COUNTRY_CODE_DECOMP,         b.eq_delta_rank,         c.ccc_risk_manager_login,         c.eq_issue_riskmgr_rank,         a.usd_eq_delta,         a.liquidity_days     FROM         EQ_DELTA_BY_ISSUE a,         EQ_DELTA_RANKED b,         EQ_DELTA_RISKMGR_RANKED c,         EQ_ISSUE d     WHERE         1 = 1 AND         a.ISSUE_ID_DECOMP = b.ISSUE_ID_DECOMP AND         a.issue_id_decomp = c.issue_id_decomp AND         a.issue_id_decomp = d.issue_id_decomp AND b.COB_DATE = '2018-02-28' and         c.COB_DATE = b.COB_DATE AND         a.cob_date = d.cob_date AND         b.EQ_DELTA_RANK <= 15 AND         c.EQ_ISSUE_RISKMGR_RANK = 1     ORDER BY         cob_date DESC,         eq_delta_rank ASC ) SELECT     * FROM     EQ_TOP_CONC