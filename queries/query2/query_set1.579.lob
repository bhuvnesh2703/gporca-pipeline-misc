With x as ( SELECT FLAG_SECTOR, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN ABS_USD_EXPOSURE ELSE 0 END) AS COB_GROSS, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN ABS_USD_EXPOSURE ELSE 0 END) AS PREV_GROSS, SUM(CASE WHEN COB_DATE = '2018-02-28' THEN USD_EXPOSURE ELSE 0 END) AS COB_NET, SUM(CASE WHEN COB_DATE = '2018-02-27' THEN USD_EXPOSURE ELSE 0 END) AS PREV_NET FROM ( SELECT COB_DATE, FLAG_SECTOR, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, sum(USD_EXPOSURE) as USD_EXPOSURE, sum(ABS_USD_EXPOSURE) as ABS_USD_EXPOSURE FROM ( SELECT a.COB_DATE, CASE WHEN (a.GICS_LEVEL_1_NAME = 'FINANCIALS' and book not in ('IGFIN') AND a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME NOT IN ('GAS NATURAL SDG, S.A.','AT SECURITIES B.V.')) THEN 'FINANCIALS' WHEN (a.GICS_LEVEL_1_NAME = 'FINANCIALS' and book in ('IGFIN')) THEN 'EXCL' ELSE 'CORPORATES' END AS FLAG_SECTOR, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.TAPSCUSIP, sum(coalesce(a.USD_EXPOSURE,0))/1000 as USD_EXPOSURE, abs(sum(coalesce(a.USD_EXPOSURE,0)))/1000 as ABS_USD_EXPOSURE FROM cdwuser.U_EXP_MSR a WHERE a.COB_DATE >= '2018-02-27' AND a.CCC_DIVISION = 'FIXED INCOME DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.CCC_PRODUCT_LINE NOT IN ('DISTRESSED TRADING') AND a.PRODUCT_TYPE_CODE IN ('BOND','BONDFUT','BONDFUTOPT','BONDIL','BONDOPT','PREF') AND a.FID1_SENIORITY IN ('AT1','SUBT1','SUBUT2') AND a.USD_EXPOSURE <> 0 AND a.CCC_TAPS_COMPANY = '0302' GROUP BY a.COB_DATE, CASE WHEN (a.GICS_LEVEL_1_NAME = 'FINANCIALS' and book not in ('IGFIN') AND a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME NOT IN ('GAS NATURAL SDG, S.A.','AT SECURITIES B.V.')) THEN 'FINANCIALS' WHEN (a.GICS_LEVEL_1_NAME = 'FINANCIALS' and book in ('IGFIN')) THEN 'EXCL' ELSE 'CORPORATES' END, a.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, a.TAPSCUSIP ) x GROUP BY COB_DATE, FLAG_SECTOR, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME ) y GROUP BY FLAG_SECTOR, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME ) SELECT FLAG_SECTOR, RANK() OVER (PARTITION BY FLAG_SECTOR ORDER BY COB_GROSS DESC) as RANK, POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, COB_GROSS, PREV_GROSS, COB_NET, PREV_NET FROM x