WITH RM_RANKING AS ( SELECT A.*, row_number() OVER ( ORDER BY DELTA ) AS ranking from ( SELECT a.CCC_RISK_MANAGER_LOGIN, sum(a.usd_delta) AS DELTA FROM CDWUSER.U_IED_VIEW a WHERE a.COB_DATE IN ('2018-2-28') AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.ccc_PL_REPORTING_REGION IN ('AMERICAS') AND a.CCC_BUSINESS_AREA = 'DERIVATIVES' AND a.SLIDE_MIN_10_USD IS NOT NULL AND a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1- 1) = 'C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size < 0 AND a.EXCH <> 'OTC' GROUP BY CCC_RISK_MANAGER_LOGIN ORDER BY abs(sum(a.usd_delta)) DESC ) A ) SELECT a.COB_DATE, a.CCC_RISK_MANAGER_LOGIN, b.ranking, CASE WHEN (a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1-1)='C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size>0) THEN 'Early Exercise Long' WHEN (a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1-1)='C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size<0 AND a.EXCH = 'OTC') THEN 'Early Exercise Short OTC' WHEN (a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1-1)='C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size<0) THEN 'Early Exercise Short Listed' WHEN a.EXPIRATION_DATE <= '2018-2-15' THEN 'Expiring before Friday' WHEN a.EXPIRATION_DATE <= '2018-2-16' THEN 'Expiring Friday' ELSE 'Other' END AS TYPE_FLAG, SUM(a.SLIDE_MIN_05_USD +a.USD_DELTA*.05)/1000 AS D05_Adj, SUM(a.SLIDE_MIN_10_USD +a.USD_DELTA*.1)/1000 AS D10_Adj, SUM(a.SLIDE_MIN_20_USD +a.USD_DELTA*.2)/1000 AS D20_Adj, SUM(a.SLIDE_MIN_30_USD +a.USD_DELTA*.3)/1000 AS D30_Adj FROM CDWUSER.U_IED_VIEW a LEFT JOIN RM_RANKING b ON a.CCC_RISK_MANAGER_LOGIN = b.CCC_RISK_MANAGER_LOGIN WHERE a.COB_DATE IN ('2018-2-28') AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.CCC_BANKING_TRADING = 'TRADING' AND a.ccc_PL_REPORTING_REGION IN ('AMERICAS') AND a.CCC_BUSINESS_AREA = 'DERIVATIVES' AND a.SLIDE_MIN_10_USD IS NOT NULL GROUP BY a.COB_DATE, a.CCC_RISK_MANAGER_LOGIN, b.ranking, CASE WHEN (a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1-1)='C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size>0) THEN 'Early Exercise Long' WHEN (a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1-1)='C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size<0 AND a.EXCH = 'OTC') THEN 'Early Exercise Short OTC' WHEN (a.UNDERLIER_TICK = 'spy' AND a.EXPIRATION_DATE <= '2018-2-28' AND a.EXPIRATION_DATE >= '2018-2-16' AND a.STRIKE <= a.UNDERLIER_PRICE AND substr(a.SECURITY_DESCRIPTION, length(a.SECURITY_DESCRIPTION)+1-1)='C' AND a.EXECUTIVE_MODEL = 'AMERICAN-OPTION' AND a.trade_size<0) THEN 'Early Exercise Short Listed' WHEN a.EXPIRATION_DATE <= '2018-2-15' THEN 'Expiring before Friday' WHEN a.EXPIRATION_DATE <= '2018-2-16' THEN 'Expiring Friday' ELSE 'Other' END