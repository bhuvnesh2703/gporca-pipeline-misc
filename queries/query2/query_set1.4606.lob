SELECT D.COB_DATE, CASE WHEN RANK_CM < 6 THEN CCC_PRODUCT_LINE ELSE 'OTHERS' END AS CCC_BUSINESS_AREA, D.DIVISION_GROUP, D.CM_PRODUCT_TYPE, D.CATEGORY, SUM(D.CM_NET_EXP) AS CM_NET_EXP FROM ( SELECT C.COB_DATE, C.CCC_PRODUCT_LINE, C.DIVISION_GROUP, C.CM_PRODUCT_TYPE, C.CATEGORY, C.CM_NET_EXP, DENSE_RANK() OVER ( ORDER BY CASE WHEN CM_NET_EXP_COB IS NULL THEN 1 ELSE 0 END ASC, ABS(CM_NET_EXP_COB) DESC ) RANK_CM FROM ( SELECT B.COB_DATE, B.CCC_PRODUCT_LINE, B.DIVISION_GROUP, B.CM_PRODUCT_TYPE, B.CATEGORY, B.CM_NET_EXP, SUM(CM_NET_EXP_COB) OVER (PARTITION BY CCC_PRODUCT_LINE) CM_NET_EXP_COB FROM ( SELECT A.COB_DATE, A.CCC_PRODUCT_LINE, A.DIVISION_GROUP, A.CM_PRODUCT_TYPE, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('STRUCTURED RATES', 'LIQUID FLOW RATES') THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING') THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP','FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT','COMMODITIES' ) THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN DIVISION_GROUP IN ('ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG') THEN DIVISION_GROUP WHEN CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION') AND DIVISION_GROUP IN ('ISG CORE', 'ISG NON CORE') THEN 'OTHER ISG' ELSE 'NON ISG' END AS CATEGORY, ( SUM ( COALESCE ( CAST ( A.CM_DELTA AS NUMERIC (15,5) ) , 0 ) ) + SUM ( COALESCE ( CAST ( A.ER_CM_DELTA_DECOMP AS NUMERIC(15,5) ) , 0 ) ) ) / 1000 AS CM_NET_EXP, SUM ( CASE WHEN COB_DATE = '02/28/2018' THEN COALESCE ( CAST ( A.CM_DELTA AS NUMERIC (15,5) ) , 0 ) /1000 + COALESCE ( CAST ( A.ER_CM_DELTA_DECOMP AS NUMERIC(15,5) ) , 0 ) /1000 END ) CM_NET_EXP_COB FROM CDWUSER.U_DM_FIRMWIDE A WHERE COB_DATE >= '07/01/2016' AND COB_DATE <= '02/28/2018' AND NOT ( A.PRODUCT_TYPE_CODE IN ('ZCS') AND A.CCC_PRODUCT_LINE IN ('IB STRUCTURED') ) GROUP BY A.COB_DATE, A.CCC_PRODUCT_LINE, A.DIVISION_GROUP, A.CM_PRODUCT_TYPE, CASE WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('STRUCTURED RATES', 'LIQUID FLOW RATES') THEN 'IR' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES') THEN 'CC' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('SECURITIZED PRODUCTS GRP') THEN 'SPG' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING') THEN 'FXEM' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA IN ('CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CDP' WHEN CCC_DIVISION = 'FIXED INCOME DIVISION' AND DIVISION_GROUP = 'ISG CORE' AND CCC_BUSINESS_AREA NOT IN ( 'STRUCTURED RATES', 'LIQUID FLOW RATES', 'CREDIT-CORPORATES', 'SECURITIZED PRODUCTS GRP','FXEM MACRO TRADING', 'EM CREDIT TRADING', 'FXEM CREDIT TRADING', 'CREDIT DERIVATIVE PROD', 'DSP - CREDIT','COMMODITIES' ) THEN 'OTHER' WHEN CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND DIVISION_GROUP = 'ISG CORE' THEN 'EQUITY' WHEN ( CCC_DIVISION = 'COMMODITIES' OR CCC_BUSINESS_AREA = 'COMMODITIES' ) AND DIVISION_GROUP = 'ISG CORE' THEN 'COMM' WHEN DIVISION_GROUP IN ('ISG NON CORE', 'TREASURY', 'GWMG', 'OTHER ISG') THEN DIVISION_GROUP WHEN CCC_DIVISION NOT IN ('INSTITUTIONAL EQUITY DIVISION', 'COMMODITIES', 'FIXED INCOME DIVISION') AND DIVISION_GROUP IN ('ISG CORE', 'ISG NON CORE') THEN 'OTHER ISG' ELSE 'NON ISG' END ) B ) C ) D GROUP BY D.COB_DATE, CASE WHEN RANK_CM < 6 THEN CCC_PRODUCT_LINE ELSE 'OTHERS' END , D.DIVISION_GROUP, D.CM_PRODUCT_TYPE, D.CATEGORY