With x as ( SELECT a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH as TickExch, a.ISSUE_ID_DECOMP, a.PRODUCT_DESCRIPTION_DECOMP, a.PRODUCT_TYPE_CODE_DECOMP, a.TICKER_DECOMP, a.ISSUER_COUNTRY_CODE_DECOMP, sum(coalesce(a.USD_EQ_DELTA_DECOMP,0)) as USD_EQ_PARTIAL_DELTA, ABS(sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) as ABS_USD_EQ_PARTIAL_DELTA FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE = '2017-08-10' AND a.SILO_SRC = 'IED' and a.CCC_BANKING_TRADING = 'TRADING' AND a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND a.ASSET_CLASS = 'EQ' AND a.LE_GROUP = 'UK' GROUP BY a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH, a.ISSUE_ID_DECOMP, a.PRODUCT_DESCRIPTION_DECOMP, a.PRODUCT_TYPE_CODE_DECOMP, a.TICKER_DECOMP, a.ISSUER_COUNTRY_CODE_DECOMP ), y as ( SELECT TickExch, sum(ABS_USD_EQ_PARTIAL_DELTA) as TOT_ABS_USD_EQ_PARTIAL_DELTA FROM x WHERE x.ABS_USD_EQ_PARTIAL_DELTA <> 0 GROUP BY TickExch ), z as ( SELECT v.UNDERLIER_TICK || '.' || v.UNDERLIER_EXCH as TICKEXCH, s.cob_date, sum(case when s.SCENARIO_NAME = 'V-.05' then s.pos_tv_minus_base else 0 end) as VolDown5, sum(case when s.SCENARIO_NAME = 'V-.02' then s.pos_tv_minus_base else 0 end) as VolDown2, sum(case when s.SCENARIO_NAME = 'V+.02' then s.pos_tv_minus_base else 0 end) as VolPlus2, sum(case when s.SCENARIO_NAME = 'V+.05' then s.pos_tv_minus_base else 0 end) as VolPlus5, sum(case when s.SCENARIO_NAME = 'V+.1' then s.pos_tv_minus_base else 0 end) as VolPlus10 from CDWUSER.U_SURFACE_MSR s, CDWUSER.u_ied_view v where s.cob_date = v.cob_date and s.process_id = v.process_id and s.position_id = v.position_id and v.COB_DATE = '2018-02-28' and v.CCC_BANKING_TRADING = 'TRADING' and v.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' and v.SILO_SRC = 'IED' and v.CCC_TAPS_COMPANY in ('0302', '0313', '0314', '0319', '0328', '0342', '0347', '0517', '0620', '0621', '0646', '0711', '0713', '0715', '0721', '0726', '0853', '0856', '0993', '1308', '1311', '1313', '1314', '1317', '1322', '1344', '1433', '1438', '1472', '1480', '1498', '1709', '1718', '4043', '4044', '4067', '4068', '4086', '4092', '4241', '4267', '4391', '4536', '4543', '4545', '4562', '4564', '4588', '4590', '4857', '4858', '4859', '4863', '4876', '4880', '4884', '5103', '5104', '5121', '5148', '5180', '5181', '5254', '5274', '5310', '5357', '5614', '5656', '5856', '5869', '6036', '6114', '6120', '6152', '6156', '6157', '6158', '6262', '6316', '6325', '6367', '6374', '6376', '6383', '6384', '6589', '6590', '6837', '6838', '6893', '6899', '7016', '7280', '7281', '7416', '7435', '7458', '7704', '8174', '8179', '8237', '8253', '8275', '8284', '8290', '8292', '8441', '8524', '8537', '8564', '8627', '8757', '8772', '8789', '8790', '8941', '8942', '8943', '8959', '8961', '8962', '8963') and s.SCENARIO_NAME in ('V-.05', 'V-.02', 'V+.02', 'V+.05', 'V+.1') group by v.UNDERLIER_TICK || '.' || v.UNDERLIER_EXCH, s.cob_date ) SELECT RANK () OVER (ORDER BY GREATEST ((-1)* (SUM(z.VolDown5*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.VolDown2*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.VolPlus2*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.VolPlus5*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA)), (-1)* (SUM(z.VolPlus10*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA))) DESC) || '_' || 'TopDeltaSlide' AS Concentration, x.ISSUER_COUNTRY_CODE_DECOMP, SUM(z.VolDown5*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as VolDown5_Decomp, SUM(z.VolDown2*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as VolDown2_Decomp, SUM(z.VolPlus2*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as VolPlus2_Decomp, SUM(z.VolPlus5*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as VolPlus5_Decomp, SUM(z.VolPlus10*x.ABS_USD_EQ_PARTIAL_DELTA / y.TOT_ABS_USD_EQ_PARTIAL_DELTA) as VolPlus10_Decomp FROM x INNER JOIN y ON x.TICKEXCH = y.TICKEXCH INNER JOIN z ON y.TICKEXCH = z.TICKEXCH Group by x.ISSUER_COUNTRY_CODE_DECOMP Fetch first 15 rows only