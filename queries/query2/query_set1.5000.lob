with temp_table as (SELECT COB_DATE, vertical_system, spg_desc, fid1_seniority, RATING_GRADE_CD, ccc_division, ccc_BUSINESS_AREA, ccc_PRODUCT_LINE, ccc_STRATEGY, ccc_PL_REPORTING_REGION, BOOK, COUNTRY_CD_OF_RISK as COUNTRY, product_type_code, usd_exposure as usd_net_exposure, usd_total_commit as usd_commit, usd_notional, 0 as market_value, usd_ir_unified_pv01 as usd_pv01, case when CURRENCY_OF_MEASURE not in ('UBD', 'USD') then usd_fx else 0 end as usd_fx, coalesce(USD_CM_DELTA, 0) as cm_delta, case when vertical_system NOT LIKE ('PIPELINE%') AND FEED_SOURCE_NAME NOT IN ('ER1') then coalesce(USD_DELTA, 0) else 0 end as nramv, coalesce(usd_ir_kappa,0)/10 + coalesce(usd_real_kappa,0)/10 as usd_kappa, CASE WHEN VERTICAL_SYSTEM LIKE '%STS%' THEN USD_FX_PARTIAL_KAPPA ELSE USD_FX_KAPPA end as usd_fx_kappa, coalesce(usd_cm_kappa,0) as usd_cm_kappa, usd_eq_kappa, usd_ir_partial_gamma as usd_ir_gamma, usd_pv01sprd, usd_cr_kappa, usd_sev01*10 as usd_sev01, usd_pv10_bench FROM cdwuser.U_EXP_MSR WHERE cob_date in ('2018-02-28','2018-01-31','2018-02-21','2018-02-14','2018-02-07','2018-01-24','2018-01-17','2018-01-10','2018-01-03','2017-12-27','2017-12-20','2017-12-13','2017-12-06','2017-11-29','2017-11-22','2017-11-15','2017-11-08','2017-11-01','2017-10-25','2017-10-18','2017-10-11','2017-10-04','2017-09-27','2017-09-20','2017-09-13','2017-09-06','2017-08-30','2017-08-23','2017-08-16') AND ccc_taps_company IN ('0201','0103','0205','0206','0530','5924') AND var_excl_fl <> 'Y' UNION ALL SELECT COB_DATE, vertical_system, spg_desc, fid1_seniority, case when mrd_rating in ('A', 'AA', 'AAA', 'BBB') then 'IG' when mrd_rating in ('BB', 'B', 'CCC', 'CC', 'C', 'D') then 'NIG' else 'NR' end as RATING_GRADE_CD, ccc_division, ccc_BUSINESS_AREA, ccc_PRODUCT_LINE, ccc_STRATEGY, ccc_PL_REPORTING_REGION, BOOK, COUNTRY_CD_OF_RISK as COUNTRY, product_type_code, 0 as usd_net_exposure, 0 as usd_commit, 0 as usd_notional, 0 as market_value, 0 as usd_pv01, 0 as usd_fx, 0 as cm_delta, coalesce(USD_EQ_DELTA_DECOMP, 0) as nramv, 0 as usd_kappa, 0 as usd_fx_kappa, 0 as usd_cm_kappa, 0 as usd_eq_kappa, 0 as usd_ir_gamma, 0 as usd_pv01sprd, 0 as usd_cr_kappa, 0 as usd_sev01, 0 as usd_pv10_bench FROM cdwuser.U_DECOMP_MSR WHERE vertical_system NOT LIKE ('PIPELINE%') and cob_date in ('2018-02-28','2018-01-31','2018-02-21','2018-02-14','2018-02-07','2018-01-24','2018-01-17','2018-01-10','2018-01-03','2017-12-27','2017-12-20','2017-12-13','2017-12-06','2017-11-29','2017-11-22','2017-11-15','2017-11-08','2017-11-01','2017-10-25','2017-10-18','2017-10-11','2017-10-04','2017-09-27','2017-09-20','2017-09-13','2017-09-06','2017-08-30','2017-08-23','2017-08-16') AND ccc_taps_company IN ('0201','0103','0205','0206','0530','5924') AND var_excl_fl <> 'Y' AND FEED_SOURCE_ID = 301 AND COALESCE (PRODUCT_TYPE_CODE_DECOMP, '') <> 'COMM' AND COALESCE (CASH_ISSUE_TYPE, '') <> 'COMM' UNION ALL SELECT COB_DATE, vertical_system, spg_desc, fid1_seniority, RATING_GRADE_CD, ccc_division, ccc_BUSINESS_AREA, ccc_PRODUCT_LINE, ccc_STRATEGY, ccc_PL_REPORTING_REGION, BOOK, COUNTRY_CD_OF_RISK as COUNTRY, product_type_code, 0 as usd_net_exposure, 0 as usd_commit, 0 as usd_notional, coalesce(USD_MARKET_VALUE, 0) as market_value, 0 as usd_pv01, 0 as usd_fx, 0 as cm_delta, 0 as nramv, 0 as usd_kappa, 0 as usd_fx_kappa, 0 as usd_cm_kappa, 0 as usd_eq_kappa, 0 as usd_ir_gamma, 0 as usd_pv01sprd, 0 as usd_cr_kappa, 0 as usd_sev01, 0 as usd_pv10_bench FROM cdwuser.U_OT_MSR WHERE vertical_system NOT LIKE ('PIPELINE%') and cob_date in ('2018-02-28','2018-01-31','2018-02-21','2018-02-14','2018-02-07','2018-01-24','2018-01-17','2018-01-10','2018-01-03','2017-12-27','2017-12-20','2017-12-13','2017-12-06','2017-11-29','2017-11-22','2017-11-15','2017-11-08','2017-11-01','2017-10-25','2017-10-18','2017-10-11','2017-10-04','2017-09-27','2017-09-20','2017-09-13','2017-09-06','2017-08-30','2017-08-23','2017-08-16') AND ccc_taps_company IN ('0201','0103','0205','0206','0530','5924') AND var_excl_fl <> 'Y' AND FEED_SOURCE_NAME NOT IN ('ER1') ) select A.cob_date, sum(A.usd_pv01) as usd_pv01, sum(A.usd_fx) as usd_fx, sum(A.cm_delta) as cm_delta, sum(A.NRAMV) as NRAMV, sum(A.usd_kappa) as usd_kappa, sum(A.usd_fx_kappa) as usd_fx_kappa, sum(A.usd_cm_kappa) as usd_cm_kappa, sum(A.usd_eq_kappa) as usd_eq_kappa, sum(A.usd_ir_gamma) as usd_ir_gamma, sum(A.usd_pv01sprd) as usd_pv01sprd, sum(A.usd_cr_kappa) as usd_cr_kappa, sum(A.usd_sev01) as usd_sev01, sum(A.usd_pv10_bench) as usd_pv10_bench, sum(case when A.CREDIT_TYPE_FLAG='CREDIT-HY' then A.USD_NET_EXPOSURE else 0 end) as CREDIT_HY, sum(case when A.CREDIT_TYPE_FLAG='EMERGING MARKETS' then A.USD_NET_EXPOSURE else 0 end) as CREDIT_EM, sum(case when A.CREDIT_TYPE_FLAG='SECURITIZED' and A.SECURITIZED_CATEGORY='RESI' then A.USD_NET_EXPOSURE else 0 end) as secu_resi, sum(case when A.CREDIT_TYPE_FLAG='SECURITIZED' and A.SECURITIZED_CATEGORY='CMBS' then A.USD_NET_EXPOSURE else 0 end) as secu_cmbs, sum(case when A.CREDIT_TYPE_FLAG='SECURITIZED' and A.SECURITIZED_CATEGORY='ABS' then A.USD_NET_EXPOSURE else 0 end) as secu_abs from ( SELECT b.COB_DATE, CASE WHEN b.COUNTRY NOT IN ('VIR','IMN','GIB','BHS','DNK','BMU','CYM','AUS','AUT','BEL','CAN','CHE','DEU','FIN','FRA','GBR','JPN','LUX','NLD','NOR','NZL','SWE','USA','JEY','GGY','SUP','XS','XCI','VGB','CYP','CHN','SGP','TWN','HKG','CZE','ISR','QAT','SVK','SAU','SVN','CHL') THEN 'EMERGING MARKETS' WHEN BOOK IN ('SCALL','SCCDS','TOTMT') THEN 'EXCLUDED' WHEN CCC_BUSINESS_AREA IN ('STRUCTURED RATES') AND PRODUCT_TYPE_CODE IN ('SWAP') THEN 'CREDIT-CORP' WHEN PRODUCT_TYPE_CODE IN ('EQUITY','OPTION','STOCK','ASCOT','WARRNT','ADR','FUND','SWAP','FUTURE','ETF') OR (PRODUCT_TYPE_CODE='PREF' AND VERTICAL_SYSTEM NOT LIKE '%C1%') THEN 'EQUITY' WHEN CCC_DIVISION = 'MS PRINCIPAL INVESTING' OR CCC_BUSINESS_AREA IN ('MSPI INVESTING','PRINCIPAL INVESTING') OR (PRODUCT_TYPE_CODE = 'EQUITY' AND (CCC_BUSINESS_AREA IN ('CREDIT-CORPORATES','CREDIT CORPORATES PRIMARY','PROP WORKOUT','IRCC MANAGEMENT') OR CCC_DIVISION='INVESTMENTS')) THEN 'PRIVATE EQUITY OTHER' WHEN ((CCC_PRODUCT_LINE LIKE ('%CVA%') or CCC_STRATEGY LIKE ('%CVA%')) AND CCC_DIVISION NOT IN ('INT RATE CREDIT CURRENCY','FIXED INCOME DIVISION','INTEREST RATE CURRENCY GR') AND CCC_PRODUCT_LINE<>'COUNTERPARTY MANAGEMENT') OR CCC_PRODUCT_LINE IN ('MS CVA MNE - DERIVATIVES','MS CVA MNE DERIVS IRCC') OR CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES') THEN 'CVA OTHER' WHEN (CCC_PRODUCT_LINE LIKE ('%CVA%') or CCC_STRATEGY LIKE ('%CVA%')) AND (CCC_DIVISION IN ('INT RATE CREDIT CURRENCY','FIXED INCOME DIVISION','INTEREST RATE CURRENCY GR') OR CCC_PRODUCT_LINE='COUNTERPARTY MANAGEMENT') THEN 'CVA OTHER FID' WHEN CCC_PRODUCT_LINE LIKE ('%CVA%') OR CCC_STRATEGY LIKE ('%CVA%') OR CCC_BUSINESS_AREA LIKE ('%CVA%') THEN 'CVA UNCAT.' WHEN (CCC_BUSINESS_AREA IN ('CREDIT-SECURITIZED PRODS','SECURITIZED PRODUCT GRP','SECURITIZED PRODUCTS GRP') AND CCC_PRODUCT_LINE in ('MANAGEMENT','SPG MANAGEMENT')) THEN 'EXCLUDED' WHEN CCC_BUSINESS_AREA='LENDING' AND (CCC_PRODUCT_LINE='PROJECT FINANCE' or ccc_strategy = 'PROJECT FINANCE') THEN 'EXCLUDED' WHEN ((VERTICAL_SYSTEM IN ('SPG_NY','SPG_LN','SPG_TK','MBS_NY','MUNI_NY') OR upper(SPG_DESC) LIKE '%ABS%' OR upper(SPG_DESC) LIKE '%CMBS%' OR upper(SPG_DESC) LIKE '%COLONNADE%' OR PRODUCT_TYPE_CODE LIKE 'ARS%' OR upper(SPG_DESC) LIKE '%RMBS%' OR upper(SPG_DESC) LIKE '%RPX%' OR upper(SPG_DESC) LIKE '%WAREHOUSE%' OR PRODUCT_TYPE_CODE='RPX') AND SPG_DESC NOT IN ('SWAP','RATE FUTURES','GOVERNMENT')) AND upper(SPG_DESC) NOT LIKE '%CORP%' AND PRODUCT_TYPE_CODE<>'MUNI' THEN 'SECURITIZED' WHEN CCC_BUSINESS_AREA IN ('STRUCTURED CREDIT PROD','CREDIT DERIVATIVE PROD', 'DSP - CREDIT') THEN 'CREDIT-CORP' WHEN FID1_SENIORITY IN ('SUBT1', 'SUBUT2') AND CCC_DIVISION IN ('INT RATE CREDIT CURRENCY','FIXED INCOME DIVISION') AND PRODUCT_TYPE_CODE IN ('BOND','PREF') AND CCC_STRATEGY<>'DISTRESSED TRADING1' THEN 'CREDIT-HY' WHEN BOOK IN ('JVMK2','JVPMK') THEN 'CREDIT-HY' WHEN CCC_BUSINESS_AREA='LENDING' AND BOOK LIKE '%WORKOUT%' THEN 'CREDIT-HY' WHEN CCC_BUSINESS_AREA='LENDING' AND (CCC_PRODUCT_LINE='HELD FOR INVESTMENT' or CCC_STRATEGY='HELD FOR INVESTMENT') THEN 'EXCLUDED' WHEN CCC_BUSINESS_AREA in ('CREDIT-CORPORATES','CREDIT CORPORATES PRIMARY') AND (CCC_PRODUCT_LINE IN ('NON INVSMT GRADE PRIMARY','NON IG PRIMARY - LOANS','NON IG PRIMARY - HY BOND', 'PRIMARY - LOANS') or ccc_strategy = 'NON IG PRIMARY - HY BOND') THEN 'EXCLUDED' WHEN CCC_BUSINESS_AREA IN('PROPRIETARY TRADING','PROPRIETARY TRADING1') OR CCC_PRODUCT_LINE IN ('PROP WORKOUT - CREDIT ARB','PROP WORKOUT - COURNOT','LEGACY CREDIT TRADING','COURNOT','CREDIT ARBITRAGE') OR CCC_STRATEGY IN ('PROP WORKOUT - CREDIT ARB','PROP WORKOUT - COURNOT','LEGACY CREDIT TRADING','COURNOT','CREDIT ARBITRAGE') OR (CCC_PRODUCT_LINE = 'CREDIT TRADING' AND CCC_BUSINESS_AREA = 'CREDIT PROPRIETARY TDG' AND CCC_PL_REPORTING_REGION = 'AMERICAS') OR BOOK IN ('CCINY','CFBND','CFPNY','SPAIR','PIVOL','PICOR') THEN 'CREDIT-CORP' WHEN PRODUCT_TYPE_CODE='CONVRT' AND (CCC_DIVISION IN ('COMMODITIES','INT RATE CREDIT CURRENCY','FIXED INCOME DIVISION','NON CORE','WW FID OTHER','FIC OTHER') OR CCC_PRODUCT_LINE IN ('CONVERTIBLE PRODUCTS') OR CCC_BUSINESS_AREA IN ('COMMODITIES')) AND CCC_PRODUCT_LINE NOT IN ('DISTRESSED TRADING','PAR LOANS TRADING') AND CCC_DIVISION NOT IN ('NON CORE') AND CCC_BUSINESS_AREA NOT IN ('NON CORE') THEN 'CREDIT-CORP' WHEN CCC_STRATEGY='DISTRESSED TRADING1' AND PRODUCT_TYPE_CODE IN ('CDSOPTIDX','CRDINDEX','LOANINDEX','CRDBSKT') THEN 'CREDIT-CORP' WHEN (CCC_BUSINESS_AREA IN ('PROP WORKOUT') OR CCC_PRODUCT_LINE IN ('CONVERTIBLE TRADING SEC','EXCESS TRADING','FINANCING LOANS') OR CCC_STRATEGY IN ('DISTRESSED TRADING1','CONVERTIBLE TRADING SEC','EXCESS TRADING','FINANCING LOANS') OR ((CCC_PRODUCT_LINE IN ('PAR LOANS TRADING') or CCC_STRATEGY IN ('PAR LOANS TRADING','PRIVATE LOANS TRADING')) AND BOOK IN ('TRAZY')) OR BOOK IN ('SYNNY','SELNA') OR BOOK LIKE ('%EXCESS%') OR CCC_BUSINESS_AREA IN ('CONVERTIBLE TRADING SEC','LEVERAGED LOANS') OR (CCC_PRODUCT_LINE IN ('LEVERAGED CREDIT TRADING','LEVERAGED CREDIT TRADING1') AND CCC_STRATEGY <> 'NA HY TDG')) OR ((upper(SPG_DESC) LIKE '%CORPORATE CDO%' OR upper(SPG_DESC) LIKE '%CORPORATE CLO%')) OR (upper(SPG_DESC) LIKE '%CORP%' AND RATING_GRADE_CD IN ('NR','NIG') AND (CCC_BUSINESS_AREA IN ('CREDIT-SECURITIZED PRODS','SECURITIZED PRODUCTS GRP','SECURITIZED PRODUCT GRP') OR CCC_PRODUCT_LINE LIKE 'CDO PRIMARY%' OR CCC_PRODUCT_LINE LIKE 'CLIENT NON RESI TRADING%' OR CCC_PRODUCT_LINE LIKE 'COMMERCIAL RE (PTG)%' OR CCC_PRODUCT_LINE LIKE 'MORTGAGE PROP TRADING%' OR CCC_STRATEGY LIKE 'MORTGAGE PROP TRADING%' OR CCC_PRODUCT_LINE LIKE '%GPCG%' OR CCC_PRODUCT_LINE LIKE 'PTG%' OR CCC_STRATEGY LIKE 'PTG%' OR CCC_PRODUCT_LINE LIKE 'RESI SEC%' OR CCC_PRODUCT_LINE LIKE 'SECURITIZED SEC%' OR CCC_DIVISION IN ('NON CORE') OR CCC_BUSINESS_AREA IN ('NON CORE'))) THEN 'CREDIT-HY' WHEN (CCC_PRODUCT_LINE IN ('PAR LOANS TRADING') or CCC_STRATEGY IN ('PAR LOANS TRADING','PRIVATE LOANS TRADING')) AND BOOK NOT IN ('TRAZY') THEN 'CREDIT-CORP' ELSE 'CREDIT-CORP' END AS CREDIT_TYPE_FLAG, CASE WHEN (b.SPG_DESC LIKE ('%COLONNADE%') OR b.SPG_DESC='OTHER CREDIT BASKET' AND b.BOOK IN ('COLONNADE')) OR b.BOOK='AEOLUS GPCG' THEN 'COLONNADE' WHEN SPG_DESC LIKE ('%CMBS%') THEN 'CMBS' WHEN SPG_DESC LIKE ('%RMBS%') OR SPG_DESC='RPX' OR PRODUCT_TYPE_CODE='RPX' THEN 'RESI' WHEN SPG_DESC LIKE ('ABS%') OR SPG_DESC IN ('OTHER CREDIT BASKET','OTHER LOANS') THEN 'ABS' WHEN PRODUCT_TYPE_CODE='MUNI' THEN 'OTHER' ELSE 'OTHER' END AS SECURITIZED_CATEGORY, b.usd_net_exposure, b.usd_commit, b.usd_notional, b.market_value, b.usd_pv01, b.usd_fx, b.cm_delta, b.nramv, b.usd_kappa, b.usd_fx_kappa, b.usd_cm_kappa, b.usd_eq_kappa, b.usd_ir_gamma, b.usd_pv01sprd, b.usd_cr_kappa, b.usd_sev01, b.usd_pv10_bench from temp_table B ) A group by A.cob_date