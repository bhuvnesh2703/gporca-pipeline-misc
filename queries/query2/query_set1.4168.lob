WITH SRC AS (SELECT max(legal_ultimate_namee) as legal_ultimate_name, legal_ultimate_id, ccc_strategy, tapscusip, original_rating, sum(VAL03*cob_multiplier) AS pv10_cob, sum(VAL03*change_multiplier) AS pv10_chng, sum(usd_pv01sprd*cob_multiplier) AS usd_pv01sprd_cob, sum(usd_pv01sprd*change_multiplier) AS usd_pv01sprd_chng, sum(usd_net_exposure*cob_multiplier) AS usd_net_exposure_cob, sum(usd_net_exposure*change_multiplier) AS usd_net_exposure_chng FROM ( SELECT coalesce(POSITION_ISSUER_PARTY_DARWIN_NAME, POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME, fid1_index_family) as legal_ultimate_namee, POSITION_ISSUER_PARTY_DARWIN_ID as legal_ultimate_id, case when cob_date = '2018-02-28' then 1 else 0 end as cob_multiplier, case when cob_date = '2018-02-28' then 1 else -1 end as change_multiplier, ccc_strategy, tapscusip, original_rating, usd_pv01sprd, slide_pv_pls_10pct_usd as val03, usd_exposure as usd_net_exposure FROM ( SELECT POSITION_ISSUER_PARTY_DARWIN_NAME, POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME, fid1_index_family, POSITION_ISSUER_PARTY_DARWIN_ID, cob_date, ccc_strategy, tapscusip, insurer_rating as original_rating, 0 as usd_pv01sprd, coalesce(slide_ir_pls_200bp_usd,0) as slide_pv_pls_10pct_usd, 0 as usd_exposure FROM CDWUSER.U_IR_MSR ir WHERE cob_date in ('2018-02-28', '2018-01-31') AND PARENT_LEGAL_ENTITY = '0302(G)' and VERTICAL_SYSTEM LIKE ('SPG%') AND ccc_business_area not in ('CPM TRADING (MPE)', 'CPM', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') AND CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'EQ XVA HEDGING') AND UPPER(sectype2) Not In (UPPER('Govts'),'FX',UPPER('Swaps'),UPPER('RateFuture')) AND CCC_STRATEGY <> 'CORE PRIMARY' AND NOT (vertical_system LIKE 'PIPELINE_%' and ccc_business_area = 'LENDING') AND product_type_code <> 'CP' AND UPPER(FID1_INDUSTRY_NAME_LEVEL1) <> UPPER('Sovereign') AND var_excl_fl <> 'Y' AND ccc_banking_trading = 'TRADING' UNION ALL SELECT POSITION_ISSUER_PARTY_DARWIN_NAME, POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME, fid1_index_family, POSITION_ISSUER_PARTY_DARWIN_ID, cob_date, ccc_strategy, tapscusip, insurer_rating as original_rating, 0 as usd_pv01sprd, coalesce(slide_spgcc_min_10pct_usd,0) + coalesce(slide_ptlpv_min_20pct_usd,0) + coalesce(slide_cmbx_min_10pct_usd,0) as slide_pv_pls_10pct_usd, 0 as usd_exposure FROM CDWUSER.U_SP_MSR WHERE cob_date in ('2018-02-28', '2018-01-31') AND PARENT_LEGAL_ENTITY = '0302(G)' and VERTICAL_SYSTEM LIKE ('SPG%') AND ccc_business_area not in ('CPM TRADING (MPE)', 'CPM', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') AND CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'EQ XVA HEDGING') AND UPPER(sectype2) Not In (UPPER('Govts'),'FX',UPPER('Swaps'),UPPER('RateFuture')) AND CCC_STRATEGY <> 'CORE PRIMARY' AND NOT (vertical_system LIKE 'PIPELINE_%' and ccc_business_area = 'LENDING') AND product_type_code <> 'CP' AND UPPER(FID1_INDUSTRY_NAME_LEVEL1) <> UPPER('Sovereign') AND var_excl_fl <> 'Y' AND ccc_banking_trading = 'TRADING' UNION ALL SELECT POSITION_ISSUER_PARTY_DARWIN_NAME, POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME, fid1_index_family, POSITION_ISSUER_PARTY_DARWIN_ID, cob_date, ccc_strategy, tapscusip, insurer_rating as original_rating, coalesce(usd_pv01sprd,0) as usd_pv01sprd, 0 as slide_pv_pls_10pct_usd, coalesce(usd_exposure,0) as usd_exposure FROM CDWUSER.U_CR_MSR WHERE cob_date in ('2018-02-28', '2018-01-31') AND PARENT_LEGAL_ENTITY = '0302(G)' and VERTICAL_SYSTEM LIKE ('SPG%') AND ccc_business_area not in ('CPM TRADING (MPE)', 'CPM', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') AND CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'EQ XVA HEDGING') AND UPPER(sectype2) Not In (UPPER('Govts'),'FX',UPPER('Swaps'),UPPER('RateFuture')) AND CCC_STRATEGY <> 'CORE PRIMARY' AND NOT (vertical_system LIKE 'PIPELINE_%' and ccc_business_area = 'LENDING') AND product_type_code <> 'CP' AND UPPER(FID1_INDUSTRY_NAME_LEVEL1) <> UPPER('Sovereign') AND var_excl_fl <> 'Y' AND ccc_banking_trading = 'TRADING' ) X ) Y GROUP BY legal_ultimate_id, ccc_strategy, tapscusip, original_rating ) /*******************/ select dense_rank() over(order by abs(PV01_RANK_LE) desc) as issuer_rank, dense_rank() over(partition by legal_ultimate_id, legal_ultimate_name order by case when ccc_strategy is null then 0 else 1 end, abs(PV01_RANK) desc, ROWNUM ) as tapscusip_rank, legal_ultimate_id, legal_ultimate_name, ccc_strategy, tapscusip, original_rating, usd_pv01sprd_cob, usd_pv01sprd_chng, pv10_cob, pv10_chng, usd_net_exposure_cob, usd_net_exposure_chng from ( select C.*, ROW_NUMBER() OVER() AS ROWNUM, sum(usd_pv01sprd_cob) over(partition by legal_ultimate_id) AS PV01_RANK_LE, sum(usd_pv01sprd_cob) over(partition by legal_ultimate_id, legal_ultimate_name, ccc_strategy, tapscusip, original_rating) as PV01_RANK from ( select legal_ultimate_id, max(legal_ultimate_name) as legal_ultimate_name, ccc_strategy, tapscusip, original_rating, sum(usd_pv01sprd_cob) as usd_pv01sprd_cob, sum(usd_pv01sprd_chng) as usd_pv01sprd_chng, sum(pv10_cob) as pv10_cob, sum(pv10_chng) as pv10_chng, sum(usd_net_exposure_cob) as usd_net_exposure_cob, sum(usd_net_exposure_chng) as usd_net_exposure_chng from src group by legal_ultimate_id, ROLLUP (ccc_strategy, tapscusip, original_rating) ) C where legal_ultimate_id is not null and not ((tapscusip is null and ccc_strategy is not null) or (original_rating is null and tapscusip is not null)) fetch first 121 rows only ) a