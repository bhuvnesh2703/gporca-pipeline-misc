with partial_position as ( SELECT COB_DATE, PROCESS_ID, POSITION_ID, (CASE WHEN CASH_ISSUE_TYPE in ('INDEX', 'ETF') And PARTIAL_DECOMP_PRODUCT_TYPE_CODE not in ('ADR', 'STOCK') THEN 1 WHEN CASH_ISSUE_TYPE in ('STOCK', 'ADR') And PARTIAL_DECOMP_PRODUCT_TYPE_CODE in ('ADR', 'STOCK') THEN 2 ELSE 3 END) AS CLASSIFIER FROM CDWUSER.U_EXP_MSR_PARTIAL WHERE COB_DATE = '2018-02-28' AND CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND CCC_BANKING_TRADING = 'TRADING' AND ((CASH_ISSUE_TYPE in ('INDEX', 'ETF') And PARTIAL_DECOMP_PRODUCT_TYPE_CODE not in ('ADR', 'STOCK')) OR (CASH_ISSUE_TYPE in ('STOCK', 'ADR') And PARTIAL_DECOMP_PRODUCT_TYPE_CODE in ('ADR', 'STOCK'))) GROUP BY 1,2,3,4 ), decomp as ( SELECT COB_DATE, PROCESS_ID, POSITION_ID, UNDERLIER_TICK || '.' || UNDERLIER_EXCH as MdSymbol, ticker_decomp||'.'||exchange_decomp as Decomposed_MdSymbol, ISSUER_COUNTRY_CODE_DECOMP as Country, ISSUE_ID_DECOMP as Issue, Avg(PRODUCT_WEIGHT_DECOMP) as Delta_Weight FROM CDWUSER.U_DECOMP_MSR where COB_DATE = '2018-02-28' AND CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND CCC_BANKING_TRADING = 'TRADING' and USD_EQ_DELTA_DECOMP <> '0' GROUP BY 1,2,3,4,5,6,7 ), Decomp_Weights as (select MdSymbol, Decomposed_MdSymbol, Country, Issue,Delta_Weight from ( Select MdSymbol, Decomposed_MdSymbol, Country, Issue, avg(Delta_Weight) as Delta_Weight From partial_position a Join decomp b on (a.COB_DATE = b.COB_DATE and a.PROCESS_ID = b.PROCESS_ID and a.POSITION_ID = b.POSITION_ID) where classifier=1 and Decomposed_MdSymbol<> 'mf_deriv.msdy' group by 1,2,3,4 union all Select MdSymbol, Decomposed_MdSymbol, Country, Issue, 1 as Delta_Weight From partial_position a Join decomp b on (a.COB_DATE = b.COB_DATE and a.PROCESS_ID = b.PROCESS_ID and a.POSITION_ID = b.POSITION_ID) where classifier=2 group by 1,2,3,4,5) a group by 1,2,3,4,5), Vega as ( Select CASE WHEN a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE = 'FUTURE' THEN 'sx5e.xstx' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('sp5lvit.iomr','spgsagp.iomr','rdxeur.vier','spx2.cbny','spx.us','sptr1.msny','spx1.msny','upro.p','spxl.p', 'MSXXHDLV.cbny') THEN 'spx.us' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('rut2.msny') THEN 'rut.us' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('ndxtr1calc.msny') THEN 'n225.osa' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('pghn_steps.cbln') THEN 'pgnh.s' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('icl_ta_usd.cbln') THEN 'icl.ta' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('ua1.msny') THEN 'ua.n' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('xlf1.msny') THEN 'xlf.p' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('MSDAXCVT.cbln') THEN 'gdaxi.ibsr' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('cce1.msny') THEN 'cce.n' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('khc1.msny') THEN 'khc.q' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('tqqq.q', 'qqq2.msny') THEN 'qqq.q' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('topxdv.tyor') THEN 'topix.tyo' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('dhr1.msny') THEN 'dhr.n' ELSE a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE end as Asset_MdSymbol , a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE, Sum( a.USD_EQ_VEGA) as Vega From CDWUSER.U_IED_COMP_MSR a WHERE a.COB_DATE = '2018-02-28' And a.DIVISION = 'IED' And a.CCC_BANKING_TRADING = 'TRADING' And a.USD_EQ_VEGA <> '0' Group by CASE WHEN a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE = 'FUTURE' THEN 'sx5e.xstx' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('sp5lvit.iomr','spgsagp.iomr','rdxeur.vier','spx2.cbny','spx.us','sptr1.msny','spx1.msny','upro.p','spxl.p', 'MSXXHDLV.cbny') THEN 'spx.us' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('rut2.msny') THEN 'rut.us' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('ndxtr1calc.msny') THEN 'n225.osa' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('pghn_steps.cbln') THEN 'pgnh.s' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('icl_ta_usd.cbln') THEN 'icl.ta' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('ua1.msny') THEN 'ua.n' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('xlf1.msny') THEN 'xlf.p' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('MSDAXCVT.cbln') THEN 'gdaxi.ibsr' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('cce1.msny') THEN 'cce.n' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('khc1.msny') THEN 'khc.q' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('tqqq.q', 'qqq2.msny') THEN 'qqq.q' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('topxdv.tyor') THEN 'topix.tyo' WHEN a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE in ('dhr1.msny') THEN 'dhr.n' ELSE a.PARTIAL_DECOMP_TICK||'.'||a.PARTIAL_DECOMP_EXCHANGE end, a.PARTIAL_DECOMP_PRODUCT_TYPE_CODE) select Asset_Mdsymbol,sum(kappa) as kappa,Country from (Select w.Asset_Mdsymbol, sum(y.Delta_Weight*w.Vega)/1000 as Kappa , case when y.Country in ('AUT','BEL','BGR','CHE','CZE','DEU','DNK','ESP','EST','FIN','FRA','GEO','GGY','GRC','HRV','HUN','IRL','ISL','ITA','JEY','LTU','LUX','NLD','NOR','POL','PRT','ROU','RUS','SVK','SVN','SWE') Then 'Europe' when y.Country in ('ARE','BGD','BHR','CHN','HKG','IDN','IND','ISR','JOR','JPN','KAZ','KOR','KWT','LBN','LKA','MYS','OMN','PAK','PHL','QAT','SAU','SGP','THA','TUR','TWN','VNM') Then 'Asia' when y.Country in ('GBR') Then 'UK' when y.Country in ('USA') Then 'USA' else 'Other' end as Country From Vega w Join Decomp_Weights y on (w.Asset_MdSymbol = y.Mdsymbol) Group by w.Asset_Mdsymbol, y.Country ) a group by Asset_Mdsymbol,Country