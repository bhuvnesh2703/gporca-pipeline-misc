With x as ( select c.COB_DATE, c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME as Issuer, max(c.MRD_RATING) as Rating, sum(CREDIT_SPREAD) as Credit_Spread, sum(coalesce(c.USD_EXPOSURE,0)) as Net_Exposure, sum(coalesce(c.usd_pv01sprd,0)) as CR_PV01 FROM ( Select 'EQ' as Source, c.COB_DATE, ULT_ISSUER_PARTY_DARWIN_NAME as POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, c.PROCESS_ID, c.POSITION_ID, max(c.MRD_RATING) as MRD_RATING, 0 as CREDIT_SPREAD, Sum(USD_EQ_DELTA_DECOMP) as USD_EXPOSURE, 0 as usd_pv01sprd from cdwuser.U_DECOMP_MSR c where c.COB_DATE in ( '2018-02-28' , '2018-01-31' ) and c.DIVISION = 'IED' and c.CCC_BANKING_TRADING = 'TRADING' and coalesce(USD_EQ_DELTA_DECOMP,0) <> 0 and c.CCC_PRODUCT_LINE = 'CONVERTIBLE PRODUCTS' and ULT_ISSUER_PARTY_DARWIN_NAME <> 'BANCO BRADESCO S.A. ' and c.CUSIP<>'999CBV0L1' and c.CCC_PL_REPORTING_REGION = 'EMEA' AND PRODUCT_TYPE_CODE IN ('ADR','FUTURE','OPTION','STOCK', 'WARRANT','SWAP','WARRNT') Group by c.COB_DATE, ULT_ISSUER_PARTY_DARWIN_NAME, c.POSITION_ID, PROCESS_ID Union Select 'CR' as Source, c.COB_DATE, c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, c.PROCESS_ID, c.POSITION_ID, max(c.MRD_RATING) as MRD_RATING, max(CREDIT_SPREAD) as CREDIT_SPREAD, sum(USD_EXPOSURE) as USD_EXPOSURE, sum(coalesce(c.usd_pv01sprd,0)) as usd_pv01sprd from cdwuser.U_CR_MSR c where c.COB_DATE in ( '2018-02-28' , '2018-01-31' ) and c.DIVISION = 'IED' and c.CCC_BANKING_TRADING = 'TRADING' and c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME <> 'BANCO BRADESCO S.A. ' and c.CUSIP<>'999CBV0L1' and c.CCC_PRODUCT_LINE = 'CONVERTIBLE PRODUCTS' and c.CCC_PL_REPORTING_REGION = 'EMEA' group by c.COB_DATE, c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, c.POSITION_ID, PROCESS_ID UNION SELECT 'CR' AS Source, c.COB_DATE, 'Banco Espirito Santo' as POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, c.PROCESS_ID, c.POSITION_ID, MAX (c.MRD_RATING) AS MRD_RATING, MAX (CREDIT_SPREAD) AS CREDIT_SPREAD, SUM (USD_EXPOSURE) AS USD_EXPOSURE, SUM (COALESCE (c.usd_pv01sprd, 0)) AS usd_pv01sprd FROM cdwuser.U_CR_MSR c WHERE c.COB_DATE IN ('2018-02-28','2018-01-31') AND c.DIVISION = 'IED' AND c.CCC_BANKING_TRADING = 'TRADING' AND c.CCC_PRODUCT_LINE = 'CONVERTIBLE PRODUCTS' AND c.CCC_PL_REPORTING_REGION = 'EMEA' and c.CUSIP = '999CBV0L1' GROUP BY c.COB_DATE, c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, c.POSITION_ID, PROCESS_ID ) c Group by c.COB_DATE, c.POSITION_ULT_ISSUER_PARTY_DARWIN_NAME, c.POSITION_ID, PROCESS_ID), xTop as (Select Rank() over (order by abs(sum(case when cob_date = '2018-02-28' then Net_Exposure else 0 end)) desc)||'_'||'TopCBExp' as Concentration, issuer, sum(case when cob_date = '2018-02-28' then Net_Exposure else 0 end) as Net_Exposure_COB, sum(case when cob_date = '2018-02-28' then Net_Exposure else -Net_Exposure end) as Net_Exposure_DOD, sum(case when cob_date = '2018-02-28' then CR_PV01 else 0 end) as CR_PV01_COB, sum(case when cob_date = '2018-02-28' then CR_PV01 else -CR_PV01 end) as CR_PV01_DOD from x group by Issuer fetch first 5 Rows only), xRating as (select Issuer, Rating, rank() over (partition by Issuer order by abs(sum(case when cob_date = '2018-02-28' then Net_Exposure else 0 end)) desc) as RatingRank from x group by issuer, rating), xBucket as (select Issuer, Case when CREDIT_SPREAD < 50 then '<50' when CREDIT_SPREAD >= 50 and CREDIT_SPREAD < 100 then '50-100' when CREDIT_SPREAD >= 100 and CREDIT_SPREAD < 200 then '100-200' when CREDIT_SPREAD >=200 and CREDIT_SPREAD < 500 then '200-500' when CREDIT_SPREAD >= 500 and CREDIT_SPREAD < 1000 then '500-1000' when CREDIT_SPREAD >= 1000 then '>1000' else 'NA' end as CREDIT_SPREAD_BUCKET, rank() over (partition by Issuer order by abs(sum(case when cob_date = '2018-02-28' then Net_Exposure else 0 end)) desc) as BucketRank from x group by Issuer, case when CREDIT_SPREAD < 50 then '<50' when CREDIT_SPREAD >= 50 and CREDIT_SPREAD < 100 then '50-100' when CREDIT_SPREAD >= 100 and CREDIT_SPREAD < 200 then '100-200' when CREDIT_SPREAD >=200 and CREDIT_SPREAD < 500 then '200-500' when CREDIT_SPREAD >= 500 and CREDIT_SPREAD < 1000 then '500-1000' when CREDIT_SPREAD >= 1000 then '>1000' else 'NA' end) Select xTop.Concentration, xTop.Issuer, xRating.RATING, xBucket.CREDIT_SPREAD_BUCKET, xTop.Net_Exposure_Cob, xTop.Net_Exposure_DOD, xTop.CR_PV01_COB, xTop.CR_PV01_DOD from xTop inner join xRating on (xTop.issuer = xRating.issuer) inner join xBucket on (xTop.issuer = xBucket.issuer) where xRating.RatingRank = 1 and xBucket.BucketRank = 1 order by xTop.Concentration