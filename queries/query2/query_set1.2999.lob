with pnl as ( select q.cob_date, q.ccc_pl_reporting_region AS pl_reporting_region, q.ccc_business_area AS business_area, q.ccc_strategy, ROUND (SUM (q.ytd_pl), 2) / 1000000 AS ytd_pnl from dwuser.u_pct_pnl_current q WHERE q.ccc_division = 'INSTITUTIONAL EQUITY DIVISION' AND q.cob_date >='2018-01-01' AND q.cob_date <='2018-02-28' AND NOT q.cob_date='2017-01-03' AND (q.account_purpose_code <> 'J' OR q.account_purpose_code IS NULL) group by q.cob_date, q.ccc_pl_reporting_region, q.ccc_business_area, q.ccc_strategy ) /* TOTAL BUSINESS_AREA */ SELECT 'Total' AS Commissions, b.COB_DATE AS DATE_OF_MAX, b.PL_REPORTING_REGION AS PNL_REGION, b.BUSINESS_AREA, b.YTD_PNL AS MAX_YTD_PNL FROM ( SELECT a.COB_DATE, a.PL_REPORTING_REGION, a.BUSINESS_AREA, a.YTD_PNL, MAX (a.YTD_PNL) OVER (PARTITION BY a.PL_REPORTING_REGION, a.BUSINESS_AREA) as MAX_YTD_PNL FROM ( SELECT cob_date, pl_reporting_region, business_area, SUM (ytd_pnl) AS ytd_pnl FROM pnl GROUP BY cob_date, pl_reporting_region, business_area ) a ) b WHERE b.YTD_PNL = b.MAX_YTD_PNL UNION ALL /* TOTAL REGION */ SELECT 'Total' AS Commissions, b.COB_DATE AS DATE_OF_MAX, b.PL_REPORTING_REGION AS PNL_REGION, BUSINESS_AREA, b.YTD_PNL AS MAX_YTD_PNL FROM ( SELECT a.COB_DATE, a.PL_REPORTING_REGION, a.BUSINESS_AREA, a.YTD_PNL, MAX (a.YTD_PNL) OVER (PARTITION BY a.PL_REPORTING_REGION, a.BUSINESS_AREA) as MAX_YTD_PNL FROM ( SELECT cob_date, pl_reporting_region, 'TOTAL' || ' ' || pl_reporting_region AS BUSINESS_AREA, SUM (ytd_pnl) AS ytd_pnl FROM pnl GROUP BY cob_date, pl_reporting_region ) a ) b WHERE b.YTD_PNL = b.MAX_YTD_PNL UNION ALL /* TOTAL */ SELECT 'Total' AS Commissions, b.COB_DATE AS DATE_OF_MAX, b.PL_REPORTING_REGION AS PNL_REGION, BUSINESS_AREA, b.YTD_PNL AS MAX_YTD_PNL FROM ( SELECT a.COB_DATE, a.PL_REPORTING_REGION, a.BUSINESS_AREA, a.YTD_PNL, MAX (a.YTD_PNL) OVER (PARTITION BY a.PL_REPORTING_REGION, a.BUSINESS_AREA) as MAX_YTD_PNL FROM ( SELECT cob_date, 'TOTAL' AS pl_reporting_region, '' AS BUSINESS_AREA, SUM (ytd_pnl) AS ytd_pnl FROM pnl GROUP BY cob_date ) a ) b WHERE b.YTD_PNL = b.MAX_YTD_PNL UNION ALL /* TOTAL REGION excl. CVA, DVA, TCM' */ SELECT 'Total' AS Commissions, b.COB_DATE AS DATE_OF_MAX, b.PL_REPORTING_REGION AS PNL_REGION, BUSINESS_AREA, b.YTD_PNL AS MAX_YTD_PNL FROM ( SELECT a.COB_DATE, a.PL_REPORTING_REGION, a.BUSINESS_AREA, a.YTD_PNL, MAX (a.YTD_PNL) OVER (PARTITION BY a.PL_REPORTING_REGION, a.BUSINESS_AREA) as MAX_YTD_PNL FROM ( SELECT cob_date, pl_reporting_region AS pl_reporting_region, 'TOTAL' || ' ' || pl_reporting_region || ' excl. CVA, DVA, TCM' AS BUSINESS_AREA, SUM (ytd_pnl) AS ytd_pnl FROM pnl WHERE ccc_strategy NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'MS DVA STR NOTES IED', 'TCM ALLOCATION IED', 'TCM ALLOCATION OFFSET', 'PB - TCM ALLOCATION', 'OTHER - TCM ALLOCATION', 'DERIVS - TCM ALLOCATION', 'CASH - TCM ALLOCATION', 'IWM - TCM ALLOCATION') GROUP BY cob_date, pl_reporting_region ) a ) b WHERE b.YTD_PNL = b.MAX_YTD_PNL UNION ALL /* TOTAL excl. CVA, DVA, TCM' */ SELECT 'Total' AS Commissions, b.COB_DATE AS DATE_OF_MAX, b.PL_REPORTING_REGION AS PNL_REGION, BUSINESS_AREA, b.YTD_PNL AS MAX_YTD_PNL FROM ( SELECT a.COB_DATE, a.PL_REPORTING_REGION, a.BUSINESS_AREA, a.YTD_PNL, MAX (a.YTD_PNL) OVER (PARTITION BY a.PL_REPORTING_REGION, a.BUSINESS_AREA) as MAX_YTD_PNL FROM ( SELECT cob_date, 'TOTAL excl. CVA, DVA, TCM' AS pl_reporting_region, '' AS BUSINESS_AREA, SUM (ytd_pnl) AS ytd_pnl FROM pnl WHERE ccc_strategy NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'MS DVA STR NOTES IED', 'TCM ALLOCATION IED', 'TCM ALLOCATION OFFSET', 'PB - TCM ALLOCATION', 'OTHER - TCM ALLOCATION', 'DERIVS - TCM ALLOCATION', 'CASH - TCM ALLOCATION', 'IWM - TCM ALLOCATION') GROUP BY cob_date) a ) b WHERE b.YTD_PNL = b.MAX_YTD_PNL