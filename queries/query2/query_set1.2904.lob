WITH DIVISIONALRANK AS( SELECT d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION, RANK() OVER(ORDER BY ABS(sum(coalesce(d.USD_EQ_DELTA_DECOMP,0)))/1000 DESC) AS DIV_RANK, sum(coalesce(d.USD_EQ_DELTA_DECOMP,0))/1000 as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') AND d.LE_GROUP='UK' AND d.CCC_BANKING_TRADING='TRADING' GROUP BY d.COB_DATE, d.LE_GROUP, d.CCC_BANKING_TRADING, d.CCC_DIVISION ), DIVISION_SHORTNAME AS( SELECT d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END AS DIVISION FROM CDWUSER.U_DECOMP_MSR d WHERE d.COB_DATE IN ('2018-02-28') GROUP BY d.COB_DATE, d.CCC_DIVISION, CASE WHEN d.CCC_DIVISION ='FIXED INCOME DIVISION' THEN 'FID' ELSE d.DIVISION END ), PAYOFF_MOD_LIST AS( SELECT e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.PAYOFF_MODEL, RANK() OVER(ORDER BY ABS(sum(coalesce(e.USD_EQ_KAPPA,0)))DESC) as RANK, sum(coalesce(e.USD_EQ_KAPPA,0))/1000 as USD_EQ_KAPPA FROM CDWUSER.U_EQ_MSR e WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' AND e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK<>1) GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.PAYOFF_MODEL HAVING abs(sum(coalesce(e.USD_EQ_KAPPA,0)))>0 ) SELECT e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, n.DIVISION, CASE WHEN l.RANK<=5 THEN e.PAYOFF_MODEL ELSE 'Others' END as PAYOFF_MODEL, CASE WHEN e.CCC_DIVISION IN(SELECT CCC_DIVISION FROM DIVISIONALRANK WHERE DIV_RANK=1) THEN e.CCC_DIVISION ELSE e.CCC_BUSINESS_AREA END AS CCC_BUSINESS_AREA, CASE WHEN l.RANK<=5 THEN l.RANK ELSE 6 END RANK, sum(coalesce(e.USD_EQ_KAPPA,0))/1000 as USD_EQ_KAPPA FROM CDWUSER.U_EQ_MSR e LEFT JOIN PAYOFF_MOD_LIST l ON e.PAYOFF_MODEL=l.PAYOFF_MODEL INNER JOIN DIVISION_SHORTNAME n ON e.COB_DATE=n.COB_DATE AND e.CCC_DIVISION=n.CCC_DIVISION WHERE e.COB_DATE IN ('2018-02-28') AND e.LE_GROUP='UK' AND e.CCC_BANKING_TRADING='TRADING' GROUP BY e.COB_DATE, e.LE_GROUP, e.CCC_BANKING_TRADING, e.CCC_DIVISION, e.CCC_BUSINESS_AREA, CASE WHEN l.RANK<=5 THEN l.RANK ELSE 6 END, CASE WHEN l.RANK<=5 THEN e.PAYOFF_MODEL ELSE 'Others' END, n.DIVISION