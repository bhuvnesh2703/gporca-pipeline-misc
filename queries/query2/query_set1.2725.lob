with Partial_Decomp_EQ_AND_CM as ( select partial_decomp_tick, SUM(CM_Flag+EQ_Flag) as EQ_CM_Flag from ( select case when a.asset_class='EQ' then 1 else 0 end as CM_Flag, case when a.asset_class='CM' and (USD_CM_PARTIAL_DELTA <> 0.00 or USD_CM_PARTIAL_DELTA IS NULL) then 1 else 0 end as EQ_Flag, a.partial_decomp_tick from cdwuser.U_EXP_MSR_PARTIAL a where a.asset_class in('EQ', 'CM') and a.partial_decomp_tick is not null and a.cob_date='2018-02-28' and a.CASH_ISSUE_TYPE in ('ETF','INDEX') group by 1,2,3 ) a group by partial_decomp_tick having SUM(CM_Flag+EQ_Flag) =2 ), x as( select PRODUCT_DESCRIPTION,Vega, rank() over(order by abs(Vega)desc ) rank FROM ( select PRODUCT_DESCRIPTION,sum(Vega) Vega from ( select e.PRODUCT_DESCRIPTION, sum(coalesce(e.USD_EQ_KAPPA,0)) as Vega from cdwuser.U_EXP_MSR_PARTIAL e where e.DIVISION = 'IED' and e.CCC_BANKING_TRADING = 'TRADING' and cob_date='2018-02-28' and e.partial_decomp_tick in (select partial_decomp_tick from Partial_Decomp_EQ_AND_CM ) group by e.PRODUCT_DESCRIPTION union all select e.PRODUCT_DESCRIPTION, sum(coalesce(e.USD_EQ_KAPPA,0)) as Vega from cdwuser.U_EXP_MSR_PARTIAL e where e.DIVISION = 'IED' and e.CCC_BANKING_TRADING = 'TRADING' and cob_date='2018-02-28' and coalesce(e.PRODUCT_TYPE_CODE,'') = 'COMM' and e.partial_decomp_tick not in (select partial_decomp_tick from Partial_Decomp_EQ_AND_CM ) and USD_EQ_KAPPA is not null group by e.PRODUCT_DESCRIPTION )a group by PRODUCT_DESCRIPTION ) b ) select 'TopCMVega' as Concentration, Vega as Measure from x where rank=1 union all select 'NetCMVega' as Concentration, Sum(vega) as Measure from x