with src as (SELECT country_cd_of_risk as country, RATING_GRADE_CD as rating, SUM (case when cob_date = '2018-02-28' then coalesce(usd_pv01sprd, 0) else 0 end ) AS usd_pv01sprd_cob, SUM (case when cob_date = '2018-02-28' then coalesce(usd_pv01sprd, 0) else -coalesce(usd_pv01sprd, 0) end ) AS usd_pv01sprd_change FROM CDWUSER.u_exp_msr tr WHERE cob_date in ('2018-02-28', '2018-02-27') AND PARENT_LEGAL_ENTITY = '0302(G)' AND var_excl_fl <> 'Y' AND ccc_business_area IN ('FXEM MACRO TRADING', 'EM CREDIT TRADING') GROUP BY country_cd_of_risk, RATING_GRADE_CD ) , TOP AS ( SELECT RANK() OVER (ORDER BY ABS(SUM(USD_PV01SPRD_COB)) DESC) AS RANK, COUNTRY FROM SRC WHERE USD_PV01SPRD_COB <> 0 GROUP BY COUNTRY ) SELECT CASE WHEN RANK >= 11 THEN 11 ELSE TOP.RANK END AS RANK, CASE WHEN RANK >= 11 THEN 'Other' ELSE TOP.COUNTRY END AS COUNTRY, SRC.RATING, SUM(SRC.USD_PV01SPRD_COB) AS USD_PV01SPRD_COB, SUM(SRC.USD_PV01SPRD_CHANGE) AS USD_PV01SPRD_CHANGE FROM TOP LEFT JOIN SRC ON TOP.COUNTRY = SRC.COUNTRY GROUP BY CASE WHEN RANK >= 11 THEN 11 ELSE TOP.RANK END, CASE WHEN RANK >= 11 THEN 'Other' ELSE TOP.COUNTRY END, SRC.RATING