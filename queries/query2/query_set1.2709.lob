With x As (select e.COB_DATE, e.UNDERLIER_PRODUCT_DESCRIPTION, e.UNDERLIER_TICK||'.'||e.UNDERLIER_EXCH as Tickxchng, e.EXECUTIVE_MODEL, Case when e.cash_issue_type not in ('INDEX','MULASS','BASKET') then 1 else 0 end as SNFLag, sum(coalesce(e.SLIDE_EQ_MIN_30_USD,0) + .3*coalesce(e.USD_DELTA,0)) as D30, sum(coalesce(e.SLIDE_EQ_MIN_20_USD,0) + .20*coalesce(e.USD_DELTA,0)) as D20, sum(coalesce(e.SLIDE_EQ_MIN_10_USD,0) + .1*coalesce(e.USD_DELTA,0)) as D10, sum(coalesce(e.SLIDE_EQ_MIN_05_USD,0) + .05*coalesce(e.USD_DELTA,0)) as D5, sum(coalesce(e.SLIDE_EQ_PLS_05_USD,0) - .05*coalesce(e.USD_DELTA,0)) as P5, sum(coalesce(e.SLIDE_EQ_PLS_10_USD,0) - .1*coalesce(e.USD_DELTA,0)) as P10, sum(coalesce(e.SLIDE_EQ_PLS_20_USD,0) - .2*coalesce(e.USD_DELTA,0)) as P20 from cdwuser.U_EQ_MSR e where e.DIVISION = 'IED' and e.CCC_BANKING_TRADING = 'TRADING' and e.COB_DATE in ('2018-02-28', '2018-02-27') and e.CCC_PL_REPORTING_REGION = 'EMEA' group by Cob_Date, e.UNDERLIER_PRODUCT_DESCRIPTION, e.UNDERLIER_TICK||'.'||e.UNDERLIER_EXCH, e.EXECUTIVE_MODEL, Case when e.cash_issue_type not in ('INDEX','MULASS','BASKET') then 1 else 0 end) , xMrank as (select Executive_Model, Rank() over (order by abs(sum(case when cob_date = '2018-02-28' then D30 else 0 end)) desc) as ModelRank from x group by Executive_Model) (select Rank() over (order by abs(sum(case when cob_date = '2018-02-28' and ModelRank < 19 then D30 else 0 end)) desc)||'_'||'TopModelSlide' as Concentration, case when ModelRank < 19 then x.executive_model else 'Others' end as Category, 'N/A' as Tickxchng, sum(case when cob_date = '2018-02-28' then D30 else 0 end) as D30_COB, sum(case when cob_date = '2018-02-28' then D30 else -D30 end) as D30_DOD, sum(case when cob_date = '2018-02-28' then D20 else 0 end) as D20_COB, sum(case when cob_date = '2018-02-28' then D10 else 0 end) as D10_COB, sum(case when cob_date = '2018-02-28' then D5 else 0 end) as D5_COB, sum(case when cob_date = '2018-02-28' then D5 else -D5 end) as D5_DOD, sum(case when cob_date = '2018-02-28' then P5 else 0 end) as P5_COB, sum(case when cob_date = '2018-02-28' then P10 else 0 end) as P10_COB, sum(case when cob_date = '2018-02-28' then P10 else -P10 end) as P10_DOD, sum(case when cob_date = '2018-02-28' then P20 else 0 end) as P20_COB from x inner join xMrank on x.Executive_Model = xMRank.executive_model group by case when ModelRank < 19 then x.executive_model else 'Others' end) Union All (select Rank() over (order by greatest(abs(D30_COB),abs(D20_COB),abs(D10_COB),abs(D5_COB),abs(P5_COB),abs(P10_COB),abs(P20_COB)) desc)||'_'||'TopDeltaSlide' as Concentration, Category, Tickxchng, D30_COB,D30_DOD,D20_COB,D10_COB,D5_COB,D5_DOD,P5_COB , P10_COB, P10_DOD, P20_COB From (select x.underlier_product_description as Category, Tickxchng, sum(case when cob_date = '2018-02-28' then D30 else 0 end) as D30_COB, sum(case when cob_date = '2018-02-28' then D30 else -D30 end) as D30_DOD, sum(case when cob_date = '2018-02-28' then D20 else 0 end) as D20_COB, sum(case when cob_date = '2018-02-28' then D10 else 0 end) as D10_COB, sum(case when cob_date = '2018-02-28' then D5 else 0 end) as D5_COB, sum(case when cob_date = '2018-02-28' then D5 else -D5 end) as D5_DOD, sum(case when cob_date = '2018-02-28' then P5 else 0 end) as P5_COB, sum(case when cob_date = '2018-02-28' then P10 else 0 end) as P10_COB, sum(case when cob_date = '2018-02-28' then P10 else -P10 end) as P10_DOD, sum(case when cob_date = '2018-02-28' then P20 else 0 end) as P20_COB from x Where SNFlag = 1 group by underlier_product_description, Tickxchng) a fetch first 12 rows only)