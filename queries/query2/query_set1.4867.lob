SELECT Sum(IS_INCLUDED_PNL - delta_PNL) AS DELTA_ADJ_PNL, sum(IS_INCLUDED_PNL) AS IS_INCLUDED_PNL, CCC_PRODUCT_LINE, STORAGE_FLAG, COB_DATE, ccc_strategy, ccc_Strategy_details, STRESS_SCENARIO, SUBPROD_PRODUCT_TYPE, SUBPROD_PRODUCT_SUBTYPE FROM ( SELECT 'CM_MOD' AS src, PVT.COB_DATE, ccc_Strategy, ccc_Strategy_details, CASE WHEN book = '2860' THEN 'COMMOD INDEX' ELSE PVT.ccc_product_line END AS CCC_product_line, PVT.attribution, Stress_Scenario, CASE WHEN Ccc_product_line = 'PRECIOUS METALS' THEN 'PRECIOUSMETAL' WHEN ccc_strategy = 'BASE METALS' THEN 'BASEMETAL' ELSE subprod_product_type END AS subprod_product_type, CASE WHEN SUBPROD_PRODUCT_SUBTYPE IN ('ALUMINUM', 'ALUMINUM-20MT') THEN 'ALUMINUM' WHEN ( Ccc_product_line = 'PRECIOUS METALS' AND subprod_product_subtype = 'PM SPREADS' ) OR ( Ccc_product_line = 'PRECIOUS METALS' AND product_sub_type_name = 'LISTEDOPTION' AND subprod_product_subtype IS NULL ) THEN 'PM SPREADS' ELSE SUBPROD_PRODUCT_SUBTYPE END AS SUBPROD_PRODUCT_SUBTYPE, CASE WHEN risk_run_custom1 = 'STORAGE' THEN 'Storage' ELSE 'No Storage' END AS Storage_Flag, Sum(CASE WHEN SCENARIO_TYPE = 'GREEK' AND ATTRIBUTION = 'CM DELTA' THEN SCENARIO_PNL ELSE 0 END) AS delta_PNL, SUM(CASE WHEN IS_INCLUDED = 'YES' THEN PVT.SCENARIO_PNL ELSE 0 END) AS IS_INCLUDED_PNL FROM DWUSER.U_MODULAR_SCENARIOS PVT where COB_DATE in ('2018-02-21') AND Run_profile = 'CM_MOD_SCN_RUN' AND PVT.CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' AND coalesce(pvt.subprod_product_type, 'null') NOT IN ('CURRENCY', 'CREDIT', 'INTEREST RATE', 'WEATHER') AND ( ccc_strategy not in ( 'CVA RISK MANAGEMENT','FUNDING COLLATERAL COMM') OR book = '2860' ) AND book <> '12165' AND NOT ( ATTRIBUTION = 'CM GAMMA' AND has_crossgamma = 'Y' ) AND stress_scenario LIKE 'CM_PRICE%' GROUP BY PVT.COB_DATE, ccc_strategy, ccc_Strategy_details, ccc_product_line, ccc_strategy, product_sub_type_name, CASE WHEN book = '2860' THEN 'COMMOD INDEX' ELSE PVT.ccc_product_line END, PVT.attribution, subprod_product_type, SUBPROD_PRODUCT_SUBTYPE, CASE WHEN risk_run_custom1 = 'STORAGE' THEN 'Storage' ELSE 'No Storage' END, Stress_Scenario ) a GROUP BY CCC_PRODUCT_LINE, STORAGE_FLAG, COB_DATE, ccc_strategy, ccc_Strategy_details, STRESS_SCENARIO, SUBPROD_PRODUCT_TYPE, SUBPROD_PRODUCT_SUBTYPE