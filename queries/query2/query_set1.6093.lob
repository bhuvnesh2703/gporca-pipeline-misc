WITH EXPOSURES AS  ( SELECT     COB_DATE,     POSITION_ISSUER_PARTY_DARWIN_NAME,     SUM(CASE WHEN PRODUCT_TYPE_CODE = 'EQUITY' THEN USD_DELTA ELSE USD_NET_EXPOSURE END) AS Net_Exposure      FROM     (         SELECT             a.COB_DATE,             a.CCC_PL_REPORTING_REGION,             a.SILO_SRC,             CASE WHEN a.POSITION_ISSUER_PARTY_DARWIN_NAME LIKE '%REPUBLIC OF CHINA' THEN a.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME                 ELSE a.POSITION_ISSUER_PARTY_DARWIN_NAME END AS POSITION_ISSUER_PARTY_DARWIN_NAME,             CASE WHEN a.PRODUCT_TYPE_CODE IN ('ADR', 'FUTURE', 'OPTION', 'STOCK', 'WARRANT', 'SWAP', 'WARRNT', 'ETF') THEN 'EQUITY' WHEN                  a.PRODUCT_TYPE_CODE IN ('BOND', 'ASCOT', 'CONVRT') THEN 'CONVERT' WHEN a.PRODUCT_TYPE_CODE IN ('DEFSWAP', 'CRDINDEX')                  THEN 'CDS'             ELSE a.PRODUCT_TYPE_CODE END AS PRODUCT_TYPE_CODE,             SUM (a.USD_DELTA) AS USD_DELTA,             SUM (a.USD_PV01SPRD) AS SPREAD_PV01_USD,             SUM (COALESCE (a.USD_CREDIT_PV10PCT,                            0)) + SUM (COALESCE (a.USD_PV10_BENCH,                                                 0)) AS USD_PV10,             SUM (a.USD_MARKET_VALUE) AS USD_MARKET_VALUE,             SUM (a.USD_EXPOSURE) AS USD_NET_EXPOSURE,             CASE WHEN SUM (a.USD_EXPOSURE) IS NULL THEN SUM (a.USD_DELTA)             ELSE SUM (a.USD_EXPOSURE) END AS JTD         FROM cdwuser.U_EXP_MSR a  WHERE (a.COB_DATE = '2018-02-28' or a.COB_DATE = '2018-02-27') AND a.LE_GROUP = 'UK' AND              a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' AND             a.CCC_PRODUCT_LINE = 'CONVERTIBLE PRODUCTS' AND             a.CCC_BANKING_TRADING = 'TRADING' AND             a.FID1_INDUSTRY_NAME_LEVEL2 NOT IN ('SOVEREIGNS')          GROUP BY             a.COB_DATE,             a.CCC_PL_REPORTING_REGION,             a.SILO_SRC,             CASE WHEN a.POSITION_ISSUER_PARTY_DARWIN_NAME LIKE '%REPUBLIC OF CHINA' THEN a.POSITION_CHILD_ISSUER_PARTY_DARWIN_NAME                 ELSE a.POSITION_ISSUER_PARTY_DARWIN_NAME END,             CASE WHEN a.PRODUCT_TYPE_CODE IN ('ADR', 'FUTURE', 'OPTION', 'STOCK', 'WARRANT', 'SWAP', 'WARRNT', 'ETF') THEN 'EQUITY' WHEN                  a.PRODUCT_TYPE_CODE IN ('BOND', 'ASCOT', 'CONVRT') THEN 'CONVERT' WHEN a.PRODUCT_TYPE_CODE IN ('DEFSWAP', 'CRDINDEX')                  THEN 'CDS'             ELSE a.PRODUCT_TYPE_CODE END     )     sub_qry WHERE POSITION_ISSUER_PARTY_DARWIN_NAME <> 'UNDEFINED' GROUP BY  COB_DATE,     POSITION_ISSUER_PARTY_DARWIN_NAME ) ,  CURR AS ( SELECT *  FROM (     SELECT a.*,     RANK() OVER (PARTITION BY COB_DATE ORDER BY ABS(COALESCE(NET_EXPOSURE,0)) DESC) AS RANK     FROM EXPOSURES a     WHERE a.COB_DATE = '2018-02-28' ) x WHERE RANK <= 5 )  SELECT  a.COB_DATE, a.POSITION_ISSUER_PARTY_DARWIN_NAME, a.NET_EXPOSURE, abs(a.NET_EXPOSURE) as ABS_NET_EXPOSURE FROM CURR a  UNION ALL  SELECT  a.COB_DATE, a.POSITION_ISSUER_PARTY_DARWIN_NAME, a.NET_EXPOSURE, abs(a.NET_EXPOSURE) as ABS_NET_EXPOSURE FROM EXPOSURES a WHERE a.COB_DATE = '2018-02-27' AND a.POSITION_ISSUER_PARTY_DARWIN_NAME IN  ( SELECT POSITION_ISSUER_PARTY_DARWIN_NAME FROM CURR )