Select cob_date, case when SOURCE_SCN_NAME='FRB2017_SA_FX_All' then 'FRB2017_SA_FX_ALL' else SOURCE_SCN_NAME end as stress_scenario, 'Full Reval' as category, ccc_division, ccar_business_category, product_type, currency_pair, case when bu_risk_system like '%FXOPT%' then 'FXOPT' else bu_risk_system end as vertical_system, SUM(RAW_PNL)/1000 as pnl FROM DWUSER.U_RAW_SCENARIO_PNL WHERE COB_DATE = '2018-02-28' and bu_risk_system like '%FXOPT%' and product_type='FXOPT' and SOURCE_SCN_NAME in ( 'BHC2017_S1_EQ_ALL', 'BHC2017_S1_CR_ALL', 'FRB2017_SA_EQ_ALL', 'FRB2017_SA_CR_ALL', 'FRB2017_SA_EQ_All', 'BHC2017_S1_CM_ALL', 'FRB2017_SA_CM_ALL', 'FRB2017_SA_CM_All',  'BHC2017_S1_IR_ALL', 'FRB2017_SA_IR_ALL', 'FRB2017_SA_IR_All', 'BHC2017_S1', 'FRB2017_SA' ) and ccar_business_category <> 'NOT_INCLUDED' group by cob_date, SOURCE_SCN_NAME, product_type, currency_pair, ccc_division, ccar_business_category, bu_risk_system UNION ALL SELECT cob_date, stress_scenario, attribution as category, ccc_division, CASE WHEN BOOK = 'CHINS' THEN 'NOT INCLUDED - CVA Manual' WHEN BOOK IN ('FVNN2', 'FVNT2', 'FVNL3', 'CVPN1') THEN 'NOT INCLUDED - CVA Manual 2' WHEN BOOK = 'COCOL' THEN 'CVA TRADING' ELSE CCAR_BUSINESS_CATEGORY END AS ccar_business_category, product_type,  case when (scenario_dimension = 'FX PRICE' and length(measure_currency)=3 and measure_currency in ('EUR', 'AUD','GBP','NZD' ))  then concat(measure_currency,'USD') when (scenario_dimension = 'FX PRICE' and length(measure_currency)=3 and measure_currency not in ('EUR', 'AUD','GBP','NZD' )) then concat('USD',measure_currency) when (scenario_dimension = 'FX VOLATILITY' and length(measure_currency)=3 and measure_currency in ('EUR', 'AUD','GBP','NZD' ))  then concat(measure_currency,'USD') when (scenario_dimension = 'FX VOLATILITY' and length(measure_currency)=3 and measure_currency not in ('EUR', 'AUD','GBP','NZD' )) then concat('USD',measure_currency) else measure_currency end as currency_pair, CASE WHEN risk_system LIKE '%BANKLOANS%' THEN 'BANKLOANS' WHEN risk_system LIKE '%BT%' THEN 'BT' WHEN risk_system LIKE '%C1%' THEN 'C1' WHEN risk_system LIKE '%FXDDI%' THEN 'FXDDI' WHEN risk_system LIKE '%FXOPT%' THEN 'FXOPT' WHEN risk_system LIKE '%GWM%' THEN 'GWM' WHEN risk_system LIKE '%IRD%' THEN 'STS' WHEN risk_system LIKE '%PERSIST%' THEN 'PERSIST' WHEN risk_system LIKE '%SPG%' OR risk_system LIKE '%MBS%' THEN 'SPG' WHEN risk_system LIKE 'STS_%' THEN 'STS' WHEN risk_system LIKE '%RETAIL%' THEN 'GWM' WHEN risk_system LIKE '%REPO%' THEN 'REPO' WHEN (RISK_SYSTEM LIKE 'EQUITY%' OR RISK_SYSTEM = 'R1') THEN 'GRS' WHEN RISK_SYSTEM LIKE '%MSIM%' THEN 'MSIM' ELSE (CASE WHEN ccc_division = 'COMMODITIES' THEN 'CORISK' WHEN RISK_SYSTEM IN ('NY-EXTERN-STRATES', 'PM-FXPB', 'PM-IR', 'PM-OPTIONS') THEN 'CORISK' ELSE 'OTHER' END) END AS VERTICAL_SYSTEM, SUM ( CASE WHEN attribution = 'FX VEGA' AND ccc_division = 'COMMODITIES' AND (risk_system NOT LIKE '%BANKLOANS%' AND risk_system NOT LIKE '%BT%' AND risk_system NOT LIKE '%C1%' AND risk_system NOT LIKE '%FXDDI%' AND risk_system NOT LIKE '%FXOPT%' AND risk_system NOT LIKE '%GWM%' AND risk_system NOT LIKE '%IRD%' AND risk_system NOT LIKE '%PERSIST%' AND risk_system NOT LIKE '%SPG%' AND risk_system NOT LIKE '%MBS%' AND risk_system NOT LIKE 'STS_%' AND risk_system NOT LIKE '%RETAIL%' AND risk_system NOT LIKE '%REPO%') THEN scenario_pnl / 10 WHEN (risk_system not LIKE 'STS_%' AND stress_scenario='BHC2017_S1_FX_ALL' and scenario_dimension = 'FX PRICE'  and measure_currency='BRL') then scenario_pnl*(-0.3082/-0.3482) WHEN (risk_system not LIKE 'STS_%' AND stress_scenario='BHC2017_S1_FX_ALL' and scenario_dimension = 'FX PRICE'  and measure_currency='BRX') then scenario_pnl*(-0.3482/-0.3082) WHEN (risk_system not LIKE 'STS_%' AND stress_scenario='BHC2017_S1_FX_ALL' and scenario_dimension = 'FX PRICE'  and measure_currency='BR1') then scenario_pnl*(-0.3482/-0.3082) WHEN (risk_system not LIKE 'STS_%' AND stress_scenario='BHC2017_S1_FX_ALL' and scenario_dimension = 'FX PRICE'  and measure_currency='RUB') then scenario_pnl*(-0.2527/-0.2127) WHEN (risk_system not LIKE 'STS_%' AND stress_scenario='BHC2017_S1_FX_ALL' and scenario_dimension = 'FX PRICE'  and measure_currency='RBX') then scenario_pnl*(-0.2127/-0.2527) WHEN (risk_system not LIKE 'STS_%' AND stress_scenario='BHC2017_S1_FX_ALL' and scenario_dimension = 'FX PRICE'  and measure_currency='RU1') then scenario_pnl*(-0.2127/-0.2527) ELSE scenario_pnl END)/1000 AS pnl FROM dwuser.u_modular_scenarios_ccar WHERE COB_DATE = '2018-02-28' AND stress_scenario in ( 'BHC2017_S1_EQ_ALL', 'BHC2017_S1_CR_ALL', 'FRB2017_SA_EQ_ALL', 'FRB2017_SA_EQ_All', 'FRB2017_SA_CR_ALL', 'BHC2017_S1_CM_ALL', 'FRB2017_SA_CM_ALL', 'FRB2017_SA_CM_All', 'BHC2017_S1_IR_ALL', 'FRB2017_SA_IR_ALL', 'FRB2017_SA_IR_All', 'BHC2017_S1', 'FRB2017_SA' ) AND SCENARIO_TYPE = 'GREEK' AND NOT (RISK_SYSTEM LIKE '%FXOPT%' and product_type = 'FXOPT') AND NOT (risk_system like '%FXDDI%' and hedge_strategy_name = 'HEDGE ALL') AND RISK_SYSTEM NOT LIKE '%SILO' AND (CCAR_BUSINESS_CATEGORY NOT LIKE 'NOT%' OR BOOK = 'MBREIFUNDHEDGES') AND NOT (CCAR_ASSET_PRODUCT_CATEGORY IN ('EQ: PRIVATE') AND (RISK_SYSTEM LIKE '%EQUITY%' OR RISK_SYSTEM = 'R1')) AND NOT (HAS_CROSSGAMMA = 'Y' AND ATTRIBUTION = 'CM GAMMA') AND NOT(include_in_reg_cap = 'N') AND NOT (ccc_division = 'COMMODITIES' AND PRODUCT_LINE = 'EXTERNAL DESKS') AND NOT (ccc_division IN ('FIC DVA', 'TREASURY CAPITAL MARKETS', 'OVERHEAD INTEREST', 'UNDEFINED')) AND NOT (SCENARIO_DIMENSION IN ('CR PRICE', 'CR HAZARD SPREAD', 'CR PRICE;CR HAZARD SPREAD') AND UPPER (PRODUCT_TYPE) IN ('CD', 'CP', 'ABS', 'AGN', 'AGNCMO', 'BERMUDAN_SWAPTION_VA', 'CAP', 'CASH', 'CLNCLN', 'COMM', 'COMMFUT', 'COMOPT', 'CURRENCY FORWARD', 'CVA', 'DEPOSIT', 'EQFUT', 'EQOPT', 'EQUITY', 'EQUITYALPHA', 'ETF', 'FEE', 'FLOOR', 'FX', 'FX FORWARD-T', 'FXBSKT', 'FXFUTURES', 'FXOPT', 'IDIOPT', 'IROPT', 'LOAN_RESIARM', 'LOAN_RESIFIX', 'MBSOPT', 'MISC', 'MMF', 'MUNI', 'MUNICDS', 'MUNICDX', 'RATEFUT', 'RATEFUTOPT', 'REPO', 'RMBS', 'SWAPIL', 'SWAPTION', 'TOB', 'MUNI ETF', 'SWAPNOTE', 'MUNI_TAXABLE', 'PREF', 'BERMDISC', 'CAPFLOOR', 'CMSCAPFLOOR', 'CMS', 'ARREARS', 'ZBOND', 'ASCOT', 'ADR', 'ETF', 'FUTURE', 'OPTION', 'STOCK', 'WARRNT', 'SWAP') AND PRODUCT_TYPE || '.' || PRODUCT_HIERARCHY_LEVEL_7 <> 'ZCS.IR_SWAPTION_BERMUDAN' AND ( (CCAR_ASSET_PRODUCT_CATEGORY NOT LIKE 'EQ%' AND CCAR_ASSET_PRODUCT_CATEGORY NOT LIKE 'CM%' AND CCAR_ASSET_PRODUCT_CATEGORY NOT LIKE 'AGENCIES:%' AND CCAR_ASSET_PRODUCT_CATEGORY NOT LIKE 'SECURITIZED:%' AND CCAR_ASSET_PRODUCT_CATEGORY NOT LIKE 'ARS:%' AND CCAR_ASSET_PRODUCT_CATEGORY NOT LIKE 'MUNIS:%' AND spg_description != 'AGENCY CMBS IO') OR PRODUCT_TYPE = 'TRS LOAN ETF' ) AND NOT (PRODUCT_HIERARCHY_LEVEL_7 IN ('OTHER AGENCY-MEDIUM TERM NOTE-NON-CALLABLE & NON-PUTABLE', 'US AGENCY-INTERMEDIATE AND LT DEBT-NON CALLPUT', 'US AGENCY-MEDIUM TERM NOTE-NON-CALLABLE & NON-PUTABLE') OR PRODUCT_TYPE = 'AGN') AND (CCAR_ASSET_PRODUCT_CATEGORY LIKE 'ADV%' OR CCAR_ASSET_PRODUCT_CATEGORY LIKE 'EM%' OR CCAR_ASSET_PRODUCT_CATEGORY LIKE 'SOV%')) AND BOOK NOT IN ('CHINS', 'FVNN2', 'FVNT2', 'FVNL3', 'CVPN1') AND (CCAR_BUSINESS_CATEGORY NOT LIKE 'NOT%' OR CCC_BUSINESS_AREA IN ('GLOBAL EQUITY ADMIN & DEV', 'SEED CAPITAL HEDGE - EQ', 'MANAGED FUTURES HC & ADMIN', 'BRM COLLATERAL RISK MGMT') OR BOOK IN ('WORKOUT - LEV CRED', 'WORKOUT- EQUITY', 'PROP WORKOUT - EQUITY NAM', 'RES FINCO AGNEW SHLEUR-RESFI', 'CATRC', 'NALEV', 'LONDON LEVERAGED CREDIT TRANSFERRED-LNLCT', 'NORTH AMERICA LEVERAGED CREDIT-NALCT', 'BRTRC', 'LNPIN')) GROUP BY cob_date, ccar_business_category, stress_scenario, ccc_division, product_type, risk_system, attribution, scenario_dimension, measure_currency, book