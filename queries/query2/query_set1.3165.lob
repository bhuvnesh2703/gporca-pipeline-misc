WITH z as ( SELECT COB_DATE, CCC_PL_REPORTING_REGION, CCC_TAPS_COMPANY,UNDERLIER,ISSUER_COUNTRY_CODE_DECOMP, NUMERATOR /(CASE WHEN (DENOMINATOR = 0 OR DENOMINATOR IS NULL) THEN 1 ELSE DENOMINATOR END) RATIO FROM ( SELECT COB_DATE, CCC_PL_REPORTING_REGION, CCC_TAPS_COMPANY, UNDERLIER, ISSUER_COUNTRY_CODE_DECOMP, ABS(USD_EQ_DELTA_DECOMP) NUMERATOR , ABS(SUM(USD_EQ_DELTA_DECOMP) OVER(PARTITION BY COB_DATE,CCC_PL_REPORTING_REGION,CCC_TAPS_COMPANY,UNDERLIER)) DENOMINATOR FROM ( SELECT a.COB_DATE, CASE WHEN a.CCC_PL_REPORTING_REGION = 'EMEA' THEN 'EMEA' WHEN a.CCC_PL_REPORTING_REGION = 'AMERICAS' THEN 'AMERICAS' WHEN a.CCC_PL_REPORTING_REGION IN ('ASIA PACIFIC','JAPAN') THEN 'ASIA' ELSE 'Others' END AS CCC_PL_REPORTING_REGION, CASE WHEN a.CCC_TAPS_COMPANY = '0302' THEN 'MSIP' WHEN a.CCC_TAPS_COMPANY in ('4663','7281','5274','5254','8179','7280','6262','1311','8292','0721','4391','0517') THEN 'MSBIL' WHEN a.CCC_TAPS_COMPANY = '0319' THEN 'MSIM' ELSE 'Other' END as CCC_TAPS_COMPANY, a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH as UNDERLIER, a.ISSUER_COUNTRY_CODE_DECOMP, (sum(coalesce(a.USD_EQ_DELTA_DECOMP,0))) as USD_EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND a.USD_EQ_DELTA_DECOMP <> 0 AND a.CCC_BANKING_TRADING = 'TRADING' AND (a.CCC_BUSINESS_AREA NOT IN ('CPM TRADING (MPE)', 'CPM','CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') AND a.CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'EQ XVA HEDGING')) AND a.LE_GROUP = 'UK' GROUP BY 1,2,3,4,5 )a )b ), x as ( SELECT a.COB_DATE, a.CCC_PL_REPORTING_REGION, a.CCC_TAPS_COMPANY, a.TICKER_PARTIAL,a.UNDERLIER, CASE WHEN p.UNDERLIER IS NOT NULL THEN TICKER_PARTIAL ELSE a.UNDERLIER END AS TICKER_FINAL, SUM(USD_EQ_PARTIAL_KAPPA) USD_EQ_PARTIAL_KAPPA FROM ( SELECT a.COB_DATE, CASE WHEN a.CCC_PL_REPORTING_REGION = 'EMEA' THEN 'EMEA' WHEN a.CCC_PL_REPORTING_REGION = 'AMERICAS' THEN 'AMERICAS' WHEN a.CCC_PL_REPORTING_REGION IN ('ASIA PACIFIC','JAPAN') THEN 'ASIA' ELSE 'Others' END AS CCC_PL_REPORTING_REGION, CASE WHEN a.CCC_TAPS_COMPANY = '0302' THEN 'MSIP' WHEN a.CCC_TAPS_COMPANY in ('4663','7281','5274','5254','8179','7280','6262','1311','8292','0721','4391','0517') THEN 'MSBIL' WHEN a.CCC_TAPS_COMPANY = '0319' THEN 'MSIM' ELSE 'Other' END as CCC_TAPS_COMPANY, a.PARTIAL_DECOMP_TICK || '.' || a.PARTIAL_DECOMP_EXCHANGE AS TICKER_PARTIAL, a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH AS UNDERLIER, SUM(CASE WHEN a.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' THEN (COALESCE (a.USD_EQ_PARTIAL_KAPPA,0)) ELSE (COALESCE (a.USD_EQ_KAPPA,0)) END) AS USD_EQ_PARTIAL_KAPPA FROM CDWUSER.U_EXP_MSR_PARTIAL a WHERE a.COB_DATE in ('2018-02-28','2018-02-27') AND (a.USD_EQ_KAPPA <> 0 OR a.USD_EQ_PARTIAL_KAPPA <> 0) AND a.CCC_BANKING_TRADING = 'TRADING' AND (a.CCC_BUSINESS_AREA NOT IN ('CPM TRADING (MPE)', 'CPM','CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') AND a.CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'EQ XVA HEDGING')) AND a.LE_GROUP = 'UK' GROUP BY 1,2,3,4,5 ) a LEFT OUTER JOIN ( SELECT UNDERLIER_TICK || '.' || UNDERLIER_EXCH UNDERLIER FROM CDWUSER.U_DECOMP_MSR WHERE COB_DATE in ('2018-02-28','2018-02-27') AND USD_EQ_DELTA_DECOMP <> 0 AND CCC_BANKING_TRADING = 'TRADING' AND (CCC_BUSINESS_AREA NOT IN ('CPM TRADING (MPE)', 'CPM','CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') AND CCC_STRATEGY NOT IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES', 'EQ XVA HEDGING')) AND LE_GROUP = 'UK' GROUP BY 1 ) p ON a.TICKER_PARTIAL = p.UNDERLIER GROUP BY 1,2,3,4,5,6 ) SELECT COB_DATE, CCC_PL_REPORTING_REGION, CCC_TAPS_COMPANY, AREA, SUM(USD_KAPPA_COUNTRY) AS USD_KAPPA_COUNTRY FROM ( SELECT x.COB_DATE, x.CCC_PL_REPORTING_REGION, x.CCC_TAPS_COMPANY, x.TICKER_FINAL, CASE WHEN z.ISSUER_COUNTRY_CODE_DECOMP IN ('USA','CAN') THEN 'NAM' WHEN z.ISSUER_COUNTRY_CODE_DECOMP IN ('ALB','AND','AUT','BLR','BEL','BIH','BGR','CYP','HRV','CZE','DNK','EST','FRO','FIN','FRA','GEO','DEU','GRC','GGY','VAT','HUN','ISL','IRL','IMN','ITA','JEY','LVA','LIE','LTU','LUX','MKD','MLT','MDA','MCO','MNE','NLD','NOR','POL','PRT','ROU','RUS','SMR','SRB','SVK','SVN','ESP','SJM','SWE','CHE','UKR') THEN 'Europe' WHEN z.ISSUER_COUNTRY_CODE_DECOMP IN ('GBR') THEN 'UK' WHEN z.ISSUER_COUNTRY_CODE_DECOMP IN ('CHN') THEN 'China' WHEN z.ISSUER_COUNTRY_CODE_DECOMP IN ('HKG') THEN 'Hong Kong' WHEN z.ISSUER_COUNTRY_CODE_DECOMP IN ('JPN') THEN 'Japan' ELSE 'Other' END as AREA, z.ISSUER_COUNTRY_CODE_DECOMP, SUM(x.USD_EQ_PARTIAL_KAPPA * z.Ratio ) AS USD_KAPPA_COUNTRY FROM x LEFT JOIN z ON (x.COB_DATE, x.CCC_PL_REPORTING_REGION,x.CCC_TAPS_COMPANY,x.TICKER_FINAL) = (z.COB_DATE,z.CCC_PL_REPORTING_REGION,z.CCC_TAPS_COMPANY,z.UNDERLIER) where x.TICKER_FINAL <> 'UNDEFINED.UNDEFINED' group by 1,2,3,4,5,6 ) a GROUP BY COB_DATE, CCC_PL_REPORTING_REGION, AREA, CCC_TAPS_COMPANY