WITH CM_SLIDES AS( SELECT a.UNDERLIER_PRODUCT_DESCRIPTION, sum(a.SLIDE_MIN_30_USD) as SLIDE_MIN_30_USD, sum(a.SLIDE_MIN_20_USD) as SLIDE_MIN_20_USD, sum(a.SLIDE_MIN_10_USD) as SLIDE_MIN_10_USD, sum(a.SLIDE_MIN_05_USD) as SLIDE_MIN_05_USD, sum(a.SLIDE_PLS_05_USD) as SLIDE_PLS_05_USD, sum(a.SLIDE_PLS_10_USD) as SLIDE_PLS_10_USD, sum(a.SLIDE_PLS_20_USD) as SLIDE_PLS_20_USD, LEAST(sum(a.SLIDE_MIN_30_USD), sum(a.SLIDE_MIN_20_USD), sum(a.SLIDE_MIN_10_USD), sum(a.SLIDE_MIN_05_USD), sum(a.SLIDE_PLS_05_USD), sum(a.SLIDE_PLS_10_USD), sum(a.SLIDE_PLS_20_USD)) as SLIDES_MIN FROM ( SELECT CASE WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('bcoil.msny','spgsbrp.iomr') THEN 'BRENT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xau=.idnr','spgsgcp.iomr','sgld.l', 'xau.us', 'xau=.shd') THEN 'GOLD' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgssip.iomr','xag=.idnr', 'xag=.shd') THEN 'SILVER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpt=.shd','xpt=.idnr') THEN 'PLATINUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpd=.shd','xpd=.idnr') THEN 'PALLADIUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('sb.msny') THEN 'SUGAR' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('wti.msdy') THEN 'WTI' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgscnp.iomr','ng-w-hh.shd') THEN 'NAT GAS' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgskcp.iomr','kc.msny') THEN 'COFFEE' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgswhp.iomr','2srw-kcm.idn') THEN 'WHEAT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cc.msny','spgsccp.iomr') THEN 'COCOA' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cttn.msny') THEN 'COTTON' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('c-us2y-kc.idn') THEN 'CORN' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cmcu3.lmer') THEN 'LME COPPER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('hg.msny') THEN 'HG COPPER' ELSE a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH END as UNDERLIER_PRODUCT_DESCRIPTION, a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH as Ticker, sum(a.SLIDE_CM_MIN_30_USD) as SLIDE_MIN_30_USD, sum(a.SLIDE_CM_MIN_20_USD) as SLIDE_MIN_20_USD, sum(a.SLIDE_CM_MIN_10_USD) as SLIDE_MIN_10_USD, sum(a.SLIDE_CM_MIN_05_USD) as SLIDE_MIN_05_USD, sum(a.SLIDE_CM_PLS_05_USD) as SLIDE_PLS_05_USD, sum(a.SLIDE_CM_PLS_10_USD) as SLIDE_PLS_10_USD, sum(a.SLIDE_CM_PLS_20_USD) as SLIDE_PLS_20_USD FROM CDWUSER.U_EXP_MSR a WHERE a.COB_DATE ='2018-02-28' AND a.CASH_ISSUE_TYPE in ('CMDT','COMM') AND a.CCC_RISK_MANAGER_LOGIN = 'freemric' GROUP BY CASE WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('bcoil.msny','spgsbrp.iomr') THEN 'BRENT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xau=.idnr','spgsgcp.iomr','sgld.l', 'xau.us', 'xau=.shd') THEN 'GOLD' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgssip.iomr','xag=.idnr', 'xag=.shd') THEN 'SILVER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpt=.shd','xpt=.idnr') THEN 'PLATINUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('xpd=.shd','xpd=.idnr') THEN 'PALLADIUM' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('sb.msny') THEN 'SUGAR' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('wti.msdy') THEN 'WTI' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgscnp.iomr','ng-w-hh.shd') THEN 'NAT GAS' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgskcp.iomr','kc.msny') THEN 'COFFEE' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('spgswhp.iomr','2srw-kcm.idn') THEN 'WHEAT' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cc.msny','spgsccp.iomr') THEN 'COCOA' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cttn.msny') THEN 'COTTON' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('c-us2y-kc.idn') THEN 'CORN' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('cmcu3.lmer') THEN 'LME COPPER' WHEN a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH in ('hg.msny') THEN 'HG COPPER' ELSE a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH END, a.UNDERLIER_TICK || '.' || a.UNDERLIER_EXCH ) a GROUP BY a.UNDERLIER_PRODUCT_DESCRIPTION ) SELECT UNDERLIER_PRODUCT_DESCRIPTION, SLIDE_MIN_30_USD, SLIDE_MIN_20_USD, SLIDE_MIN_10_USD, SLIDE_MIN_05_USD, SLIDE_PLS_05_USD, SLIDE_PLS_10_USD, SLIDE_PLS_20_USD, RANK() OVER(ORDER BY SLIDES_MIN ASC) AS RANK FROM CM_SLIDES