Select a.BU_RISK_RUN_CUSTOM1, a.COB_DATE,a.CCC_PL_REPORTING_REGION, a.PRODUCT_TYPE_CODE, a.LOCATION_GROUP, a.TIME_BUCKET_CALENDAR, a.QUARTERS, SUM(a.DOLLAR_GREEK) as DOLLAR_GREEK, SUM(a.RAW_GREEK) as RAW_GREEK From ( select job_cmdty_code, prod_pos_name_description, CCC_PRODUCT_LINE,product_sub_type_code, product_type_code, CMDTY_CD,EXPIRATION_DATE,time_bucket_quarter,CCC_TRD_BOOK, product_sub_type_name,COB_DATE,CCC_BUSINESS_AREA,TIME_BUCKET_CALENDAR,CCC_STRATEGY,Location_Group,CCC_PL_REPORTING_REGION, BU_RISK_RUN_CUSTOM1, sum(cast(USD_CM_Delta as numeric(15,5))) as dollar_greek, sum(case when (PRODUCT_TYPE_CODE = 'TIMESPREAD' and PROD_POS_NAME_DESCRIPTION = 'WCS POST SPREAD' ) OR product_type_code in ('CLEAN FREIGHT','DIRTY FREIGHT','COAL','DRY FREIGHT','EMISSIONS-EU','IRON ORE','NATGAS','PLASTICS') then 0 else cast(RAW_CM_DELTA as numeric(15,5)) end) as raw_greek, case when product_sub_type_name in ('STORAGE RELET', 'STORAGE CONTRACT') and COB_DATE >=EXPIRATION_DATE and BU_RISK_RUN_CUSTOM1 = 'STORAGE' then 'TANK' when product_sub_type_name in ('FLEXDEAL', 'P_TANK-T', 'PHYSICAL INVENTORY') and BU_RISK_RUN_CUSTOM1 <> 'STORAGE' then 'TANK' else 'NOTANK' end as TANK, case when EXPIRATION_DATE < ('2019-09-01') then time_bucket_quarter end as quarters FROM cdwuser.U_CM_MSR Where COB_DATE IN ('2018-02-28','2018-01-31') AND ((CCC_BUSINESS_AREA NOT IN ('OIL LIQUIDS') AND CCC_DIVISION = 'COMMODITIES') OR (CCC_DIVISION = 'FIXED INCOME DIVISION' AND CCC_BUSINESS_AREA = 'COMMODITIES' and CCC_PRODUCT_LINE IN ('OIL & PRODUCTS'))) AND PRODUCT_TYPE_CODE NOT IN ('CURRENCY', 'INTEREST RATE', 'INFLATION', 'TBD', 'MISC','CVA', 'FVA', 'ERROR') group by job_cmdty_code, prod_pos_name_description,CCC_PRODUCT_LINE,product_sub_type_code,product_type_code,product_sub_type_name,COB_DATE, CCC_PL_REPORTING_REGION, CCC_BUSINESS_AREA,TIME_BUCKET_CALENDAR, CMDTY_CD, EXPIRATION_DATE,Location_Group,time_bucket_quarter,CCC_TRD_BOOK, BU_RISK_RUN_CUSTOM1, CCC_STRATEGY)A GROUP BY a.BU_RISK_RUN_CUSTOM1, a.COB_DATE, a.PRODUCT_TYPE_CODE, a.CCC_PL_REPORTING_REGION, a.LOCATION_GROUP, a.TIME_BUCKET_CALENDAR, a.QUARTERS