SELECT b.CCC_PL_REPORTING_REGION, b.COB_DATE, b.RISK_MANAGER_LOCATION, b.CCC_BUSINESS_AREA, b.CCC_DIVISION, b.CURRENCY_COMBINED, B.CURRENCY_OF_MEASURE,b.IRPV01SPRD, b.IRPV01SPRDchng, b.basistype, case when basistype='1m' then 1 when basistype='6m' then 2 when basistype= '12m' then 3 when basistype='OIS' then 4 when basistype='xccybasis' then 5 when basistype='Other' then 6 else 7 end as rankbasistype FROM ( SELECT a.COB_DATE,RISK_MANAGER_LOCATION,a.CURRENCY_OF_MEASURE, Case when a.CCC_PRODUCT_LINE in ('CREL BANK HFI','CRE LENDING SEC/HFS','WAREHOUSE') Then 'WAREHOUSE AND CRE LENDING' When a.FID1_SENIORITY IN ('AT1', 'SUBT1', 'SUBUT2') Then 'JUNIOR SUBORDINATE' when a.CCC_PRODUCT_LINE IN ('DISTRESSED TRADING') then 'DISTRESSED TRADING' else a.CCC_BUSINESS_AREA end as CCC_BUSINESS_AREA, case when curve_name in ('eurnw_1m', 'eurnw_disc', 'eurnw_6m', 'eurnw_12m', 'fxusdeur') then 'EUR' when curve_name in ('usdnw_1m', 'usdn_1m', 'usdlibor1m', 'usdnw_disc', 'usdn_disc', 'usdnw_6m', 'usdn_6m', 'usdnw_12m', 'usdn_12m') then 'USD' when curve_name in ('jpynw_1m', 'jpymu_1m', 'jpymu_tib1', 'jpynw_3m', 'jpymu_3m', 'jpynw_6m', 'jpymu_6m', 'jpymu_tib6', 'jpynw_12m', 'jpymu_12m', 'fxusdjpy') then 'JPY' when curve_name in ('gbpnw_1m', 'gbpnw_disc', 'gbpnw_6m', 'gbpnw_12m', 'fxusdgbp') then 'GBP' when curve_name in ('audnw_1m', 'audn_1m', 'chfnw_1m', 'nok3w_1m', 'seknw_1m', 'cadnw_1m', 'hkdn_1m', 'sgdn_1m', 'audnw_3m', 'audn_disc', 'chfnw_3m', 'chf36_3m', 'seknw_disc', 'cadnw_disc', 'czk36_3m', 'hkdn_disc', 'nzdn_disc', 'nzdnw_3m', 'sgdn_3m', 'sgdn_disc', 'audnw_6m', 'audn_6m', 'chfnw_6m', 'chf36_6m', 'nok3w_6m', 'seknw_6m', 'dkk2w_6m', 'czk36_6m', 'audnw_12m', 'audn_12m', 'chf36_12m', 'nok3w_12m', 'seknw_12m', 'dkk2w_12m', 'chfnw_12m','fxusdaud', 'fxusdchf', 'fxusdnok', 'fxusdsek', 'fxusddkk', 'fxusdcad', 'fxusdkrw', 'fxusdkr1', 'fxusdkr2', 'fxusdmyr', 'fxusdbr1', 'fxusdhkd', 'fxusdhuf', 'fxusdidr', 'fxusdmxn', 'fxusdnzd', 'fxusdsgd', 'fxusdthb', 'fxusdtry', 'fxusdtwd', 'fxusdzar', 'fxusdcnh', 'fxusdcny') then 'OTHER' end as CURRENCY_COMBINED, SUM (case when cob_date in ('2018-02-28') then USD_IRPV01SPRD else 0 end ) AS IRPV01SPRD, SUM (case when cob_date in ('2018-02-28') then USD_IRPV01SPRD else - USD_IRPV01SPRD end ) AS IRPV01SPRDchng, CASE WHEN curve_name in ('fxusdeur','fxusdgbp','fxusdjpy','fxusdaud', 'fxusdchf', 'fxusdnok', 'fxusdsek', 'fxusddkk', 'fxusdcad', 'fxusdkrw', 'fxusdkr1', 'fxusdkr2', 'fxusdmyr', 'fxusdbr1', 'fxusdhkd', 'fxusdhuf', 'fxusdidr', 'fxusdmxn', 'fxusdnzd', 'fxusdsgd', 'fxusdthb', 'fxusdtry', 'fxusdtwd', 'fxusdzar', 'fxusdcnh', 'fxusdcny') THEN 'xccybasis' WHEN curve_name in ('eurnw_1m','gbpnw_1m','usdnw_1m', 'usdn_1m', 'usdlibor1m','jpynw_1m', 'jpymu_1m','jpymu_tib1','chfnw_1m', 'nok3w_1m', 'seknw_1m','audnw_1m', 'audn_1m', 'cadnw_1m','hkdn_1m', 'sgdn_1m') THEN '1m' WHEN curve_name in ('eurnw_6m','gbpnw_6m','usdnw_6m', 'usdn_6m','jpynw_6m', 'jpymu_6m', 'jpymu_tib6','audnw_6m', 'audn_6m', 'chfnw_6m', 'chf36_6m', 'nok3w_6m', 'seknw_6m', 'dkk2w_6m', 'czk36_6m') THEN '6m' WHEN curve_name in ('eurnw_disc','gbpnw_disc','usdnw_disc', 'usdn_disc','jpynw_3m', 'jpymu_3m','chfnw_3m', 'chf36_3m', 'seknw_disc', 'audnw_3m', 'audn_disc', 'cadnw_disc','czk36_3m', 'hkdn_disc', 'nzdn_disc', 'nzdnw_3m', 'sgdn_3m', 'sgdn_disc') THEN 'OIS' WHEN curve_name in ('eurnw_12m','gbpnw_12m','usdnw_12m', 'usdn_12m','jpynw_12m', 'jpymu_12m','audnw_12m', 'audn_12m', 'chf36_12m', 'nok3w_12m', 'seknw_12m', 'dkk2w_12m', 'chfnw_12m') THEN '12m' ELSE 'Other' END AS basistype, case when( a.CCC_BUSINESS_AREA IN ('CPM','CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') OR a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING')) then 'CVA' else a.CCC_DIVISION end as CCC_DIVISION, CCC_PL_REPORTING_REGION from CDWUSER.U_EXP_MSR a WHERE cob_date in ('2018-02-28', '2018-01-31') and A.USD_IRPV01SPRD <> 0 AND VERTICAL_SYSTEM NOT LIKE '%EQUITY%' AND parent_legal_entity = '0302(G)' and ccc_banking_trading='TRADING' and CCC_DIVISION in ('COMMODITIES','FIXED INCOME DIVISION','NON CORE') AND a.RISK_MANAGER_LOCATION <> 'LONDON' GROUP BY A.COB_DATE,RISK_MANAGER_LOCATION,a.CURRENCY_OF_MEASURE, Case when a.CCC_PRODUCT_LINE in ('CREL BANK HFI','CRE LENDING SEC/HFS','WAREHOUSE') Then 'WAREHOUSE AND CRE LENDING' When a.FID1_SENIORITY IN ('AT1', 'SUBT1', 'SUBUT2') Then 'JUNIOR SUBORDINATE' when a.CCC_PRODUCT_LINE IN ('DISTRESSED TRADING') then 'DISTRESSED TRADING' else a.CCC_BUSINESS_AREA end, case when curve_name in ('eurnw_1m', 'eurnw_disc', 'eurnw_6m', 'eurnw_12m', 'fxusdeur') then 'EUR' when curve_name in ('usdnw_1m', 'usdn_1m', 'usdlibor1m', 'usdnw_disc', 'usdn_disc', 'usdnw_6m', 'usdn_6m', 'usdnw_12m', 'usdn_12m') then 'USD' when curve_name in ('jpynw_1m', 'jpymu_1m', 'jpymu_tib1', 'jpynw_3m', 'jpymu_3m', 'jpynw_6m', 'jpymu_6m', 'jpymu_tib6', 'jpynw_12m', 'jpymu_12m', 'fxusdjpy') then 'JPY' when curve_name in ('gbpnw_1m', 'gbpnw_disc', 'gbpnw_6m', 'gbpnw_12m', 'fxusdgbp') then 'GBP' when curve_name in ('audnw_1m', 'audn_1m', 'chfnw_1m', 'nok3w_1m', 'seknw_1m', 'cadnw_1m', 'hkdn_1m', 'sgdn_1m', 'audnw_3m', 'audn_disc', 'chfnw_3m', 'chf36_3m', 'seknw_disc', 'cadnw_disc', 'czk36_3m', 'hkdn_disc', 'nzdn_disc', 'nzdnw_3m', 'sgdn_3m', 'sgdn_disc', 'audnw_6m', 'audn_6m', 'chfnw_6m', 'chf36_6m', 'nok3w_6m', 'seknw_6m', 'dkk2w_6m', 'czk36_6m', 'audnw_12m', 'audn_12m', 'chf36_12m', 'nok3w_12m', 'seknw_12m', 'dkk2w_12m', 'chfnw_12m','fxusdaud', 'fxusdchf', 'fxusdnok', 'fxusdsek', 'fxusddkk', 'fxusdcad', 'fxusdkrw', 'fxusdkr1', 'fxusdkr2', 'fxusdmyr', 'fxusdbr1', 'fxusdhkd', 'fxusdhuf', 'fxusdidr', 'fxusdmxn', 'fxusdnzd', 'fxusdsgd', 'fxusdthb', 'fxusdtry', 'fxusdtwd', 'fxusdzar', 'fxusdcnh', 'fxusdcny') then 'OTHER' end, CASE WHEN curve_name in ('fxusdeur','fxusdgbp','fxusdjpy','fxusdaud', 'fxusdchf', 'fxusdnok', 'fxusdsek', 'fxusddkk', 'fxusdcad', 'fxusdkrw', 'fxusdkr1', 'fxusdkr2', 'fxusdmyr', 'fxusdbr1', 'fxusdhkd', 'fxusdhuf', 'fxusdidr', 'fxusdmxn', 'fxusdnzd', 'fxusdsgd', 'fxusdthb', 'fxusdtry', 'fxusdtwd', 'fxusdzar', 'fxusdcnh', 'fxusdcny') THEN 'xccybasis' WHEN curve_name in ('eurnw_1m','gbpnw_1m','usdnw_1m', 'usdn_1m', 'usdlibor1m','jpynw_1m', 'jpymu_1m','jpymu_tib1','chfnw_1m', 'nok3w_1m', 'seknw_1m','audnw_1m', 'audn_1m', 'cadnw_1m','hkdn_1m', 'sgdn_1m') THEN '1m' WHEN curve_name in ('eurnw_6m','gbpnw_6m','usdnw_6m', 'usdn_6m','jpynw_6m', 'jpymu_6m', 'jpymu_tib6','audnw_6m', 'audn_6m', 'chfnw_6m', 'chf36_6m', 'nok3w_6m', 'seknw_6m', 'dkk2w_6m', 'czk36_6m') THEN '6m' WHEN curve_name in ('eurnw_disc','gbpnw_disc','usdnw_disc', 'usdn_disc','jpynw_3m', 'jpymu_3m','chfnw_3m', 'chf36_3m', 'seknw_disc', 'audnw_3m', 'audn_disc', 'cadnw_disc','czk36_3m', 'hkdn_disc', 'nzdn_disc', 'nzdnw_3m', 'sgdn_3m', 'sgdn_disc') THEN 'OIS' WHEN curve_name in ('eurnw_12m','gbpnw_12m','usdnw_12m', 'usdn_12m','jpynw_12m', 'jpymu_12m','audnw_12m', 'audn_12m', 'chf36_12m', 'nok3w_12m', 'seknw_12m', 'dkk2w_12m', 'chfnw_12m') THEN '12m' ELSE 'Other' END, case when( a.CCC_BUSINESS_AREA IN ('CPM','CREDIT', 'MS CVA MNE - FID', 'MS CVA MNE - COMMOD') OR a.CCC_STRATEGY IN ('MS CVA MPE - DERIVATIVES', 'MS CVA MNE - DERIVATIVES','EQ XVA HEDGING')) then 'CVA' else a.CCC_DIVISION end, a.CCC_PL_REPORTING_REGION ) b