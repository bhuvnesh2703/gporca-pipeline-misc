SELECT a.ccc_taps_company AS ENTITY, SUM(a.PV01) AS PV01, SUM(a.PV01SPRD) AS PV01SPRD, SUM(a.EQ_DELTA) AS EQ_DELTA, SUM(a.FX_DELTA) AS FX_DELTA, SUM(a.CM_DELTA) AS CM_DELTA, SUM(a.EQ_KAPPA) AS EQ_KAPPA, SUM(a.FX_KAPPA) AS FX_KAPPA, SUM(a.CM_KAPPA) AS CM_KAPPA, SUM(a.IR_KAPPA) AS IR_KAPPA, SUM(a.NET_EXPOSURE) AS NET_EXPOSURE, SUM(a.PV10_BENCH) AS PV10_BENCH FROM( SELECT ccc_taps_company, sum(usd_ir_unified_pv01) as PV01, sum(case when ccc_business_area not like '%MNE%' then usd_pv01sprd else 0 end) as PV01SPRD, 0 as EQ_DELTA, sum(CASE WHEN CCC_TAPS_COMPANY IN ('0111') and CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(USD_FX,0) END) as FX_DELTA, 0 as CM_DELTA, sum(usd_eq_kappa) as EQ_KAPPA, 0 as FX_KAPPA, 0 as CM_KAPPA, sum(coalesce(usd_ir_kappa,0))/10 + sum(coalesce(usd_real_kappa,0))/10 as IR_KAPPA, sum(usd_exposure) as NET_EXPOSURE, sum(usd_pv10_bench) as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' AND VAR_EXCL_FL <> 'Y' GROUP BY ccc_taps_company UNION ALL SELECT ccc_taps_company, 0 as PV01, 0 as PV01SPRD, SUM(coalesce(USD_DELTA, 0)) as EQ_DELTA, 0 as FX_DELTA, 0 as CM_DELTA, 0 as EQ_KAPPA, 0 as FX_KAPPA, 0 as CM_KAPPA, 0 as IR_KAPPA, 0 as NET_EXPOSURE, 0 as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' AND VAR_EXCL_FL <> 'Y' GROUP BY ccc_taps_company UNION ALL SELECT ccc_taps_company, 0 as PV01, 0 as PV01SPRD, 0 as EQ_DELTA, 0 as FX_DELTA, SUM(coalesce(USD_CM_DELTA, 0)) as CM_DELTA, 0 as EQ_KAPPA, 0 as FX_KAPPA, 0 as CM_KAPPA, 0 as IR_KAPPA, 0 as NET_EXPOSURE, 0 as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' AND VAR_EXCL_FL <> 'Y' and CCC_TAPS_COMPANY not in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') GROUP BY ccc_taps_company UNION ALL SELECT ccc_taps_company, 0 as PV01, 0 as PV01SPRD, 0 as EQ_DELTA, 0 as FX_DELTA, SUM(case when PRODUCT_TYPE_CODE NOT IN ('EQUITY','EQUITY INDEX','ERROR','IGNORE', 'INFLATION','INTEREST RATE','CURRENCY','TBD') then coalesce(USD_CM_DELTA,0) else 0 end) +sum(case when VERTICAL_SYSTEM ='NY-NG-SUPPLYLINK' and CCC_STRATEGY in ('NAPG NAT GAS','NA NATURAL GAS') and PRODUCT_SUB_TYPE_NAME ='OTC OPTION PREMIUM' then LCY_BALSHEET else 0 end )/1000 AS CM_DELTA, 0 as EQ_KAPPA, 0 as FX_KAPPA, 0 as CM_KAPPA, 0 as IR_KAPPA, 0 as NET_EXPOSURE, 0 as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' AND VAR_EXCL_FL <> 'Y' and CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') GROUP BY ccc_taps_company UNION ALL SELECT ccc_taps_company, 0 as PV01, 0 as PV01SPRD, 0 as EQ_DELTA, 0 as FX_DELTA, 0 as CM_DELTA, 0 as EQ_KAPPA, SUM(CASE WHEN VERTICAL_SYSTEM LIKE '%STS%' THEN USD_FX_PARTIAL_KAPPA ELSE USD_FX_KAPPA END) AS FX_KAPPA, 0 as CM_KAPPA, 0 as IR_KAPPA, 0 as NET_EXPOSURE, 0 as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' GROUP BY ccc_taps_company UNION ALL SELECT ccc_taps_company, 0 as PV01, 0 as PV01SPRD, 0 as EQ_DELTA, 0 as FX_DELTA, 0 as CM_DELTA, 0 as EQ_KAPPA, 0 as FX_KAPPA, SUM(USD_CM_KAPPA) as CM_KAPPA, 0 as IR_KAPPA, 0 as NET_EXPOSURE, 0 as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' AND VAR_EXCL_FL <> 'Y' and CCC_TAPS_COMPANY not in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') GROUP BY ccc_taps_company UNION ALL SELECT ccc_taps_company, 0 as PV01, 0 as PV01SPRD, 0 as EQ_DELTA, 0 as FX_DELTA, 0 as CM_DELTA, 0 as EQ_KAPPA, 0 as FX_KAPPA, SUM( CASE WHEN feed_source_name <> 'CORISK' then usd_cm_kappa ELSE CASE WHEN product_type_code=upper('Eur ng') then coalesce(raw_cm_kappa/10,0) /1000 WHEN product_type_code NOT IN(upper('equity index'),upper('Currency'), upper('Credit')) THEN coalesce(raw_cm_kappa,0) /1000 ELSE 0 end END) as CM_KAPPA, 0 as IR_KAPPA, 0 as NET_EXPOSURE, 0 as PV10_BENCH FROM cdwuser.U_EXP_MSR WHERE cob_date = '02/28/2018' AND VAR_EXCL_FL <> 'Y' and CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') AND PRODUCT_TYPE_CODE NOT IN ('INTEREST RATE', 'EURO PWR SPREAD', 'EURO GAS SPREAD', 'TIMESPREAD', 'TBD') AND LOT_UNIT_OF_LABEL NOT IN ('M','IR','Err','USD','MWH','EDF','USDC','TBD') AND CCC_BUSINESS_AREA NOT IN ('CREDIT','COMMODS FINANCING') and book not in ('CVPN1', 'FVPN1', 'CVNN1', 'FVNN1') GROUP BY ccc_taps_company ) a WHERE a.ccc_taps_company NOT IN ('UNDEFINED','UNDF','MISS') GROUP BY a.ccc_taps_company