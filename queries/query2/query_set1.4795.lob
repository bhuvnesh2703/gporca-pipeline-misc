WITH TOP4_ISSUERS AS ( SELECT COB_DATE, ISSUER_COUNTRY_CODE_DECOMP FROM ( SELECT 'MSIP' AS LE, COB_DATE, ISSUER_COUNTRY_CODE_DECOMP, RANK() OVER (ORDER BY ABS(SUM(USD_EQ_DELTA_DECOMP)) DESC) AS RANK, SUM(USD_EQ_DELTA_DECOMP) AS EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR A WHERE COB_DATE = '2018-02-28' AND PARENT_LEGAL_ENTITY IN ('0302(G)') AND CCC_PL_REPORTING_REGION = 'AMERICAS' AND var_excl_fl <> 'Y' AND CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' GROUP BY COB_DATE, ISSUER_COUNTRY_CODE_DECOMP ) x WHERE RANK <= 4 GROUP BY COB_DATE, ISSUER_COUNTRY_CODE_DECOMP ), ALL_ISSUERS AS ( SELECT CASE WHEN B.PARENT_LEGAL_ENTITY LIKE '0302(G)%' THEN 'MSIP' ELSE 'MSCO' END AS LE, B.COB_DATE, B.ISSUER_COUNTRY_CODE_DECOMP, SUM(B.USD_EQ_DELTA_DECOMP) AS EQ_DELTA_DECOMP FROM CDWUSER.U_DECOMP_MSR B WHERE B.COB_DATE IN ('2018-02-28','2018-01-31','2017-12-29','2017-11-30','2017-10-31','2017-09-29','2017-08-31','2017-07-31','2017-06-30','2017-05-31','2017-04-28','2017-03-31','2017-02-28') AND (B.PARENT_LEGAL_ENTITY LIKE '0201(G)%' OR B.PARENT_LEGAL_ENTITY LIKE '0302(G)%') AND B.CCC_PL_REPORTING_REGION = 'AMERICAS' AND B.VAR_EXCL_FL <> 'Y' AND B.CCC_DIVISION = 'INSTITUTIONAL EQUITY DIVISION' GROUP BY B.PARENT_LEGAL_ENTITY, B.COB_DATE, B.ISSUER_COUNTRY_CODE_DECOMP ) SELECT X.*, CASE WHEN ISSUER_COUNTRY_GROUP = 'OTHERS' THEN 2 ELSE 1 END AS RANK FROM ( SELECT ALL_ISSUERS.COB_DATE, ALL_ISSUERS.LE, TOP4_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP, ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP, COALESCE(CASE WHEN ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMp = TOP4_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP THEN ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP ELSE 'OTHERS' END,'Total') AS ISSUER_COUNTRY_GROUP, SUM(ALL_ISSUERS.EQ_DELTA_DECOMP) AS EQ_DELTA_DECOMP FROM ALL_ISSUERS LEFT JOIN TOP4_ISSUERS ON ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMp = TOP4_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP GROUP BY ALL_ISSUERS.COB_DATE, ALL_ISSUERS.LE, TOP4_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP, ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP, CASE WHEN ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMp = TOP4_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP THEN ALL_ISSUERS.ISSUER_COUNTRY_CODE_DECOMP ELSE 'OTHERS' END ) X