SELECT Sum(is_included_pnl - delta_pnl) AS DELTA_ADJ_PNL, Sum(is_included_pnl) AS IS_INCLUDED_PNL, storage_flag, cob_date, stress_scenario, strategy, strategy_details, PRODUCT_SUB_TYPE_NAME FROM ( SELECT 'CM_MOD' AS src, PVT.cob_date, PVT.ccc_business_area, PVT.attribution, CCC_strategy AS strategy, PVT.strategy_details, stress_scenario, has_crossgamma, PRODUCT_SUB_TYPE_NAME, CASE WHEN risk_run_custom1 = 'STORAGE' THEN 'Storage' ELSE 'No Storage' END AS Storage_Flag, book, Sum(CASE WHEN scenario_type = 'GREEK' AND attribution = 'CM DELTA' THEN scenario_pnl ELSE 0 END) AS delta_PNL, Sum(CASE WHEN is_included = 'YES' THEN PVT.scenario_pnl ELSE 0 END) AS IS_INCLUDED_PNL FROM dwuser.u_modular_scenarios PVT WHERE COB_DATE in ('2018-02-28','2018-02-21') and run_profile = 'CM_MOD_SCN_RUN' AND ccc_business_area = 'COMMODITIES' AND COALESCE(pvt.subprod_product_type, 'null') NOT IN ('CURRENCY', 'CREDIT', 'INTEREST RATE', 'WEATHER') AND book <> '12165' AND NOT ( attribution = 'CM GAMMA' AND has_crossgamma = 'Y' ) AND ccc_product_line in ('NA POWER & GAS','EU POWER & GAS') AND stress_scenario LIKE '%VOL_0' GROUP BY PVT.cob_date, PVT.ccc_business_area, PVT.attribution, has_crossgamma, CASE WHEN risk_run_custom1 = 'STORAGE' THEN 'Storage' ELSE 'No Storage' END, stress_scenario, ccc_strategy, PVT.strategy_details, PRODUCT_SUB_TYPE_NAME, book ) a GROUP BY storage_flag, cob_date, stress_scenario, strategy, strategy_details, PRODUCT_SUB_TYPE_NAME