SELECT CASE WHEN TODAY.WM_BANKING_PRODUCT_GROUP IS NULL THEN PRIOR_DAY.WM_BANKING_PRODUCT_GROUP ELSE TODAY.WM_BANKING_PRODUCT_GROUP END AS WM_BANKING_PRODUCT_GROUP, CASE WHEN TODAY.ACCOUNT IS NULL THEN PRIOR_DAY.ACCOUNT ELSE TODAY.ACCOUNT END AS ACCOUNT , CASE WHEN TODAY.WM_BANKING_PRODUCT_SUB_GROUP IS NULL THEN PRIOR_DAY.WM_BANKING_PRODUCT_SUB_GROUP ELSE TODAY.WM_BANKING_PRODUCT_SUB_GROUP END AS WM_BANKING_PRODUCT_SUB_GROUP, SUM(TODAY.USD_NOTIONAL) AS TODAY_NOTIONAL, SUM(PRIOR_DAY.USD_NOTIONAL) AS PRIOR_NOTIONAL, SUM(TODAY.USD_PV01) AS TODAY_PV01, SUM(PRIOR_DAY.USD_PV01) AS PRIOR_PV01, SUM(TODAY.SLIDE_IR_PLS_200BP_USD) AS TODAY_SLIDE_IR_PLS_200BP_USD, SUM(PRIOR_DAY.SLIDE_IR_PLS_200BP_USD) AS PRIOR_SLIDE_IR_PLS_200BP_USD, SUM(TODAY.SLIDE_IR_PLS_200BP_USD) - SUM(PRIOR_DAY.SLIDE_IR_PLS_200BP_USD) AS UP200_CHG FROM (SELECT a.COB_DATE, a.ACCOUNT, CASE WHEN A.WM_BANKING_PRODUCT_GROUP = 'AFS' OR A.BOOK IN ('PBCMB') OR (A.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9')) THEN 'AFS' WHEN A.BOOK IN ('MSDPT3M', 'MSDPT3M', 'MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'DEPOSITS' WHEN A.book = 'CCISW' OR a.WM_BANKING_PRODUCT_GROUP = 'Bank Lending' THEN 'Bank Lending' ELSE a.WM_BANKING_PRODUCT_GROUP END AS WM_BANKING_PRODUCT_GROUP, CASE WHEN a.book = 'CCISW' OR a.WM_BANKING_PRODUCT_SUB_GROUP = 'Mortgages (HFS)' THEN 'Mortgages (HFS)' WHEN A.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9') THEN 'AFS AGN FIXED' WHEN A.account in ('0720B59U5', '0720B53Z0', '0720CB3C7', '0720B50C4', '0720A43U5', '0720CB2T1', '0720A43N1','07200DK45') then 'AFS Credit Fixed' WHEN A.BOOK IN ('MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'SAVINGS' ELSE a.WM_BANKING_PRODUCT_SUB_GROUP END AS WM_BANKING_PRODUCT_SUB_GROUP, SUM (USD_NOTIONAL) AS USD_NOTIONAL, SUM (MV) AS MV, SUM (USD_PV01) AS USD_PV01, SUM (CASE WHEN a.WM_BANKING_PRODUCT_SUB_GROUP = 'Swaption' THEN COALESCE (SLIDE_IR_MIN_200BP_USD,0) ELSE COALESCE (SLIDE_IR_MIN_200BP_USD,USD_PV01 * - 200) END) AS SLIDE_IR_MIN_200BP_USD, SUM (CASE WHEN a.WM_BANKING_PRODUCT_SUB_GROUP = 'Swaption' THEN COALESCE (SLIDE_IR_PLS_200BP_USD,0) ELSE COALESCE (SLIDE_IR_PLS_200BP_USD, USD_PV01 * 200) END) AS SLIDE_IR_PLS_200BP_USD FROM ( SELECT a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_SUB_TYPE_CODE, a.PRODUCT_TYPE_NAME, SUM (COALESCE (cast (USD_NOTIONAL as numeric(15,5)), 0)) / 1000 AS USD_NOTIONAL, SUM (COALESCE (cast (USD_EXPOSURE as numeric(15,5)), 0)) / 1000 AS USD_EXPOSURE, SUM (COALESCE (cast (USD_PROCEED as numeric(15,5)), 0)) / 1000 AS MV, SUM (COALESCE (cast (USD_IR_UNIFIED_PV01 as numeric(15,5)), 0)) AS USD_PV01, SUM (cast (a.SLIDE_IR_PLS_200BP_USD as numeric(15,5))) AS SLIDE_IR_PLS_200BP_USD, SUM (cast (a.SLIDE_IR_MIN_200BP_USD as numeric(15,5))) AS SLIDE_IR_MIN_200BP_USD FROM cdwuser.u_dm_wm_position a WHERE A.COB_DATE IN ( '2018-02-28' ) AND A.CCC_TAPS_COMPANY = '6635' AND (A.VAR_EXCL_FL <> 'Y' OR A.BOOK IN ('MSDPB3M', 'MSDPT3M')) AND (A.ccc_banking_trading = 'BANKING' OR (A.CCC_HIERARCHY_LEVEL2 IN ('WEALTH MANAGEMENT', 'GLOBAL WEALTH MANAGEMENT') OR a.CCC_business_area = 'US BANKS-LIQUIDITY') AND A.PRODUCT_TYPE_CODE = 'REPO' AND A.CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS')) AND A.WM_BANKING_PRODUCT_GROUP NOT IN ('WLS') GROUP BY a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.PRODUCT_SUB_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_TYPE_NAME ) A GROUP BY a.COB_DATE, a.ACCOUNT, CASE WHEN A.WM_BANKING_PRODUCT_GROUP = 'AFS' OR A.BOOK IN ('PBCMB') OR (A.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9')) THEN 'AFS' WHEN A.BOOK IN ('MSDPT3M', 'MSDPT3M', 'MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'DEPOSITS' WHEN a.book = 'CCISW' OR a.WM_BANKING_PRODUCT_GROUP = 'Bank Lending' THEN 'Bank Lending' ELSE a.WM_BANKING_PRODUCT_GROUP END, CASE WHEN a.book = 'CCISW' OR a.WM_BANKING_PRODUCT_SUB_GROUP = 'Mortgages (HFS)' THEN 'Mortgages (HFS)' WHEN a.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9') THEN 'AFS AGN FIXED' WHEN A.account in ('0720B59U5', '0720B53Z0', '0720CB3C7', '0720B50C4', '0720A43U5', '0720CB2T1', '0720A43N1','07200DK45') then 'AFS Credit Fixed' WHEN A.BOOK IN ('MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'SAVINGS' ELSE a.WM_BANKING_PRODUCT_SUB_GROUP END ) TODAY FULL OUTER JOIN (SELECT a.COB_DATE, a.ACCOUNT, CASE WHEN A.WM_BANKING_PRODUCT_GROUP = 'AFS' OR A.BOOK IN ('PBCMB') OR (A.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9')) THEN 'AFS' WHEN A.BOOK IN ('MSDPT3M', 'MSDPT3M', 'MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'DEPOSITS' WHEN A.book = 'CCISW' OR a.WM_BANKING_PRODUCT_GROUP = 'Bank Lending' THEN 'Bank Lending' ELSE a.WM_BANKING_PRODUCT_GROUP END AS WM_BANKING_PRODUCT_GROUP, CASE WHEN a.book = 'CCISW' OR a.WM_BANKING_PRODUCT_SUB_GROUP = 'Mortgages (HFS)' THEN 'Mortgages (HFS)' WHEN A.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9') THEN 'AFS AGN FIXED' WHEN A.account in ('0720B59U5', '0720B53Z0', '0720CB3C7', '0720B50C4', '0720A43U5', '0720CB2T1', '0720A43N1','07200DK45') then 'AFS Credit Fixed' WHEN A.BOOK IN ('MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'SAVINGS' ELSE a.WM_BANKING_PRODUCT_SUB_GROUP END AS WM_BANKING_PRODUCT_SUB_GROUP, SUM (USD_NOTIONAL) AS USD_NOTIONAL, SUM (MV) AS MV, SUM (USD_PV01) AS USD_PV01, SUM (CASE WHEN a.WM_BANKING_PRODUCT_SUB_GROUP = 'Swaption' THEN COALESCE (SLIDE_IR_MIN_200BP_USD,0) ELSE COALESCE (SLIDE_IR_MIN_200BP_USD,USD_PV01 * - 200) END) AS SLIDE_IR_MIN_200BP_USD, SUM (CASE WHEN a.WM_BANKING_PRODUCT_SUB_GROUP = 'Swaption' THEN COALESCE (SLIDE_IR_PLS_200BP_USD,0) ELSE COALESCE (SLIDE_IR_PLS_200BP_USD, USD_PV01 * 200) END) AS SLIDE_IR_PLS_200BP_USD FROM ( SELECT a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_SUB_TYPE_CODE, a.PRODUCT_TYPE_NAME, SUM (COALESCE (cast (USD_NOTIONAL as numeric(15,5)), 0)) / 1000 AS USD_NOTIONAL, SUM (COALESCE (cast (USD_EXPOSURE as numeric(15,5)), 0)) / 1000 AS USD_EXPOSURE, SUM (COALESCE (cast (USD_PROCEED as numeric(15,5)), 0)) / 1000 AS MV, SUM (COALESCE (cast (USD_IR_UNIFIED_PV01 as numeric(15,5)), 0)) AS USD_PV01, SUM (cast (a.SLIDE_IR_PLS_200BP_USD as numeric(15,5))) AS SLIDE_IR_PLS_200BP_USD, SUM (cast (a.SLIDE_IR_MIN_200BP_USD as numeric(15,5))) AS SLIDE_IR_MIN_200BP_USD FROM cdwuser.u_dm_wm_position a WHERE A.COB_DATE IN ( '2018-02-27' ) AND A.CCC_TAPS_COMPANY = '6635' AND (A.VAR_EXCL_FL <> 'Y' OR A.BOOK IN ('MSDPB3M', 'MSDPT3M')) AND (A.ccc_banking_trading = 'BANKING' OR (A.CCC_HIERARCHY_LEVEL2 IN ('WEALTH MANAGEMENT', 'GLOBAL WEALTH MANAGEMENT') OR a.CCC_business_area = 'US BANKS-LIQUIDITY') AND A.PRODUCT_TYPE_CODE = 'REPO' AND A.CCC_BUSINESS_AREA NOT IN ('NON CORE MARKETS', 'CORE MARKETS')) AND A.WM_BANKING_PRODUCT_GROUP NOT IN ('WLS') GROUP BY a.POSITION_ID, a.COB_DATE, a.ACCOUNT, a.CCC_PRODUCT_LINE, a.VERTICAL_SYSTEM, a.BOOK, a.PRODUCT_TYPE_CODE, a.PRODUCT_SUB_TYPE_CODE, a.WM_BANKING_PRODUCT_GROUP, a.WM_BANKING_PRODUCT_SUB_GROUP, a.BANKING_PRODUCT_DESCRIPTION, a.PRODUCT_TYPE_NAME ) A GROUP BY a.COB_DATE, a.ACCOUNT, CASE WHEN A.WM_BANKING_PRODUCT_GROUP = 'AFS' OR A.BOOK IN ('PBCMB') OR (A.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9')) THEN 'AFS' WHEN A.BOOK IN ('MSDPT3M', 'MSDPT3M', 'MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'DEPOSITS' WHEN a.book = 'CCISW' OR a.WM_BANKING_PRODUCT_GROUP = 'Bank Lending' THEN 'Bank Lending' ELSE a.WM_BANKING_PRODUCT_GROUP END, CASE WHEN a.book = 'CCISW' OR a.WM_BANKING_PRODUCT_SUB_GROUP = 'Mortgages (HFS)' THEN 'Mortgages (HFS)' WHEN a.BOOK = 'GWM_INVESTPORT_TRUST' AND A.ACCOUNT IN ('0710PT251', '0710PT3A9') THEN 'AFS AGN FIXED' WHEN A.account in ('0720B59U5', '0720B53Z0', '0720CB3C7', '0720B50C4', '0720A43U5', '0720CB2T1', '0720A43N1','07200DK45') then 'AFS Credit Fixed' WHEN A.BOOK IN ('MSDPB_SAVINGS', 'MSDPT_SAVINGS') THEN 'SAVINGS' ELSE a.WM_BANKING_PRODUCT_SUB_GROUP END ) PRIOR_DAY ON TODAY.ACCOUNT = PRIOR_DAY.ACCOUNT GROUP BY CASE WHEN TODAY.ACCOUNT IS NULL THEN PRIOR_DAY.ACCOUNT ELSE TODAY.ACCOUNT END, CASE WHEN TODAY.WM_BANKING_PRODUCT_GROUP IS NULL THEN PRIOR_DAY.WM_BANKING_PRODUCT_GROUP ELSE TODAY.WM_BANKING_PRODUCT_GROUP END, CASE WHEN TODAY.WM_BANKING_PRODUCT_SUB_GROUP IS NULL THEN PRIOR_DAY.WM_BANKING_PRODUCT_SUB_GROUP ELSE TODAY.WM_BANKING_PRODUCT_SUB_GROUP END ORDER BY SUM(TODAY.SLIDE_IR_PLS_200BP_USD) ASC