SELECT COB_DATE, term0, CURRENCY_OF_MEASURE, cast(sum(CASE WHEN ( CURRENCY_OF_MEASURE = 'MXN' AND FUNDING_FLAG = 'Funding' ) THEN -1 * term_USD_IRPV01SPRD ELSE term_USD_IRPV01SPRD END) as numeric(15,5)) AS term_USD_IRPV01SPRD from ( SELECT COB_DATE ,CURRENCY_OF_MEASURE ,FUNDING_FLAG, CASE WHEN TERM < 0.02 THEN '01. <1W' WHEN TERM < 0.0834 THEN '02. 1W' WHEN TERM < 0.17 THEN '03. 1M' WHEN TERM < 0.25 THEN '04. 2M' WHEN TERM < 0.5 THEN '05. 3M' WHEN TERM < 1 THEN '06. 6M' WHEN TERM < 2 THEN '07. 1Y' WHEN TERM < 3 THEN '08. 2Y' WHEN TERM < 4 THEN '09. 3Y' WHEN TERM < 5 THEN '10. 4Y' WHEN TERM < 7 THEN '11. 5Y' WHEN TERM < 10 THEN '12. 7Y' WHEN TERM < 15 THEN '13. 10Y' WHEN TERM < 20 THEN '14. 15Y' WHEN TERM < 30 THEN '15. 20Y' ELSE '16. 30Y+' END AS term0, CASE WHEN TERM < 0.02 THEN sum(USD_IRPV01SPRD::numeric(15,5)) WHEN TERM < 0.0834 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (0.0834 - TERM) / (0.0834 - 0.02) WHEN TERM < 0.17 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (0.17 - TERM) / (0.17 - 0.0834) WHEN TERM < 0.25 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (0.25 - TERM) / 0.08 WHEN TERM < 0.5 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (0.5 - TERM) / 0.25 WHEN TERM < 1 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (1 - TERM) / 0.5 WHEN TERM < 2 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (2 - TERM) / 1 WHEN TERM < 3 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (3 - TERM) / 1 WHEN TERM < 4 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (4 - TERM) / 1 WHEN TERM < 5 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (5 - TERM) / 1 WHEN TERM < 7 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (7 - TERM) / 2 WHEN TERM < 10 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (10 - TERM) / 3 WHEN TERM < 15 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (15 - TERM) / 5 WHEN TERM < 20 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (20 - TERM) / 5 WHEN TERM < 30 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (30 - TERM) / 10 ELSE NULL END AS term_USD_IRPV01SPRD from ( select cob_date, currency_of_measure, case when USD_IRPV01SPRD is not null then 'XCCY' else 'Funding' end as funding_flag, term_of_measure / 365 AS term, case when usd_notional is not null and book IN ('TSGFX','THKFX') THEN CASE WHEN USD_MARKET_VALUE>=0 THEN (USD_MARKET_VALUE * term_of_measure / 365) / 10000 ELSE (-USD_MARKET_VALUE * term_of_measure / 365) / 10000 END when usd_notional is not null AND VERTICAL_SYSTEM LIKE '%FXDDI%' AND CCC_BUSINESS_AREA IN ('TSY DEBT') AND CCC_PRODUCT_LINE IN ( 'S-TERM DEBT' ,'FX AND OTHER FUNDING' ) AND CCC_STRATEGY IN ('FX SWAPS') AND BOOK NOT IN ( 'CT0101XE' ,'CT0302XE' ) then (- USD_NOTIONAL * term_of_measure / 365) / 10000 when usd_notional is not null AND BOOK IN ('TZUFX', 'TLNFX') AND term_of_measure/365<30 THEN (-USD_NOTIONAL * term_of_measure/365)/10000 when USD_MARKET_VALUE IS NOT NULL AND BOOK = 'KRSWP' then (- USD_MARKET_VALUE * term_of_measure / 365) / 10000 when USD_IRPV01SPRD IS NOT NULL AND curve_type IN ( 'FXBASISYIELDCURVE' ,'FXBASISYIELDCURVE' ) AND CCC_BUSINESS_AREA NOT IN ('MS BANK - PRIVATE BANK1') AND CCC_STRATEGY NOT IN ( 'STRUCTURED N' ,'L-TERM DEBT SN' ,'L-TERM DEBT SN ALLOC' ) AND book NOT IN ( 'AEOEQ' ,'LIABB' ,'TRPFD' ,'PRFEQ' ,'TDET2' ,'TDET3' ,'TDET4' ,'TDET5' ,'TDET6' ,'TDET7' ,'TDET8' ,'TDEBT' ,'TDCLH' ,'TYCNY' ,'TZUFX' ,'TSGFX' ,'TLNFX' ,'TSTJY' ,'THKFX' ) then USD_IRPV01SPRD end as USD_IRPV01SPRD FROM Cdwuser.U_EXP_MSR WHERE COB_DATE between '2017-10-31' and '2018-02-28' AND CCC_DIVISION = 'TREASURY CAPITAL MARKETS' AND COB_DATE < EXPIRATION_DATE AND CURRENCY_OF_MEASURE NOT IN ('USD') and (USD_IRPV01SPRD is not null OR USD_MARKET_VALUE is not NULL or usd_notional is not null) ) t GROUP BY COB_DATE ,CURRENCY_OF_MEASURE ,FUNDING_FLAG ,TERM UNION ALL SELECT COB_DATE ,CURRENCY_OF_MEASURE ,FUNDING_FLAG, CASE WHEN TERM < 0.02 THEN '01. <1W' WHEN TERM < 0.0834 THEN '03. 1M' WHEN TERM < 0.17 THEN '04. 2M' WHEN TERM < 0.25 THEN '05. 3M' WHEN TERM < 0.5 THEN '06. 6M' WHEN TERM < 1 THEN '07. 1Y' WHEN TERM < 2 THEN '08. 2Y' WHEN TERM < 3 THEN '09. 3Y' WHEN TERM < 4 THEN '10. 4Y' WHEN TERM < 5 THEN '11. 5Y' WHEN TERM < 7 THEN '12. 7Y' WHEN TERM < 10 THEN '13. 10Y' WHEN TERM < 15 THEN '14. 15Y' WHEN TERM < 20 THEN '15. 20Y' ELSE '16. 30Y+' END AS term0, CASE WHEN TERM < 0.02 THEN NULL WHEN TERM < 0.0834 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 0.02) / (0.0834 - 0.02) WHEN TERM < 0.17 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 0.0834) / (0.17 - 0.0834) WHEN TERM < 0.25 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 0.17) / 0.08 WHEN TERM < 0.5 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 0.25) / 0.25 WHEN TERM < 1 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 0.5) / 0.5 WHEN TERM < 2 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 1) / 1 WHEN TERM < 3 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 2) / 1 WHEN TERM < 4 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 3) / 1 WHEN TERM < 5 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 4) / 1 WHEN TERM < 7 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 5) / 2 WHEN TERM < 10 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 7) / 3 WHEN TERM < 15 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 10) / 5 WHEN TERM < 20 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 15) / 5 WHEN TERM < 30 THEN sum(USD_IRPV01SPRD::numeric(15,5)) * (TERM - 20) / 10 ELSE sum(USD_IRPV01SPRD) END AS term_USD_IRPV01SPRD from ( select cob_date, currency_of_measure, case when USD_IRPV01SPRD is not null then 'XCCY' else 'Funding' end as funding_flag, term_of_measure / 365 AS term, case when usd_notional is not null and book IN ('TSGFX','THKFX') THEN CASE WHEN USD_MARKET_VALUE>=0 THEN (USD_MARKET_VALUE * term_of_measure / 365) / 10000 ELSE (-USD_MARKET_VALUE * term_of_measure / 365) / 10000 END when usd_notional is not null AND VERTICAL_SYSTEM LIKE '%FXDDI%' AND CCC_BUSINESS_AREA IN ('TSY DEBT') AND CCC_PRODUCT_LINE IN ( 'S-TERM DEBT' ,'FX AND OTHER FUNDING' ) AND CCC_STRATEGY IN ('FX SWAPS') AND BOOK NOT IN ( 'CT0101XE' ,'CT0302XE' ) then (- USD_NOTIONAL * term_of_measure / 365) / 10000 when USD_MARKET_VALUE IS NOT NULL AND BOOK = 'KRSWP' then (- USD_MARKET_VALUE * term_of_measure / 365) / 10000 when USD_IRPV01SPRD IS NOT NULL AND curve_type IN ( 'FXBASISYIELDCURVE' ,'FXBASISYIELDCURVE' ) AND CCC_BUSINESS_AREA NOT IN ('MS BANK - PRIVATE BANK1') AND CCC_STRATEGY NOT IN ( 'STRUCTURED N' ,'L-TERM DEBT SN' ,'L-TERM DEBT SN ALLOC' ) AND book NOT IN ( 'AEOEQ' ,'LIABB' ,'TRPFD' ,'PRFEQ' ,'TDET2' ,'TDET3' ,'TDET4' ,'TDET5' ,'TDET6' ,'TDET7' ,'TDET8' ,'TDEBT' ,'TDCLH' ,'TYCNY' ,'TZUFX' ,'TSGFX' ,'TLNFX' ,'TSTJY' ,'THKFX' ) then USD_IRPV01SPRD end as USD_IRPV01SPRD FROM cdwuser.U_EXP_MSR WHERE COB_DATE between '2017-10-31' and '2018-02-28' AND CCC_DIVISION = 'TREASURY CAPITAL MARKETS' AND COB_DATE < EXPIRATION_DATE and CURRENCY_OF_MEASURE in ('AUD', 'CAD', 'CHF','EUR','GBP','HKD','JPY','MXN','NZD','SGD') and (USD_IRPV01SPRD is not null OR USD_MARKET_VALUE is not NULL or usd_notional is not null) ) t GROUP BY COB_DATE ,CURRENCY_OF_MEASURE ,FUNDING_FLAG ,TERM ) c group by cob_date, term0, CURRENCY_OF_MEASURE;