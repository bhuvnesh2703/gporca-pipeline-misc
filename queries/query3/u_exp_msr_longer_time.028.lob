select cob_date, sum(case when currency_of_measure = 'MXN' and funding_flag = 'Funding' then -1 * USD_IRPV01SPRD::numeric(15,5) else USD_IRPV01SPRD::numeric(15,5) end) as TERM_USD_IRPV01SPRD from ( select cob_date, currency_of_measure, case when USD_IRPV01SPRD is not null then 'XCCY' else 'Funding' end as funding_flag, sum( case when usd_notional is not null and book IN ('TSGFX', 'THKFX') then CASE WHEN USD_MARKET_VALUE>=0 THEN (USD_MARKET_VALUE::numeric(15,5) * term_of_measure::numeric(15,5) / 365) / 10000 ELSE (-USD_MARKET_VALUE::numeric(15,5) * term_of_measure::numeric(15,5) / 365) / 10000 END when usd_notional is not null AND VERTICAL_SYSTEM LIKE '%FXDDI%' AND CCC_BUSINESS_AREA IN ('TSY DEBT') AND CCC_PRODUCT_LINE IN ( 'S-TERM DEBT', 'FX AND OTHER FUNDING' ) AND CCC_STRATEGY IN ('FX SWAPS') AND BOOK NOT IN ( 'CT0101XE', 'CT0302XE' ) then (- USD_NOTIONAL::numeric(15,5) * term_of_measure::numeric(15,5) / 365) / 10000 when usd_notional is not null AND BOOK IN ('TZUFX', 'TLNFX') AND term_of_measure/365<30 THEN (-USD_NOTIONAL::numeric(15,5) * term_of_measure::numeric(15,5)/365)/10000 when USD_MARKET_VALUE IS NOT NULL AND BOOK = 'KRSWP' then (- USD_MARKET_VALUE::numeric(15,5) * term_of_measure::numeric(15,5) / 365) / 10000 when USD_IRPV01SPRD IS NOT NULL AND curve_type IN ( 'FXBASISYIELDCURVE', 'FXBASISYIELDCURVE' ) AND CCC_BUSINESS_AREA NOT IN ('MS BANK - PRIVATE BANK1') AND CCC_STRATEGY NOT IN ( 'STRUCTURED N', 'L-TERM DEBT SN', 'L-TERM DEBT SN ALLOC' ) AND book NOT IN ( 'AEOEQ' ,'LIABB' ,'TRPFD' ,'PRFEQ' ,'TDET2' ,'TDET3' ,'TDET4' ,'TDET5' ,'TDET6' ,'TDET7' ,'TDET8' ,'TDEBT' ,'TDCLH' ,'TYCNY' ,'TZUFX' ,'TSGFX' ,'TLNFX' ,'TSTJY' ,'THKFX' ) then USD_IRPV01SPRD end ) as USD_IRPV01SPRD FROM cdwuser.U_EXP_MSR WHERE COB_DATE between '2017-10-31' and '2018-02-28' AND CCC_DIVISION = 'TREASURY CAPITAL MARKETS' AND COB_DATE < EXPIRATION_DATE AND CURRENCY_OF_MEASURE NOT IN ('USD') and (USD_IRPV01SPRD is not null OR USD_MARKET_VALUE is not null or USD_NOTIONAL is not null) GROUP BY COB_DATE,currency_of_measure, case when USD_IRPV01SPRD is not null then 'XCCY' else 'Funding' end ) c group by cob_date