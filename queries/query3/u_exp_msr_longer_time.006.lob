Select COB_DATE, CCC_DIVISION, LE, sum(pv01) as pv01, sum(spv01) as spv01, sum(SPV01_noMNE) as spv01_noMNE, sum(eq_delta) as eq_delta, sum(fx_delta) as fx_delta, sum(ir_kappa) as ir_kappa, sum(eq_kappa) as eq_kappa, sum(fx_kappa) as fx_kappa, case when le not in ('MSCGI') then sum(cm_kappa) end as cm_kappa, case when le not in ('MSCGI') then sum(cm_delta) end as cm_delta, sum(net_exposure) as net_exposure, sum(bpv10) as bpv10 From ( SELECT COB_DATE, CCC_DIVISION, CASE when CCC_TAPS_COMPANY in ( '0201','0103','0205','0206','0530','5924') then 'MSCO' when CCC_TAPS_COMPANY in ('0111') then 'MSCS' when CCC_TAPS_COMPANY in ('5745') then 'MSCAP' when CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') then 'MSCGI' when CCC_TAPS_COMPANY in ('0146') then 'MSDP' ELSE CCC_TAPS_COMPANY END AS LE, SUM(USD_IR_UNIFIED_PV01) AS PV01, sum(usd_pv01sprd) AS SPV01, SUM(case when ccc_business_area not like '%MNE%' /*and ccc_business_area not like 'MNE%' */then usd_pv01sprd else 0 end) AS SPV01_noMNE, SUM(USD_DELTA) AS EQ_DELTA, SUM(CASE WHEN CCC_TAPS_COMPANY IN ('0111') and CURRENCY_OF_MEASURE IN ('AED','BHD','CNH','CNY','HKD','OMR','QAR','SAR','USD') THEN 0 WHEN CURRENCY_OF_MEASURE IN ('UBD','USD') THEN 0 ELSE COALESCE(USD_FX,0) END) AS FX_DELTA, SUM(coalesce(USD_IR_KAPPA,0)/10) + SUM(coalesce(USD_REAL_KAPPA,0)/10) AS IR_KAPPA, SUM(USD_EQ_KAPPA) AS EQ_KAPPA, SUM(CASE WHEN VERTICAL_SYSTEM LIKE '%STS%' THEN USD_FX_PARTIAL_KAPPA ELSE USD_FX_KAPPA END) AS FX_KAPPA, /*march GDL measures:CM_kappa, cm_delta*/ sum(USD_CM_KAPPA) as CM_KAPPA, sum(USD_CM_DELTA) as CM_DELTA, SUM(USD_EXPOSURE) AS NET_EXPOSURE, sum(USD_PV10_BENCH) AS BPV10 FROM CDWUSER.U_EXP_MSR WHERE cob_date >= '12/29/2017' and cob_date <= '02/28/2018' and CCC_TAPS_COMPANY in ( '0201','0103','0205','0206','0530','5924','0111','0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609','0146','5745') AND VAR_EXCL_FL <> 'Y' GROUP BY COB_DATE, CCC_DIVISION, CASE when CCC_TAPS_COMPANY in ( '0201','0103','0205','0206','0530','5924') then 'MSCO' when CCC_TAPS_COMPANY in ('0111') then 'MSCS' when CCC_TAPS_COMPANY in ('5745') then 'MSCAP' when CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') then 'MSCGI' when CCC_TAPS_COMPANY in ('0146') then 'MSDP' ELSE CCC_TAPS_COMPANY END ) A group by COB_DATE, CCC_DIVISION, LE UNION ALL SELECT COB_DATE,CCC_DIVISION, 'MSCGI' AS LE, 0 AS PV01, 0 as SPV01, 0 AS SPV01_noMNE, 0 AS EQ_DELTA, 0 AS FX_DELTA, 0 AS IR_KAPPA, 0 AS EQ_KAPPA, 0 AS FX_KAPPA, SUM( CASE WHEN product_type_code IN ('INTEREST RATE', 'EURO PWR SPREAD', 'EURO GAS SPREAD', 'TIMESPREAD', 'TBD') THEN 0 WHEN feed_source_name <> 'CORISK' THEN coalesce(usd_cm_kappa,0) ELSE( CASE WHEN product_type_code = 'EUR NG' THEN coalesce(raw_cm_kappa,0) / 10000 WHEN product_type_code NOT IN('EQUITY INDEX', 'CURRENCY', 'CREDIT') THEN coalesce(raw_cm_kappa,0) / 1000 ELSE 0 END) END) AS CM_KAPPA, 0 AS CM_DELTA, 0 AS NET_EXPOSURE, 0 AS BPV10 FROM cdwuser.u_exp_msr WHERE cob_date >= '12/29/2017' and cob_date <= '02/28/2018' and CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') AND var_excl_fl <> 'Y' AND PRODUCT_TYPE_CODE NOT IN ('EURO GAS SPREAD', 'EURO PWR SPREAD', 'TIMESPREAD') AND LOT_UNIT_OF_LABEL NOT IN ('M','IR','Err','USD','MWH','EDF','USDC','TBD') AND CCC_BUSINESS_AREA NOT IN ('CREDIT','COMMODS FINANCING') group by COB_DATE,CCC_DIVISION UNION ALL SELECT COB_DATE,CCC_DIVISION, 'MSCGI' AS LE, 0 AS PV01, 0 AS SPV01, 0 AS SPV01_noMNE, 0 AS EQ_DELTA, 0 AS FX_DELTA, 0 AS IR_KAPPA, 0 AS EQ_KAPPA, 0 AS FX_KAPPA, 0 AS CM_KAPPA, SUM(case when PRODUCT_TYPE_CODE NOT IN ('EQUITY','EQUITY INDEX','ERROR','IGNORE', 'INFLATION','INTEREST RATE','CURRENCY','TBD') AND CCC_BUSINESS_AREA NOT IN ('CREDIT','COMMODS FINANCING') then coalesce(USD_CM_DELTA,0) else 0 end) +sum(case when VERTICAL_SYSTEM ='NY-NG-SUPPLYLINK' and CCC_STRATEGY in ('NAPG NAT GAS','NA NATURAL GAS') and PRODUCT_SUB_TYPE_NAME ='OTC OPTION PREMIUM' then LCY_BALSHEET else 0 end )/1000 AS CM_DELTA, 0 AS NET_EXPOSURE, 0 AS BPV10 FROM cdwuser.u_exp_msr WHERE cob_date >= '12/29/2017' and cob_date <= '02/28/2018' and CCC_TAPS_COMPANY in ('0105', '0513', '1133', '1614', '2042', '4442', '4919', '4920', '5122', '6399', '7025', '7038', '7114', '7323', '7410', '7504', '7516', '8296', '8304', '8562', '8747', '8934', '7706', '7549', '6706', '5427', '7414', '7465', '7493', '7278', '7279', '7705', '7624', '7681', '7800', '5656', '7708', '7707', '7801', '7627', '7759', '7710', '7762', '7630', '7628', '7761', '7684', '5923', '7609') AND var_excl_fl <> 'Y' group by COB_DATE,CCC_DIVISION