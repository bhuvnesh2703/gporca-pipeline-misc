with src as ( select cob_date, account, book, ticket, tapscusip , child_issuer_id, child_issuer_name , product_type, product_subtype , coupon, currency , maturity_date, netting_category , country_of_domicile, ccc_business_area , ccc_product_line, charge_type, sr_charge_factor , sr_term_bucket, country_rank, is_country_defaulted_within_5_years , sr_std_charge_required , is_trading_fl, investment_grade , sum(abs(sr_value)) as GROSS_EXPOSURE , abs(sum(sr_value)) as NET_EXPOSURE , sum(abs(sr_charge)) *12.5 as GROSS_RWA , abs(sum(sr_charge)) *12.5 as NET_RWA from CDWUSER.U_CAPITAL where cob_date in (date '20180228', date '20180221') and asset_class <> 'EQ' and sr_value <> 0 group by cob_date, account, book, ticket, tapscusip , child_issuer_id, child_issuer_name , product_type, product_subtype , coupon, currency , maturity_date, netting_category , country_of_domicile, ccc_business_area , ccc_product_line, charge_type, sr_charge_factor , sr_term_bucket, country_rank, is_country_defaulted_within_5_years , sr_std_charge_required , is_trading_fl, investment_grade ), c as (select * from src where cob_date = date '20180228'), p as (select * from src where cob_date = date '20180221'), q1 as ( select c.* , p.sr_std_charge_required as PREV_SR_STD_CHARGE_REQUIRED , p.sr_charge_factor as PREV_SR_CHARGE_FACTOR , p.gross_exposure as PREV_GROSS_EXPOSURE , p.net_exposure as PREV_NET_EXPOSURE , p.gross_rwa as PREV_GROSS_RWA , p.net_rwa as PREV_NET_RWA , (c.net_rwa-p.net_rwa) as NET_RWA_IMPACT from c LEFT join p on (c.account, c.book, c.ticket, c.tapscusip , c.child_issuer_id, c.child_issuer_name , c.product_type, c.product_subtype , c.coupon, c.currency , c.maturity_date, c.netting_category , c.tapscusip, c.country_of_domicile) = (p.account, p.book, p.ticket, p.tapscusip , p.child_issuer_id, p.child_issuer_name , p.product_type, p.product_subtype , p.coupon, p.currency , p.maturity_date, p.netting_category , p.tapscusip, p.country_of_domicile) where c.sr_std_charge_required <> p.sr_std_charge_required and (c.net_rwa <> 0 and p.net_rwa<>0) ) select * from q1